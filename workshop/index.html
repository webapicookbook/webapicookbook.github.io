<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.0.0rc1" />
<title>RESTful Web API Patterns and Practices Cookbook (Workshop Edition)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>RESTful Web API Patterns and Practices Cookbook (Workshop Edition)</h1>
<span id="author">Mike Amundsen</span><br />
<span id="email"><code>&lt;<a href="mailto:mca@mamund.com">mca@mamund.com</a>&gt;</code></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph" id="patterns"><p><a href="https://www.webapicookbook.com/">https://www.webapicookbook.com/</a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Copyright &#169; 2022-2024 by Mike Amundsen</p></div>
</div></div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.webapicookbook.com/">
<img src="images/cover.jpg" alt="images/cover.jpg" />
</a>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preface">1. Preface</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>There are no separate systems. The world is a continuum. Where to draw a boundary around a system depends on the purpose of the discussion.</q></p>
<p data-type="attribution">Donella H. Meadows</p>
</blockquote>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p><em>This document holds all the recipes I&#8217;ve selected for this volume. Since this is just an excerpt from a much larger work, lots of background supporting material has been left out of this release. For the full story, check out the O&#8217;Reilly book upon which this content is based.</em></p></div>
</div></div>
<div class="paragraph"><p>When thinking about programming the network, often the focus is on what it takes to program a <em>machine</em>. Things like the programming language, use of memory, data storage, and passing properties back and forth through functions are seen as the primary tools. However, when it comes to programming the <em>network</em>, new challenges appear, and that means we need new thinking and new tooling, too.</p></div>
<div class="sect2">
<h3 id="_elements_of_restful_hypermedia">1.1. Elements of RESTful Hypermedia</h3>
<div class="paragraph"><p>RESTful, hypermedia-based implementations rely on three key elements: messages, actions, and vocabularies (see <a href="#fig0101">[fig0101]</a>). In hypermedia-based solutions, messages are passed using common formats like HTML, Collection+JSON, and SIREN. These messages contain content based on a shared domain vocabulary, such as PSD2 for banking, ACORD for insurance, or FIHR for health information. And these same messages include well-defined actions such as <code>save</code>, <code>share</code>, <code>approve</code>, and so forth.</p></div>
<div class="imageblock" id="fig0101">
<div class="content">
<img src="images/rwcb_0101.png" alt="images/rwcb_0101.png" width="80%" />
</div>
<div class="title">Figure 1. Elements of hypermedia</div>
</div>
<div class="paragraph"><p>With these three concepts, I hope to engage you in thinking about how we build and use services over HTTP today, and how, with a slight change in perspective and approach, we can update the design and implementation of these services in a way that improves their usability, lowers the cost of creating and accessing them, and increases the ability of both service producers and consumers to build and sustain viable API-led businesses—even when some of the services we depend upon are unreliable or unavailable.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_restful_recipe_catalog_summary">2. RESTful Recipe Catalog Summary</h2>
<div class="sectionbody">
<div class="paragraph"><p>The goal of this collection is to enable software designers, architects, developers, and maintainers to build service interfaces (APIs) that take advantage of the strengths of the web, while lowering the costs and risks of creating reliable high-level services that hold dependencies on other APIs and services reachable only over the network.</p></div>
<div class="paragraph"><p>To do that, I&#8217;ve gathered a collection of more than 70 recipes and patterns that I&#8217;ve learned and used over the several decades I&#8217;ve spent helping clients design, build, and deploy successful business services on the open web. I suspect you will be familiar with at least some of the recipes you&#8217;ll find here—possibly by other names or in different forms. I also hope that you will find novel approaches to similar problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Over the years, I&#8217;ve found that the challenges of software design rarely change. The <em>solutions</em> to those problems change frequently based on technology advances and fashion trends. We&#8217;ll focus on the challenges in this book, and I&#8217;ll leave the up-to-date technology and fashion choices to you, the reader.</p></div>
</td>
</tr></table>
</div>
<div class="dlist"><dl>
<dt class="hdlist1">
<a href="#design">RESTful Design</a>
</dt>
<dd>
<p>
Reliable and resilient services start with thoughtful designs. This chapter covers a set of common challenges you&#8217;ll need to deal with before you even get to the level of coding and releasing your services. This chapter will be particularly helpful to architects as well as service designers, and helps set the tone for the various recipes that follow.
</p>
</dd>
<dt class="hdlist1">
<a href="#clients">RESTful Clients</a>
</dt>
<dd>
<p>
This chapter focuses on challenges you&#8217;ll face when creating service/API consumer applications. I made a point of discussing client apps <em>before</em> talking about recipes for service interfaces themselves. A common approach for creating flexible and resilient service consumers is necessary for any program that plans on creating a stable and reliable platform for open services that can live on the web as well as within an enterprise.
</p>
</dd>
<dt class="hdlist1">
<a href="#services">RESTful Services</a>
</dt>
<dd>
<p>
With a solid foundation of design principles and properly architected client applications, it can be easier to build and release stable service producers that can be safely updated over time without breaking existing API consumers. This set of recipes focuses not only on principles of solid service interface design but also on the importance of supporting runtime error recovery and reliability patterns to make sure your solutions stay up and running even when parts of your system experience failures.
</p>
</dd>
<dt class="hdlist1">
<a href="#data">Distributed Data</a>
</dt>
<dd>
<p>
This chapter focuses on the challenges of supporting persisted data in an online, distributed environment. Most of the recipes here are aimed at improving the responsiveness, scalability, and reliability of your data services by ensuring data integrity—even when changing internal data models and implementations at runtime.
</p>
</dd>
<dt class="hdlist1">
<a href="#workflow">RESTful Workflow</a>
</dt>
<dd>
<p>
The last set of recipes focuses on creating and managing service workflow on the web. The key challenge to face for open services workflow is to create a safe and reliable set of solutions for enlisting multiple unrelated services into a single, resilient workflow to solve a problem none of the individual services knows anything about. I saved this chapter for last since it relies on many of the recipes covered earlier in the book.
</p>
</dd>
<dt class="hdlist1">
<a href="#principles">Guiding Principles</a> 
</dt>
<dd>
<p>
This appendix is a short "motivational poster" version of the single guiding principle behind the selected recipes, as well as some secondary principles used to shape the description and, ultimately, the implementation of these patterns in general.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="design">3. RESTful Design</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>The problem is essentially the one discussed by science fiction writers: "how do you get communications started among totally uncorrelated ‘sapient' beings?"</p>
<p data-type="attribution">J.C.R. Licklider, 1966</p>
</blockquote>
<div class="paragraph"><p>A foundational element of any system-level design is a set of shared principles or understandings about how parts of the system interact. That is the overarching problem we&#8217;ll address in this chapter—how to design systems where machines built by different people who have never met can successfully interact with each other. The recipes in this chapter focus on the design aspects of hypermedia systems. To do that, you&#8217;ll find recipes that explore the relationship between media types, hypermedia controls, data properties, and semantic profiles that help bring them together (see <a href="#fig0301">[fig0301]</a>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If you&#8217;re interested in the background concepts and technologies behind designing hypermedia-driven solutions, see <a href="#background-design">[background-design]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For communications within the web, HTTP is at the heart of this shared understanding. HTTP sets the rules—and the <em>expectations</em>—for sending data between services. And, despite the fact that HTTP&#8217;s history dates back to the mid 1980s, it is still ubiquitous and relevant after more than 30 years.</p></div>
<div class="imageblock" id="fig0301">
<div class="content">
<img src="images/rwcb_0301.png" alt="images/rwcb_0301.png" width="80%" />
</div>
<div class="title">Figure 2. Hypermedia design recipes</div>
</div>
<div class="paragraph"><p>It is important to remember that HTTP is the higher-level protocol agreement between machines on the network. Lower-level protocols, like <a href="https://oreil.ly/qypkt">TCP</a>, <a href="https://oreil.ly/LpNOn">IP</a>, and <a href="https://oreil.ly/ES6sA">UDP</a>, provide the backbone for moving bits around. One of the things I find most interesting about this low-level communications system is that it works <em>because</em> the communication components do not understand the meaning of the data they ship around. Meaning is separated from the message.</p></div>
<div class="paragraph"><p>The notion that information can be dealt with independent of the messages used to share that information is a key  understanding that makes M2M communication possible "at scale." Dealing with information within its own level is also important. HTTP offers a great example of this using media types. I can send you company sales data in an HTML message. I can send you the same information in a CSV message, or as a plain text message, and so forth. The <em>data</em> is independent of the media type.</p></div>
<div class="paragraph"><p>You&#8217;ll find this notion of separation throughout the recipes in this chapter. While protocol and media type are well-established forms of separation, the recipes in this chapter also rely on an additional form—that of separating <em>vocabulary</em> from the message format. Vocabulary is the set of rules we use to communicate something important. Communication works best when we both share the same vocabulary.</p></div>
<div class="paragraph pagebreak-before less_space"><p>For example, you can imagine two animated machines talking to each other:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>"Hey, Machine-1, let&#8217;s talk about health care systems using the <a href="https://oreil.ly/vQUQ6">HL7 FHIR Release 4 vocabulary</a>."</p></div>
<div class="paragraph"><p>"OK, Machine-2. But can we please use RDF to send messages instead of XML?"</p></div>
<div class="paragraph"><p>"Sure, Machine-1. As long as we can use HTTP and not MQTT."</p></div>
<div class="paragraph"><p>"Agreed!"</p></div>
</div>
<div class="attribution">
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Notably, the FHIR platform recognizes that FHIR information can be shared using XML, JSON, and RDF message formats—a clear nod to the importance of separating domain-specific information from the formats used to share that information.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Another important shared understanding for scalable systems is agreement on "how we get things done." In this case, the way things get done is through hypermedia. Hypermedia controls, such as links and forms, are used to express the runtime metadata needed to complete a task. The controls themselves are structured objects that both services and clients understand ahead of time. However, the contents of that control—the values of the metadata properties—are supplied at runtime. These include the data properties needed for a particular action, the protocol method to use to execute the action, and the target URL for that action. All are decided at runtime. The client doesn&#8217;t need to memorize them—it receives them in the message. Basically, the hypermedia controls are another level of separation. In fact, the <a href="https://json-ld.org">JSON-LD</a> message format relies on a separate vocabulary (<a href="https://oreil.ly/W32Sr">Hydra</a>) to express the hypermedia information within a JSON-LD message. You&#8217;ll find a few recipes here that acknowledge the importance of hypermedia for RWAs. You&#8217;ll also find several specific hypermedia recipes in the following chapters covering specific implementation patterns.</p></div>
<div class="paragraph"><p>Finally, you&#8217;ll find some recipes that are specific to successful communication over HTTP. These recipes cover things like network promise (safety and idempotence) and the realities of supporting M2M communications over unreliable connections at long distances. Lucky for us, HTTP is well suited for resolving broken connections—it was designed and built when most HTTP conversations were conducted over relatively slow voice telephone lines. However, for HTTP to really work well, both clients and servers need to agree on the proper use of message metadata (e.g., HTTP headers), along with some added support for how to react when network-level errors occur.</p></div>
<div class="paragraph"><p>So, this design chapter focuses on recipes that acknowledge the power of separate layers of communication, the role of hypermedia in communicating <em>how things get done</em>, and some shared understanding on how to ensure reliable communications when errors occur.</p></div>
<div class="sect2 pagebreak-before less_space">
<h3 id="design-media-types">3.1. Creating Interoperability with Registered Media Types</h3>
<div class="paragraph"><p>A key to establishing a stable, reliable system is to ensure long-term interoperability between services. That means services created years in the past are able to successfully exchange messages with services created years in the future.</p></div>
<div class="sect3">
<h4 id="_problem">3.1.1. Problem</h4>
<div class="paragraph"><p>How do you design services that have a high degree of interoperability well into the future?</p></div>
</div>
<div class="sect3">
<h4 id="_solution">3.1.2. Solution</h4>
<div class="paragraph"><p>The best way to ensure a high level of long-term interoperability between services is to establish stable rules for exchanging information. On the web, the best way to do that is to select and document support for one or more open source media type formats for data exchange. For example, the HTML media type offers a strongly typed format that HTML browsers can "bind" to without needing to understand the <em>contents</em> of the HTML document. In fact, the contents of a document can change over time (adding paragraphs, moving text, links, forms, etc.), but the HTML browser does not need to be updated. Using HTML ensures future compatibility.</p></div>
<div class="paragraph"><p>A good source for long-term, stable media types is the <a href="https://oreil.ly/rMOws">Internet Assigned Numbers Authority (IANA)</a>. Viable candidate media types for long-term support of RWAs are unstructured media types like XML and JSON, as well as structured media types such as HTML, Collection+JSON, UBER, HAL, and SIREN. See <a href="#standards">[standards]</a> for a list of viable media types at the time of this book&#8217;s release.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#design-structured-types">[design-structured-types]</a> for more on the difference between structured and unstructured media types.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion">3.1.3. Discussion</h4>
<div class="paragraph"><p>When you create services, you should document which registered media types (RMTs) your service can support. It is recommended that your service support more than one RMT, and that you allow service consumers to both discover which RMTs your service supports and how they can indicate their preference when exchanging messages (see <a href="#clients-representors">[clients-representors]</a>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>When I release a service, I almost always add  HTML as one of the designated message formats.  It has been around for 30+ years, you can use any common browser as a client for the service (great for testing), and there are enough parsers and other HTML tooling to make it relatively easy for consumers of your service to be able to exchange data with you.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Additional recommendations for candidate media types are: 1) they should support hypermedia within the message (see <a href="#design-hypermedia">[design-hypermedia]</a>) and 2) they should support custom extensions (e.g., your ability to safely add new features to the format without breaking any existing applications). This last point will come in handy when you are stuck supporting a format that has fallen out of favor and you need to make some modifications to extend the life of your service.</p></div>
<div class="paragraph"><p>It is also possible to create your own media type format for your services. That can work if: 1) your universe of service API consumers is relatively limited (e.g., within your own company), 2) your universe of service API consumers is crazy large (e.g., Google, Facebook, Amazon, etc.), or 3) your services are the leader in a vertical (e.g., document management, financial services, health care, etc.). If your efforts do not fall into one of these categories, I recommend you <em>do not</em> author your own media type.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">So You Want to Create Your Own Media Type, Eh?</div>
<div class="paragraph"><p>If you decide to author your own custom media type, you should treat it as if it will become a popular, public format. That means documenting it and registering it <a href="https://oreil.ly/8u7a8">properly</a>. You also need to be ready to support any community that grows up around your media type format—including example apps and other tooling. Finally, you need to be committed to doing this work for a long time. Also, keep in mind that some people might build their own services using your format, and they will deserve the proper support well into the future.</p></div>
<div class="paragraph"><p>Over the years, I&#8217;ve authored close to a dozen original media types. Only a few have ever garnered much attention. But I still try to keep up my responsibilities to all of them.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also">3.1.4. See Also</h4>
<ul>
 <li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-structured-types">[design-structured-types]</a></li>
 <li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-hypermedia">[design-hypermedia]</a></li>
 <li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-representors">[clients-representors]</a></li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-structured-types">3.2. Ensuring Future Compatibility with <span class=".keep-together">Structured Media Types</span></h3>
<div class="paragraph"><p>An important foundational element in the design of RWAs is supporting future compatibility. This means making it possible for services written in the past to continue to interact with services well into the future. It also means designing interactions so that it is unlikely that future changes to already-deployed services will <em>break</em> other existing services or clients.</p></div>
<div class="sect3">
<h4 id="_problem_2">3.2.1. Problem</h4>
<div class="paragraph"><p>How do you design M2M interactions that can support modifications to in-production services that do not break existing service consumers?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_2">3.2.2. Solution</h4>
<div class="paragraph"><p>To support nonbreaking changes to existing services, you should use <em>structured media types</em> (SMTs) to pass information back and forth. SMTs make it possible to emit a stable, nonbreaking message even when the <em>contents</em> of that message (e.g., the properties of a record, list of actions, etc.) have changed. The key is to design interactions with the message shared between machines maintaining the same structure even when the data conveyed by that message changes. See the example for details.</p></div>
<div class="paragraph"><p>A structured media type provides a strongly typed format that does not change based on the data being expressed. This is in opposition to unstructured message formats like XML and JSON. See the example for details.</p></div>
<div class="paragraph"><p>It is a good idea to use well-known media types in your interactions. Media types registered through the <a href="https://oreil.ly/7FTks">IANA</a> are good candidates. For example, HTML is a good example of an SMT. Other viable general-use SMT formats are Collection+JSON and  UBER. See <a href="#standards-media-types">[standards-media-types]</a> for a longer list of media types to consider.</p></div>
</div>
<div class="sect3">
<h4 id="_example">3.2.3. Example</h4>
<div class="paragraph"><p>An SMT provides a strongly typed format that does not change based on the data being expressed. Here&#8217;s an example of a simple message expressed as HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"Person"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Marti<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Contardi<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
 ...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"Person"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Marti<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Contardi<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"emailAddress"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>mcontardi@example.org<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>The <em>structure</em> of this message can be expressed (in an overly simplified way) as: "one or more <code>li</code> elements enclosed by a single <code>ul</code> element." Note that adding more content (for example, an email address) does not change the <em>structure</em> of the message (you could use the same message validator), just the <em>contents</em>.</p></div>
<div class="paragraph"><p>Contrast the preceding example with the following JSON objects:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"Person" : <span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">Marti</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Contardi</span>"
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span>
 ...
<span style="color: #990000">{</span>"Person" : <span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">Marti</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Contardi</span>"<span style="color: #990000">,</span>
  "emailAddress": "<span style="color: #FF0000">mcontardi@example.org</span>"<span style="color: #990000">,</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>The JSON structure can be expressed as: "a JSON object with two keys (<code>givenName</code> and <code>familyName</code>)." Adding an email address to the message would result in a change in the <em>structure</em>  of the JSON message (e.g., requires a new JSON schema document) as well as a change in <em>content</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_2">3.2.4. Discussion</h4>
<div class="paragraph"><p>The important element in this recipe is to keep the <em>content</em> of the message loosely coupled to the <em>structure</em>. That allows message consumer applications to more easily and consistently validate incoming messages (to "bind" to the message type)—even when the contents of those messages change over time.</p></div>
<div class="paragraph"><p>Another way to think about this solution is to assume that the first task of message consumer applications is to make sure the message is <em>well-formed</em>—that it complies with the basic rules of how a message must be constructed. It is, however, a different task to make sure the message is <em>valid</em>—that the message <em>content</em> follows established rules for what information needs to appear within the messages (e.g., "all <code>Person</code> messages MUST include a <code>givenName</code>, <code>familyName</code>, and <code>emailAddress</code> property").</p></div>
<div class="paragraph"><p>To ensure future compatibility, the first step is to make sure negotiation messages can remain well-formed even when the rules for what constitutes a valid message change over time. </p></div>
</div>
<div class="sect3">
<h4 id="_see_also_2">3.2.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-vocabularies">[design-vocabularies]</a></li>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-profiles">[design-profiles]</a></li>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-hypermedia" >[design-hypermedia]</a></li>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-representors">[clients-representors]</a></li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-vocabularies">3.3. Sharing Domain Specifics via Published Vocabularies</h3>
<div class="paragraph"><p></p></div>
<div class="paragraph"><p>Services with a well-managed vocabulary are more likely to be understood by others and therefore more likely to gain wider adoption. Just like you need to support registered, structured media types to ensure the long-term compatibility and reliability of your service, you also need to support stable, consistent domain specifics to ensure long-term viability for both service producers and consumers.</p></div>
<div class="sect3">
<h4 id="_problem_3">3.3.1. Problem</h4>
<div class="paragraph"><p>How can you make sure your service&#8217;s data property names will be understood by other services—even services that you did not create?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_3">3.3.2. Solution</h4>
<div class="paragraph"><p>To ensure that the data properties your service uses to exchange information are well understood by a wide range of other services (even ones you did not create), you should employ well-documented, widely known data property names as part of your external interface (API). These names should already be defined in published data vocabularies; if not, you should publish your data vocabulary so that others creating similar services can find and use the same terms.</p></div>
<div class="paragraph"><p>A good source of general-use published vocabularies for the web is <a href="https://schema.org" class="orm:hideurl"><em>Schema.org</em></a>. It has hundreds of well-defined terms that apply to a wide set of use cases and it continues to grow in a well-governed way. There are other well-governed vocabulary sources like <a href="https://microformats.org/" class="orm:hideurl"><em>Microformats.org</em></a> and <a href="https://oreil.ly/aFW7i">Dublin Core</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>A word of caution. Some vocabularies, especially industry-specific ones, are not fully open source (e.g., you must pay for access and participation). I will also point out that some vocabulary initiatives, even some open source ones, aim for more than a simple shared vocabulary. They include architectural, platform, and even SDK recommendations and/or constraints.</p></div>
<div class="paragraph"><p>Your best bet for creating long-term support for interoperability is to make sure any vocabulary terms you use are disconnected from any other software or hardware dependencies.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>As of this writing there are some industry-specific public vocabularies to consider, too. Some examples are: <a href="https://oreil.ly/1BXOi">PSD2</a> for payments, <a href="https://oreil.ly/AMxkP">FHIR</a> for health care, and <a href="https://oreil.ly/lfSCE">ACORD</a> for insurance.</p></div>
<div class="paragraph"><p>When you release your service, you should also release a document that lists all the vocabulary terms consumed or emitted by your service along with links to proper definitions. See <a href="#design-profiles">[design-profiles]</a> for more on how to properly document and publish your vocabulary documents.</p></div>
</div>
<div class="sect3">
<h4 id="_example_2">3.3.3. Example</h4>
<div class="paragraph"><p>When you have the option, you should use well-known terms in your service&#8217;s external API even when your own internal data storage system uses local or company-specific terms.</p></div>
<div class="paragraph"><p>For example, here&#8217;s a <code>person</code> record that reflects the terms used within a typical US company:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" : <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://api.example.org/persons</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href": "<span style="color: #FF0000">http://api.example.org/persons/q1w2e3r4</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">fname</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Dana</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">lname</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">ph</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123-456-7890</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And here&#8217;s the same record that has been updated to reflect terms available in the Schema.org vocabulary:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" : <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://api.example.org/persons</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://profiles.example.org/persons</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href": "<span style="color: #FF0000">http://api.example.org/persons/q1w2e3r4</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Dana</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">telephone</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123-456-7890</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note the use of the <code>profile</code> link relation in the second example. See <a href="#design-profiles">[design-profiles]</a> for details.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_3">3.3.4. Discussion</h4>
<div class="paragraph"><p>This recipe is based on the idea of making sure the data property terms are not tightly coupled to the message format. It is, essentially, the flip side of <a href="#design-structured-types">[design-structured-types]</a>. Committing to well-known, loosely coupled vocabularies is also an excellent way to protect your service from changes to any internal data models over time.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#data">[data]</a> for more recipes on handling data for RWAs.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Constraining your external interfaces to use only well-known, well-documented property names is one of the best things you can do to ensure the interoperability of your service. This, along with publishing semantic profiles (see <a href="#design-profiles">[design-profiles]</a>), make up the backbone of large-scale information system management. However, this work is not at all easy. It requires attention to detail, careful documentation, and persistent support. The team that manages and enforces a community&#8217;s vocabulary is doing important and valuable work.</p></div>
<div class="paragraph"><p>One of the challenges of this recipe is that the <em>public</em> vocabulary for your services is quite likely not the same as the <em>private</em> vocabulary. That private set of names is usually tied to age-old internal practices, possibly a single team&#8217;s design aesthetics, or even decisions dictated by commercial off-the-shelf (COTS) software purchased a long time ago. To solve this problem, services need to implement what is called an <a href="https://oreil.ly/pQkt2">"anti-corruption layer"</a>. There is no need to modify the existing data storage model or services.</p></div>
<div class="paragraph"><p>It is important to document and share your service vocabulary. A good practice is to publish a list of all the "magic strings" (see <a href="#intro-magic-strings">[intro-magic-strings]</a>) in a single place along with a short description and, whenever possible, a reference (in the form of a URL) to the source of the description.  I use the Application-Level Profile Semantics (ALPS) format for this (see <a href="#design-profiles">[design-profiles]</a>).</p></div>
<div class="paragraph pagebreak-before less_space"><p>Here is an example ALPS vocabulary document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "alps" : <span style="color: #990000">{</span>
   "descriptor": <span style="color: #990000">[</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/givenName</span>"<span style="color: #990000">,</span>
      "title": "<span style="color: #FF0000">Given name. In the U.S., the first name of a Person.</span>"<span style="color: #990000">,</span>
      "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/givenName</span>"
      "title": "<span style="color: #FF0000">Family name. In the U.S., the last name of a Person.</span>"<span style="color: #990000">,</span>
      "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">telephone</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/telephone</span>"<span style="color: #990000">,</span>
      "title": "<span style="color: #FF0000">The telephone number.</span>"<span style="color: #990000">,</span>
      "tag": "<span style="color: #FF0000">ontology</span>"
     <span style="color: #990000">},</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">country</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">http://microformats.org/wiki/hcard#country-name</span>"<span style="color: #990000">,</span>
      "title": "<span style="color: #FF0000">Name of the country associated with this person.</span>"<span style="color: #990000">,</span>
      "tag": "<span style="color: #FF0000">ontology</span>"
     <span style="color: #990000">}</span>
   <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When creating RWA vocabularies, it is a good practice to identify a single preferred source for term definitions, along with one or more "backup" sources. For example, your vocabulary governance document guidance could read like the following:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>"Whenever possible, use terms from Schema.org first. If no acceptable terms can be found, look next to Microformats.org and then to Dublin Core for possible terms. Finally, if you cannot find acceptable terms in any of those locations, create a new term in the company-wide vocabulary repository at [some-url]."</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Some additional notes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Mixing terms
</dt>
<dd>
<p>
It is perfectly acceptable to mix vocabulary references in a single set of terms. You can see in the preceding example that I included three terms from Schema.org and one term from Microformats.org.
</p>
</dd>
<dt class="hdlist1">
Limiting synonyms
</dt>
<dd>
<p>
Just as in real life, there can be multiple terms that mean the same thing, for example, "tel" (from Microformats.org) and "telephone" (from Schema.org). Whenever possible, limit the use of synonyms by adopting a single term for all external uses.
</p>
</dd>
<dt class="hdlist1">
Publishing vocabularies
</dt>
<dd>
<p>
See <a href="#design-profiles">[design-profiles]</a> on how to publish this document and retrieve it on the web.
</p>
</dd>
</dl></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_see_also_3">3.3.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-structured-types">[design-structured-types]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-profiles">[design-profiles]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-profiles">[clients-profiles]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-profile-negotiation">[clients-profile-negotiation]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-profiles">3.4. Describing Problem Spaces with Semantic Profiles</h3>
<div class="paragraph"><p>Along with decoupling your well-defined data property vocabulary from your message structures, it is important to also put effort into defining how the data properties get passed back and forth. This is the work of "describing the problem space." Problem spaces are used in games and interactive artwork as a way to place "guide rails" on a set of related activities. Problem spaces are the "rules of the game," so to speak. RWAs rely on the "rules of the game" as well.</p></div>
<div class="sect3">
<h4 id="_the_problem">3.4.1. The Problem</h4>
<div class="paragraph"><p>How can you provide a detailed description of all the possible data properties, objects, and actions supported by your services in a way that is usable both at design time and at runtime?</p></div>
</div>
<div class="sect3">
<h4 id="_the_solution">3.4.2. The Solution</h4>
<div class="paragraph"><p>To make sure developers can quickly and accurately understand the data exchanges and actions supported by your service, you can publish a semantic profile document (SPD). SPDs contain a complete list of all the data properties, objects, and actions a service supports. Semantic profiles, however, are <em>not</em> API definition documents like OpenAPI, WSDL, AsyncAPI, and others. See <a href="#standards-api-definitions">[standards-api-definitions]</a> in the appendix for a longer list of API definition formats.</p></div>
<div class="paragraph"><p>SPDs typically include all three elements of information architecture: ontology, taxonomy, and choreography.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See  <a href="#intro-vocabularies">[intro-vocabularies]</a> for a discussion of the three pillars of IA.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph pagebreak-before less_space"><p>Two common SPD formats are Dublin Core Application Profiles (DCAP) and Application-Level Profile Semantics (ALPS). Since I am a coauthor on ALPS, all the examples, I&#8217;ll show here use the ALPS format. See <a href="#standards-profiles">[standards-profiles]</a> in <a href="#standards">[standards]</a> for a longer list.</p></div>
</div>
<div class="sect3">
<h4 id="design-alps-person">3.4.3. Example</h4>
<div class="paragraph"><p>Here is an example of a valid ALPS semantic profile document. Notice that the three pillars of Morville&#8217;s information architecture (ontology, taxonomy, and choreography) are represented in this example (see <a href="#intro-vocabularies">[intro-vocabularies]</a> for details):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "$schema": "<span style="color: #FF0000">https://alps-io.github.io/schemas/alps.json</span>"<span style="color: #990000">,</span>
  "alps" : <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Person Semantic Profile Document</span>"<span style="color: #990000">,</span>
  "doc": <span style="color: #990000">{</span>"value":
    "Simple SPD example for http://webapicookbook.com[Web API Cookbook]."<span style="color: #990000">},</span>
  "descriptor": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">href</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/url</span>"<span style="color: #990000">,</span>
     "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">identifier</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/identifier</span>"<span style="color: #990000">,</span>
     "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/givenName</span>"<span style="color: #990000">,</span>
     "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/familyName</span>"<span style="color: #990000">,</span>
     "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">telephone</span>"<span style="color: #990000">,</span> "def": "<span style="color: #FF0000">https://schema.org/telephone</span>"<span style="color: #990000">,</span>
     "tag": "<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>

    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">Person</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
      "descriptor": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#href</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#identifier</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#givenName</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#familyName</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#telephone</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">Home</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
      "descriptor": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">},</span>

    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">List</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
      "descriptor": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#Person</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goFilter</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goItem</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doCreate</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">Item</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
      "descriptor": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#Person</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goFilter</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goItem</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doUpdate</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doRemove</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">goHome</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span> "rt": "<span style="color: #FF0000">#Home</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">goList</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span> "rt": "<span style="color: #FF0000">#List</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">goFilter</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span> "rt": "<span style="color: #FF0000">#List</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">goItem</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span> "rt": "<span style="color: #FF0000">#Item</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">doCreate</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">unsafe</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span> "rt": "<span style="color: #FF0000">#Item</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">doUpdate</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">idempotent</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span>
      "rt": "<span style="color: #FF0000">#Item</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">doRemove</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">idempotent</span>"<span style="color: #990000">,</span> "tag": "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span>
      "rt": "<span style="color: #FF0000">#Item</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p><a href="#design-alps-person-image">[design-alps-person-image]</a> shows a workflow diagram (the <em>choreography</em>) for the <em>person-alps.json</em> file. You can find the complete ALPS rendering (ALPS file, diagram, and documentation) of this semantic profile at the <a href="http://webapicookbook.com">book&#8217;s website</a>.</p></div>
<div class="imageblock" id="design-alps-person-image">
<div class="content">
<img src="images/rwcb_0302.png" alt="images/rwcb_0302.png" />
</div>
<div class="title">Figure 3. Person workflow (in ALPS format)</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_4">3.4.4. Discussion</h4>
<div class="paragraph"><p>Adopting SPDs is an important part of creating usable RWAs. However, this approach is relatively new and is not yet widely used. Even though ALPS and DCAP have been around for about 10 years, there aren&#8217;t a lot of tools and only limited written guidance on semantic profiles. Still, my own experience with ALPS leads me to think you&#8217;ll be seeing more on semantic profiles (even if it is in some future form other than ALPS and DCAP).</p></div>
<div class="paragraph"><p>An SPD is a kind of machine-readable interface documentation. SPDs are designed to communicate general elements of the interface (base-level properties, aggregate objects, and actions). SPDs do not contain implementation-level details, such as MQTT topics, HTTP resources, protocol methods, return codes, etc. These details are left to those tasked with writing the actual code that runs <em>behind</em> the interface described by semantic profiles.</p></div>
<div class="paragraph"><p>Some other considerations when using semantic profiles:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Aim for wide (re)use.
</dt>
<dd>
<p>
The value of a single semantic profile increases with the number of services using that profile. That means you should create profiles that are easily used by others (see <a href="#principles">[principles]</a>). It&#8217;s a good practice to keep semantic profiles more general than specific. The more specific you make your profile, the smaller the audience for that profile.
</p>
</dd>
<dt class="hdlist1">
Don&#8217;t use semantic profiles as API definitions.
</dt>
<dd>
<p>
Semantic profiles are <em>descriptions</em>, not <em>definitions</em>. Many of the details you need to include in an interface definition do not belong in semantic profiles. For example, don&#8217;t include URLs or URL patterns in semantic profiles. Instead put them in the API definition file (e.g., OpenAPI, etc.).
</p>
</dd>
<dt class="hdlist1">
Use semantic profiles to describe your information architecture.
</dt>
<dd>
<p>
A good practice is to <em>tag</em> your semantic profile elements to indicate which ones are describing the ontology, which are taxonomy, and which are choreography (see <a href="#design-alps-person">[design-alps-person]</a>).
</p>
</dd>
<dt class="hdlist1">
Share semantic profiles in all responses.
</dt>
<dd>
<p>
It&#8217;s a good idea to return the URI of your semantic profile with each protocol response. See Chapters <a href="#clients">4</a> and <a href="#services">5</a> for details on how to do this.
</p>
</dd>
<dt class="hdlist1">
Limit changes to published semantic profiles.
</dt>
<dd>
<p>
Since clients and/or services may create a logical dependency on your published semantic profile, it is a good practice to <em>not</em> make any breaking changes to the SPD once it is released. If you need to make changes, it is better to create a new profile document at a new URI (e.g., <em>api.example.org/profiles/personV2</em>) and to leave the existing profile (the one without the changes) online, too.
</p>
</dd>
<dt class="hdlist1">
Make your semantic profiles accessible from a central location.
</dt>
<dd>
<p>
To make it easy for people (and machines) to find your semantic profiles, create a central online location where they can be easily found. This might be a set of actual profile documents or a page that has pointers (URLs) to other places where each profile document is kept. This second option is good for cases where you are not the profile author and you still want to have some control over which profiles are commonly used.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_see_also_4">3.4.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-media-types">[design-media-types]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-hypermedia" >[design-hypermedia]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-profiles">[clients-profiles]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-representors">[clients-representors]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-hypermedia">[clients-hypermedia]</a></il>
<ul>
</div>
</div>
<div class="sect2">
<h3 id="design-hypermedia">3.5. Expressing Actions at Runtime with Embedded Hypermedia</h3>
<div class="paragraph"><p>Using embedded hypermedia within responses in order to inform API consumer applications what actions are currently possible is a foundational element in RWAs. As mentioned in <a href="#intro-kay">[intro-kay]</a>, hypermedia controls make it possible to implement <em>super loose coupling</em>, and that means you can more easily modify services in the future, too.</p></div>
<div class="sect3">
<h4 id="_problem_4">3.5.1. Problem</h4>
<div class="paragraph"><p>How can you extend the lifetime of services by building systems that support safe, nonbreaking workflow changes as well as short-term modifiability of existing services by customizing data exchanges at runtime?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_4">3.5.2. Solution</h4>
<div class="paragraph"><p>The best way to support both short- and long-term modifiability for product services is to rely on inline hypermedia affordances to express the details of context-dependent data exchanges at runtime. That means you need to adopt message exchange formats that support embedded hypermedia (see Recipes <a href="#design-media-types">3.1</a> and <a href="#design-structured-types">3.2</a>).</p></div>
</div>
<div class="sect3">
<h4 id="_example_3">3.5.3. Example</h4>
<div class="paragraph"><p>HTML offers a great example of embedded hypermedia controls to express data exchanges at runtime. Here&#8217;s an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Create Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"profile"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/profiles/person"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;style&gt;</span></span>
      input <span style="color: #FF0000">{</span><span style="color: #0000FF">display:</span><span style="font-style: italic"><span style="color: #009900">block</span></span>;<span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/style&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Create Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"doCreate"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/person/"</span>
      <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">enctype</span><span style="color: #990000">=</span><span style="color: #FF0000">"application/x-www-form-urlencoded"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;fieldset&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;hidden</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"identifier"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"q1w2e3r4"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"telephone"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"telephone"</span> <span style="color: #009900">pattern</span><span style="color: #990000">=</span><span style="color: #FF0000">"[0-9]{10}"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"reset"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Cancel"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/fieldset&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>This form indicates one default input (<code>identifier</code>) and three additional inputs, two of which are required (<code>givenName</code>, <code>familyName</code>) and one which <em>must</em> pass the <code>pattern</code> validator (<code>telephone</code>).  The form also indicates three possible actions (<code>submit</code>, <code>reset</code>, and <code>cancel</code>) along with details on the URL, HTTP method, and body encoding metadata for the <code>submit</code> action. Even better, any HTML-compliant client (e.g., a web browser) can support all these actions without the need for any custom programming code.</p></div>
<div class="paragraph"><p>Here&#8217;s a simple example in Collection+JSON:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://api.example.org/person/</span>"<span style="color: #990000">,</span>

    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://api.xample.org/person/doCreate</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">reset</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://api.example.org/person/doCreate?reset</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">cancel</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://api.example.org./person</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "template" : <span style="color: #990000">{</span>
      "data" : <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">identifer</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value" : ""<span style="color: #990000">,</span> "required":<span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value" : ""<span style="color: #990000">,</span> "required":<span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">telephone</span>"<span style="color: #990000">,</span> "value" : ""<span style="color: #990000">,</span> "regex":"<span style="color: #FF0000">[0-9]{10}</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Again, a Collection+JSON-compliant client application would be able to enforce all the input rules described in the hypermedia response without the need for any added programming.</p></div>
<div class="paragraph"><p>In both cases, the <em>meaning</em> of the values of the input elements and metadata properties do not need to be understood by the API consumer—they just need to be enforced. So the number of inputs, the destination URL of the HTTP POST, and even some of the rules can all change over time, and the API consumer application can still reliably enforce the constraints. For example, the validation rule for the <code>telephone</code> value can change (e.g., it might be context dependent based on where the application is running).</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_5">3.5.4. Discussion</h4>
<div class="paragraph"><p>Adopting embedded hypermedia messages is probably the most important step toward creating RESTful web APIs. There are a number of acceptable structured media types (see <a href="#standards-media-types">[standards-media-types]</a>) to choose from, and supporting them with a parsing library is a one-type expense that pays off every time you use the library.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For an in-depth look at hypermedia client applications, see my book <em>RESTful Web Clients</em>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>While embedded hypermedia is valuable, using it does come at some cost. First, it is a <em>design-time</em> constraint. Both API consumers and producers need to agree to use it. This is "the price of entry" when creating RWAs. While this is not different than "you must use HTML, CSS, and JavaScript in responses to web browsers," I still find many architects and developers who chafe at the idea of using hypermedia-rich responses. When you decide to build RWAs, you may need to help some people past this hurdle. The material in <a href="#cp-thinking">[cp-thinking]</a> can be helpful for this.</p></div>
<div class="paragraph"><p>Selecting the "right" structured hypermedia media type can easily turn into a battle. There are multiple types to pick from, and some people fall into the trap of "you can only pick one." In truth, you can use features designed into HTTP (see <a href="#services-conneg">[services-conneg]</a>) to help support multiple response formats and select the best option at runtime. This is 30-year-old tech, so there are lots of examples and supporting code bits to help you handle this. You can even decide on a single format to start (usually HTML) and then add more types over time without breaking any existing applications.</p></div>
<div class="paragraph"><p>Expressing domain state using hypermedia types can also be a challenge at times. Developers need to be able to convert internal object and model rules into valid hypermedia controls (<code>forms</code>, <code>inputs</code>, <code>links</code>, etc.). It is a kind of translation skill that must be acquired.</p></div>
<div class="paragraph"><p>The work of emitting and consuming hypermedia formats at runtime is a common task, too. See <a href="#services-conneg">[services-conneg]</a> for details on how to use HTTP to help with that. Also, writing API consumers that can navigate hypermedia responses takes some skill. Many of the recipes in <a href="#clients">[clients]</a> are devoted to this work.</p></div>
<div class="paragraph"><p>Other things to consider when using embedded hypermedia formats:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Supporting context changes
</dt>
<dd>
<p>
You can modify the hypermedia details in a response based on the user context and/or server state. For example, a form might have five fields when an authenticated administrator logs in, but only have three input fields for anonymous users.
</p>
</dd>
<dt class="hdlist1">
Enabling service location changes
</dt>
<dd>
<p>
When you use hypermedia controls to describe potential actions, you can engage in Alan Kay&#8217;s "extreme late binding." Hypermedia clients are designed to look for identifiers in the message ("where is the <code>update-customer</code> control?"), and to understand and act upon the metadata found in that hypermedia control. All of this can happen at runtime, not design or build time. That means the metadata details of an action can be changed while the service is in production. For example, you can change the target URL of an action from a local endpoint within the current service to an external endpoint on another machine—all without breaking the client application.
</p>
</dd>
<dt class="hdlist1">
Adapting to workflow changes
</dt>
<dd>
<p>
Changes in multistep processes or workflows can also be enabled with hypermedia. Service responses can return one or more steps to complete and expect the client application to act on each one. There might be three steps in the initial release (create account, add associated company, and add a new contact). Later, these three steps might be consolidated into two (create account, add associated company and contact). As long the client service consumer is following along with the supplied hypermedia instructions (instead of hardwiring the steps into code), changes like this will not break the consumer application. See <a href="#workflow">[workflow]</a> for recipes on implementing hypermedia workflows.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_see_also_5">3.5.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-media-types">[design-media-types]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-structured-types">[design-structured-types]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-hypermedia">[clients-hypermedia]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-qualities">[clients-qualities]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#services-conneg">[services-conneg]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-idempotent">3.6. Designing Consistent Data Writes with <span class=".keep-together">Idempotent Actions</span></h3>
<div class="paragraph"><p>A particularly gnarly problem when working with external services in a machine-to-machine situation over HTTP is the "failed POST" challenge. Consider the case where a client application issues an HTTP POST to an account service to deduct 50 credits from an account and <em>never gets a reply</em> to that request. Did the request never arrive at the server? Did it arrive, get processed properly, and the client never received the <code>200 OK</code> response? The real question is: should the client issue the request again?</p></div>
<div class="paragraph"><p>There is a simple solution to the problem, and it requires using HTTP <code>PUT</code>, not <code>POST</code>.</p></div>
<div class="sect3">
<h4 id="_problem_5">3.6.1. Problem</h4>
<div class="paragraph"><p>How do you design write actions over HTTP that remove the possibility of "double-posting" the data? How can you know whether it is safe to resend a data-write for the HTTP request if the client app never gets an HTTP response the first time?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_5">3.6.2. Solution</h4>
<div class="paragraph"><p>All data-write actions should be sent using HTTP <code>PUT</code>, not HTTP <code>POST</code>.  HTTP <code>PUT</code> actions can be easily engineered to prevent "double-posting" <em>and</em> ensure it is safe to retry the action when the server response never reaches the client application.</p></div>
</div>
<div class="sect3">
<h4 id="_example_4">3.6.3. Example</h4>
<div class="paragraph"><p>Influenced by the database pattern of CRUD (create, read, update, delete), for many years the "create" action has been mapped to HTTP <code>POST</code> and the "update" action has been mapped to HTTP <code>PUT</code>. However, writing data to a server with HTTP <code>POST</code> is a challenge since the action is not consistently repeatable. To say it another way, the POST option is not <em>idempotent</em>. That is, POST does not return the same result when repeated for the same resource.  However, by design, the HTTP <code>PUT</code> operation <em>is</em> idempotent—it assures the same results even when you repeat the action multiple times.</p></div>
<div class="paragraph"><p>To avoid the possibility of inadvertently creating two resources when only one was needed, the best solution is to always use HTTP <code>PUT</code> to write data to another machine on the network:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
PUT /person/q1w2e3 HTTP/2.0
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
If-None-Match: *

givenName=Mace&amp;familyName=Morris

**** RESPONSE
HTTP/2.0 201 CREATED
Content-Type: application/vnd.collection+json
ETag: "p0o9i8u7y6t5r4e3w2q1"
...</code></pre>
</div></div>
<div class="paragraph"><p>Note that, while not common, it is proper for HTTP to have a <code>PUT</code> request result in a <code>201 CREATED</code> response—if there is no resource at that address. But how do you tell the service that you are expecting to create a new resource instead of update an existing one? For that, you need to use <code>If-None-Match</code>. In the preceding example, the <code>If-None-Match: *</code> header says "create a new resource at the supplied URL if there is no existing resource at this URL."</p></div>
<div class="paragraph"><p>If I wanted the service to treat the HTTP <code>PUT</code> as a replacement of an existing resource, I would use the following HTTP interaction:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
PUT /person/q1w2e3 HTTP/2.0
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
If-Match: "p0o9i8u7y6t5r4e3w2q1"

givenName=Mace&amp;familyName=Morris

**** RESPONSE
HTTP/2.0 200 OK
Content-Type: application/vnd.collection+json
ETag: "o9i8u7y6t5r4e3w2q1p0"
...</code></pre>
</div></div>
<div class="paragraph"><p>Here, the HTTP request is marked with the <code>If-Match:</code> header that contains the entity tag (or ETag) that identifies the exact version of the resource at <code>/person/q1w2e3</code> you wish to update. If the ETag at that URL doesn&#8217;t match the one in the request (e.g., if the resource doesn&#8217;t exist or has been updated by someone else lately), then the HTTP <code>PUT</code> will be rejected with an <code>HTTP 412 Precondition Failed</code> response instead.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_6">3.6.4. Discussion</h4>
<div class="paragraph"><p>This use of the PUT-Create pattern is a way to simplify the challenge of knowing when it is OK to retry an unsuccessful write operation over HTTP. It works because by design, <code>PUT</code> can be retried without creating unwanted side effects. <code>POST</code>—by design—doesn&#8217;t make that promise. There have been a handful of attempts to make POST retry-able. Two examples are Bill de hÓra&#8217;s <a href="https://oreil.ly/KJh9v">HTTPLR</a> and Mark Nottingham&#8217;s <a href="https://oreil.ly/1wFmz">POE</a>. Neither gained wide adoption.</p></div>
<div class="paragraph"><p>Using HTTP <code>PUT</code> to create new resources takes a bit more work up front—both for clients and servers—primarily because it depends on proper use of the HTTP headers <code>If-None-Match</code>, <code>If-Match</code>, and <code>ETag</code>. In my experience, it is best to "bake" this recipe into code for both the server and the client applications. I typically have "cover methods" in my local code called <code>createResource(&#8230;)</code> and <code>updateResource(&#8230;)</code> (or something similar) that know how to craft a proper HTTP <code>PUT</code> request (including the right headers) and how to respond when things don&#8217;t go as planned. The convenience of these cover methods lowers the perceived added cost of using PUT-Create and ensures it is implemented consistently across client and server.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See related recipes on creating and updating resources in Chapters <a href="#clients">4</a> and <a href="#services">5</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Another recipe that is wrapped up in this one is the ability for client applications to supply resource identifiers. When using POST, the service is usually expected to create a new resource identifier—typically a monotonic ID like <code>/person/1</code>, <code>/person/2</code>, and so forth. When using PUT, clients are expected to supply the resource identifier (think "Please upload the file <em>my-todo-list.doc</em> to my document storage"). See Chapters <a href="#clients">4</a> and <a href="#services">5</a> for more on that.</p></div>
<div class="paragraph"><p>Designing in this support for idempotent writes with the PUT-Create pattern means both your client and server applications will be more reliable and consistent—even if the network connections you are using are not.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_6">3.6.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-repeat">[design-repeat]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href=clients.html"#clients-http">[clients-http]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#services-idempotent-create">[services-idempotent-create]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-idempotent">[data-idempotent]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-state-transfer">3.7. Enabling Interoperability with Inter-Service <span class=".keep-together">State Transfers</span></h3>
<div class="paragraph"><p>An important part of creating a collection of interoperable services on the web is making sure each service can act independently and be enlisted in a larger goal or solution. We need to make sure our service APIs do not assume that the only valid use case is when clients are "captives" of that service. Services need to be seen as "part" of a whole, not just a "whole."</p></div>
<div class="sect3">
<h4 id="_problem_6">3.7.1. Problem</h4>
<div class="paragraph"><p>How can we make sure our service interfaces work even when that service is enlisted as one part of a larger solution? A solution that has been designed by someone else (the API consumer application) and that integrates with other APIs. What does it take to ensure our services can be easily integrated with other services that I haven&#8217;t seen before and don&#8217;t control, while still maintaining system safety and data integrity?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_6">3.7.2. Solution</h4>
<div class="paragraph"><p>Establishing the principle that your service should be able to interoperate with other, unknown, services can be a challenge. The easiest and safest way to do this is to implement the API as a set of standalone, stateless operations. These can accept inputs, perform an action, return results, and forget the whole experience.</p></div>
<div class="paragraph"><p>Computing values is a good example of a simple, stateless transfer between services. Consider a postal code validator service that might support passing in a body with a full address (and possibly some identity metadata) and returning an associated postal code. All the needed state data is transferred in the request/response pair.</p></div>
<div class="paragraph"><p>However, there will be times when you need to transfer a block of data into a service, allow that service to operate on that data for a while, and then export the results. In these cases, more explicit import/export operations may be a good solution.</p></div>
<div class="sect4 xxx">
<h5 id="_using_forms">3.7.2.1. Using FORMS</h5>
<div class="paragraph"><p>The simplest way to transfer state between services is by passing data properties using a form supplied by the service <em>receiving</em> the state information.  Fundamentally, this is how HTML and the other hypermedia formats work. However, some services may require additional metadata be transferred in order to process the incoming data, or may not support native hypermedia controls. In those cases, you need to design additional support in your interface to explicitly transfer state data.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_using_import_export_operations">3.7.2.2. Using import/export operations</h5>
<div class="paragraph"><p>The next easiest way to create a service that is easy for someone else to use is to support a step that allows transferring state from one service to another. Usually this means offering an operation that imports (<code>importState</code>) state from somewhere else, and an operation that exports (<code>exportState</code>) your service&#8217;s state to somewhere else.</p></div>
<div class="paragraph"><p>Instead of adding explicit import/export actions to your interface, you can also build that functionality into selected existing actions of the API. For example, you can arrange to accept inputs (via a FORM element) when creating a new user account.</p></div>
<div class="paragraph"><p>The preceding use cases are examples of transferring state "by value"—sending the exact state values from one service to the next using runtime FORMS descriptions. This is the easiest way to interoperate with other services you don&#8217;t control.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_shared_references">3.7.2.3. Shared references</h5>
<div class="paragraph"><p>You can also arrange to transfer state "by reference"—by sharing a URL that points to the collection of data you wish to transfer. This takes a bit more coordination between services since both of them need to know, ahead of time, about the idea of shared data via URLs, and the format in which the shared data is stored. See <a href="#workflow-state">[workflow-state]</a> for more details.</p></div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_example_5">3.7.3. Example</h4>
<div class="paragraph"><p>There are three ways you can enable state transfer between services:</p></div>
<div class="ulist"><ul>
<li>
<p>
Pass by value using inline existing FORMS
</p>
</li>
<li>
<p>
Pass by value using dedicated operations (e.g., <code>importState</code> and <code>exportState</code>)
</p>
</li>
<li>
<p>
Pass by reference (via a shared URL) using dedicated operations or a FORM
</p>
</li>
</ul></div>
<div class="sect4 xxx">
<h5 id="_pass_by_value_using_existing_forms">3.7.3.1. Pass by value using existing FORMS</h5>
<div class="paragraph"><p>Transferring state data between services via hypermedia forms is the simplest and most direct way to solve the problem:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/shopping/cart"</span>
  <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"cartCreate"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"cartId"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"q1w2e3r4t5y6u7i8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"cartName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mike's Cart"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>This works well when the state data collection is small and the receiving service doesn&#8217;t require that an existing stateful session exist beforehand.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_pass_by_value_using_dedicated_operations">3.7.3.2. Pass by value using dedicated operations</h5>
<div class="paragraph"><p>You can also support state transfer by adding import and export operations to your service interface. For example, your service might offer a shopping cart management experience. Along with the usual steps (<code>create</code>, <code>addItem</code>, <code>removeItem</code>, and <code>checkout</code>), you could add a step that imports an existing shopping cart collection and one that exports that collection.</p></div>
<div class="paragraph"><p>Here is a snippet of ALPS that shows some of the actions of a simple shopping API that supports import and export operations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  $schema: "https://alps-io.github.io/schemas/alps.json"<span style="color: #990000">,</span>
  alps: <span style="color: #990000">{</span>
    version: "1.0"<span style="color: #990000">,</span>
    title: "Simple Shopping Cart"<span style="color: #990000">,</span>
    doc: <span style="color: #990000">{</span>value: "A simple shopping cart service"<span style="color: #990000">},</span>

    "descriptor" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "id" : "<span style="color: #FF0000">doCartImport</span>"<span style="color: #990000">,</span>
        "type" : "<span style="color: #FF0000">idempotent</span>"<span style="color: #990000">,</span>
        "rt" : "<span style="color: #FF0000">#cartCollection</span>"<span style="color: #990000">,</span>
        "tag" : "<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span>
        "descriptor" : <span style="color: #990000">[</span>
          "href" : "<span style="color: #FF0000">#cartCollection</span>"
        <span style="color: #990000">]</span>
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "id" : "<span style="color: #FF0000">doCartExport</span>"<span style="color: #990000">,</span>
        "type" : "<span style="color: #FF0000">idempotent</span>"<span style="color: #990000">,</span>
        "rt" : "<span style="color: #FF0000">cartCollection</span>"<span style="color: #990000">,</span>
        "tag" : "<span style="color: #FF0000">choreography</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This works well when the amount of state data to transfer is relatively large and/or complex (e.g., a collection of 15 items plus metadata). The upside is you get to transfer a lot of data in a single step. The downside is you need to coordinate this kind of state transfer ahead of time since both parties must agree on the data property names, contents, and the general shape of the collection to be transferred.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_pass_by_reference">3.7.3.3. Pass by reference</h5>
<div class="paragraph"><p>You can also arrange to pass state data between services by sharing a "pointer" to a state collection stored somewhere else that is reachable by both parties. The easiest way to do this is to share a URL that points to a resource that will respond with the media type and vocabulary format expected (or explicitly requested) by the calling party.</p></div>
<div class="paragraph"><p>The interaction would look like this (in HTML):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/users/q1w2e3r4"</span>
  <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">enctype</span><span style="color: #990000">=</span><span style="color: #FF0000">"multipart/form-data"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"file"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"userData"</span> <span style="color: #009900">accept</span><span style="color: #990000">=</span><span style="color: #FF0000">"application/vnd.collection+json"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>This example describes an "upload" operation that the target service can implement. Again, the key to success here is that both parties have already agreed to the expected data format and vocabulary contents ahead of time. You can document these transfer operations when you publish your API to let others know how your service interface expects to send information to or receive information from other services.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_7">3.7.4. Discussion</h4>
<div class="paragraph"><p>If at all possible, supply hypermedia forms in your API responses that handle state transfers in a single step. This will allow other services to act as API clients and execute the transfer directly. This requires no additional coordination between clients and servers.</p></div>
<div class="paragraph"><p>Also, keep the orchestration between services to a minimum. For example, it&#8217;s best to handle state transfers in a single step instead of requiring API consumers to first start a session or log in before doing other actions. If identity is needed, make that interaction the result of a redirection from the target state transfer:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
POST /shopping/cartCreate HTTP/1.1
Host: api.example.org
Content-Type: application/x-www-form-urlencoded

cartId=q1w2e3r4&amp;cartName=Mike's%20Cart

**** RESPONSE ****
HTTP/1.1 Unauthorized
WWW-Authenticate: Basic

**** REQUEST ****
POST /shopping/cartCreate HTTP/1.1
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
Authorization: Basic q1i8w2o9e3p0r4u7t5...

cartId=q1w2e3r4&amp;cartName=Mike's%20Cart

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Authorization: Basic: q1i8w2o9e3p0r4u7t5...
Link: &lt;http://docs.alps.io/shopping.json&gt;; rel="profile"

{
  "alps" : {
    ...
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>If you decide to support "pass by reference" state transfers, it is best to use structured media types like HAL, SIREN, Collection+JSON, etc. as the message format, and to supply vocabulary references (e.g., ALPS URIs) when passing the data. This will improve the chances that the uploaded data is only accepted when the receiving <span class=".keep-together">service</span> confirms the format and the vocabularies are "understood" by the receiving party.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Dealing with Cross-Origin Resource Sharing Limitations</div>
<div class="paragraph"><p>Beware that HTML browsers will not support cross-origin POSTing of messages or uploading of documents from "external" domains. This has to do with the <a href="https://oreil.ly/AKyDh">Cross-Origin Resource Sharing (CORS)</a> limitations implemented by HTML browsers. If you are implementing an API that will support a "by reference" state transfer (e.g., a file upload), you may also need to emit headers (e.g., <code>Access-Control-Allow-Origin</code>, etc.) to allow API consumers to successfully upload their documents.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_7">3.7.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-state">[clients-state]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-ignore">[data-ignore]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-state">[workflow-state]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-repeat">3.8. Designing for Repeatable Actions</h3>
<div class="paragraph"><p>On the web, there are lots of chances that a single request might not get through, might be invalid, or might just "disappear" with no response. This inherent unreliability of the network means we need to design in ways to survive and—whenever possible—overcome these problems in order to create service interfaces that are dependable over time. This recipe relies on the concept of <em>idempotence</em> to make HTTP requests repeatable when necessary.</p></div>
<div class="sect3">
<h4 id="_problem_7">3.8.1. Problem</h4>
<div class="paragraph"><p>Sometimes an HTTP request fails due to network problems or some other transient problem. What can we do to make sure our failed HTTP requests can be reliably repeated without causing additional problems? What is idempotence, how does it work, and how can we design in support for repeatability for our service interfaces?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_7">3.8.2. Solution</h4>
<div class="paragraph"><p>HTTP was initially designed to take into account the possibility that some requests might fail. Usually, these failures are transient network problems, and repeating the request will resolve the problem. Repeating <em>safe</em> HTTP requests—ones that are read-only—is not a hard problem. But repeating HTTP requests that modify resources can be much trickier. See <a href="#workflow-retry">[workflow-retry]</a> for some common solutions to this problem.</p></div>
<div class="sect4 xxx">
<h5 id="_network_idempotence">3.8.2.1. Network idempotence</h5>
<div class="paragraph"><p>There are two things you can do to improve the possibility of repeating HTTP requests. First, you can use HTTP&#8217;s <em>idempotent</em> methods (<code>GET</code>, <code>PUT</code>, and <code>DELETE</code>) in order to read, write, and remove resources. That means <em>not</em> relying on HTTP&#8217;s <code>POST</code> (since it was not built to support idempotent updates).  Whenever possible, I rely on <code>PUT</code> to create new resources (see <a href="#services-idempotent-create">[services-idempotent-create]</a>). It takes a bit more work to set up <code>PUT</code> for create, but it greatly improves the reliability of your service.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_operation_idempotence">3.8.2.2. Operation idempotence</h5>
<div class="paragraph"><p>The second thing you can do is design write operations themselves to support idempotences. This often means <em>not</em> using patterns like increments ("add one to each total") or computing percentages ("increase the sale price by 5%") and instead using replacement values and validators ("if the current price is 100, change it to 105").</p></div>
<div class="paragraph"><p>By relying on HTTP&#8217;s <code>PUT</code> to update a resource and by designing the body of updates to use replacement rather than increment, you can increase the repeatability of the write operations for your service interface.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_6">3.8.3. Example</h4>
<div class="paragraph"><p>Both network- and message-based repeatability are important. This section offers examples of each.</p></div>
<div class="sect4 xxx">
<h5 id="_network_repeatability">3.8.3.1. Network repeatability</h5>
<div class="paragraph"><p>Designing resource creation and update to use HTTP&#8217;s PUT method uses the idempotence of PUT to support repeatability at the network level:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /onboarding/q1w2e3r4
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
Content-Length: NN
...

id=q1w2e3r4&amp;givenName=Mork&amp;familyName=Morkelson&amp;...

**** RESPONSE ****
503 Service Unavailable
Content-Type: application/problem+json
Content-Length: XX
...
{
"type": "https://example.com/probs/unavailable",
"title": "Server Unavailable",
"detail": "Can't reach target server",
"instance": "/onboarding/q1w2e3r4",
"status": 503
}</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the PUT failed due to a problem with another server along the way. Since PUT is idempotent, it is safe to repeat this request again. In fact, you could repeat this request even if you never got an HTTP response at all (a rare, but possible outcome).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_message_repeatability">3.8.3.2. Message repeatability</h5>
<div class="paragraph"><p>Even when the network-level interaction is idempotent (e.g., you are using POST instead of PUT), you can improve repeatability of an HTTP request by making sure the body of the message supports functional idempotence.</p></div>
<div class="paragraph"><p>For example, when updating all the prices in your product catalog, you can provide a nonidempotent update, like this:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /catalog/priceUpdate
Host: api.example.org
Content-Type:application/x-www-form-urlencoded
Accept: application/vnd.siren+json
....

updatePercent=.05</code></pre>
</div></div>
<div class="paragraph"><p>In this example, when the PUT request is received, the value of <code>updatePercent</code> is used to update each of the 55 products in the company catalog.</p></div>
<div class="paragraph"><p>But what happens if the update fails halfway through the list of products? Some products were updated, some were not. Or what if we never get a response message for the request? Was is successfully applied? To all products? It is safe to rerun this action?</p></div>
<div class="paragraph"><p>We can greatly improve the repeatability of this example by redesigning it as idempotent at the message-level update:</p></div>
<div class="paragraph"><p>&lt;!-- [source] -&#8594;</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /catalog/priceUpdate
Host: api.example.org
Content-Type:text/csv
Accept: application/vnd.siren+json
....

productId, currentPrice,newPrice
q1w2e3, 100,105
t5y6u7, 200,210
i8o9p0, 250,265
i8y6r4, 50,55
...</code></pre>
</div></div>
<div class="paragraph"><p>Notice that this update message includes the <code>productId</code>, <code>currentPrice</code>, and <code>newPrice</code> properties. Now this action can safely be repeated. The service can check to see if the catalog price for a particular <code>productId</code> is set to <code>currentPrice</code> before applying the <code>newPrice</code> value. Otherwise, the operation can skip the price update for that record and move on to the next.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Another possible solution for this example is to simply include the <code>productId</code> and <code>newPrice</code> values. Running the process multiple times will still result in the proper pricing every time.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It&#8217;s important to not just rely on the HTTP method to ensure a message&#8217;s repeatability.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_8">3.8.4. Discussion</h4>
<div class="paragraph"><p>Designing repeatable updates often means doing more work up front to better explain the changes you want to apply to a resource (or collection of resources). This is definitely more work, but easily pays for itself the first time you have an unexpected crash in the middle of applying a large update.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">PUT or POST?</div>
<div class="paragraph"><p>Because repeatability is so important, most of the examples you&#8217;ll see in this book use <code>PUT</code> instead of <code>POST</code> for creating new resources and updating existing ones. It is possible to make <code>POST</code> idempotent by adding an idempotency key like the one proposed for the <a href="https://oreil.ly/7dnC3">IETF</a>. I still use <code>PUT</code> most of the time for my designs. See <a href="#design-idempotent">[design-idempotent]</a> for additional discussion on this topic.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_see_also_8">3.8.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-idempotent">[design-idempotent]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#services-idempotent-create">[services-idempotent-create]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-idempotent">[data-idempotent]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-compliant">[workflow-compliant]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-revert">3.9. Designing for Reversible Actions</h3>
<div class="paragraph"><p>There will be cases where, after applying a change to one or more resources, you will need to roll back or undo that change. This recipe shows how you can make support for reversibility part of your service interfaces.</p></div>
<div class="sect3">
<h4 id="_problem_8">3.9.1. Problem</h4>
<div class="paragraph"><p>What happens when you want to back out or roll back an update to one or more resources? How can you design your updates to make reversibility safe and easy to implement and use?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_8">3.9.2. Solution</h4>
<div class="paragraph"><p>When you need to roll back an update, there are two basic ways to solve the problem:</p></div>
<div class="ulist"><ul>
<li>
<p>
Support a local undo (see <a href="#workflow-undo">[workflow-undo]</a>)
</p>
</li>
<li>
<p>
Send another HTTP request that reverses the previous one
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first example (support a local undo) is covered in <a href="#workflow-undo">[workflow-undo]</a>, so I won&#8217;t get into those details here. Suffice it to say that the local undo works for cases where there are no other dependent actions (e.g., you have no other services that were modified as a consequence of the update you wish to reverse). If, however, your update has affected other records in the system or your update is just one of several that might be applied to the same resource, then supporting reversibility can be more complicated.</p></div>
<div class="sect4 xxx">
<h5 id="_issue_a_second_request">3.9.2.1. Issue a second request</h5>
<div class="paragraph"><p>For cases where only a single record has been affected (e.g., a data-centric resource updates a system of record), you can usually issue another HTTP request that has a rollback effect on the resource. For example, if you issued an HTTP <code>PUT</code> to replace the <code>givenName</code> property of a record, you can usually issue another HTTP <code>PUT</code> to replace the same property with the previous value. This assumes you <em>know</em> the previous value and safely make the change (e.g., no one else has already modified the record).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_issue_a_special_request">3.9.2.2. Issue a special request</h5>
<div class="paragraph"><p>There are cases where a simple re-<code>PUT</code> will not work. You might have issued an HTTP <code>DELETE</code> for a resource and want to recover that resource. There is no HTTP <code>UNDELETE</code> method. Instead you need to restore an existing record with a special command. The safest way is to create another, special operation (<code>undoDelete</code>) that uses HTTP <code>PUT</code> and some argument (usually the previous URL along with a validation value like the ETag header). This means the service interface needs to be designed to support this feature, including saving <code>DELETE</code>d resources in case they need to be restored!</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_7">3.9.3. Example</h4>
<div class="paragraph"><p>You can use the two PUTs approach or a special command to add reversibility support to your designs.</p></div>
<div class="sect4 xxx">
<h5 id="_rollback_with_two_puts">3.9.3.1. Rollback with two PUTs</h5>
<div class="paragraph"><p>Here&#8217;s an example where you can issue a second PUT to undo the first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
GET /users/q1w2e3r4
Host: api.example.org
Accept: application/html

**** RESPONSE ****
200 OK
Content-Type: application/html
ETag: "w/p0o9i8u7y6t5r4"
...

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"user"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Millie<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Murcheson<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Here&#8217;s the first update:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
PUT /users/q1w2e3r4
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
Accept: application/html
If-Match: "w/p0o9i8u7y6t5r4"

givenName=Molly&amp;familyName=Murcheson

**** RESPONSE ****
200 OK
Content-Type: application/html
If-Match: "w/q2w3e4r5t6y7u8"
...

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"user"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Molly<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Murcheson<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And, finally, we can roll back the change with another HTTP <code>PUT</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
PUT /users/q1w2e3r4
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
Accept: application/html
If-Match: "w/q2w3e4r5t6y7u8"

givenName=Millie&amp;familyName=Murcheson

**** RESPONSE ****
200 OK
Content-Type: application/html
ETag: "w/i9u8y7t6r5e4"
...

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"user"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Millie<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Murcheson<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note the use of the <code>ETag</code> to "version" the response and <code>If-Match</code> headers to make the PUT conditional.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_special_command_approach">3.9.3.2. Special command approach</h5>
<div class="paragraph"><p>In more involved cases, you&#8217;ll need to use a special rollback action on your service interface.</p></div>
<div class="paragraph"><p>Here is the action that removes an existing resource from the collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
DELETE /users/q1w2e3r4
Host: api.example.org
Accept: application/html
If-Match "w/y6t5r4e3w2q1"

**** RESPONSE ****
204 No Content
....</tt></pre></div></div>
<div class="paragraph"><p>And here is a special command for the interface that supports rolling back the <code>DELETE</code> action:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
PUT /users/rollback?id=q1w2e3r4
Host: api.example.org
Accept: application/html
If-Match "w/y6t5r4e3w2q1"

**** RESPONSE ****
201 Created
Location: /users/q1w2e3r4
....</tt></pre></div></div>
<div class="paragraph"><p>Note the use of <code>201 Created</code> to confirm the resource has been restored.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_9">3.9.4. Discussion</h4>
<div class="paragraph"><p>The advantage of issuing a special request is that client applications don&#8217;t need to recall details of the original resource in order to undo an update. The downside is that service interfaces need to take responsibility for keeping a history of resource changes.</p></div>
<div class="paragraph"><p>When all else fails, you may need to solve your reversibility problem the hard way: calling service support for help re-creating the previous conditions on the platform. See <a href="#workflow-help">[workflow-help]</a> for more on this approach.</p></div>
<div class="paragraph"><p>The URL to use for special rollback commands is nothing special. I&#8217;ve seen teams use the same URL space as the original target resource (<code>/users/q1w2e3r4</code>), and I&#8217;ve seen teams use a special rollback resource (<code>/rollbacks/users/q1w2e3r4</code>). I&#8217;ve also seen a mix of both (see the preceding example).</p></div>
<div class="paragraph"><p>For situations where more than one resource is modified by a single action (e.g., <code>removeCustomerData</code> affects the customer, orders, and sales data stores), you need to design a special rollback feature for your resource and, if possible, make sure all three dependent services support their own rollback or, if possible, implement your own version of a local undo (see <a href="#workflow-undo">[workflow-undo]</a>) for each of the other services. This can be a bit tricky, and you may need to get cooperation from the owners of the other services in order to support the rollback properly.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_9">3.9.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-compliant">[workflow-compliant]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-undo">[workflow-undo]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-help">[workflow-help]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-extend">3.10. Designing for Extensible Messages</h3>
<div class="paragraph"><p>Usually, once a service interface experiences wide use, ideas for improving that interface start to appear. One of the ways to improve the interface is to extend the message body of the HTTP response type. This recipe shows you how to easily design in a way to extend the message body in the future without breaking any existing API <span class=".keep-together">consumers</span>.</p></div>
<div class="sect3">
<h4 id="_problem_9">3.10.1. Problem</h4>
<div class="paragraph"><p>You are getting requests to modify the response body of an API call. Some want new properties added, others want a scalar property (e.g., <code>phoneNumber</code>) turned into an array (<code>phoneNumbers</code>). How can you make these kinds of extensions without breaking any API consumers already using the current release? What are the limits of extending messages?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_9">3.10.2. Solution</h4>
<div class="paragraph"><p>An effective approach to modifying response bodies that are already in production is to adopt the "Don&#8217;t Change It, Add It" rule (see <a href="#background-services-add">[background-services-add]</a>). That means you leave any existing elements in place and simply include new elements in the current response body. You can also design your response formats to support a simple name-value-pair collection where you can place additional new properties (of any type, including arrays). See the following examples for details.</p></div>
</div>
<div class="sect3">
<h4 id="_example_8">3.10.3. Example</h4>
<div class="paragraph"><p>Consider a simple HTTP response like this message body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
  "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>There are a number of possible ways to extend this object to improve its ability to accommodate requested changes in the future.</p></div>
<div class="sect4 xxx">
<h5 id="_add_a_properties_collection">3.10.3.1. Add a properties collection</h5>
<div class="paragraph"><p>You can add new properties to the object by including a name-value pair (NVP) collection as part of the initial design:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
  "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
  "nvp" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now you can add any other kind of property (scalar, array, object) without disrupting the existing structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
  "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
  "nvp" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"hatsize" : "<span style="color: #FF0000">3</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"phoneNumbers": <span style="color: #990000">[</span>"123-456-7890"<span style="color: #990000">,</span>"980-657-3421"<span style="color: #990000">]},</span>
    <span style="color: #990000">{</span>"address": <span style="color: #990000">{</span>"street":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"city":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"state":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"zip":"<span style="color: #FF0000">...</span>"<span style="color: #990000">}}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
</div>
<div class="sect4 xxx">
<h5 id="_add_parallel_properties">3.10.3.2. Add parallel properties</h5>
<div class="paragraph"><p>There are times when you need to modify or extend an existing property into multiple related properties. For example, you might need to improve the <code>name</code> property and extend it to use <code>givenName</code> and <code>familyName</code>. Instead of <em>replacing</em> the <code>name</code> property, you can just <em>add</em> the two new properties:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">Merk</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Muffly</span>"<span style="color: #990000">,</span>
  "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
  "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
  "nvp" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"hatsize" : "<span style="color: #FF0000">3</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"phoneNumbers": <span style="color: #990000">[</span>"123-456-7890"<span style="color: #990000">,</span>"980-657-3421"<span style="color: #990000">]},</span>
    <span style="color: #990000">{</span>"address": <span style="color: #990000">{</span>"street":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"city":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"state":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"zip":"<span style="color: #FF0000">...</span>"<span style="color: #990000">}}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, when returning the message in HTTP response, both formats are supported. API consumers that understand the <code>name</code> property will still find it, and API consumers that understand the new properties (<code>givenName</code> and <code>familyName</code>) will find what they expect.</p></div>
<div class="paragraph"><p>It is important to point out that the rules of message bodies <em>sent</em> to the service (via PUT or POST) will need to be modified, too. In this case, the service can be modified to accept all three values (<code>name</code>, <code>givenName</code>, and <code>familyName</code>). When the API client sends just <code>name</code>, the service can spit up the passed value and store the results in <code>givenName</code> and <code>familyName</code>. Conversely, when the API client sends <code>givenName</code> and <code>familyName</code>, the service can combine those two values and store the results in <code>name</code>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_host_multiple_output_formats">3.10.3.3. Host multiple output formats</h5>
<div class="paragraph"><p>In some cases, the changes to the response message are extensive enough that just modifying a few properties is not enough. Instead, you can return multiple versions of the same information in a single response. To do this, you need to design your initial message to allow for "hosting" multiple output formats. You can do this by using an additional "root" element in all your response designs.</p></div>
<div class="paragraph"><p>Here&#8217;s how our current example object looks with an additional "root" to host output formats:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"message" : <span style="color: #990000">{</span>
  "person" : <span style="color: #990000">{</span>
    "givenName": "<span style="color: #FF0000">Merk</span>"<span style="color: #990000">,</span>
    "familyName": "<span style="color: #FF0000">Muffly</span>"<span style="color: #990000">,</span>
    "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
    "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
    "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
    "nvp" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"hatsize" : "<span style="color: #FF0000">3</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"phoneNumbers": <span style="color: #990000">[</span>"123-456-7890"<span style="color: #990000">,</span>"980-657-3421"<span style="color: #990000">]},</span>
      <span style="color: #990000">{</span>"address": <span style="color: #990000">{</span>"street":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"city":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"state":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"zip":"<span style="color: #FF0000">...</span>"<span style="color: #990000">}}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Now that the important properties are enclosed in the <code>person</code> element, we can easily return new releases of the <code>person</code> or even other new message elements:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"message" : <span style="color: #990000">{</span>
  "personv2": <span style="color: #990000">{</span>...<span style="color: #990000">},</span>
  "metadata": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "person" : <span style="color: #990000">{</span>
    "givenName": "<span style="color: #FF0000">Merk</span>"<span style="color: #990000">,</span>
    "familyName": "<span style="color: #FF0000">Muffly</span>"<span style="color: #990000">,</span>
    "name": "<span style="color: #FF0000">Merk Muffly</span>"<span style="color: #990000">,</span>
    "region"<span style="color: #990000">,</span> "southwest"<span style="color: #990000">,</span>
    "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
    "nvp" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"hatsize" : "<span style="color: #FF0000">3</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"phoneNumbers": <span style="color: #990000">[</span>"123-456-7890"<span style="color: #990000">,</span>"980-657-3421"<span style="color: #990000">]},</span>
      <span style="color: #990000">{</span>"address": <span style="color: #990000">{</span>"street":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"city":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"state":"<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span>"zip":"<span style="color: #FF0000">...</span>"<span style="color: #990000">}}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>As long as the initial design includes the initial enclosing root element, adding new versions of message bodies or entirely new root elements does not disrupt existing API consumers.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_10">3.10.4. Discussion</h4>
<div class="paragraph"><p>These design rules are especially handy if you decided to <em>not</em> use an existing hypermedia format and are instead creating your own.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Most of the predefined message formats used in these recipes (HTML, HAL, SIREN, and Collection+JSON)  already follow these extensibility rules.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>A key challenge to the success of these extensibility patterns will be that API consumers may apply strict schema validators (JSON-Schema, XML-Schema, etc.) to incoming messages. You can remind consumers to <em>not</em> make this mistake, but you cannot completely prevent it.</p></div>
<div class="paragraph"><p>Usually, you can apply these same design patterns to existing message formats (e.g., HTML, HAL, etc.) without disrupting existing client applications.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_10">3.10.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-extend">[design-extend]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-schema">[clients-schema]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-outgoing">[clients-outgoing]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-modify-production">[data-modify-production]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-extend">[data-extend]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href=workflow.html"#workflow-compliant">[workflow-compliant]</a></il>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-modify">3.11. Designing for Modifiable Interfaces</h3>
<div class="paragraph"><p>Just as well-used APIs are likely to generate requests for message format changes, they are also likely to experience requests for modifications to the external interface itself, including URLs, HTTP methods, and input arguments. This recipe offers three rules for updating service interfaces without breaking existing API consumers.</p></div>
<div class="sect3">
<h4 id="_problem_10">3.11.1. Problem</h4>
<div class="paragraph"><p>How can I update the service interface (including changing URLs, HTTP methods, and input arguments) without breaking existing clients? What are the three rules for creating nonbreaking changes? What other principles should I keep in mind when attempting to update an existing service interface?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_10">3.11.2. Solution</h4>
<div class="paragraph"><p>Almost every API experiences interface changes. One of the advantages of working in the virtual world is that change is less costly than in the physical product world. But there are still challenges. However, you can make change a part of your design from the very beginning with some general guidelines and three solid rules.</p></div>
<div class="sect4 xxx">
<h5 id="_first_do_no_harm">3.11.2.1. First, do no harm</h5>
<div class="paragraph"><p>The phrase “First, do no harm” comes from the Hippocratic Oath. Dating back to the fourth century BCE, the Hippocratic Oath has been taken by many physicians as a pledge to give proper care to patients. This phrase is just one small part of the oath, but it&#8217;s the best-known part. API deserve the same pledge, too.</p></div>
<div class="paragraph"><p>Once your API is in production, it takes on a life of its own. When other applications are using your API, those applications become dependent on your API. You, as the author of the API, have a responsibility to all your API users. And one of the very first responsibilities is to "do no harm." If you make a change to a running API that breaks one of your API consumers, you are not following the Hippocratic Oath of APIs.</p></div>
</div>
<div class="sect4 pagebreak-before less_space xxx">
<h5 id="_a_fork_in_the_road">3.11.2.2. A fork in the road</h5>
<div class="paragraph"><p>Sometimes you’ll run into a situation where you must make a breaking change to a production API. For example, you might release an API that allows customers to update their personal information on your servers, and a year later the company decides that it will no longer allow customers to edit that data directly. When this happens, you need to release a new API with the proper functionality and instruct all users of the existing API to update their applications to point to the new interface. While that happens, you need some time when both APIs are available in production.</p></div>
<div class="paragraph"><p>This process is called "forking" the interface. You create a new API based on the existing one and run both in production until everyone has updated their client applications. Along the way, you can do a few things to make it easy to migrate from the old release to the new one.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_three_rules_for_modifying_your_service_interface">3.11.2.3. Three rules for modifying your service interface</h5>
<div class="paragraph"><p>When you decide to update your existing interface, you need to follow these rules:</p></div>
<div class="ulist"><ul>
<li>
<p>
Take nothing away
</p>
</li>
<li>
<p>
Don’t redefine things
</p>
</li>
<li>
<p>
Make additions optional
</p>
</li>
</ul></div>
<div class="paragraph"><p>Once you&#8217;ve published your API, all the URLs, associated properties (inputs and outputs), and even the HTTP methods in the documentation are <em>promises</em> that you can&#8217;t break. Using hypermedia formats that allow you to include input metadata (FORMS) at runtime can help reduce dependence on protocol details like HTTP methods and input arguments, but changing existing promises its the wrong way to go. Instead, you can <em>add</em> new features that provide the needed functionality.</p></div>
<div class="paragraph"><p>You also cannot redefine the existing elements of the interface. If you define the <code>?size</code> query parameter to mean the size of a page of data, you can&#8217;t later redefine <code>?size</code> to mean the size of a hat or shoe. Redefining elements is the same as replacing them, and that&#8217;s a breaking change.</p></div>
<div class="paragraph"><p>Finally, any new things can be <em>added</em> as optional elements to the interface as long as they don&#8217;t take anything else away or redefine an existing item. If you come up with more input arguments, you can add those to the FORM, but you cannot make them <em>required</em>. If you want to create a new action that has new required inputs, you can define a new API endpoint, method, and argument collection (a new FORM). But you cannot make calling that action required, either.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#design-extend">[design-extend]</a> for more details on modifying the service interface response body.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_9">3.11.3. Example</h4>
<div class="paragraph"><p>If you add a new argument to an input form, you need to make that argument optional, and you should supply a default value, too:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- existing search form --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"GET"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"findUsers"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span>, <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- updated search form --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"GET"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"findUsers"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"regions"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"all"</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"false"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that these nonbreaking changes work both ways. API consumers should be able to send either form to the server to get results. If the <code>region</code> argument is missing, the service should <em>assume</em> the default value (<code>"all"</code>) was sent.</p></div>
<div class="paragraph"><p>If you want to modify an action that has new required inputs, you can simply <em>add</em> the new action to the interface and allow API client applications to ignore that form until they are updated to handle it.</p></div>
<div class="paragraph"><p>Here&#8217;s a form that accepts an order for processing:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>"actions": [
  {
    "name": "processOrder",
    "title": "Process Order",
    "method": "PUT",
    "href": "/orders/processing/q1w2e3r4",
    "type": "application/x-www-form-urlencoded",
    "fields": [
      { "name": "orderNumber", "type": "hidden", "value": "42" },
      { "name": "productCode", "type": "text", "value": "..." },
      { "name": "quantity", "type": "number", "value": "..." }
    ]
  },
  {
    "name": "ProcessSalesRepOrder",
    "title": "Process Sales Rep Order",
    "method": "PUT",
    "href": "/orders/salesrep/p0o9i8u7",
    "type": "application/x-www-form-urlencoded",
    "fields": [
      { "name": "orderNumber", "type": "hidden", "value": "42" },
      { "name": "productCode", "type": "text", "value": "..." },
      { "name": "quantity", "type": "number", "value": "..." },
      { "name": "salesRep", "type": "text", "value": "..." }
    ]
  }
]</tt></pre></div></div>
<div class="paragraph"><p>Here, a feature has been added that allows sales representatives to get credit for new product sales. But they only get credit if the sales rep&#8217;s name is sent in with the order. That&#8217;s a required element of the new <code>processSalesRepOrder</code> action. A solid solution is to include both actions and allow client applications to use the one they understand.</p></div>
<div class="paragraph"><p>As long as you "do no harm," you can modify the existing service interface long after it has been published to production.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_11">3.11.4. Discussion</h4>
<div class="paragraph"><p>While documenting your API (and all its changes) is important, it is not enough. Especially in cases where you don&#8217;t know all the people using your API (see <a href="#principles">[principles]</a>), you can&#8217;t be sure that people will read your documentation or that, once they read it, they have the time or resources to update their API consumer apps.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Changes to the service interface vocabulary (see <a href="#design-vocabularies">[design-vocabularies]</a>) require the same attention to detail. Be sure to "do no harm" when updating your semantic profiles, too.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You might think you can safely change a few of the interface details of your API without causing API consumer problems, but that’s often not the case. This was pointed out by Google’s Hyrum Wright when he coined what would
later be known as Hyrum&#8217;s Law. He said, "With a sufficient number of users of an API, it does not matter what you promise in the contract: all observable behaviors of your system will be depended on by
somebody."</p></div>
<div class="paragraph"><p>Internally, one way you can confirm that your interface modifications do not introduce breaking changes is to be sure to apply the existing test suite to the <em>new</em> interface. By running all the old tests against the new API, you can come close to seeing how existing client applications will react to your interface changes.</p></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_see_also_11">3.11.5. See Also</h4>
<ul>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#design-extend">[design-extend]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-schema">[clients-schema]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#clients-outgoing">[clients-outgoing]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-modify-production">[data-modify-production]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#data-extend">[data-extend]</a></il>
<li><a data-type="xref" data-xrefstyle="rec-num-title" href="#workflow-compliant">[workflow-compliant]</a></il>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clients">4. RESTful Clients</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>The good news about computers is that they do what you tell them to do. The bad news is that they do what you tell them to do.</q></p>
<p data-type="attribution">Ted Nelson</p>
</blockquote>
<div class="paragraph"><p>Writing applications that use APIs to consume external services on the web requires a mix of specificity (<em>what</em> to do) and generality (<em>how</em> to do it) that can be challenging. The recipes in this chapter are focused on both <em>what</em> we tell client applications to do using local code and <em>how</em> we tell them via the protocol and messages we send back and forth. This combination of "what" and "how" makes up the foundation of stable, yet flexible, API consumer apps.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For more information on the art of creating API consumers, check out <a href="#background-clients">[background-clients]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>As a general rule, being very explicit about what clients can and cannot do will result in applications that are easy to break and hard to reuse. A better approach is to create API consumer apps that make only a few basic assertions about <em>how</em> they communicate (e.g., protocol, message model, and vocabulary) with servers and let the server supply all the other details (the <em>what</em>) at runtime. As shown in <a href="#fig0401">[fig0401]</a>, the recipes in this chapter focus on using hypermedia formats over HTTP protocol to support validation, state management, and the creation of goal-oriented client applications. This is what HTML browsers have done for 30+ years. We need to take a similar approach with our API consumers, too.</p></div>
<div class="paragraph"><p>That doesn&#8217;t mean we need to duplicate the HTML browser. That client application is focused on a high degree of usability that relies on humans to be the "brains" behind the interface (or in front of the interface, really). The HTML message format is designed to make it possible to control the visual rendering of messages as well as the animation of content using inline scripting. This focus on UI and humans is not needed for most web service API consumers.</p></div>
<div class="imageblock" id="fig0401">
<div class="content">
<img src="images/rwcb_0401.png" alt="images/rwcb_0401.png" width="80%" />
</div>
<div class="title">Figure 4. Hypermedia client recipes</div>
</div>
<div class="paragraph"><p>Instead, for web services, we need to focus on M2M interactions and how to make up for the "missing element"—the human. The recipes in this chapter have been selected because they lead to a high level of reusability without depending on humans to be involved in every step of the client-server interaction. To that end, there is an emphasis on four elements of resilient hypermedia-driven clients:</p></div>
<div class="ulist"><ul>
<li>
<p>
Taking advantage of protocols and formats
</p>
</li>
<li>
<p>
Relying on runtime metadata
</p>
</li>
<li>
<p>
Solving the M2M interface challenge
</p>
</li>
<li>
<p>
Using semantic profiles as shared understanding between client and server
</p>
</li>
</ul></div>
<div class="paragraph"><p>With that as a backdrop, let&#8217;s dig into our set of client-side recipes for RESTful web APIs.</p></div>
<div class="sect2">
<h3 id="clients-urls">4.1. Limiting the Use of Hardcoded URLs</h3>
<div class="paragraph"><p>Changing URLs on the server can cause annoying problems for client applications. Sometimes URL changes occur due to adding or removing features—it is a challenge to protect your client application from these kinds of problems. Sometimes the service URLs change due to "re-homing" or moving the service from one platform or implementation group to another. How can you limit the impact of server URL changes on your client application?</p></div>
<div class="sect3">
<h4 id="_problem_11">4.1.1. Problem</h4>
<div class="paragraph"><p>How can you reduce the chances of a client application failing when service URLs are changed?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_11">4.1.2. Solution</h4>
<div class="paragraph"><p>The best way to limit the impact of service URL changes in your client applications is to "abstract away" the actual URL values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Use named URL variables.
</dt>
<dd>
<p>
First, you should code your client so that any URL reference within the application is a named variable, not an actual URL. This is a similar pattern to how you can "localize" your client application for a single language (French, Arabic, Korean, etc.).
</p>
</dd>
<dt class="hdlist1">
Store URL values in configuration files.
</dt>
<dd>
<p>
Second, once you have a set of URL variable names, move the actual strings out of the source code and into a configuration file. This makes it possible to update the URLs without changing the source code or recompiling the application. Depending on your platform, you may still need to redeploy your client application after changing the configuration file.
</p>
</dd>
<dt class="hdlist1">
Reduce the number of URLs you need to "memorize" to one.
</dt>
<dd>
<p>
If at all possible, limit the total number of URLs your application needs to "know about" in the first place. If you&#8217;re accessing a service that supports hypermedia formats (Collection+JSON, SIREN, HAL, etc.), your client application will likely only need to "memorize" one URL—the starting or "home" URL (see <a href="#services-stable-url">[services-stable-url]</a>).
</p>
</dd>
<dt class="hdlist1">
Convince the service teams to use hypermedia or configuration files.
</dt>
<dd>
<p>
Lastly, if you have influence over the people who are writing the services you use (e.g., your enterprise colleagues), try to convince them to use hypermedia formats that supply URLs at runtime, or at least provide a downloadable configuration file where the service team can store all the named URL variables that your client will need at runtime.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_example_10">4.1.3. Example</h4>
<div class="paragraph"><p>To recap, the four ways you can reduce the impact of service URL changes are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use named URL variables in your code.
</p>
</li>
<li>
<p>
Move the URLs into client configuration files.
</p>
</li>
<li>
<p>
Limit the number of URLs your client needs to know ahead of time.
</p>
</li>
<li>
<p>
Get services to provide the URLs for you.
</p>
</li>
</ul></div>
<div class="sect4 xxx">
<h5 id="_using_named_url_variables">4.1.3.1. Using named URL variables</h5>
<div class="paragraph"><p>The following is an example of a code snippet showing the list of named URL variables stored in client code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// initializing named variables for service URLs</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> serviceURLs <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>home <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>list <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/list/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>filter <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/filter/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>read <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/list/{id}/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>update <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/list/{id}/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>remove <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/list/{id}/"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>approve <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/{id}/status"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>close <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/{id}/status"</span><span style="color: #990000">;</span>
serviceURLs<span style="color: #990000">.</span>pending <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.api.example.org/{id}/status"</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">/* later in your client code... */</span></span>

<span style="font-style: italic"><span style="color: #9A1900">// using named URL variables</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">const</span></span> http <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>

<span style="font-style: italic"><span style="color: #9A1900">// Send a request</span></span>
http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">,</span> serviceURLs<span style="color: #990000">.</span>list<span style="color: #990000">);</span>
http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>

<span style="font-style: italic"><span style="color: #9A1900">// handle responses</span></span>
http<span style="color: #990000">.</span>onload <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>http<span style="color: #990000">.</span>responseURL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> serviceURLs<span style="color: #990000">.</span>home<span style="color: #990000">:</span>
    <span style="color: #990000">...</span>
    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #990000">...</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>Note that some URL values are shared for different names variables. This is often the case when the important information is passed via an HTTP body and/or HTTP method (e.g., HTTP <code>PUT</code> versus HTTP <code>DELETE</code>).  You&#8217;ll also notice that some URLs contain a templated value (e.g., <code>http://api.example.org/list/{id}/</code>). This means that both client and server MUST share a similar standard for encoding templated URLs. I recommend using libraries that conform to the <a href="https://oreil.ly/ApkCn">IETF&#8217;s RFC 6570</a>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_loading_named_url_variables_from_configuration">4.1.3.2. Loading named URL variables from configuration</h5>
<div class="paragraph"><p>Once you have your code set up for only using named URL variables, it is a short step to moving all those URLs outside your codebase into a configuration file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span>
      src<span style="color: #990000">=</span><span style="color: #FF0000">"client.example.org/js/service-urls-config.js"</span><span style="color: #990000">&gt;&lt;/</span>script<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="color: #990000">&gt;</span>
      <span style="color: #990000">...</span>
      <span style="font-style: italic"><span style="color: #9A1900">// using named URL variables</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> http <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>

      <span style="font-style: italic"><span style="color: #9A1900">// Send a request</span></span>
      http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">,</span> serviceURLs<span style="color: #990000">.</span>list<span style="color: #990000">);</span>
      http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>

      <span style="font-style: italic"><span style="color: #9A1900">// handle responses</span></span>
      http<span style="color: #990000">.</span>onload <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>http<span style="color: #990000">.</span>responseURL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> serviceURLs<span style="color: #990000">.</span>home<span style="color: #990000">:</span>
          <span style="color: #990000">...</span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
          <span style="color: #990000">...</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
      <span style="color: #990000">...</span>
    <span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;/</span>head<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
   <span style="color: #990000">...</span>
  <span style="color: #990000">&lt;/</span>body<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>html<span style="color: #990000">&gt;</span>
</tt></pre></div></div>
<div class="paragraph"><p>The configuration file (which looks just like the code in the previous example) is stored at the same location as the client code (<em>http://client.example.org/js/</em>). However, it could be stored anywhere the client application can access, including a local file system that is supported by the client platform.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_limit_memorized_client_urls_to_one_with_hypermedia">4.1.3.3. Limit memorized client URLs to one with hypermedia</h5>
<div class="paragraph"><p>If your service is using hypermedia formats that automatically supply URLs at runtime, you can limit the number of URLs your client application needs to know ahead of time to possibly <em>one</em> URL: the starting or "home" URL. Then your client can "find" any other URLs based on inline information found in <code>id</code>, <code>name</code>, <code>rel</code>, and/or <code>tags</code> (see <a href="#services-stable-url">[services-stable-url]</a>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* find-rel.js */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> startingURL <span style="color: #990000">=</span> <span style="color: #FF0000">"http://service.example.org/"</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> thisURL <span style="color: #990000">=</span> <span style="color: #FF0000">""</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> link <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// using named URL variables</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">const</span></span> http <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>

<span style="font-style: italic"><span style="color: #9A1900">// Send a request</span></span>
http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">,</span> serviceURLs<span style="color: #990000">.</span>list<span style="color: #990000">);</span>
http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>

<span style="font-style: italic"><span style="color: #9A1900">// handle responses</span></span>
http<span style="color: #990000">.</span>onload <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>http<span style="color: #990000">.</span>responseURL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> startingURL<span style="color: #990000">:</span>
      link <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">findREL</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"list"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>link<span style="color: #990000">.</span>href<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
         thisURL <span style="color: #990000">=</span> link<span style="color: #990000">.</span>href<span style="color: #990000">;</span>
         <span style="color: #990000">...</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #990000">...</span>
    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #990000">...</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>Finally, if you can influence the service teams, try to convince them to either use hypermedia types so that client applications need to remember only their starting URL, or have the server team provide a remote configuration file that holds all the named variables that define the static URLs the client will need.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_12">4.1.4. Discussion</h4>
<div class="paragraph"><p>The best way to limit the client-side impact of service URL changes is to keep the URLs out of the client application code. The most effective way to do that is for services to use hypermedia formats that provide URLs at runtime, or for services to provide configuration information that contains a list of URLs as named variables. If you can&#8217;t get that from the service, then it is up to the client application programmers to come as close to that as possible. That means using a client-side configuration file or, if loading configuration data is not viable (e.g., security reasons), then create your own client-side named variable collection in code.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>It is important to acknowledge that relying on client-side configuration files is not an ideal solution. Changes in service URLs need to be communicated to the client developer so that the client-side information (config or code) can be updated. This presents a possible lag between service changes and client changes. You can set up client-side monitoring of changes, but that&#8217;s just adding more work and can only shorten the client application&#8217;s reaction time to unannounced changes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It was noted earlier that some URL variables may share the same URL data, but have very different uses. For example, the service URLs for read, update, and delete may be the same (<em>http://service.example.org/{id}</em>). This leads to the next step of client applications keeping the entire collection of request metadata in code, too (URL, method, headers, query string, and/or body information). See <a href="#clients-forms">[clients-forms]</a> for more on this option and when to use it.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_12">4.1.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-forms">[clients-forms]</a>
</p>
</li>
<li>
<p>
<a href="#services-stable-url">[services-stable-url]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-related">[workflow-related]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-http">4.2. Coding Clients to Be HTTP Aware</h3>
<div class="paragraph"><p>Sometimes helper libraries, wrappers, and/or API software developer kits (SDKs) can make it <em>harder</em> for API client applications to solve their problems instead of making it easier. For this reason it is important to make sure your API client applications are able to "converse" with services in HTTP (or whatever the target protocol might be).</p></div>
<div class="sect3">
<h4 id="_problem_12">4.2.1. Problem</h4>
<div class="paragraph"><p>In cases where services offer help classes or SDKs, there are times when the client cannot find the exact local function needed to solve a problem. How can you make sure that client applications can work around any limitations of any helper libraries or SDKs supplied by the service?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_12">4.2.2. Solution</h4>
<div class="paragraph"><p>The best way to create API client applications that are both effective and nimble is to make sure they are "protocol-aware"—that they can, when needed, speak directly to a service using the HTTP protocol (or whatever protocol the service is using). To do that, even when your client app takes advantage of SDKs and helper libraries, you should make sure your client app <em>also</em> knows how to "speak HTTP" directly. That will ensure your application can use the service in ways the original service authors had not thought about when creating the initial release.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Clients Teaching Services</div>
<div class="paragraph"><p>It is worth mentioning that service providers may learn a lot by monitoring the ways client applications access their APIs (including the order in which the accesses are made). In some cases, client applications will be teaching services the features and workflows they wish to have. With this information, services can release new editions that make those tasks safer and easier to complete.</p></div>
</div></div>
<div class="paragraph"><p>It is perfectly acceptable to mix the use of available service SDKs with direct HTTP calls when needed.  In fact, it is a good idea to create your own high-level HTTP library that can easily be invoked on demand.</p></div>
</div>
<div class="sect3">
<h4 id="_example_11">4.2.3. Example</h4>
<div class="paragraph"><p>While most modern languages supply HTTP libraries and functions, it is a good idea to create your own high-level HTTP support library. That means handling both the HTTP request and HTTP response details. Here&#8217;s a simple example of a client-side JavaScript helper library for HTTP calls:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ajax <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

  <span style="font-style: italic"><span style="color: #9A1900">// setup code here...</span></span>

  <span style="font-style: italic"><span style="color: #9A1900">/***********************************************************</span></span>
<span style="font-style: italic"><span style="color: #9A1900">    *** PUBLIC METHODS ***</span></span>
<span style="font-style: italic"><span style="color: #9A1900">    args = {url:string, headers:{}, queryString:{}, body:{},</span></span>
<span style="font-style: italic"><span style="color: #9A1900">      callback:function, context:string}</span></span>
<span style="font-style: italic"><span style="color: #9A1900">   ***********************************************************/</span></span>
  httpGet<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpGetXML<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpGetJSON<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpGetPlainText<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPost<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPostVars<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPostForXML<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPostForJSON<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPostForPlainText<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpPut<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpHead<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpDelete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpOptions<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  httpTrace<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// implementation details below ...</span></span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>This library can then be called using the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">getDocument</span></span><span style="color: #990000">(</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> args <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  args<span style="color: #990000">.</span>url <span style="color: #990000">=</span> url<span style="color: #990000">;</span>
  args<span style="color: #990000">.</span>callbackFunction <span style="color: #990000">=</span> ajaxComplete<span style="color: #990000">;</span>
  args<span style="color: #990000">.</span>context <span style="color: #990000">=</span> <span style="color: #FF0000">"processLinks"</span><span style="color: #990000">;</span>
  args<span style="color: #990000">.</span>headers <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">'accept'</span><span style="color: #990000">:</span><span style="color: #FF0000">'application/vnd.collection+json'</span><span style="color: #FF0000">}</span>

  ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">httpGet</span></span><span style="color: #990000">(</span>args<span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// later ...</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">ajaxComplete</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span>headers<span style="color: #990000">,</span>context<span style="color: #990000">,</span>status<span style="color: #990000">,</span>msg<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>status<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span> <span style="font-style: italic"><span style="color: #9A1900">// handle status</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span> <span style="font-style: italic"><span style="color: #9A1900">// dispatch to context</span></span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>This example is psuedocode from a client-side JavaScript implementation focused on browser-based applications. The exact details of your library are not important. What is important is that your client application can quickly and safely craft an HTTP request and handle the HTTP response. Notice that the library is designed to make HTTP calls easier to deal with and does not limit access to the protocol.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_13">4.2.4. Discussion</h4>
<div class="paragraph"><p>Not only is it important to offer API client apps direct access to the HTTP protocol, it is important to code the application so that the developer is always aware that HTTP calls are taking place. It might seem like a good idea to "hide the HTTP" under semantic methods like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> serviceClient <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  findUser <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>userId<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="font-weight: bold"><span style="color: #000000">assignUserWorkTickets</span></span><span style="color: #990000">(</span>userId<span style="color: #990000">,</span>ticketArray<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The second call in this example (<code>assignUserWorkTickets</code>) might be a minefield. How many HTTP calls are involved? Just one? Maybe one per item in the <code>ticketArray</code>? Are the ticket calls sequential, or are they run in parallel?  Developers should be able to "see" what they are getting into when they use an SDK or library. Even something as simple as changing the helper library calls from <code>assignUserWorkTickets</code> to <code>sendHttpRequests({ requestList:WorkTickets, parallel:true })</code> can help developers get a sense of the consequences of their actions.</p></div>
<div class="paragraph"><p>Also, an HTTP-aware API client doesn&#8217;t need to be complicated, either. Client-side browser applications can get quite a bit done with the <code>XMLHttpRequest</code> object without getting too deep into the weeds of HTTP. See <a href="#clients-urls">[clients-urls]</a> for an example.</p></div>
<div class="paragraph"><p>The downside of using this approach is that some services might want to protect themselves against inexperienced or possibly malicious client-side developers. They want to use SDKs to control the way client applications interact with the service. This never works to deter malicious actors and often just frustrates well-meaning developers trying to solve their own problems in ways the service provider had not imagined. I&#8217;ve seen many cases where client-side teams have abandoned an API because the required SDK was deemed unsuitable.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_13">4.2.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-urls">[clients-urls]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#services-stable-url">[services-stable-url]</a>
</p>
</li>
<li>
<p>
<a href="#services-conneg">[services-conneg]</a>
</p>
</li>
<li>
<p>
<a href="#data-response">[data-response]</a>
</p>
</li>
<li>
<p>
<a href="#data-caching">[data-caching]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-messages">4.3. Coding Resilient Clients with Message-Centric Implementations</h3>
<div class="paragraph"><p>To extend the life of the client application and improve its stability, it is a good idea to code client applications to "speak" in well-known media types.</p></div>
<div class="sect3">
<h4 id="_problem_13">4.3.1. Problem</h4>
<div class="paragraph"><p>How can you ensure your client application is more resilient to small changes and not coupled too tightly to a specific domain or running service?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_13">4.3.2. Solution</h4>
<div class="paragraph"><p>A great way to build resilient client applications is to code your client app to bind tightly to the message returned by the service, not to a particular service or domain problem. That way, if there are minor changes in the service, as long as the media type response stays the same, your client application is likely to continue to operate correctly.</p></div>
</div>
<div class="sect3">
<h4 id="_example_12">4.3.3. Example</h4>
<div class="paragraph"><p>You have lots of options when coding your API client. You can bind it directly to the service and its documented objects, or you can bind your client to the structured media types that the service emits.  In almost all cases, it is better to bind to media types than to service interface types.</p></div>
<div class="paragraph"><p>Here is an example of a ToDo domain application. This client is implemented by binding to all the actions described in the API documentation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* to-do-functions.js */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> thisPage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">makeRequest</span></span><span style="color: #990000">(</span>href<span style="color: #990000">,</span> context<span style="color: #990000">,</span> body<span style="color: #990000">)</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processResponse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">,</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">refreshList</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">searchList</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">addToList</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">completeItem</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showList</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">attachEvents</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
</tt></pre></div></div>
<div class="paragraph"><p>The details of what goes on within each function are not important here. What is key is that each action in the domain (<code>refresh</code>, <code>search</code>, <code>add</code>, etc.) is described <em>in the source code</em> of the client. When the service adds any new features (e.g., the ability to <code>setDueDate</code> for a task), this client application code will be out-of-date and will not be able to adapt to the new feature. And it would be more challenging if the details changed, such as arguments or other action metadata (e.g., change <code>POST</code> to <code>PUT</code>, modify the URLs, etc.).</p></div>
<div class="paragraph"><p>Now, look at the following client that is focused on a message-centric coding model. In this case, the code is not focused on the ToDo domain actions but on the messages (e.g., HTML, HAL, SIREN, etc.) the client sends and receives. In fact, this message-centric approach would be the same no matter the service domain or topic:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* to-do-messages.js */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> thisPage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">makeRequest</span></span><span style="color: #990000">(</span>href<span style="color: #990000">,</span> context<span style="color: #990000">,</span> body<span style="color: #990000">)</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processResponse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">,</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">displayResponse</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">renderControls</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">handleClicks</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
</tt></pre></div></div>
<div class="paragraph"><p>Again, details are missing but the point here is that the functionality of the client application is rooted in the work of making requests, processing the response message, displaying the results, the input controls, and then catching any click events. That&#8217;s it. The actual domain-specific actions (<code>refresh</code>, <code>search</code>, <code>add</code>, etc.) will be described <em>in the response message</em> via hypermedia control, not the code. That means when the service adds a new feature (like the <code>setDueDate</code> operation), this client will "see" the new actions described in the message and automatically render that action. There will be no need to write new code to support new operations.</p></div>
<div class="paragraph"><p>Binding to the message means that new actions and most modifications of existing actions are "free"—there is no need for additional coding.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_14">4.3.4. Discussion</h4>
<div class="paragraph"><p>Shifting your client code from domain specific to message centric is probably the more effective way to create resilient applications for the web. This is the approach of the HTML-based web browser, which has been around for close to 30 years without any significant interface changes. This is despite the fact that the internal coding for HTML browsers has been completely replaced more than once, there are multiple, competing editions of the browser from various vendors, and the features of HTML have changed over time, too.</p></div>
<div class="paragraph"><p>Much like the recipe to make your API clients "HTTP-aware" (see <a href="#clients-http">[clients-http]</a>), making them message centric adds an additional layer of resilience to your solution. As we&#8217;ll see later in this chapter (see <a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>), there are more layers to this "client resilience cake" to deal with, too. Each layer added creates a more robust and stable foundation upon which to build your specific solution.</p></div>
<div class="paragraph"><p>One of the downsides of this approach is that it depends on services to properly support strong typed message models for resource responses (see <a href="#clients-messages">[clients-messages]</a>). If the service you need to connect with only responds with unstructured media types like XML and JSON, it will be tough to take advantage of a message-centric coding model for your client applications.  If you have any influence over your service teams (e.g., you&#8217;re in a corporate IT department), it can really pay dividends if you can convince them to use highly structured media types like HTML, HAL, SIREN, Collection+JSON, and others. See <a href="#design">[design]</a> for several recipes focused on the value of media types as a guiding principle for web services.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_14">4.3.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-media-types">[design-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#clients-http">[clients-http]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-profiles">4.4. Coding Effective Clients to Understand <span class=".keep-together">Vocabulary Profiles</span></h3>
<div class="paragraph"><p>Just as it is important to code clients to be able to "speak" HTTP and bind to message formats, it is also important to code your client applications to be able to "converse" in the vocabulary of the service and/or domain. To do that, you need to code client applications to recognize and utilize domain vocabularies expressed as external profile documents.</p></div>
<div class="sect3">
<h4 id="_problem_14">4.4.1. Problem</h4>
<div class="paragraph"><p>How can you make sure that your client application will be able to "understand" the vocabulary (names of call properties and actions) of the services it will interact with, even when some of the services themselves might change over time?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_14">4.4.2. Solution</h4>
<div class="paragraph"><p>To make sure clients and servers are "talking the same language" at runtime, you should make sure both client and server are coded to understand the same vocabulary terms (e.g., data names and action names). You can accomplish this by relying on one of the well-known vocabulary formats, including:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://oreil.ly/GX41I">RDF, Resource Description Framework Schema</a>
</p>
</li>
<li>
<p>
<a href="https://oreil.ly/TSviq">OWL, Web Ontology Language</a>
</p>
</li>
<li>
<p>
<a href="https://oreil.ly/eR9Px">DCAP, Dublin Core Application Profiles</a>
</p>
</li>
<li>
<p>
<a href="https://oreil.ly/eTVa2">ALPS, Application-Level Profile Semantics</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Since I am a coauthor on the ALPS specification, you&#8217;ll see lots of examples of using ALPS as the vocabulary standards document. You may also be using a format not listed here—and that&#8217;s just fine. The important thing is that you and the services your client application interacts with agree on a vocabulary format as a way to describe the problem domain.</p></div>
</div>
<div class="sect3">
<h4 id="_example_13">4.4.3. Example</h4>
<div class="paragraph"><p>Expressing a service&#8217;s domain as a set of vocabulary terms allows both client and service to <em>share understanding</em> in a generic, stable manner. This was covered in <a href="#design-profiles">[design-profiles]</a>. Here&#8217;s a set of vocabulary terms for a simple domain:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Simple ToDo

## Purpose
We need to track 'ToDo' records in order to improve both timeliness
and accuracy of customer follow-up activity.

## Data
In this first pass at the application, we need to keep track of the
following data properties:

 * **id** : a globally unique value for each ToDo record
 * **body** : the text content of the ToDo record

## Actions
This edition of the application needs to support the following operations:

 * **Home** : starting location of the service
 * **List** : return a list of all active ToDo records in the system
 * **Add** : add a new ToDo record to the system
 * **Remove** : remove a completed ToDo record from the system</code></pre>
</div></div>
<div class="paragraph"><p>Next, after translating that story document into ALPS, it looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$schema":"<span style="color: #FF0000">https://alps-io.github.io/schemas/alps.json</span>"<span style="color: #990000">,</span>
  "alps" : <span style="color: #990000">{</span>
    "version":"<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "title":"<span style="color: #FF0000">ToDo List</span>"<span style="color: #990000">,</span>
    "doc" : <span style="color: #990000">{</span>"value":"<span style="color: #FF0000">ALPS ToDo Profile (see [ToDo Story](to-do-story.md))</span>"<span style="color: #990000">},</span>

    "descriptor":<span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">title</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">ontology</span>"<span style="color: #990000">},</span>

      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[{</span>"href":"<span style="color: #FF0000">#goList</span>"<span style="color: #990000">}]</span>
      <span style="color: #990000">},</span>

      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
        "descriptor":<span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#id</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#title</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#doAdd</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href":"<span style="color: #FF0000">#doRemove</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">},</span>

      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">goHome</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "rt":"<span style="color: #FF0000">#home</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">choreography</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">goList</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">safe</span>"<span style="color: #990000">,</span> "rt":"<span style="color: #FF0000">#list</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">choreography</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">doAdd</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">unsafe</span>"<span style="color: #990000">,</span> "rt":"<span style="color: #FF0000">#list</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[{</span>"href":"<span style="color: #FF0000">#id</span>"<span style="color: #990000">},{</span>"href":"<span style="color: #FF0000">#title</span>"<span style="color: #990000">}]},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">doRemove</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">idempotent</span>"<span style="color: #990000">,</span> "rt":"<span style="color: #FF0000">#list</span>"<span style="color: #990000">,</span> "tag":"<span style="color: #FF0000">choreography</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[{</span>"href":"<span style="color: #FF0000">#id</span>"<span style="color: #990000">}]}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This ALPS document contains all the possible data elements and action elements, along with additional metadata on how to craft requests to the service and what to expect in response.  This ALPS document can be the source material for creating client applications that will be able to successfully interact with any service that supports this profile. This is especially true for services that support hypermedia responses.</p></div>
<div class="paragraph"><p>For example, assuming a ToDo-compliant service is running at localhost:8484, a ToDo-compliant client might do the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># data to work with
STACK PUSH {"id":"zaxscdvf","body":"testing"}

# vocabulary and format supported
CONFIG SET {"profile":"http://api.examples.org/profiles/todo-alps.json"}
CONFIG SET {"format":"application/vnd.mash+json"}

# write to service
REQUEST WITH-URL http://api.example.org/todo/list WITH-PROFILE WITH-FORMAT
REQUEST WITH-FORM doAdd WITH-STACK
REQUEST WITH-LINK goList
REQUEST WITH-FORM doRemove WITH-STACK
EXIT</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Check out <a href="#hyper">[hyper]</a> for a short review of how to program in HyperLANG with the HyperCLI.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Note that the client only needs to know the starting URL, along with the names of the actions (<code>doAdd</code>, <code>goList</code>, and <code>doRemove</code>) and the names of the data properties (<code>id</code> and <code>body</code>). The client also needs to tell the service what vocabulary (<code>profile</code>) and media type (<code>format</code>) will be used during the interaction. These are all decisions made when <em>coding</em> the application. With that done, the remainder of the script invokes actions and sends data that the client knows ahead of time will be valid—based on the published vocabulary. Since, in this case, the service is known to support hypermedia responses, the client can safely assume that the vocabulary links and forms will be found in the service response and coded accordingly.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_15">4.4.4. Discussion</h4>
<div class="paragraph"><p>Vocabulary documents are the glue that binds API producers and API consumers without resorting to tight coupling. As we have seen in the last example, reliance on clear vocabularies and well-known media type formats does a great deal to reduce the coupling between client and service without losing any detail.</p></div>
<div class="paragraph"><p>Services often publish API definition documents (e.g., <a href="https://oreil.ly/uyE9c">OpenAPI</a>, <a href="https://oreil.ly/gcOVb">AsyncAPI</a>, <a href="https://oreil.ly/9AKUs">RAML</a>, etc.). This is handy for people who want to implement a single instance of the API <em>service</em>, but it has limited value for API consumers. When API client applications use the service implementation specification to create an API consumer, that application will be tightly bound to this particular service implementation. Any changes to the service implementation are likely to break that client application. A better approach is to bind the API consumer to a published <em>profile</em> document instead.</p></div>
<div class="paragraph"><p>If the service you are working with does not publish a stable vocabulary document, it is a good idea to create your own. Use the API definition documentation (OpenAPI, etc.) as a guide to craft your own ALPS document (or some other format, if you wish), and then publish that document for your team (and others) to use when creating an API client for that service. It is also a good idea to include that ALPS document in your client application&#8217;s source code repository for future reference.</p></div>
<div class="paragraph"><p>As shown in the last example, you get the greatest benefit of vocabulary profiles when the service you are working with returns hypermedia responses. When that is not the case (and you don&#8217;t have the ability to influence the service teams), you can still code your client as if hypermedia was in the response (see <a href="#clients-forms">[clients-forms]</a> for details).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_15">4.4.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-definitions">[services-definitions]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-profile-negotiation">4.5. Negotiating for Profile Support at Runtime</h3>
<div class="paragraph"><p>Client applications that depend on services that provide responses using pre-determined semantic profiles need a way to make sure those services will be "speaking" in the required vocabulary.</p></div>
<div class="sect3">
<h4 id="_problem_15">4.5.1. Problem</h4>
<div class="paragraph"><p>You&#8217;ve coded your client to work with any service that complies with, for example, the ToDo semantic profile. How can you confirm—at runtime—that the service you are about to use supports the <code>to-do</code> vocabulary?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_15">4.5.2. Solution</h4>
<div class="paragraph"><p>A client application can dependably check for semantic profile support in a service using the "profile negotiation" pattern. Clients can use the <code>accept-profile</code> request header to indicate the expected semantic profile, and services can use the <code>content-profile</code> response header to indicate the supporting semantic profile.</p></div>
<div class="paragraph"><p>Like content negotiation (see <a href="#services-conneg">[services-conneg]</a>), profile negotiation allows clients and servers to share metadata details about the resource representation and make decisions on whether the server&#8217;s response is acceptable for the client. When services return resource profiles that do not match the client&#8217;s request, the client can reject the response with an error, request more information from the server, or continue <span class=".keep-together">anyway</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_14">4.5.3. Example</h4>
<div class="paragraph"><p>Clients can determine the supported semantic profiles for a service resource in a number of ways. Profile negotiation is the most direct way for clients to indicate and validate a service&#8217;s profile support.</p></div>
<div class="paragraph"><p>The following is a simple example of profile negotiation:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept-Profile: &lt;http://profiles.example.org/to-do&gt;

*** RESPONSE
HTTP/2.0 200 OK
Content-Profile: http://profiles/example.org/to-do

...</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the client uses the <code>accept-profile</code> header to indicate the desired vocabulary, and the service uses the <code>content-profile</code> header to tell the client what profile was used to compose the resource representation that was returned.</p></div>
<div class="paragraph"><p>Servers may also return a <code>406</code> HTTP status code (<code>Not Acceptable</code>) when a client requests a semantic profile the service does not support.  When doing so, the service should return metadata that indicates which profiles that service is prepared to support instead:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept-Profile: &lt;http://profiles.example.org/to-do/v3&gt;

*** RESPONSE
HTTP/2.0 406 Not Acceptable
Content-Type: application/vnd.collection+json</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection":
  <span style="color: #990000">{</span>
    "links" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel":"<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://profiles.example.org/todo/v1</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel":"<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://profiles.example.org/todo/v2</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">},</span>
    "error" : <span style="color: #990000">{</span>
      "title" : "<span style="color: #FF0000">Unsupported Profile</span>"<span style="color: #990000">,</span>
      "message" : "<span style="color: #FF0000">See links for supported profiles for this resource.</span>"
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It is also possible for services to provide a way for client applications to preemptively request details on the supported semantic profiles. To do this, services can offer one or more links with the relation value of “<code>profile</code>," with each link pointing to a supported semantic profile document. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection":
  <span style="color: #990000">{</span>
    "title" : "<span style="color: #FF0000">Supported Semantic Profiles</span>"<span style="color: #990000">,</span>
    "links" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel":"<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://profiles.example.org/todo/v1</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel":"<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://profiles.example.org/todo/v2</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel":"<span style="color: #FF0000">profile</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">http://profiles.example.org/todo/v3</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>These links can appear in any resource representation that supports that profile. Even when only one semantic profile is supported, it is a good idea to emit profile links in responses to help clients (and their developers) recognize the supported vocabularies. In this case, clients can look at the collection of profile links to see if their semantic profile identifier is among those listed in the response.</p></div>
<div class="paragraph"><p>The list of supported profiles can be reported as HTTP headers too:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept-Profile: &lt;http://profiles.example.org/to-do/v3&gt;

*** RESPONSE
HTTP/2.0 406 Not Acceptable
Content-Type: application/vnd.collection+json
Links &lt;http://profiles.example.org/todo/v3&gt;; rel="profile",
&lt;http://profiles.example.org/todo/v2&gt;; rel="profile",
&lt;http://profiles.example.org/todo/v1&gt;; rel="profile"</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_16">4.5.4. Discussion</h4>
<div class="paragraph"><p>It&#8217;s a good idea for client applications that are "coded to the profile" to validate all incoming responses to make sure the client will be able to process the resource correctly. Since servers may actually report more than one profile link in responses, client applications should assume all profile metadata is reported as a collection and search for the desired profile identifier within that collection.</p></div>
<div class="paragraph"><p>Negotiating for semantic profiles with <code>accept-profile</code> and <code>content-profile</code> is not very common. The <a href="https://oreil.ly/iBy3h">specification that outlines that work</a> is still a draft document and, as of this writing, the most recent WC3 work on <a href="https://oreil.ly/geeWl">profiles</a> is still a work in progress. However, within a closed system (e.g., enterprise IT), implementing profile negotiation can be a good way to promote and encourage the use of semantic profiles in <span class=".keep-together">general</span>.</p></div>
<div class="paragraph"><p>I don&#8217;t recommend getting too granular with identifying semantic profile versions (v1, v1.1, v1.1.1, etc.), as it only makes for more work at runtime for both client applications and remote services. When changes to profiles need to be made, it is a good idea to keep the variations backward compatible for as long as possible. If a profile update results in a breaking change, you should update the identifier to indicate a new version (v1 &#8594; v2).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_16">4.5.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabulary-formats">[services-vocabulary-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-representors">4.6. Managing Representation Formats at Runtime</h3>
<div class="paragraph"><p>Client applications that need to interact with more than one service may need to be coded to "converse" in more than one message format (HTML, HAL, SIREN, Collection+JSON, etc.). That means recognizing and dealing with multiple message formats at runtime.</p></div>
<div class="sect3">
<h4 id="_problem_16">4.6.1. Problem</h4>
<div class="paragraph"><p>How do client applications that need to be able to process more than one message type request and validate the message types they receive from services and process information from varying formats consistently?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_16">4.6.2. Solution</h4>
<div class="paragraph"><p>Applications that operate should be able to manage the resource representation formats (HTML, HAL, SIREN, Collection+JSON, etc.) using the HTTP <code>Accept</code> and <code>Content-Type</code> headers. This focus on message-centric coding (see <a href="#clients-messages">[clients-messages]</a>) will give stability to your client code without banding it closely to the specific domain of the service(s) you are using.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Media Type First Development</div>
<div class="paragraph"><p>The first step in managing message formats on the web is to take advantage of HTTP&#8217;s <code>Accept</code> and <code>Content-Type</code> headers to signal format preferences to the service and to validate the representation format returned by the service.</p></div>
</div></div>
<div class="paragraph"><p>Whenever your client makes an API request, you should include an HTTP <code>Accept</code> header to indicate the structured format(s) your application "understands." Then, when the server replies, you should check the <code>Content-Type</code> header to confirm which of your supported formats was returned. If the format returned is not one your client can handle, you should stop processing and report the problem. In human-driven apps, this is usually done with a pop-up message or inline content. For M2M apps, this can be done as an error message back to the calling machine and/or a log message sent to some supervising authority:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json

*** RESPONSE
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="paragraph"><p>The client applications also need to be coded in a way that creates a separation of concern (SoC) between the message formats exchanged with services and the internal representation of the information. When the server returns a response, the client application can route the message body to the proper handler for processing. This is where the message is translated into an internal model that the client application can use to inspect and manipulate the response.</p></div>
<div class="paragraph"><p>That means implementing the Message Translator pattern internally so that clients can consistently translate between internal object models and external messages.</p></div>
</div>
<div class="sect3">
<h4 id="_example_15">4.6.3. Example</h4>
<div class="paragraph"><p>Here is an example of code that validates the media type of the service response and handles it accordingly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">handleResponse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">,</span>url<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ctype
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>readyState<span style="color: #990000">===</span><span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      ctype <span style="color: #990000">=</span> ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getResponseHeader</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"content-type"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toLowerCase</span></span><span style="color: #990000">();</span>
      <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>ctype<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"application/vnd.collection+json"</span><span style="color: #990000">:</span>
          cj<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"application/vnd.siren+json"</span><span style="color: #990000">:</span>
          siren<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"application/vnd.hal+json"</span><span style="color: #990000">:</span>
          hal<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
          <span style="font-weight: bold"><span style="color: #000000">dump</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
          <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span>ex<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span>ex<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that the client can "converse" in three message formats: Collection+JSON, SIREN, and HAL. If the service returns anything else, the application sends it to the <code>dump()</code> routine for additional processing.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_17">4.6.4. Discussion</h4>
<div class="paragraph"><p>Organizing your client code to be driven by message formats works best when services support highly structured formats like HTML, HAL, SIREN, Collection+JSON, etc. When services use unstructured response formats like XML and JSON, you&#8217;ll need additional metadata to support message-driven client code. In that case, schema documents like <a href="https://oreil.ly/aVNKK">XML Schema</a> and <a href="https://oreil.ly/Qwi4k">JSON Schema</a> can be handy. See <a href="#clients-schema">[clients-schema]</a> for more on using schema documents on the client side.</p></div>
<div class="paragraph"><p>Recognizing the incoming message format is just the first step. You also need to be able to parse and often translate that message for internal use. For web browsers, you can build a single JavaScript library that converts incoming JSON formats (HAL, SIREN, Collection+JSON) into HTML for rendering. The following are the high-level methods for converting JSON-based API messages into HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="font-style: italic"><span style="color: #9A1900">// collection+JSON--&gt;HTML</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>collection<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> elm<span style="color: #990000">;</span>

  g<span style="color: #990000">.</span>cj <span style="color: #990000">=</span> collection<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">title</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">content</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">links</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">items</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">queries</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">error</span></span><span style="color: #990000">();</span>

  elm <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"cj"</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>elm<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    elm<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display<span style="color: #990000">=</span><span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// HAL --&gt; HTML</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>hal<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    g<span style="color: #990000">.</span>hal <span style="color: #990000">=</span> hal<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #000000">title</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">setContext</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>g<span style="color: #990000">.</span>context<span style="color: #990000">!==</span><span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">selectLinks</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"app"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"toplinks"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">selectLinks</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"list"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"h-links"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">content</span></span><span style="color: #990000">();</span>
      <span style="font-weight: bold"><span style="color: #000000">embedded</span></span><span style="color: #990000">();</span>
      <span style="font-weight: bold"><span style="color: #000000">properties</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Unknown Context, can't continue"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    elm <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"hal"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>elm<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      elm<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display<span style="color: #990000">=</span><span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// SIREN --&gt; HTML</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> elm<span style="color: #990000">;</span>

  g<span style="color: #990000">.</span>siren <span style="color: #990000">=</span> msg<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">title</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">getContent</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">links</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">entities</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">properties</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">actions</span></span><span style="color: #990000">();</span>

  elm <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"siren"</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>elm<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    elm<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display<span style="color: #990000">=</span><span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Each message parser is designed specifically to convert the selected message format into HTML to render in the browser. This is an implementation of the <a href="https://oreil.ly/Q3Pan">Message Translator pattern</a>. Writing these one-way translators is not very challenging for highly structured formats. Since the target (HTML) is not domain specific, a single translator can be effective for any application topic or domain. I always keep a stable browser-based media type parser on hand for quickly building rendering applications for services that use these formats.</p></div>
<div class="paragraph"><p>The work gets more challenging if you need to translate the incoming message into a domain-specific internal object model or graph. In these cases, it&#8217;s a good idea to use other metadata like semantic profiles (see <a href="#clients-profiles">[clients-profiles]</a>) or schema documents (see <a href="#clients-schema">[clients-schema]</a>) as your guide for translating the incoming message.</p></div>
<div class="paragraph"><p>The work gets exponentially more difficult when all your client has to work with is an unstructured document like XML or JSON <em>and</em> there is no reliable schema or profile supplied. In these cases, you&#8217;ll need to spend time creating custom-built translators based on the human-readable documentation. It is also likely that small changes in the documentation can cause big problems for your custom-built translator.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_17">4.6.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-conneg">[services-conneg]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-schema">4.7. Using Schema Documents as a Source of <span class=".keep-together">Message Metadata</span></h3>
<div class="paragraph"><p>When services do not support semantic profiles or structured media types, client applications may still be able to code to a semantic specification if that service returns references to schema documents that describe the contents of the message:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use schema where profiles and media types are not sufficient or are missing
</p>
</li>
<li>
<p>
<em>Do not</em> use schema documents to validate <em>incoming</em> messages
</p>
</li>
<li>
<p>
<em>Do</em> use schema to validate <em>outgoing</em> messages
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_problem_17">4.7.1. Problem</h4>
<div class="paragraph"><p>How can we build resilient client applications based on message schema for unstructured media types (XML or JSON) instead of semantic profiles?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_17">4.7.2. Solution</h4>
<div class="paragraph"><p>In cases where services consistently return schema documents with unstructured messages formats (XML or JSON) as runtime responses, you may be able to code a resilient client application without the support of semantic profiles.  To do this, you need to organize client code that is driven solely by schema information.</p></div>
<div class="paragraph"><p>The most common examples of these schema formats are <a href="https://oreil.ly/aVNKK">XML Schema</a> and <a href="https://oreil.ly/Qwi4k">JSON Schema</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_16">4.7.3. Example</h4>
<div class="paragraph"><p>When services provide them, you can also use schema documents as additional metadata information for the incoming message. This works best when the response itself contains a pointer to the schema. At runtime, it is not a good idea to validate incoming messages against a schema document unless you plan on rejecting invalid inputs entirely. Usually, runtime responses will have minor differences (e.g., added fields not found in the schema, rearranged order of elements in the response, etc.), and these minor changes are not good reasons to reject the input. However, it is handy to use the provided schema URI/URL as an <em>identifier</em> to confirm that the service has returned a response with the expected semantic metadata.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Using schema documents to validate <em>incoming</em> messages runs counter to <a href="https://oreil.ly/VWvC6">Postel&#8217;s Law</a>, which states: "be conservative in what you do, be liberal in what you accept from others." Strong typing incoming messages (instead of "be[ing] liberal in what you accept") is likely to result in rejected responses that might otherwise work well for both client and server.  The <a href="https://oreil.ly/kSM3w">specification document RFC 1122</a>, authored by Robert Braden, goes into great detail on how to design and implement features that can safely allow for minor variations in message and protocol details. See Recipes <a href="#clients-outgoing">4.12</a> and <a href="#clients-incoming">4.13</a> for more on this challenge.</p></div>
</td>
</tr></table>
</div>
<div class="sect4 xxx">
<h5 id="_negotiating_for_schemas">4.7.3.1. Negotiating for schemas</h5>
<div class="paragraph"><p>It is possible for client applications to engage in schema negotiation with the service. This is useful when both client and server know ahead of time that there are multiple editions of the same general schema (user-v1, user-v2, etc.) and you want to confirm both are working with the same edition. An <a href="https://oreil.ly/f2jS2">expired proposal</a> from the W3C suggested the use of <code>accept-schema</code> and <code>schema</code> HTTP headers:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept-Schema: &lt;urn:example:schema:e-commerce-payment&gt;

*** RESPONSE
HTTP/1.1 200 OK
Schema: &lt;urn:example:schema:e-commerce-payment
...</code></pre>
</div></div>
<div class="paragraph"><p>I&#8217;ve not encountered this negotiation approach "in the wild." If it is offered by a service, it is worth looking into as a client developer—any semantic metadata is better than none.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_schema_identifier_in_the_content_type_header">4.7.3.2. Schema identifier in the Content-Type header</h5>
<div class="paragraph"><p>The schema identifier may also be passed from server to client in the <code>Content-Type</code> header:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept: application/vnd.hal+json

*** RESPONSE
HTTP/1.1 200 OK
Content-Type: \
  application/vnd.hal+json;schema=urn:example:schema:e-commerce-payment
...</code></pre>
</div></div>
<div class="paragraph"><p>It is important to point out that adding additional facets (those after the ";") to the media type string can complicate message format validation. Also, some media type definitions expressly forbid including additional metadata in the media type identifier string (for example, JSON has this rule).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_schema_identifier_in_the_document">4.7.3.3. Schema identifier in the document</h5>
<div class="paragraph"><p>It is most common to see the schema identifier provided as part of the message body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$schema":"<span style="color: #FF0000">https://alps-io.github.io/schemas/alps.json</span>"<span style="color: #990000">,</span>
  "alps" : <span style="color: #990000">{</span>
    "version":"<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "title":"<span style="color: #FF0000">ToDo List</span>"<span style="color: #990000">,</span>
    "doc" : <span style="color: #990000">{</span>"value":"<span style="color: #FF0000">A suggested ALPS profile for a ToDo service</span>"<span style="color: #990000">},</span>
    "descriptor":<span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "def":"<span style="color: #FF0000">http://schema.org/identifier</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">title</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span> "def":"<span style="color: #FF0000">http://schema.org/title</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"id":"<span style="color: #FF0000">completed</span>"<span style="color: #990000">,</span> "type":"<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span>
        "def":"<span style="color: #FF0000">http://mamund.site44.com/alps/def/completed.txt</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The schema identifier does not need to be a dereferenceable URL (<em>https://alps-io.github.io/schemas/alps.json</em>). It may just be a URI or URN identifier string (urn:example:schema:e-commerce-payment).  The value of using a dereferenceable URL is that humans can follow the link to get additional information.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_coding_schema_aware_clients">4.7.3.4. Coding schema-aware clients</h5>
<div class="paragraph"><p>Once you know how to identify schema information, you can use it to drive your client application code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">handleSchema</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">,</span>schemaIdentifier<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> schemaType
  <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
    schemaType <span style="color: #990000">=</span> schemaIdentifier<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toLowerCase</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>ctype<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"https://api.example.com/schemas/task"</span><span style="color: #990000">:</span>
        task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"https://api.example.com/schemas/task-v2"</span><span style="color: #990000">:</span>
        task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"https://api.example.com/schemas/user"</span><span style="color: #990000">:</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"https://api.example.com/schemas/user-v2"</span><span style="color: #990000">:</span>
        user<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"https://api.example.com/schemas/note"</span><span style="color: #990000">:</span>
        note<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #000000">dump</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span>ex<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span>ex<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that organizing code around schema definitions is often much more work than relying on semantic profile formats like ALPS. Schemas are usually domain specific and are more likely to change over time than semantic profiles. In this example, you can see that there are two (apparently) incompatible schema references for the <code>task</code> object. Also, the example shows that while there are two different <code>user</code> schema documents, they are (at least as far as this client is concerned) compatible versions.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_18">4.7.4. Discussion</h4>
<div class="paragraph"><p>The primary value of schema documents comes into play when you are creating and sending messages (see <a href="#clients-outgoing">[clients-outgoing]</a>). However, client applications can also use the schema document identifiers themselves (URLs or URIs) as advisory values for processing incoming messages. Essentially, schema identifiers become confirmation values that the response received by the client will contain the information the client will need to perform its work.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>I won&#8217;t be talking about maintaining schema registries in this edition of the cookbook. I do, however, cover the power of registered vocabularies (much less constrained than schema documents) in Recipes <a href="#design-profiles">3.4</a> and <a href="#clients-profiles">4.4</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Negotiating for schema identifiers has limited value as well. It can be a good way for clients to preemptively tell services what schema they can support. This allows services to <em>reject</em> requests using HTTP status code <code>406 Not Acceptable</code>. But this, too, runs afoul of Postel&#8217;s Law.</p></div>
<div class="paragraph"><p>Client applications that are coded to be "schema aware" are likely to be more of a challenge than client applications coded as "media type aware" (see <a href="#clients-messages">[clients-messages]</a>) or "profile aware" (see <a href="#clients-profiles">[clients-profiles]</a>). That is because schema documents typically are at a much more granular level (objects), and object schema usually changes more often than the overall vocabulary or message formats.</p></div>
<div class="paragraph"><p>JSON Schema has a feature that allows for successful validation of a sample document even if that document contains additional properties not found in the schema (<code>additionalProperties:true|false</code>). By default, this is set to <code>true</code>, which allows for additional properties to appear without triggering a schema validation error. Also, altering the order of the properties within an object will not trigger a schema validation error.</p></div>
<div class="admonitionblock warning1">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Including "unknown" properties in an incoming message is not, by itself, a security problem. For example, this can be quite common in the HTML format. However, attempting to consume and process unknown properties <em>may</em> be a security hole. As you&#8217;ll see in <a href="#clients-incoming">[clients-incoming]</a>, it is best for client applications to ignore unknown properties and only process the values the application was designed to deal with.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In XML documents, schema validators are rather demanding. To be passed as valid, the elements within the XML messages need to be in the same order as indicated in the schema document, and in most cases, the appearance of a new element or property will trigger a validation error.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_18">4.7.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-outgoing">[clients-outgoing]</a>
</p>
</li>
<li>
<p>
<a href="#clients-incoming">[clients-incoming]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-identifier">4.8. Every Important Element Within a Response <span class=".keep-together">Needs an Identifier</span></h3>
<div class="paragraph"><p>Just as every important resource in a RESTful API has an identifier (URL), every important action and/or data element <em>within</em> a response deserves its own identifier. A client needs to be able to locate the right resource, and find and use the right action or data collection in the resource response.</p></div>
<div class="sect3">
<h4 id="_problem_18">4.8.1. Problem</h4>
<div class="paragraph"><p>How do you make sure that client applications can find the actions and/or data they are looking for within a response? In addition, how can you make sure the ability to find these important elements doesn&#8217;t degrade over time as the service evolves?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_18">4.8.2. Solution</h4>
<div class="paragraph"><p>The key to ensuring stable, meaningful identifiers within API responses is to select media types that support a wide range of identifier types as structural elements. HTML does a good job at this. I created the Machine Accessible Semantic Hypermedia (MASH) format as an example of a media type that supports multiple structural identifiers.</p></div>
<div class="paragraph"><p>The four kinds of identifiers are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>ID</code>
</dt>
<dd>
<p>
A document-wide unique single-value element (e.g., <code>id=<em>1q2w3e4r</em></code>)
</p>
</dd>
<dt class="hdlist1">
<code>NAME</code>
</dt>
<dd>
<p>
An application-wide unique single-value element (e.g., <code>name=<em>createUserForm</em></code>)
</p>
</dd>
<dt class="hdlist1">
<code>REL</code>
</dt>
<dd>
<p>
A system-wide unique multivalue element (e.g., <code>rel=<em>create-form self</em></code>)
</p>
</dd>
<dt class="hdlist1">
<code>TAG</code>
</dt>
<dd>
<p>
A solution-specific nonunique multivalue element (e.g., <code>tag=<em>users page-level</em></code>)
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Another example of the last item (solution-specific nonunique multivalue element) is the HTML <code>CLASS</code> element.</p></div>
<div class="paragraph"><p>Client applications should be coded to be able to find the desired FORM, LINK, or DATA block using at least one of these types of identifiers.</p></div>
</div>
<div class="sect3">
<h4 id="_example_17">4.8.3. Example</h4>
<div class="paragraph"><p>For an example of the importance of using media types that support structured identifiers, consider the following challenge:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Access the starting URL of the <code>users</code> service .
</p>
</li>
<li>
<p>
Within the response to that request, find the form for searching for existing users.
</p>
</li>
<li>
<p>
Fill out the form to find the user with the nickname "mingles," and execute the request.
</p>
</li>
<li>
<p>
Store the resulting properties of this response to client memory.
</p>
</li>
<li>
<p>
Within the response to that request, find the form for updating this resource.
</p>
</li>
<li>
<p>
Using the data in the response, fill in the update form, change the email address to &ldquo;<a href="mailto:mingles@example.org">mingles@example.org</a>,&rdquo; and execute the request.
</p>
</li>
</ol></div>
<div class="paragraph"><p>While we, as humans, could do this rather easily (e.g., in an HTML browser), getting a machine to do this takes some additional effort. Consider, for example, that you need to update the email addresses of 10 or more user accounts. Now add to this challenge that you need to deal with multiple versions of the user service, or one that uses multiple response formats, or one that has evolved over time. In these cases, the client might use a script like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># hyper-cli example

ECHO Updating email address for mingles

ACTIVATE http://api.example.org/users

ACTIVATE WITH-FORM nickSearch
  WITH-QUERY {"nick":"mingles"}

ACTIVATE WITH-FORM userUpdate
  WITH-BODY {"name":"Miguelito","nick":"mingles","email":"mingles@example.org"}

ACTIVATE WITH-FORM emailSearch
  WITH-QUERY {"email":"mingles@example.org"}

ECHO Update Confirmed

EXIT

# eof</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Check out <a href="#hyper">[hyper]</a> for more on how to use the HyperCLI and HyperLANG as a hypermedia client application.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Note in this example that the client application is relying on identifiers for three actions (<code>nickSearch</code>, <code>userUpdate</code>, and <code>emailSearch</code>) and for a collection of properties (<code>name</code>, <code>nick</code>, and <code>email</code>). The actual representation format (HTML, MASH, SIREN, etc.) does not matter for the script—that is handled internally by the client. Also note that the only URL supplied is the initial one to contact the service. The rest of the URLs are supplied in the responses (as part of the forms).</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_19">4.8.4. Discussion</h4>
<div class="paragraph"><p>Most HTTP design practices make it clear that every <em>resource</em> deserves its own identifier (in the form of a URL). This is easy to see when you look at typical HTTP API requests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>http://api.example.org/customers/123
http://api.example.org/users?customer=123</code></pre>
</div></div>
<div class="paragraph"><p>This is also true when it comes to describing interactions within a single response. For example, consider the following response from <code>/users?customer=123</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "id": "<span style="color: #FF0000">aqswdefrgt</span>"<span style="color: #990000">,</span>
  "href": "<span style="color: #FF0000">http://api.example.org/customers/123</span>"<span style="color: #990000">,</span>
  "name": "<span style="color: #FF0000">customer-record</span>"<span style="color: #990000">,</span>
  "rel": "<span style="color: #FF0000">item http://rels.example.org/customer</span>"<span style="color: #990000">,</span>
  "tags": "<span style="color: #FF0000">item customer read-only</span>"<span style="color: #990000">,</span>
  "data": <span style="color: #990000">[</span>
    "identifier": "<span style="color: #FF0000">123</span>"<span style="color: #990000">,</span>
    "companyName": "<span style="color: #FF0000">Ajax Brewing</span>"<span style="color: #990000">,</span>
    "address": "<span style="color: #FF0000">123 Main St, Byteville, MD</span>"<span style="color: #990000">,</span>
    "users": "<span style="color: #FF0000">http://api.example.org/users?customer=123</span>"
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the record metadata is as follows:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>id</code>
</dt>
<dd>
<p>
A document-wide unique ID that clients can use to locate this record in any list
</p>
</dd>
<dt class="hdlist1">
<code>href</code>
</dt>
<dd>
<p>
A system-wide URL that clients can use to retrieve this record from the service
</p>
</dd>
<dt class="hdlist1">
<code>name</code>
</dt>
<dd>
<p>
A semantic application-wide name that clients can use to return records of this "type"
</p>
</dd>
<dt class="hdlist1">
<code>rel</code>
</dt>
<dd>
<p>
A collection of system-wide names that clients can use to return records of this "type" or instance
</p>
</dd>
<dt class="hdlist1">
<code>tags</code>
</dt>
<dd>
<p>
A collection of application-wide names that clients can use to filter records in various ways
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The added <code>href</code> example here shows that the system-wide identifier (<a href="http://api.example.org/customers/123">http://api.example.org/customers/123</a>) does not need to be the same as the internal <code>id</code> (<code>aqswdefrgt</code>). In fact, it is a good idea to <em>assume</em> they are decoupled in order to avoid problems when the URL changes due to service migration, installation of new proxies, etc.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_19">4.8.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-hypermedia">[design-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#services-local-identifiers">[services-local-identifiers]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-hypermedia">4.9. Relying on Hypermedia Controls in the Response</h3>
<div class="paragraph"><p>One of the principles of REST-based services is the reliance on "hypermedia as engine of application state" or, as Roy Fielding has called it, "The Hypermedia Constraint."  Services that emit hypermedia formats as their responses make it much easier for client applications to determine what actions are possible—and how to commit those actions—at <em>runtime</em>. And the hypermedia information that appears within a response can be context sensitive. Context examples include the current state of the service (does a record already exist?), the user context (does this user have permission to edit the record?), and the context of the request itself (has someone else already edited this data?).</p></div>
<div class="sect3">
<h4 id="_problem_19">4.9.1. Problem</h4>
<div class="paragraph"><p>When service providers are emitting hypermedia-based responses, how can the API consumer best take advantage of the included information to improve both the human-agent and machine-agent experience?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_19">4.9.2. Solution</h4>
<div class="paragraph"><p>It is best to write API consumers to "understand" response formats (see <a href="#clients-messages">[clients-messages]</a> in this chapter). In the case of hypermedia types, each format has its own "hypermedia signature"—the list of hypermedia elements (called <a href="https://oreil.ly/WQfg1">hypermedia factors or H-Factors</a>) that this media type can express. Creating client applications that know the media type and understand the nine H-Factors will greatly improve the flexibility and resilience of the client application. Nine H-Factors can appear within a RESTful service response, which is described in Tables <a href="#table0401">4-1</a> and <a href="#table0402">4-2</a>.</p></div>
<table id="table0401" style="border: 1px solid black">
<caption>Five link factors</caption>
<thead>
<tr>
<th></th>
<th>Title</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>LE</p></td>
<td><p>Link Embedded</p></td>
<td><p>Brings content into the current view</p></td>
<td><p>HTML <code>&lt;img /&gt;</code> tag</p></td>
</tr>
<tr>
<td><p>LO</p></td>
<td><p>Link Outbound</p></td>
<td><p>Navigates the client to a new view</p></td>
<td><p>HTML <code>&lt;a /&gt;</code> tag</p></td>
</tr>
<tr>
<td><p>LT</p></td>
<td><p>Link Template</p></td>
<td><p>Supports additional parameters before executing</p></td>
</tr>
<tr>
<td><p>LN</p></td>
<td><p>Link Nonidempotent</p></td>
<td><p>Describes a nonidempotent action</p></td>
<td><p><code>&lt;FORM method=POST &#8230;&gt;</code></p></td>
</tr>
<tr>
<td><p>LI</p></td>
<td><p>Link Idempotent</p></td>
<td><p>Describes an idempotent action</p></td>
<td><p>SIREN <code>"actions":[{"name":"update-item","method":"put" &#8230;}]</code></p></td>
</tr>
</tbody>
</table>


<table id="table0402" style="border: 1px solid black">
<caption>Four control factors</caption>
<thead>
<tr>
<th></th>
<th>Title</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>CR</p></td>
<td><p>Control for Read Requests</p></td>
<td><p>Describes read details</p></td>
<td><p><code>Accept:application/vnd.hal+json</code></p></td>
</tr>
<tr>
<td><p>CU</p></td>
<td><p>Control for Update Requests</p></td>
<td><p>Describes write details</p></td>
<td><p><code>enctype="application/x-www-form-urlencoded"</code></p></td>
</tr>
<tr>
<td><p>CM</p></td>
<td><p>Control for HTTP Methods</p></td>
<td><p>Describes the HTTP method to use</p></td>
<td><p><code>&lt;FORM method="GET" &#8230; &gt;</code></p></td>
</tr>
<tr>
<td><p>CL</p></td>
<td><p>Control for Link Relations</p></td>
<td><p>Describes the link relation for an action</p></td>
<td><p><code>&lt;link rel="create-form" &#8230; /&gt;</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Each hypermedia format has its own H-Factor signature.</p></div>
<div class="paragraph"><p>In <a href="#fig0402">[fig0402]</a>, you can see three media types: SVG, Atom, and HTML. Note that the SVG format only supports the LE and LO factors. SVG, for example, supports embedded links like <code>&lt;IMAGE href="&#8230;"&#8230;&gt;</code>, and outbound links such as <code>&lt;A href="&#8230;"&gt;Go Home&lt;/a&gt;</code>.</p></div>
<div class="imageblock" id="fig0402">
<div class="content">
<img src="images/rwcb_0402.png" alt="images/rwcb_0402.png" width="80%" />
</div>
<div class="title">Figure 5. Visualizing the hypermedia factors of various media types</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_18">4.9.3. Example</h4>
<div class="paragraph"><p>Knowing which formats your client is likely to encounter allows the client to recognize and, where appropriate, offer options to human- and machine-driven agents in order for them to accomplish tasks.</p></div>
<div class="paragraph"><p>For example, the HyperCLI client (see <a href="#hyper">[hyper]</a>) supports a number of hypermedia formats. When using a format like SIREN, you can script the HyperCLI client to add, search, modify, or remove content based on the hypermedia controls in the responses. The following is a short SIREN script written in HyperLANG:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#
# SIREN Edit Session
# read a record, save it, modify it, write it back to the server
#

# ** make initial request
REQUEST WITH-URL http://rwcbook10.herokuapp.com

# ** retreive the first record in the list
REQUEST WITH-PATH $.entities[0].href

# ** push the item properties onto the stack
STACK PUSH WITH-PATH $.properties

# ** modify the tags property value on the stack
STACK SET {"tags":"fishing,\.\skiing,\.\hiking"}

# ** use the supplied edit form and updated stack to send update
REQUEST WITH-FORM taskFormEdit WITH-STACK

# ** confirm the change
SIREN PATH $.entities[0]

# ** exit session
EXIT</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#hyper">[hyper]</a> for a short introduction to programming in HyperLANG with the Hyper CLI.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Note that in this example, only the starting URL was supplied. The remaining actions were committed by relying on the hypermedia metadata supplied in each service response.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_20">4.9.4. Discussion</h4>
<div class="paragraph"><p>This recipe covers the principle of <em>using</em> that hypermedia data to solve problems directly. It relies on details supplied by services and, for that reason, this recipe is only helpful when services support hypermedia formats in the response.</p></div>
<div class="paragraph"><p>The advantage of relying on supplied hypermedia in your scripts is that you reduce the amount of hardcoding you need to do within your client application. You can make it easier for services to modify hypermedia details (e.g., URLs, HTTP methods, supported formats, etc.) without breaking the client application. In the preceding example, the script does not hardcode the HTTP URL, method, or encoding type for the <code>taskFormEdit</code> action. It simply uses the details supplied by the service.</p></div>
<div class="paragraph"><p>This recipe works best when the client application understands not only the response format (e.g., SIREN) but also the semantic profile (the topic domain) used by the <span class=".keep-together">service</span>. For instance, in the preceding example, the client knows ahead of time that there is a possible <code>taskFormEdit</code> hypermedia control that it can use to modify an existing record. See <a href="#clients-profiles">[clients-profiles]</a> for more on semantic profiles.</p></div>
<div class="paragraph"><p>The H-Factor signature of hypermedia formats varies widely and will affect how hardcoding is (or is not) required for an API client. For example, the SIREN format supports the full range of H-Factors, and HAL supports just a few of them. In contrast, a nonhypermedia format like <code>application/json</code> supports no built-in H-Factors, making it difficult to write a resilient API client for services that support only plain JSON responses.</p></div>
<div class="paragraph"><p>In general, the more H-Factors supported by a media type, the more likely you can write an API client that will survive changes in hypermedia details in the future.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_20">4.9.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-hypermedia">[design-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-forms">4.10. Supporting Links and Forms for <span class=".keep-together">Nonhypermedia Services</span></h3>
<div class="paragraph"><p>There are times when you need to interact with services that do not offer clear links and forms—hypermedia-style responses. There is a handy approach you can take on the client side to make up for this lack of support.</p></div>
<div class="sect3">
<h4 id="_problem_20">4.10.1. Problem</h4>
<div class="paragraph"><p>How can you get the advantages of API decoupling and the clearly described interactions available with hypermedia-style responses when the service you are working with does not offer hypermedia response formats as an option?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_20">4.10.2. Solution</h4>
<div class="paragraph"><p>When you&#8217;re working with services that don&#8217;t offer hypermedia-style responses and you still want to be able to rely on clearly described links and forms on the client side, you can code your client application to supply its own links and forms at runtime, based on the original API documentation.</p></div>
</div>
<div class="sect3">
<h4 id="_example_19">4.10.3. Example</h4>
<div class="paragraph"><p>A hypermedia-based API client consumes the response, identifies the action items (links and forms) in the message, and renders them (in the case of the human UI solution) along with any data that is received. A high-level look at that kind of client code would be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// low-level HTTP stuff</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">req</span></span><span style="color: #990000">(</span>url<span style="color: #990000">,</span> method<span style="color: #990000">,</span> body<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ajax <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>
  ajax<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">rsp</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">)</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
  ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> url<span style="color: #990000">);</span>
  ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setRequestHeader</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"accept"</span><span style="color: #990000">,</span>g<span style="color: #990000">.</span>atype<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>body <span style="color: #990000">&amp;&amp;</span> body<span style="color: #990000">!==</span><span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setRequestHeader</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"content-type"</span><span style="color: #990000">,</span> g<span style="color: #990000">.</span>ctype<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  ajax<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span>body<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">rsp</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>readyState<span style="color: #990000">===</span><span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    g<span style="color: #990000">.</span>msg <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>ajax<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">showTitle</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">showToplinks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">showItems</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">showActions</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When a response is received, the client looks through the message body and handles all the key tasks. For example, here&#8217;s what the <code>showTopLinks()</code> method might look like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// emit links for all views</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showToplinks</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> act<span style="color: #990000">,</span> actions<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> elm<span style="color: #990000">,</span> coll<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> menu<span style="color: #990000">,</span> a<span style="color: #990000">;</span>

  elm <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"toplinks"</span><span style="color: #990000">);</span>
  d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clear</span></span><span style="color: #990000">(</span>elm<span style="color: #990000">);</span>
  menu <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">node</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"div"</span><span style="color: #990000">);</span>

  actions <span style="color: #990000">=</span> g<span style="color: #990000">.</span>actions<span style="color: #990000">[</span>g<span style="color: #990000">.</span>object<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// get the link metadata</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> act <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> actions<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    link <span style="color: #990000">=</span> actions<span style="color: #990000">[</span>act<span style="color: #990000">]</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>link<span style="color: #990000">.</span>target<span style="color: #990000">===</span><span style="color: #FF0000">"app"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      a <span style="color: #990000">=</span> d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">anchor</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        href<span style="color: #990000">:</span>link<span style="color: #990000">.</span>href<span style="color: #990000">,</span>
        rel<span style="color: #990000">:(</span>link<span style="color: #990000">.</span>rel<span style="color: #990000">||</span><span style="color: #FF0000">"collection"</span><span style="color: #990000">),</span>
        className<span style="color: #990000">:</span><span style="color: #FF0000">"action item"</span><span style="color: #990000">,</span>
        text<span style="color: #990000">:</span>link<span style="color: #990000">.</span>prompt
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      a<span style="color: #990000">.</span>onclick <span style="color: #990000">=</span> link<span style="color: #990000">.</span>func<span style="color: #990000">;</span>
      d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>a<span style="color: #990000">,</span> menu<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  d<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>menu<span style="color: #990000">,</span>elm<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This example renders the top links on a user interface. The source of that rendering is the link metadata. This client gets that in a single line of code. In hypermedia responses, that link metadata is in the body of the message. But even if you only get simple JSON data responses, you can use this same code. You just need to modify where the link metadata comes from.</p></div>
<div class="paragraph"><p>In the following example, the link metadata comes from an internal structure that holds all the links and forms for a particular context ("users," "tasks," etc.). All the metadata was gleaned from the APIs human-centric documentation. All the rules for possible actions and arguments were translated from the API docs into this client-code structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-style: italic"><span style="color: #9A1900">// user object actions</span></span>
  g<span style="color: #990000">.</span>actions<span style="color: #990000">.</span>user <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    home<span style="color: #990000">:</span>       <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"app"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>httpGet<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/home/"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Home"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    tasks<span style="color: #990000">:</span>      <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"app"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>httpGet<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/task/"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Tasks"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    users<span style="color: #990000">:</span>      <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"app"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>httpGet<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user/"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Users"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    byNick<span style="color: #990000">:</span>     <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"list"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>jsonForm<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"By Nickname"</span><span style="color: #990000">,</span> method<span style="color: #990000">:</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">,</span>
                  args<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                    nick<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Nickname"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    byName<span style="color: #990000">:</span>     <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"list"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>jsonForm<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"By Name"</span><span style="color: #990000">,</span> method<span style="color: #990000">:</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">,</span>
                  args<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                    name<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Name"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    add<span style="color: #990000">:</span>        <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"list"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>jsonForm<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user/"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Add User"</span><span style="color: #990000">,</span> method<span style="color: #990000">:</span><span style="color: #FF0000">"POST"</span><span style="color: #990000">,</span>
                  args<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                    nick<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Nickname"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                      pattern<span style="color: #990000">:</span><span style="color: #FF0000">"[a-zA-Z0-9]+"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    password<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Password"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                      pattern<span style="color: #990000">:</span><span style="color: #FF0000">"[a-zA-Z0-9!@#$%^&amp;*-]+"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    name<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Full Name"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    item<span style="color: #990000">:</span>       <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"item"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>httpGet<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user/{id}"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Item"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    edit<span style="color: #990000">:</span>       <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"single"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>jsonForm<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/user/{id}"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Edit"</span><span style="color: #990000">,</span> method<span style="color: #990000">:</span><span style="color: #FF0000">"PUT"</span><span style="color: #990000">,</span>
                  args<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                    nick<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">"{nick}"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Nickname"</span><span style="color: #990000">,</span> readOnly<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    name<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">"{name}"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Full Name"</span><span style="color: #990000">,</span>required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span>
                  <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    changepw<span style="color: #990000">:</span>   <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"single"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>jsonForm<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/task/pass/{id}"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Change Password"</span><span style="color: #990000">,</span> method<span style="color: #990000">:</span><span style="color: #FF0000">"POST"</span><span style="color: #990000">,</span>
                  args<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                    nick<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">"{nick}"</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"NickName"</span><span style="color: #990000">,</span> readOnly<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    oldPass<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Old Password"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                      pattern<span style="color: #990000">:</span><span style="color: #FF0000">"[a-zA-Z0-9!@#$%^&amp;*-]+"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    newPass<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"New Password"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                      pattern<span style="color: #990000">:</span><span style="color: #FF0000">"[a-zA-Z0-9!@#$%^&amp;*-]+"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    checkPass<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>value<span style="color: #990000">:</span><span style="color: #FF0000">""</span><span style="color: #990000">,</span> prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Confirm New"</span><span style="color: #990000">,</span> required<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                    pattern<span style="color: #990000">:</span><span style="color: #FF0000">"[a-zA-Z0-9!@#$%^&amp;*-]+"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    assigned<span style="color: #990000">:</span>   <span style="color: #FF0000">{</span>target<span style="color: #990000">:</span><span style="color: #FF0000">"single"</span><span style="color: #990000">,</span> func<span style="color: #990000">:</span>httpGet<span style="color: #990000">,</span> href<span style="color: #990000">:</span><span style="color: #FF0000">"/task/?assignedUser={id}"</span><span style="color: #990000">,</span>
                  prompt<span style="color: #990000">:</span><span style="color: #FF0000">"Assigned Tasks"</span><span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Now you can use links and forms for services that don&#8217;t provide them at runtime.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_21">4.10.4. Discussion</h4>
<div class="paragraph"><p>This recipe relies on someone doing the work of translating the rules buried in the API documentation into a machine-readable form. That&#8217;s what hypermedia-compliant services do. If the service doesn&#8217;t automatically do this work, client developers can save a lot of time by doing it once and sharing the results. Consider placing all link and form metadata for a service in a separate module or an external configuration file. Even better, if you can, convince your server teams to do this for you.</p></div>
<div class="paragraph"><p>Some formats are designed specifically to make capturing and sharing link and form metadata. One is the Web Service Transition Language (WSTL). You may also be able to use JSON HyperSchema. Check out <a href="#standards-supporting-types">[standards-supporting-types]</a> <span class="keep-together">for details</span>.</p></div>
<div class="paragraph"><p>There are some additional challenges not covered in the example, the biggest being user-context management. It could be that admin users should see or do things that guest users do not. In that case, a solid approach is to create a separate set of action metadata for each security role your application supports.</p></div>
<div class="paragraph"><p>Another challenge you&#8217;ll need to deal with is when the service changes but your local metadata information does not keep up. This is another case of versioning problems that come up when clients operate on static metadata at runtime. The good news is that, when action rules change on the server, at least the client application only needs to update configuration metadata and not the entire application codebase.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_21">4.10.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-hypermedia">[design-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#services-media-types">[services-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-qualities">4.11. Validating Data Properties at Runtime</h3>
<div class="paragraph"><p>When supporting the collection of inputs for client applications, it can be a challenge to properly describe valid input values at runtime. However, relying on predefined input rules documented only in human-readable prose can limit the adaptability of the client application and reduce its usefulness over time.</p></div>
<div class="sect3">
<h4 id="_problem_21">4.11.1. Problem</h4>
<div class="paragraph"><p>How can API clients consistently enforce the right data properties on input values at runtime? Also, how can we make sure that changes in the input rules over time continue to be honored by API clients and that these rule changes do not break already-deployed API clients?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_21">4.11.2. Solution</h4>
<div class="paragraph"><p>An effective approach for API clients to support data property validation at runtime is to recognize and honor rich input descriptions (RIDs) within HTTP responses. A great example of RIDs can be found in the HTML format. HTML relies upon the <code>INPUT</code> element and a collection of attributes to describe expected inputs (<a href="https://oreil.ly/kr2Mp"><code>INPUT.type</code></a>) and define <a href="https://oreil.ly/clkaO">valid values</a> (<code>INPUT.pattern</code>, <code>INPUT.required</code>, <code>INPUT.size</code>, etc.).</p></div>
<div class="paragraph"><p>Client applications should support any or all data property quality checks provided by the incoming message format (HAL, SIREN, Collection+JSON, etc.).</p></div>
</div>
<div class="sect3">
<h4 id="_example_20">4.11.3. Example</h4>
<div class="paragraph"><p>The <a href="https://oreil.ly/ID2t7">HAL-FORMS specification</a> is a good example of an API format that supports RIDs. HAL-FORMS is an extension of the HAL media type designed specifically to add RID support to the HAL format. The HAL-FORMS <span class=".keep-together">specification</span> splits RIDs into three key groups: Core, Additional, and a special category: Options.</p></div>
<div class="paragraph"><p>The Core section lists the following elements that clients <em>should</em> support: <code>readOnly</code>, <code>regex</code>, <code>required</code>, and <code>templated</code>. The Additional section lists elements that clients <em>may</em> support: <code>cols</code>, <code>max</code>, <code>maxLength</code>, <code>min</code>, <code>minLength</code>, <code>placeholder</code>, <code>rows</code>, <code>step</code>, and <code>type</code>. The Options support is a special class of input validation that implements describing enumerators (e.g., <code>small</code>, <code>medium</code>, <code>large</code>, etc.).</p></div>
<div class="paragraph"><p>Here is an example of a HAL-FORMS Options description:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"_templates"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"default"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #990000">...</span>
      <span style="color: #FF0000">"properties"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
          <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"shipping"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"type"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"radio"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"prompt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Select Shipping Method"</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">"options"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"selectedValues"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"FedEx"</span><span style="color: #990000">],</span>
            <span style="color: #FF0000">"inline"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
              <span style="color: #FF0000">{</span><span style="color: #FF0000">"prompt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Federal Express"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"FedEx"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">{</span><span style="color: #FF0000">"prompt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"United Parcel Service"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"UPS"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
              <span style="color: #FF0000">{</span><span style="color: #FF0000">"prompt"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DHL Express"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DHL"</span><span style="color: #FF0000">}</span>
            <span style="color: #990000">]</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_22">4.11.4. Discussion</h4>
<div class="paragraph"><p>The SIREN format supports a wide range of <a href="https://oreil.ly/GUNOr">RIDs</a>. It does this by simply referring to the HTML specification for <a href="https://oreil.ly/TOWGA">input types</a>.</p></div>
<div class="paragraph"><p>The RID can often be used to determine the <em>rendering</em> of the input control (e.g., a drop-down list, date-picker, etc.). This is common when the response message is consumed by an API client that is designed for human use, but can be ignored when the client application is designed for M2M interactions.</p></div>
<div class="paragraph"><p>At a minimum, supporting a regular expression property to describe valid inputs can work in many cases and limits the implementation burden on the client application. This is especially true for M2M interactions where there is no need for user interface rendering hints.</p></div>
<div class="paragraph"><p>If the service response does not include inline/runtime RIDs, client application developers should review the human-readable documentation and implement the API consumer to support the same kinds of RIDs described here. Usually that means creating either an inline code implementation of RIDs or a configuration-based approach. No matter the implementation details, it is a good idea to turn the human-readable input validation rules into machine-readable algorithms. See <a href="#clients-forms">[clients-forms]</a> for details on this strategy.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_22">4.11.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-identifier">[clients-identifier]</a>
</p>
</li>
<li>
<p>
<a href="#clients-forms">[clients-forms]</a>
</p>
</li>
<li>
<p>
<a href="#clients-outgoing">[clients-outgoing]</a>
</p>
</li>
<li>
<p>
<a href="#clients-incoming">[clients-incoming]</a>
</p>
</li>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#data-ignore">[data-ignore]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-outgoing">4.12. Using Document Schemas to Validate <span class=".keep-together">Outgoing Messages</span></h3>
<div class="paragraph"><p>It is important for client applications to do their very best to <em>send</em> valid messages (especially message <em>bodies</em>) to servers. One way to ensure you are sending valid message bodies is to validate those bodies with a schema document. But is it always a good idea to use schema validations when sending request bodies?</p></div>
<div class="sect3">
<h4 id="_problem_22">4.12.1. Problem</h4>
<div class="paragraph"><p>How can a client application make sure it is sending a well-formed and valid request body when invoking service requests?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_22">4.12.2. Solution</h4>
<div class="paragraph"><p>Sending well-formed and valid request bodies with HTTP methods like <code>POST</code>, <code>PUT</code>, and <code>PATCH</code> is important. To reduce the chance your request is rejected, you should validate the structure and content of your request bodies before sending them to the service for processing. Essentially, it is the responsibility of the <em>client</em> application to properly craft a valid request body, and it is the role of the <em>service</em> to do its best to process all valid requests. This is the embodiment of Postel&#8217;s Law (aka the <a href="https://oreil.ly/ctpPl">robustness principle</a>).</p></div>
<div class="paragraph"><p>A very effective way to meet this requirement is to use schema documents to confirm the validity of your message body. Both JSON and XML have strong schema specifications, and there is a wide array of tooling to support them.</p></div>
<div class="paragraph"><p>There are two levels of confirmation that clients need to handle: is the document well-formed, and is the document valid? Well-formed documents have the proper <em>structure</em>. This means they can be successfully parsed. Valid documents are not only well-formed, but both the <em>structural elements</em> (e.g., <code>street_name</code>, <code>purchase_price</code>) and the <em>values</em> of the those elements are of the right data type and within acceptable value ranges (e.g., <code>purchase_price</code> is a numerical value greater than zero and less than one thousand).</p></div>
<div class="paragraph"><p>For any cases where client applications are expected to send request message bodies, those clients should perform some type of validation before committing the request to the internet. If the body format is in JSON or XML format, using schema documents and validator libraries is the way to go. For other formats (<code>application/x-www-form-urencoded</code>, etc.), client applications should rely on their own local validation routines to confirm the message body is well-formed and valid.</p></div>
</div>
<div class="sect3">
<h4 id="_example_21">4.12.3. Example</h4>
<div class="paragraph"><p>Here&#8217;s an example of a simple message body described in FORMS+JSON format:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{
  id: "filter",
  name: "filter",
  href: "http://company-atk.herokuapp.com/filter/",
  rel: "collection company filter",
  title: "Search",
  method: "GET",
  properties: [
    {name: "status",value: ""},
    {name: "companyName",value: ""},
    {name: "stateProvince",value: ""},
    {name: "country",value: ""}
  ]
}</code></pre>
</div></div>
<div class="paragraph"><p>And here&#8217;s a basic JSON Schema document that can be used to validate the message body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$schema": "<span style="color: #FF0000">http://json-schema.org/draft-04/schema#</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">object</span>"<span style="color: #990000">,</span>
  "properties": <span style="color: #990000">{</span>
    "status": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
      "enum": <span style="color: #990000">[</span>"pending"<span style="color: #990000">,</span>"active"<span style="color: #990000">,</span>"closed"<span style="color: #990000">]</span>
    <span style="color: #990000">},</span>
    "companyName": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"
    <span style="color: #990000">},</span>
    "stateProvince": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"
    <span style="color: #990000">},</span>
    "country": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The topic of JSON Schema is too large for this book to cover. To dig more into this topic, I recommend you check out <a href="https://json-schema.org">https://json-schema.org</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Here is a possible body a client might send:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{
  "status":"pending",
  "country":"CA"
}</code></pre>
</div></div>
<div class="paragraph"><p>Finally, here&#8217;s an example using a popular JSON validator (<a href="https://oreil.ly/FlNg1">ajv</a>) that I frequently use:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * load the schema file from external source</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * pass in the JSON message to send</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * process and return results/errors</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">jsonMessageCheck</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">,</span> message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> schemaCheck <span style="color: #990000">=</span> ajv<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">compile</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> status <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">schemaCheck</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span>status<span style="color: #990000">:</span>status<span style="color: #990000">,</span>errors<span style="color: #990000">:</span>schemaCheck<span style="color: #990000">.</span>errors<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="sect4 xxx">
<h5 id="_validating_xml_messages_with_xml_schema">4.12.3.1. Validating XML messages with XML Schema</h5>
<div class="paragraph"><p>There are similar options for handling XML validations, too, via XML Schema documents and tooling. There are a handful of approaches, depending on your platform.</p></div>
<div class="paragraph"><p>Using the same example, here&#8217;s the XML Schema for filtering company records:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:schema</span></span> <span style="color: #009900">attributeFormDefault</span><span style="color: #990000">=</span><span style="color: #FF0000">"unqualified"</span> <span style="color: #009900">elementFormDefault</span><span style="color: #990000">=</span><span style="color: #FF0000">"qualified"</span>
  <span style="color: #009900">xmlns:xs</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.w3.org/2001/XMLSchema"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:element</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"message"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:complexType&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:all&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:element</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"status"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"xs:string"</span>
          <span style="color: #009900">minOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">maxOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>#<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:element</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"companyName"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"xs:string"</span>
          <span style="color: #009900">minOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">maxOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>#<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:element</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"stateProvince"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"xs:string"</span>
          <span style="color: #009900">minOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">maxOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>#<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;xs:element</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"country"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"xs:string"</span>
          <span style="color: #009900">minOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">maxOccurs</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>#<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/xs:all&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/xs:complexType&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/xs:element&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/xs:schema&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For more on the world of XML and XSD, check out <a href="https://www.w3.org/TR/xmlschema">XML Schema</a> and <a href="https://www.w3.org/TR/xmlschema11-1">XML Schema 1.1</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>And here&#8217;s a sample XML message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&lt;message&gt;
  &lt;status&gt;pending&lt;/status&gt;
  &lt;country&gt;CA&lt;/country&gt;
&lt;/message&gt;</code></pre>
</div></div>
<div class="paragraph"><p>And then here&#8217;s a simple example of runtime validation in client code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xsd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">require</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'libxmljs2-xsd'</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">xmlMessageCheck</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">,</span> message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> schemaCheck<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> status <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
    schemaCheck <span style="color: #990000">=</span> xsd<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseFile</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">);</span>
    status <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #FF0000">{</span>
    status <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
    errors <span style="color: #990000">=</span> schemaCheck<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">validate</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span>status<span style="color: #990000">:</span>status<span style="color: #990000">,</span>errors<span style="color: #990000">:</span>errors<span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This sample relies on a node module based on the <a href="https://oreil.ly/MqnEO">Linux <code>xmllib</code> library</a>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_validating_forms_with_json_schema">4.12.3.2. Validating FORMS with JSON Schema</h5>
<div class="paragraph"><p>Validating <code>application/x-www-form-urlencoded</code> message bodies takes a bit more work, but as long as the message bodies are simple, you can convert the <code>application/x-www-form-urlencoded</code> messages into JSON and then apply a JSON Schema document against the results:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">const</span></span> qs <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">require</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'querystring'</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * read JSON schema doc from external source</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * send in form-urlencoded string</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * convert data into JSON and forward to json checker</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * return results from json checker</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">formJSONValidator</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">,</span> formData<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> jsonData <span style="color: #990000">=</span> qs<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>formData<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">jsonMessageCheck</span></span><span style="color: #990000">(</span>schema<span style="color: #990000">,</span> jsonData<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> results <span style="font-style: italic"><span style="color: #9A1900">// {status:status,schema.errors}</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that this routine depends on the <code>jsonMessageCheck</code> method seen earlier in this section.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_23">4.12.4. Discussion</h4>
<div class="paragraph"><p>Services should make all required schemas available online and link to them in every interaction that relies on validated messages. This means that client applications should look for schema references in services responses. Common locations are shown here.</p></div>
<div class="paragraph"><p>In the HTTP link header:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
GET /api.example.org/users/search HTTP/1.1
Accept: application/forms+json;

*** RESPONSE
200 OK HTTP/1.1
Content-Type: application/forms+json;
Link: &lt;schemas.example.org/service1/user-schema.json&gt;; profile=schema

{...}</code></pre>
</div></div>
<div class="paragraph"><p>As part of the response body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "id" : "<span style="color: #FF0000">za1xs2cd3</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">search</span>"<span style="color: #990000">,</span>
  "schema" : "<span style="color: #FF0000">api.example.org/schemas/user-search.json</span>"<span style="color: #990000">,</span>
  "links" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>
      "id" : "<span style="color: #FF0000">q1w2e3r4</span>"
      "name" : "<span style="color: #FF0000">user</span>"<span style="color: #990000">,</span>
      "href" : "<span style="color: #FF0000">http://api.example.org/q1w2e3r4</span>"<span style="color: #990000">,</span>
      "title" : "<span style="color: #FF0000">User Search</span>"<span style="color: #990000">,</span>
      "method" : "<span style="color: #FF0000">GET</span>"<span style="color: #990000">,</span>
      "properties": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name":"<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value":""<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name":"<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value":""<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name":"<span style="color: #FF0000">sms</span>"<span style="color: #990000">,</span> "value":""<span style="color: #990000">},</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  ...
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Validating message bodies using JSON/XML Schema can be tricky. For example, JSON Schema is much more forgiving than XML Schema. While there are some tools that support converting XML Schema to JSON Schema at runtime, it rarely works out well. It is best to continue to write schemas in their native format.</p></div>
<div class="paragraph"><p>The trick of converting <code>application/x-www-form-urlencoded</code> to JSON works well as long as the resulting JSON is treated as simple name/value pairs. Most FORMs-formatted messages follow this pattern, but there are cases where services get creative with FORM field names that imply a nested hierarchy. For example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>user.familyName=mamund&amp;user.givenName=ramund&amp;user.sms=+12345678901</code></pre>
</div></div>
<div class="paragraph"><p>implies a server-side message that looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "user" : <span style="color: #990000">{</span>
    "familyName" :"<span style="color: #FF0000">mamund</span>"<span style="color: #990000">,</span>
    "givenName" :"<span style="color: #FF0000">ramund</span>"<span style="color: #990000">,</span>
    "sms" : "<span style="color: #FF0000">+12345678901</span>"
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As the service get more clever with naming patterns, the suggested trick of converting FORM strings to JSON documents gets less reliable. To avoid the problem, it may be better to write a code-based validator instead.</p></div>
<div class="paragraph"><p>In the best case, services will supply client application developers with properly written (and up-to-date) schema documents to use at runtime. If the target service does not do this, application developers should review the human-readable documentation for the service API and craft their own schema documents for use at runtime. These documents should be posted somewhere online (possibly behind a secured URL) that is reachable by client applications. Care must also be taken to keep these schema documents up-to-date as the service changes over time.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>When in doubt, write your own custom message checking code directly to avoid any problems with poorly written or inadequately maintained schema documents.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Well-crafted services will make sure that any schema changes to production services will remain backward compatible with previous editions of the service. However, client applications should be prepared for services that do not follow this principle. If the target service is particularly bad at maintaining backward compatibility, client applications may need to abandon runtime validation based on schema documents and instead write code-based validators to ensure compatibility going forward.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_23">4.12.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#clients-incoming">[clients-incoming]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-incoming">4.13. Using Document Queries to Validate <span class=".keep-together">Incoming Messages</span></h3>
<div class="paragraph"><p>When API client applications receive a response from a service, it is important that they validate the incoming data to make sure the response contains the expected data in the requested format. This is especially true for M2M interactions where the human agent rarely gets a chance to view and validate incoming messages.</p></div>
<div class="sect3">
<h4 id="_problem_23">4.13.1. Problem</h4>
<div class="paragraph"><p>How can an API client application consistently and safely confirm that the incoming service response contains the expected data in the requested format?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_23">4.13.2. Solution</h4>
<div class="paragraph"><p>API client applications should inspect incoming service responses on three levels:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Protocol
</dt>
<dd>
<p>
Does the response include the expected HTTP protocol-level details (HTTP status code, content-type, and any other important headers)?
</p>
</dd>
<dt class="hdlist1">
Structure
</dt>
<dd>
<p>
Is the response body (if it exists) made up of the expected structural elements? For example, is there an expected <code>title</code> property? Does the body contain one or more <code>link</code> elements with the expected <code>rel</code>, <code>name</code>, or other properties, and so forth?
</p>
</dd>
<dt class="hdlist1">
Value
</dt>
<dd>
<p>
Assuming the expected structural elements exist (e.g., links, forms, data properties), do those elements contain the expected <em>values</em>  (e.g., <code>rel="self"</code>)? In the case of data properties, do the elements contain the expected data types (string, integer, etc.), and are the values of the data properties within acceptable ranges? For example, do <code>Date</code> type properties contain valid calendar dates? Are numerical values within acceptable upper and lower bounds?
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For details on how to use schema documents to validate <em>outgoing</em> messages, see <a href="#clients-outgoing">[clients-outgoing]</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_example_22">4.13.3. Example</h4>
<div class="paragraph"><p>Here is a simplified version of validating the incoming message for protocol, structure, and values:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>url<span style="color: #990000">,</span> options<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> checks <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// protocol-level checks</span></span>
checks<span style="color: #990000">.</span>statusOK <span style="color: #990000">=</span> <span style="color: #990000">(</span>response<span style="color: #990000">.</span>statusCode<span style="color: #990000">===</span><span style="color: #993399">200</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">)</span>
checks<span style="color: #990000">.</span>contentTypeCollectionJSON <span style="color: #990000">=</span> <span style="color: #990000">(</span>
  response<span style="color: #990000">.</span>headers<span style="color: #990000">[</span><span style="color: #FF0000">"content-type"</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">toLowercase</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">indexOf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"vnd.collection+json"</span><span style="color: #990000">)</span>
  <span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  <span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>semanticTypeTaxes <span style="color: #990000">=</span> <span style="color: #990000">(</span>
  response<span style="color: #990000">.</span>headers<span style="color: #990000">[</span><span style="color: #FF0000">"profile-type"</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">toLowercase</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">indexOf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"taxes.v1.alps"</span><span style="color: #990000">)</span>
  <span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  <span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// structural checks</span></span>
checks<span style="color: #990000">.</span>body <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>body<span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>submitLink <span style="color: #990000">=</span> <span style="color: #990000">(</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"submit"</span><span style="color: #990000">).</span>length<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>rejectLink <span style="color: #990000">=</span> <span style="color: #990000">(</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"reject"</span><span style="color: #990000">).</span>length<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>countryCode <span style="color: #990000">=</span> <span style="color: #990000">(</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"countryCode"</span><span style="color: #990000">).</span>length<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>stateProvince <span style="color: #990000">=</span> <span style="color: #990000">(</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"stateProvince"</span><span style="color: #990000">).</span>length<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>salesTotal <span style="color: #990000">=</span> <span style="color: #990000">(</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"salesTotal"</span><span style="color: #990000">).</span>length<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">?</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// value checks</span></span>
checks<span style="color: #990000">.</span>submit <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>submitLink<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #FF0000">"href"</span><span style="color: #990000">,</span><span style="color: #FF0000">"method"</span><span style="color: #990000">,</span><span style="color: #FF0000">"encoding"</span><span style="color: #990000">]);</span>
checks<span style="color: #990000">.</span>reject <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>rejectLink<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #FF0000">"href"</span><span style="color: #990000">,</span><span style="color: #FF0000">"method"</span><span style="color: #990000">,</span><span style="color: #FF0000">"encoding"</span><span style="color: #990000">]);</span>
checks<span style="color: #990000">.</span>country <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>countryCode<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">],</span>filters<span style="color: #990000">.</span>taxRules<span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>stateProv <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>stateProvince<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">],</span>filters<span style="color: #990000">.</span>taxRules<span style="color: #990000">);</span>
checks<span style="color: #990000">.</span>salesTotal <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>salesTotal<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #FF0000">"value"</span><span style="color: #990000">],</span>filters<span style="color: #990000">.</span>taxRules<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// do computation</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">validMessage</span></span><span style="color: #990000">(</span>checks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">computeTaxes</span></span><span style="color: #990000">(</span>checks<span style="color: #990000">);</span>
  checks<span style="color: #990000">.</span>taxes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">checkProperties</span></span><span style="color: #990000">(</span>taxes<span style="color: #990000">,</span>filters<span style="color: #990000">.</span>taxRules<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// send results</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">validMessage</span></span><span style="color: #990000">(</span>checks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  message <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">formBody</span></span><span style="color: #990000">(</span>checks<span style="color: #990000">.</span>submit<span style="color: #990000">,</span> checks<span style="color: #990000">.</span>taxes<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
  message <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">formBody</span></span><span style="color: #990000">(</span>checks<span style="color: #990000">.</span>reject<span style="color: #990000">,</span>checks<span style="color: #990000">.</span>taxes<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>taxMessage<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>You can also see that, after all the checks are made (and assuming they all pass), the code performs the expected task (computing taxes) and submits the results. It is easy to see from this example that most of the coding effort is in safely validating the incoming message before doing a small bit of work. This is a <em>feature</em> of well-built API client applications, especially in M2M cases.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_24">4.13.4. Discussion</h4>
<div class="paragraph"><p>Although the example is verbose, it should be noted that much of this code can be generated instead of handcoded. This can greatly reduce the effort needed to compose a well-formed API client, and improve the safety and consistency of the application at runtime.</p></div>
<div class="sect4 xxx">
<h5 id="_do_not_rely_on_schemas">4.13.4.1. Do not rely on schemas</h5>
<div class="paragraph"><p>You may be surprised to see that I am not suggesting the use of schema documents (JSON Schema, XML Schema, etc.) for validating incoming messages. In my experience, applying schemas (particularly strict schemas) to incoming messages results in too many false negatives—rejections of messages that fail the schema but could still be successfully and safely processed by the client. This is especially true in the case of XML Schema, which is strict by default. Even valid items in a different order in the document can result in a failed schema review. Schemas also don&#8217;t cover the protocol-level checks that are needed.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_consider_using_json_xml_path_queries">4.13.4.2. Consider using JSON/XML path queries</h5>
<div class="paragraph"><p>The example relies on some features of JavaScript to perform filtering checks. These lines of code can be replaced by a more generic solution using JSON Path queries. I use a JavaScript/NodeJS library called <a href="https://oreil.ly/y3dli">JSON Path-Plus</a> for this task. However, caution is advised here since, as of this writing, the JSONPath specification at <a href="https://oreil.ly/vL1yy">IETF</a> is still incomplete and will likely change <span class=".keep-together">significantly</span>.</p></div>
<div class="paragraph"><p>The <a href="https://oreil.ly/UbIwj">XML Path specification</a>, however, is quite mature and a very reliable source for checking XML-formatted messages. There is even ongoing work at the W3C to expand the scope of XML Path <a href="https://oreil.ly/uKBDe">version 3.1</a> to include support for JSON queries.</p></div>
<div class="paragraph"><p>See more on filtering incoming messages in <a href="#clients-inputs">[clients-inputs]</a>.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_24">4.13.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#clients-outgoing">[clients-outgoing]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-inputs">4.14. Validating Incoming Data</h3>
<div class="paragraph"><p>When creating API clients it is important to know how to deal with incoming messages. Essentially, every service response should be assumed to be dangerous until proven otherwise. The message may contain malicious data, smuggled scripts for execution, and/or just plain bad data that might cause the client application to <span class=".keep-together">misbehave</span>.</p></div>
<div class="paragraph"><p>Having a strategy for safely dealing with incoming payloads is essential to building a successful API ecosystem. This is especially true in ecosystems where M2M communication exists, since humans will have reduced opportunities to inspect and correct or reject questionable content.</p></div>
<div class="sect3">
<h4 id="_problem_24">4.14.1. Problem</h4>
<div class="paragraph"><p>How can client applications make sure the incoming message does not contain <span class=".keep-together">dangerous</span> or malicious content?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_24">4.14.2. Solution</h4>
<div class="paragraph"><p>API client applications should carefully inspect incoming messages (service responses) and remove or ignore any dangerous content. This can be done by relying on a few basic principles when coding the client application:</p></div>
<div class="ulist"><ul>
<li>
<p>
Always filter incoming data.
</p>
</li>
<li>
<p>
Rely on the "allow list" model instead of "deny list" for approving <span class=".keep-together">content</span>.
</p>
</li>
<li>
<p>
Maintain a "min/max" for all data values and reject any data outside that range.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These general rules are supported by another line of defense for client applications: <em>syntactic</em> validation (based on the expected data type) and <em>semantic</em> validation (based on the expected value of that data type). Examples of syntactic validation are complex types such as postal codes, telephone numbers, personal identity numbers (US Social Security numbers, etc.) and other similar predefined types. Your client application should be able to identify when these types of data are expected to appear and know how to validate the <em>structure</em> of these data types. For example, US postal codes are made up of two sets of digits: first a required five digits and then—optionally—a dash and four more digits. Well-designed message formats provide this kind of data type information in the response at runtime.</p></div>
<div class="admonitionblock warning1">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The basic premise that API clients should adopt is "defend yourself at all costs—including to the point of refusing to process the request altogether."  This flies a bit in the face of Postel&#8217;s Law (aka the robustness principle), but for a good reason. API clients should only pay attention to content values they already understand, should make sure the values are reasonable, and only perform predetermined operations on those fields.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Client applications should also do their best to validate the <em>semantic</em> value of the message content. For example, if a date range is provided—for example: <code>startDate</code> and <code>stopDate</code>—it is important to validate that the value for <code>startDate</code> is earlier than the value supplied for <code>stopDate</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_23">4.14.3. Example</h4>
<div class="paragraph"><p>Collection+JSON is an example of this kind of support for syntactic type information:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>{"collection" :
  {
    ...
    "items" : [
      {
        "rel" : "item person"
        "href" : "http://example.org/friends/jdoe",
        "data" : [
          {"name" : "full-name", "value" : "J. Doe",
            "prompt" : "Full Name", "type" : "string"},
          {"name" : "email", "value" : "jdoe@example.org",
            "prompt" : "Email", "type" : "email"},
          {"name" : "phone", "value" : "123-456-7890",
            "prompt" : "Telephone", "type" : "telephone"}
          {"name" : "birthdate", "value" : "1990-09-30",
            "prompt" : "Birthdate", "type" : "date"}
        ]
      }
    ]
    ...
  }
}</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_25">4.14.4. Discussion</h4>
<div class="paragraph"><p>Not many representation formats automatically include data type and range metadata for content values. Where possible, try to convince the services your client application uses to add this information as runtime metadata. Formats that do a pretty good job at this are JSON-LD, UBER, Collection+JSON, and any of the RDF formats.</p></div>
<div class="paragraph"><p>For cases where the type/range metadata is not available at runtime, client developers should scan the existing human-readable documentation and create their own content metadata to apply to incoming messages. While this external source might fall out of sync over time (when the human-readable documents are updated), having a machine-readable set of content filtering rules is still quite valuable.</p></div>
<div class="paragraph"><p>Here is an example of possible type and range metadata for a client that computes sales and VAT taxes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filters <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span>
filters<span style="color: #990000">.</span>taxRules <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  country<span style="color: #990000">:</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"type"</span><span style="color: #990000">:</span><span style="color: #FF0000">"enum"</span><span style="color: #990000">,</span><span style="color: #FF0000">"value"</span><span style="color: #990000">:[</span><span style="color: #FF0000">"CA"</span><span style="color: #990000">,</span><span style="color: #FF0000">"GL"</span><span style="color: #990000">,</span><span style="color: #FF0000">"US"</span><span style="color: #FF0000">}</span><span style="color: #990000">],</span>
  stateProvince<span style="color: #990000">:</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"type"</span><span style="color: #990000">:</span><span style="color: #FF0000">"enum"</span><span style="color: #990000">,</span><span style="color: #FF0000">"value"</span><span style="color: #990000">:[...]</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  salesTotal<span style="color: #990000">:</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"type"</span><span style="color: #990000">:</span><span style="color: #FF0000">"range"</span><span style="color: #990000">,</span><span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"min"</span><span style="color: #990000">:</span><span style="color: #FF0000">"0"</span><span style="color: #990000">,</span><span style="color: #FF0000">"max"</span><span style="color: #990000">:</span><span style="color: #FF0000">"1000000"</span><span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When receiving a response message, it is a good practice to create an internal, filtered representation of that message and only allow your own code to operate on the filtered representation—not the original. This reduces the chances that your application will mistakenly ingest improperly formed data and limits the possible risk to your application.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// make request, pull body, and scrub</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> reponse <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>url<span style="color: #990000">,</span> options<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">filterResponse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>body<span style="color: #990000">,</span> filters<span style="color: #990000">.</span>taxRules<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, the <code>message</code> variable contains content deemed safe for the application to use. Note that the <code>filterResponse()</code> routine can perform a number of operations. First, it should only look for content that is interesting for this client application. For example, if this client computes sales or value-added taxes, it might only need to pay attention to the fields <code>country</code>, <code>stateProvince</code>, and <code>salesTotal</code>. This filter may only return those fields while making sure the values in them are "safe." For example, the <code>country</code> field contains one of a list of valid ISO country codes, etc. The results can be used to format another message to use in future requests.</p></div>
<div class="paragraph"><p>Note that in this example, additional <em>semantic</em> validation is needed to make sure that both the <code>country</code> and <code>stateProvince</code> values are compatible. For example, <code>country="CA"</code> and <code>stateProvince="KY"</code> would be semantically invalid.</p></div>
<div class="paragraph"><p>Finally, there may be cases where an API client has the job of accepting a working document, performing some processing on that document, updating it, and sending the document along to another application or service. In these instances, it is still a good idea to filter the content of the document down to just the fields your API client needs to deal with, validate those values, perform the operation, and then update the original document with the results before passing it along.  Your API client is <em>not</em> in charge of scrubbing the whole document that is to be passed along, however. Your only responsibility is to pull the fields, clean them, do the work, and then update the original document. You should assume that any other applications that work on this document are doing the same level of self-protection.</p></div>
<div class="paragraph"><p>Here is a simplified example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processTaxes</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>args<span style="color: #990000">.</span>readUrl<span style="color: #990000">,</span> args<span style="color: #990000">.</span>readOptions<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">filterResponse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>body<span style="color: #990000">,</span>args<span style="color: #990000">.</span>rules<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>message<span style="color: #990000">.</span>status<span style="color: #990000">!==</span><span style="color: #FF0000">"error"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">computeTaxes</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">invalidMessage</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>

  options<span style="color: #990000">.</span>requestBody <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">updateBody</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>body<span style="color: #990000">,</span> message<span style="color: #990000">);</span>
  response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>args<span style="color: #990000">.</span>writeUrl<span style="color: #990000">,</span> args<span style="color: #990000">.</span>writeOptions<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>For more on scrubbing incoming data, check out the <a href="https://oreil.ly/haoIb">OWASP Input Validation Cheat Sheet</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_25">4.14.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#clients-outgoing">[clients-outgoing]</a>
</p>
</li>
<li>
<p>
<a href="#clients-incoming">[clients-incoming]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-state">4.15. Maintaining Your Own State</h3>
<div class="paragraph"><p>In a RESTful system, it can be a challenge to locate and access the transient state of requests and responses. There are only three possible places for this kind of information: server, client, and messages passed between server and client. Which option is best under what circumstances?</p></div>
<div class="sect3">
<h4 id="_problem_25">4.15.1. Problem</h4>
<div class="paragraph"><p>How can a client successfully track the transient state of server and client interactions? Where does the application state reside when a single client application is talking to multiple server-side components?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_25">4.15.2. Solution</h4>
<div class="paragraph"><p>The safest place to keep the transient state—the state of the application as defined by runtime requests and responses—is in the client. The client is responsible for selecting which servers are engaged in interactions, and the client is initiating HTTP requests. It is the client, and only the client, that has the most accurate picture of the state of the application. This is especially true when the client has enlisted multiple services (services unrelated to each other) to accomplish a task or goal.</p></div>
<div class="paragraph"><p>The easiest way to do this is for the client application to keep a detailed history of each request/response interaction and select (or compute) important application state data from that history. Most programming tools support serializing HTTP streams.</p></div>
<div class="paragraph"><p>Typically, the following elements should be captured and stored by the client:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Request elements
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
URL
</p>
</li>
<li>
<p>
Method
</p>
</li>
<li>
<p>
Headers
</p>
</li>
<li>
<p>
Query string
</p>
</li>
<li>
<p>
Request body
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
Response elements
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
URL
</p>
</li>
<li>
<p>
Status
</p>
</li>
<li>
<p>
Content-type
</p>
</li>
<li>
<p>
Headers
</p>
</li>
<li>
<p>
Body
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="paragraph"><p>Note that the URL value from the request might not be the same as the URL of the response. This might be due to an incomplete request URL (e.g., missing the protocol element: <code>api.example.org/users</code>) or as a result of server-side redirection.</p></div>
</div>
<div class="sect3">
<h4 id="_example_24">4.15.3. Example</h4>
<div class="paragraph"><p>The following is a snippet of code from the HyperCLI client application that manages the request and response elements of HTTP interactions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">...</span>
  <span style="font-style: italic"><span style="color: #9A1900">// collect request info for later</span></span>
  requestInfo <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  requestInfo<span style="color: #990000">.</span>url <span style="color: #990000">=</span> url<span style="color: #990000">;</span>
  requestInfo<span style="color: #990000">.</span>method <span style="color: #990000">=</span> method<span style="color: #990000">;</span>
  requestInfo<span style="color: #990000">.</span>query <span style="color: #990000">=</span> query<span style="color: #990000">;</span>
  requestInfo<span style="color: #990000">.</span>headers <span style="color: #990000">=</span> headers<span style="color: #990000">;</span>
  requestInfo<span style="color: #990000">.</span>body <span style="color: #990000">=</span> body<span style="color: #990000">;</span>

  <span style="font-style: italic"><span style="color: #9A1900">// make the actual call</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>body <span style="color: #990000">&amp;&amp;</span> method<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toUpperCase</span></span><span style="color: #990000">()!==</span><span style="color: #FF0000">"GET"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>method<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toUpperCase</span></span><span style="color: #990000">()===</span><span style="color: #FF0000">"DELETE"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> url<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>headers<span style="color: #990000">:</span>headers<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> url<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>headers<span style="color: #990000">:</span>headers<span style="color: #990000">,</span> body<span style="color: #990000">:</span>body<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>body<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      url <span style="color: #990000">=</span> url <span style="color: #990000">+</span> querystring<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">stringify</span></span><span style="color: #990000">(</span>body<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> url<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>headers<span style="color: #990000">:</span>headers<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  response<span style="color: #990000">.</span>requestInfo <span style="color: #990000">=</span> requestInfo<span style="color: #990000">;</span>
  responses<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>response<span style="color: #990000">);</span>
 <span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>This code creates a push-down stack that holds information on each HTTP interaction. The same client application can now recall the history of interactions and use the request and response details to make decisions on how to proceed.</p></div>
<div class="paragraph"><p>Here is the <code>SHOW HELP</code> output for the <code>DISPLAY</code> command that returns details on the available HTTP interaction history:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>DISPLAY|SHOW (synonyms)
  REQUEST (returns request details - URL, Headers, querystring, method, body)
  URL (returns the URL of the current response)
  STATUS|STATUS-CODE (returns the HTTP status code of the current response)
  CONTENT-TYPE (returns the content-type of the current response)
  HEADERS (returns the HTTP headers of the current response)
  PEEK (displays the most recent response on the top of the stack)
  POP (pops off [removes] the top item on the response stack)
  LENGTH|LEN (returns the count of the responses on the response stack)
  CLEAR|FLUSH (clears the response stack)
  PATH &lt;jsonpath-string|$#&gt; (applies the JSON Path query to current response)</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For more on HyperLANG and the HyperCLI, see <a href="#hyper">[hyper]</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_26">4.15.4. Discussion</h4>
<div class="paragraph"><p>Keeping track of HTTP requests and responses takes a bit of work to set up but results in a very powerful feature for client applications. To lower the cost of supporting this functionality, it can be helpful to create a reusable library that just handles the request/response stack and share that in all client-side HTTP applications.</p></div>
<div class="paragraph"><p>Just tracking the interactions on the stack is usually not enough functionality for clients. You&#8217;ll also need to monitor selected values and keep track of them as "state variables." You can see from the previous example that the suggested functionality includes the use of JSON Path as a way to inspect and select properties from within a single request/response pair. You can use something like this to monitor important state values, too.  See <a href="#clients-goals">[clients-goals]</a> for more on tracking important client-side variables.</p></div>
<div class="paragraph"><p>If you are working with a client application that does not manage its own file space (e.g., a web browser), you can set up an external service that will track the HTTP interactions and serve them up remotely (via HTTP!). This offers the same functionality but relies on a live HTTP connection between the client and the interaction service. That means the service might be a bit slower than a native file-based system and the service might be unavailable due to network problems between the client and the interaction service.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_26">4.15.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#clients-goals">[clients-goals]</a>
</p>
</li>
<li>
<p>
<a href="#data-ignore">[data-ignore]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="clients-goals">4.16. Having a Goal in Mind</h3>
<div class="paragraph"><p>There are times when the client application needs to continue running (making requests, performing work, sending updates, etc.) until a certain goal is reached (a queue is empty, the total has reached the proper level, etc.). This is especially true for client apps that have some level of autonomy or automated processing. There are some challenges to this, including cases where the <em>client</em> knows the goal but the <em>service(s)</em> being used by that client do not.</p></div>
<div class="sect3">
<h4 id="_problem_26">4.16.1. Problem</h4>
<div class="paragraph"><p>How do you program a client application to continue processing until some goal is reached? Also, what does it take to create client applications that have a goal that is "private" and not shared or understood by any services?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_26">4.16.2. Solution</h4>
<div class="paragraph"><p>To build client applications that can continue operations until a goal is reached, you need to program some level of autonomy for that client. The application needs to know what property (or properties) to monitor, know the target value(s) for the selected properties, be able to locate and monitor the values over time, and know when an end has been reached and how to effect a stop in processing.</p></div>
<div class="paragraph"><p>Programming this solution is essentially the work of most gaming engines or autonomous robot systems. Client applications can follow the classic artificial intelligence <a href="https://oreil.ly/5rwjg">PAGE model</a>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Percepts
</dt>
<dd>
<p>
The properties that need to be monitored.
</p>
</dd>
<dt class="hdlist1">
Actions
</dt>
<dd>
<p>
The tasks clients can commit to affect the values of the properties (read, write, compute).
</p>
</dd>
<dt class="hdlist1">
Goals
</dt>
<dd>
<p>
The desired end values.
</p>
</dd>
<dt class="hdlist1">
Environment
</dt>
<dd>
<p>
The playing field or game space in which the client operates. In our case, this would be the services with  which the client interacts in order to see and affect the Percepts on the way to achieving the Goals.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_example_25">4.16.3. Example</h4>
<div class="paragraph"><p>There are a couple of different types of goal models you are likely to need: a defined exit goal (DEG) and a defined state goal (DSG). Each takes a slightly different programming construct.</p></div>
<div class="sect4 xxx">
<h5 id="_defined_exit_goal">4.16.3.1. Defined exit goal</h5>
<div class="paragraph"><p>With DEGs, you write a program that halts or exits some process once the defined goal is reached. The following example was taken from an autonomous hypermedia client that navigates its way out of an undetermined maze:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processLinks</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span>headers<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xml<span style="color: #990000">,</span>linkItem<span style="color: #990000">,</span>i<span style="color: #990000">,</span>rel<span style="color: #990000">,</span>url<span style="color: #990000">,</span>href<span style="color: #990000">,</span>flg<span style="color: #990000">,</span>links<span style="color: #990000">,</span>rules<span style="color: #990000">;</span>

  flg <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
  links <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  rules <span style="color: #990000">=</span> <span style="color: #990000">[];</span>

  <span style="font-style: italic"><span style="color: #9A1900">// get all the links in this document</span></span>
  g<span style="color: #990000">.</span>linkCollection <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  xml <span style="color: #990000">=</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">selectNodes</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'//link'</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">(</span>i<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">;</span>i<span style="color: #990000">&lt;</span>xml<span style="color: #990000">.</span>length<span style="color: #990000">;</span>i<span style="color: #990000">++)</span>
  <span style="color: #FF0000">{</span>
    rel <span style="color: #990000">=</span> xml<span style="color: #990000">[</span>i<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">getAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'rel'</span><span style="color: #990000">);</span>
    url <span style="color: #990000">=</span> xml<span style="color: #990000">[</span>i<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">getAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'href'</span><span style="color: #990000">);</span>
    linkItem <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">'rel'</span><span style="color: #990000">:</span>rel<span style="color: #990000">,</span><span style="color: #FF0000">'href'</span><span style="color: #990000">:</span>url<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    g<span style="color: #990000">.</span>linkCollection<span style="color: #990000">[</span>g<span style="color: #990000">.</span>linkCollection<span style="color: #990000">.</span>length<span style="color: #990000">]</span> <span style="color: #990000">=</span> linkItem<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// is there an exit?</span></span>
  href <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">getLinkElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'exit'</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>href<span style="color: #990000">!=</span><span style="color: #FF0000">''</span><span style="color: #990000">)</span>
  <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">printLine</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'*** Done! '</span><span style="color: #990000">+</span>href<span style="color: #990000">);</span>
    g<span style="color: #990000">.</span>done <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// is there an entrance?</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>flg<span style="color: #990000">==</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #990000">&amp;&amp;</span> g<span style="color: #990000">.</span>start<span style="color: #990000">==</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">)</span>
  <span style="color: #FF0000">{</span>
    href <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">getLinkElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'start'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>href<span style="color: #990000">!=</span><span style="color: #FF0000">''</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      flg<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
      g<span style="color: #990000">.</span>start<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
      g<span style="color: #990000">.</span>href <span style="color: #990000">=</span> href<span style="color: #990000">;</span>
      g<span style="color: #990000">.</span>facing <span style="color: #990000">=</span> <span style="color: #FF0000">'north'</span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #000000">printLine</span></span><span style="color: #990000">(</span>href<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ok, let's go through a door</span></span>
  rules <span style="color: #990000">=</span> g<span style="color: #990000">.</span>rules<span style="color: #990000">[</span>g<span style="color: #990000">.</span>facing<span style="color: #990000">];</span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">(</span>i<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">;</span>i<span style="color: #990000">&lt;</span>rules<span style="color: #990000">.</span>length<span style="color: #990000">;</span>i<span style="color: #990000">++)</span>
  <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>flg<span style="color: #990000">==</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      href<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #000000">getLinkElement</span></span><span style="color: #990000">(</span>rules<span style="color: #990000">[</span>i<span style="color: #990000">]);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>href<span style="color: #990000">!=</span><span style="color: #FF0000">''</span><span style="color: #990000">)</span>
      <span style="color: #FF0000">{</span>
        flg<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
        g<span style="color: #990000">.</span>facing<span style="color: #990000">=</span>rules<span style="color: #990000">[</span>i<span style="color: #990000">];</span>
        <span style="font-weight: bold"><span style="color: #000000">printLine</span></span><span style="color: #990000">(</span>href<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">continue</span></span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// update pointer, handle next move</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>href<span style="color: #990000">!=</span><span style="color: #FF0000">''</span><span style="color: #990000">)</span>
  <span style="color: #FF0000">{</span>
    g<span style="color: #990000">.</span>href <span style="color: #990000">=</span> href<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">nextMove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the client application has a goal of "finding the exit" and continues to move from room to room until that goal is reached.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_defined_state_goal">4.16.3.2. Defined state goal</h5>
<div class="paragraph"><p>There are cases when you need to program a client application to maintain a desired state—a DSG. For example, you need a client app to monitor the temperature of a room and activate heating/cooling units to maintain that state. Here is a snippet of code designed to do that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// set control values</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> roomURL <span style="color: #990000">=</span> <span style="color: #FF0000">"http://api.example.org/rooms/13"</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> min <span style="color: #990000">=</span> <span style="color: #993399">18</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> max <span style="color: #990000">=</span> <span style="color: #993399">22</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> wait <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #993399">15</span><span style="color: #990000">*</span><span style="color: #993399">60</span><span style="color: #990000">*</span><span style="color: #993399">1000</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// set up periodic checks</span></span>
<span style="font-weight: bold"><span style="color: #000000">setInterval</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">checkTemp</span></span><span style="color: #990000">(</span>roomURL<span style="color: #990000">,</span>min<span style="color: #990000">,</span>max<span style="color: #990000">),</span>wait<span style="color: #990000">));</span>

<span style="font-style: italic"><span style="color: #9A1900">// do the check</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">checkTemp</span></span><span style="color: #990000">(</span>roomURL<span style="color: #990000">,</span> minTemp<span style="color: #990000">,</span> maxTemp<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rtn<span style="color: #990000">,</span> temp<span style="color: #990000">;</span>

  rtn <span style="color: #990000">=</span> <span style="color: #FF0000">""</span><span style="color: #990000">;</span>
  response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>roomURL<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">printLine</span></span><span style="color: #990000">(</span>req<span style="color: #990000">)</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>temp<span style="color: #990000">&lt;</span>minTemp<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    rtn <span style="color: #990000">=</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">form</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"heat"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>temp<span style="color: #990000">&gt;</span>maxTemp<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    rtn <span style="color: #990000">=</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">form</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"cool"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>rtn<span style="color: #990000">!==</span><span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>rtn<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">printLine</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the simple DSG, the application is tasked to maintain a room temperature between 18ºC and 22ºC. The temperature is monitored every 15 minutes and, if needed, adjusted accordingly.  Of course the service used by this client doesn&#8217;t know what the client has in mind, it just responds with the information about the requested room when asked. You can see in this example that the response from the service includes data on the temperature (<code>req.temp</code>) as well as hypermedia controls to modify the state of the temperature (<code>req.form("heat")</code> and <code>req.form("cool")</code>).  It is worth pointing out that the monitoring service (<code>http://api.example.org/rooms</code>) might not know anything about how to adjust the room temperature—that might be handled by separate services, too.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_27">4.16.4. Discussion</h4>
<div class="paragraph"><p>Coding goal-oriented clients (DEGs and DSGs) assumes a few key things. First, that the client "knows" the end goal ahead of time. Second, that the client already knows how to achieve this goal (finding the exit, adjusting the temp, etc.). Third, the client can find an accurate representation of the current state, and fourth, is able to properly evaluate the current state against the desired goal. All of these elements <em>must</em> be present for the goal-oriented client to be successful.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For this recipe, the client examples (DEG and DSG) assume that all the planning and criteria for evaluation are determined ahead of time and/or supplied when the client starts (via a config file). No machine learning or planning skills are built into the client application here.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In the DSG temperature example, the client knows that the end goal is a room temp between 18ºC and 22ºC. It also knows it can use the "heat" and "cool" forms in an HTTP response to achieve the goal. The client also knows that it can use the room URL to check on the current temperature, and knows how to evaluate the returned temp to its own internal minimum and maximum values.</p></div>
<div class="paragraph"><p>Sometimes the evaluation step is more involved. For example, in the temperature management case, maybe the temperature settings are different at different times of the day, or if there are (or are not) people in the room, or based on the current cost per kilowatt per hour, etc.  In these cases, there may be more values to monitor and use in a more involved comparison routine before taking the determined action.</p></div>
<div class="paragraph"><p>It might also be the case that the evaluation is handled by another service (not the client). For example, a stock buy/sell decision might come from a service that accepts a wide range of inputs (which your client may supply), then returns an action recommendation that the client application then executes.</p></div>
<div class="paragraph"><p>Whenever possible, it is a good idea to make both the properties to monitor and the local evaluation values a configurable set of data points. This avoids hardcoding decision-making data into the client application itself. You could, for example, provide the client with the control data via a configuration file or even a remote HTTP call to another service that holds configuration data.</p></div>
<div class="paragraph"><p>Finally, it is important to add an escape option for goal-oriented client applications. For example, if the DEG can&#8217;t find an exit to the maze, it will probably need to give up after some point or be forever trapped in a loop. This escape value should be completely controlled by the client, too. Depending on some other service for the decision to escape could fail if the remote service is unavailable or sending bad data to the <span class=".keep-together">client</span>.</p></div>
<div class="paragraph"><p>The same is true for DSG-style client applications. In our temperature monitor example, imagine that the service that returns the sensor data is broken or unavailable. What does the client do? Does it just keep checking in vain? A better option is to add some code that triggers an alert when the sensors are not responding or if they report data far outside the assumed boundaries.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_27">4.16.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#services-media-types">[services-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#data-ignore">[data-ignore]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="services">5. RESTful Services</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>The best software architecture "knows" what changes often and makes that easy.</q></p>
<p data-type="attribution">Paul Clements,
<span class="roman">Software Architecture in Practice</span> (Pearson)</p>
</blockquote>
<div class="paragraph"><p>A primary challenge in designing and implementing APIs for services is balancing usability with evolvability. It is important for service APIs to be clear and easy to understand. At the same time it is critical that these same interfaces be defined in a way that allows for future modifications. Finally, the value of service APIs is often tied to their <em>reliability over time</em>. It&#8217;s fine to be able define an API that solves an immediate problem. But as that problem varies over time, operating parameters change, and needs and goals drift over time, that API—ideally—should continue to be useful. That&#8217;s a lot to ask of a service interface design!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Check out <a href="#background-services">[background-services]</a> for additional discussion on the foundations of creating service interfaces.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>As the chapter&#8217;s opening quote implies, knowing what changes often in a software design and making that easy is a worthy goal. This is especially true for service APIs. The API is the contract—the promise that needs to be kept.</p></div>
<div class="paragraph"><p>A great example of this can be found in the way the HTTP protocol was designed. Almost every key aspect of HTTP is modifiable. HTTP methods, status codes, URLs, the list of possible headers, and the list of possible body formats are all abstract collections that can be amended over time. The <em>structure</em> of HTTP messages is consistent—that&#8217;s the promise. However the <em>content</em> of HTTP messages is variable—even, in some cases, the content of the <em>action control</em> information (e.g., HTTP methods, URLs, <span class=".keep-together">available</span> message formats, etc.). This is the key to creating stable, valuable APIs for services, and that&#8217;s what we&#8217;ll be talking about in this chapter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Since this book is focused on <em>interfaces</em>, we will not spend time in this chapter talking about the internal details of the services <em>behind</em> the interfaces. However, it is important to have a solid understanding of the inner workings of scalable, robust, and reliable services on the web. See <a href="#reading">[reading]</a> for some recommended material on designing and building services.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The recipes in this section of the book are all focused on making it easy to design and implement APIs that strike the right balance between specificity and evolvability. A key feature of this type of API is the ability to include operational metadata at runtime instead of relying solely on design and build-time descriptions. In our case, this ability to modify the messages at runtime will be driven using hypermedia formats that follow the same general design pattern of the HTTP protocol itself: a clear message structure to support variable contents.</p></div>
<div class="paragraph"><p>When creating service APIs, you need to balance the exposure and reliance on runtime and design-time metadata (see <a href="#fig0501">[fig0501]</a>).  Another key element in successful service interface implementation is the ability to support multiple representation formats via content negotiation.</p></div>
<div class="imageblock" id="fig0501">
<div class="content">
<img src="images/rwcb_0501.png" alt="images/rwcb_0501.png" width="80%" />
</div>
<div class="title">Figure 6. Hypermedia services recipes</div>
</div>
<div class="sect2">
<h3 id="services-stable-url">5.1. Publishing at Least One Stable URL</h3>
<div class="paragraph"><p>When services publish an interface on the network, these services need to be easily (and consistently) reached by API consumers. That means publishing your API at a stable location (using a URL). But does that mean you can never change the published location? And, if you can change it, how do you tell API consumers about this change?</p></div>
<div class="sect3">
<h4 id="_problem_27">5.1.1. Problem</h4>
<div class="paragraph"><p>How can you establish a stable network location (URL) for your service API, and what steps are needed to make sure your API is findable even if the underlying service has moved to a new location?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_27">5.1.2. Solution</h4>
<div class="paragraph"><p>Service interfaces should promise at least one stable URL that API consumers can use to locate and interact with the service behind that API. The exact URL does not matter. This should be the "starting point" of the API. It may be a resource that returns details about the API (including the entry point). It may be the initial listing or state of the service (e.g., the default list of users, etc.). Or it may be some other response that API consumers can rely upon to initiate access with the service (e.g., a login, a way to establish a stateful session, etc.).</p></div>
<div class="paragraph"><p>The value of the URL could be something as simple as <em>http://api.example.com/home</em> or as complicated as <em>http://v1.home.api.example.org/q1w2e3r4t5</em>. What matters is that there is at least one location that consumers can memorize (i.e., write into their source code or configuration files) that will ensure that the API consumer can connect with the service API. Finally, there is no requirement that a service API have <em>only one</em> published stable URL. However, your API should have <em>at least one</em> URL that API consumers can count on over time.</p></div>
<div class="paragraph"><p>Stable URLs should be published in the API human-readable documentation. They may also appear as a <a href="https://oreil.ly/tMGnn"><code>Link</code> header</a> in HTTP or as a <code>link</code> element in an API response body that supports inline <code>link</code> elements.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>In some cases, it might be wise to register a "well-known" URL for your service API. However, this is not a trivial effort. See <a href="https://oreil.ly/Rni9a">RFC 8615</a> and <a href="https://oreil.ly/8mhMG">RFC 7595</a> for details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Publishing a stable URL does not mean the service behind that URL cannot move. If the service moves, requests to the stable URL can be redirected to the new location using the HTTP status code <code>301 Moved Permanently</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_26">5.1.3. Example</h4>
<div class="paragraph"><p>When indicating your API&#8217;s stable URL in human-readable documentation, be sure to call it out as your API&#8217;s <em>promise</em> that the URL will be honored into the future and, if needed, will redirect API client applications to the new service location.</p></div>
<div class="paragraph"><p>You can use the <code>Link</code> header in an HTTP response to emit a stable URL for your API:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
GET / HTTP/1.1
Host: api.example.org

**** RESPONSE
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
ETag: "p0o9i8u7y6t5r4e3w2q1"
Link: &lt;http://api.example.org/home&gt;; rel="home"
...</code></pre>
</div></div>
<div class="paragraph"><p>The stable URL may also appear in the body of any (or all) responses that support inline links. Here is an example shown in a Collection+JSON response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://api.example.org/friends/</span>"<span style="color: #990000">,</span>

    "links" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel" : "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "href" : "<span style="color: #FF0000">http://api.example.org/home</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">],</span>

    "items" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
    "queries" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
    "template" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>When the service location moves, the API should continue to honor the originally published stable URL and automatically redirect the API consumer to the new location URL:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
GET / HTTP/1.1
Host: api.example.org

**** RESPONSE
HTTP/1.1 301 Moved Permanently
Location: http://new.example.org/home

**** REQUEST
GET /home HTTP/1.1
Host: new.example.org

**** RESPONSE
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
ETag: "p0o9i8u7y6t5r4e3w2q1"
Link: &lt;http://api.example.org/home&gt;; rel="home"
...</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_28">5.1.4. Discussion</h4>
<div class="paragraph"><p>Services interfaces should support <em>at least one</em> stable URL. Any stable URL is a promise to API consumers that should last the test of time. It is certainly possible to commit to promising more than one stable URL, but that just adds to the level of work API designers need to do to keep the long-term promises of <em>all</em> the stable URLs.</p></div>
<div class="paragraph"><p>Keep in mind that client applications can "memorize" as many URLs as they wish in order to create an efficient API experience with a service. Just because the service only promises one URL doesn&#8217;t mean the client application can&#8217;t learn and remember other URLs in that API.</p></div>
<div class="paragraph"><p>Services should not assume (or require) that all clients start their interactions by first visiting the stable URL. No matter the number of stable URLs promised by the API, clients are free to interact with the interface in any way they wish as long as it is making valid requests.</p></div>
<div class="paragraph"><p>I typically use the link relation value <a href="https://oreil.ly/N1x4S"><code>"home"</code></a> to indicate a stable URL for a service API. You can use any value you wish as long as you document it well and use the identifier consistently.</p></div>
<div class="paragraph"><p>It is a good idea to emit the stable URL as a <code>Link</code> header in all your API responses. It may also make sense to emit it as part of the response body whenever possible (e.g., you won&#8217;t be able to emit it for PNG or MP3 bodies!).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_28">5.1.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-urls">[clients-urls]</a>
</p>
</li>
<li>
<p>
<a href="#clients-identifier">[clients-identifier]</a>
</p>
</li>
<li>
<p>
<a href="#services-registry">[services-registry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-model-leaks">5.2. Preventing Internal Model Leaks</h3>
<div class="paragraph"><p>A common way in which service interfaces "break" is through changes in the underlying data, object, or process models within the service code. It&#8217;s important to prevent these internal elements from "leaking" out into the external API.</p></div>
<div class="sect3">
<h4 id="_problem_28">5.2.1. Problem</h4>
<div class="paragraph"><p>How can you reduce the possibility that a service&#8217;s internal data, object, and/or process model is directly exposed in the service API?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_28">5.2.2. Solution</h4>
<div class="paragraph"><p>The best way to limit the possibility of exposing internal service details in the external API is to make sure the external interface is designed to exist apart from the internal service models. That means defining service API functionality on its own terms—not simply exposing the direct service code to the "outside world."</p></div>
<div class="paragraph"><p>Essentially, API implementations (the interfaces) need to keep the service&#8217;s internal models private. To do that you need to make sure the data properties, property collections, and input/output parameters of the API are expressed as coherent elements themselves—that they can "stand alone" separately from any internal service models.  The interface should be treated as its own independent design and implementation effort, not just a "wrapper" of an existing backend service component.</p></div>
</div>
<div class="sect3">
<h4 id="_example_27">5.2.3. Example</h4>
<div class="paragraph"><p>The quickest way to avoid leaking data/object models is to ignore them when designing the API. For example, let&#8217;s assume there is a simple ToDo service that supports two local data object collections: <code>item</code> and <code>user</code>.  They might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #FF0000">{</span><span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #FF0000">"q1w2e3r4"</span><span style="color: #990000">,</span><span style="color: #FF0000">"text"</span><span style="color: #990000">:</span><span style="color: #FF0000">"This is an item"</span><span style="color: #990000">,</span><span style="color: #FF0000">"status"</span><span style="color: #990000">:</span><span style="color: #FF0000">"active"</span><span style="color: #990000">,</span><span style="color: #FF0000">"nick"</span><span style="color: #990000">:</span><span style="color: #FF0000">"mork"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span>

<span style="color: #FF0000">{</span><span style="color: #FF0000">"users"</span><span style="color: #990000">:[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"nickname"</span><span style="color: #990000">:</span><span style="color: #FF0000">"mork"</span><span style="color: #990000">,</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Mark Morkelsen"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s also assume that the possible <code>status</code> field values are limited to <code>active</code> or <code>closed</code>.</p></div>
<div class="paragraph"><p>You might think that the interface should also model two objects (<code>item</code> and <code>user</code>). But it would be just as valid to model three:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #FF0000">{</span><span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #FF0000">"q1w2e3r4"</span><span style="color: #990000">,</span><span style="color: #FF0000">"text"</span><span style="color: #990000">:</span><span style="color: #FF0000">"This is an item"</span><span style="color: #990000">,</span><span style="color: #FF0000">"status"</span><span style="color: #990000">:</span><span style="color: #FF0000">"active"</span><span style="color: #990000">,</span><span style="color: #FF0000">"nick"</span><span style="color: #990000">:</span><span style="color: #FF0000">"mork"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span>

<span style="color: #FF0000">{</span><span style="color: #FF0000">"users"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"nickname"</span><span style="color: #990000">:</span><span style="color: #FF0000">"mork"</span><span style="color: #990000">,</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Mark Morkelsen"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span>

<span style="color: #FF0000">{</span><span style="color: #FF0000">"status"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"active"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"closed"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>or even one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"todo"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #FF0000">"q1w2e3r4"</span><span style="color: #990000">,</span><span style="color: #FF0000">"text"</span><span style="color: #990000">:</span><span style="color: #FF0000">"This is an item"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"status"</span><span style="color: #990000">:</span><span style="color: #FF0000">"active"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"nickname"</span><span style="color: #990000">:</span><span style="color: #FF0000">"mork"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Morkelsen"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  <span style="color: #990000">...</span>
<span style="color: #990000">]</span><span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The point here is to <em>not</em> blindly accept the service model as the interface model. Yes, if or when the service internal model changes, there may be some work needed to maintain compatibility between the published interface and the local service. But that&#8217;s what API designs are meant to accomplish.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_29">5.2.4. Discussion</h4>
<div class="paragraph"><p>Whenever possible, I model my API properties as a single, flat collection (like the preceding example). This simplifies the client end of the process and frees the supporting services to use any local data storage model they wish. Services can even change the storage model without adversely affecting the API. This denormalization of any internal model makes it easier to maintain a stable external model even when the internal model changes over time.</p></div>
<div class="admonitionblock tip1">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Years ago, when talking about this subject, I <a href="https://oreil.ly/xrm2g">coined the axiom</a>: "Remember, when designing your web API, your data model is not your object model is not your resource model is not your message model." I also gave a talk called <a href="https://oreil.ly/aUhde">"Web API Design Maturity Model"</a> that expands on this notion.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is important to remember that the API is an independent interface. It&#8217;s fine if the interface expects the person creating a new record to send a "denormalized" collection of properties that will be regrouped and written to multiple storage locations. As long as the service can safely manage the data (e.g., make sure there are no lost updates or data conflicts), anything goes.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>We&#8217;ll dig into the details of dealing with data storage in <a href="#data">[data]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>API designers are free to create any number of HTTP resources they wish in order to support the expected interactions. Those interactions don&#8217;t need to follow the CRUD (create, read, update, delete) meme so common for HTTP APIs.  For example, <a href="#table0501">[table0501]</a> is a resource designed to support the ToDo service referred to throughout this recipe.</p></div>
<div class="tableblock" id="table0501">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Possible resource design for ToDo service interface</caption>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<thead>
<tr>
<th align="left" valign="top">Action</th>
<th align="left" valign="top">URL</th>
<th align="left" valign="top">Method</th>
<th align="left" valign="top">Request body</th>
<th align="left" valign="top">Response body</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Read List</p></td>
<td align="left" valign="top"><p class="table">/todo/</p></td>
<td align="left" valign="top"><p class="table"><code>GET</code></p></td>
<td align="left" valign="top"><p class="table">none</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Filter List</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"><code>GET</code></p></td>
<td align="left" valign="top"><p class="table">none</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Create Item</p></td>
<td align="left" valign="top"><p class="table">/todo/</p></td>
<td align="left" valign="top"><p class="table"><code>PATCH</code></p></td>
<td align="left" valign="top"><p class="table">{id,text,status,nick,name}</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Update Item Text</p></td>
<td align="left" valign="top"><p class="table">/todo/</p></td>
<td align="left" valign="top"><p class="table"><code>PATCH</code></p></td>
<td align="left" valign="top"><p class="table">{id,text}</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Update Item Nick</p></td>
<td align="left" valign="top"><p class="table">/todo/</p></td>
<td align="left" valign="top"><p class="table"><code>PATCH</code></p></td>
<td align="left" valign="top"><p class="table">{id,nick,name}</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Update Item Status</p></td>
<td align="left" valign="top"><p class="table">/todo/</p></td>
<td align="left" valign="top"><p class="table"><code>PATCH</code></p></td>
<td align="left" valign="top"><p class="table">{id,status}</p></td>
<td align="left" valign="top"><p class="table">[{id,text,status,nick,name}]</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Notice that <a href="#table0501">[table0501]</a> indicates that the ToDo list is a single resource that can be modified to add and edit items from that single resource. How the service organizes this information internally and/or <em>stores</em> this information is of no real interest to the interface consumer as long as the client application can do the needed work.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p><a href="#table0501">[table0501]</a> doesn&#8217;t include additional HTTP features, such as <code>ETag</code>, <code>If-Match</code>, <code>Last-Modified</code>, and other integrity headers. See <a href="#data-idempotent">[data-idempotent]</a> for details.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_29">5.2.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-media-types">[design-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#design-hypermedia">[design-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-media-types">[services-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-hiding">[data-hiding]</a>
</p>
</li>
<li>
<p>
<a href="#data-relations">[data-relations]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-media-types">5.3. Converting Internal Models to External Messages</h3>
<div class="paragraph"><p>To support loose coupling between evolving services, you need to establish a stable basis for communication between those services. A proven successful strategy is to rely upon well-known, highly structured registered media types as the representation format for API responses.</p></div>
<div class="paragraph"><p>That means your service interface needs to respond with the same <em>semantic</em> information while varying the message format.</p></div>
<div class="sect3">
<h4 id="_problem_29">5.3.1. Problem</h4>
<div class="paragraph"><p>How do we organize our service interface to support content negotiation for API consumers while still maintaining a low-cost/low-effort service API? What patterns should we support within our interface code in order to support representing the backend service data consistently in a standardized and well-known media type? Finally, what are the advantages and challenges of representing the same internal data for differing response message formats?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_29">5.3.2. Solution</h4>
<div class="paragraph"><p>An important way to make sure your service <em>interface</em> design is not too tightly coupled to your service&#8217;s internal data (or object) model, is to approach the representation step as a separate design effort. In other words, actively engage in the process of designing your representations—don&#8217;t just settle for a simple, direct serialization of internal models into external messages.</p></div>
<div class="paragraph"><p>A series of formats were created to represent information for HTTP. These formats contain enough structure (e.g., <code>&lt;html&gt;</code>, <code>&lt;head&gt;</code>, <code>&lt;body&gt;</code>, etc.) to support client applications that can bind to the message format instead of binding to the message <em>content</em> (e.g., <code>givenName</code>, <code>id</code>, <code>telephone</code>, etc.).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For a list of recommended response media types, see <a href="#standards">[standards]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The process of mapping parts of the service&#8217;s internal data/object model to the interface&#8217;s external object model usually takes a mix of algorithmic application and <span class=".keep-together">creative</span> design thinking. For some formats, like unstructured XML and JSON, the mapping can be quite literal: a simple serialization of the data into a message. But this can be a bad idea. For example, direct serialization of the data model into a message model exposes the internal model to the outside world and results in a brittle implementation that is likely to break if or when the internal models change—which they will! See <a href="#data-modify-production">[data-modify-production]</a> for details.</p></div>
<div class="paragraph"><p>Instead, it is better to select a structured media type (SMT) like SIREN, Collection+JSON, or even HTML as the basis for exchanging representations. Mapping the internal data to one of these formats takes a bit more effort in the beginning—you can do this "by hand" or rely on a prebuilt representative library for that media type—but pays off over time since any future changes or even additional interfaces can use the same library to render valid external messages for API consumers.</p></div>
<div class="paragraph"><p>For more on designing service interfaces independent of the underlying service, see <a href="#services-proxy">[services-proxy]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_28">5.3.3. Example</h4>
<div class="paragraph"><p>Service interface code that supports selectable media type responses needs to implement two key runtime support elements. First, the service API needs to be able to discover which formats the client prefers, and second, the service API needs to use that information to render internal data in the preferred format.</p></div>
<div class="paragraph"><p>HTTP defines the <code>Accept</code> header to allow clients to include their format preferences when they send a request. When the service API sees an <code>Accept</code> header, it needs to parse the value of that header and make a proper selection. You can review the HTTP specification on the <a href="https://oreil.ly/GLlue"><code>Accept</code> header</a> for details on how to interpret its contents.</p></div>
<div class="paragraph"><p>A simple exchange might look like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST
GET /todo/list HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json, application/vnd.uber+xml

*** RESPONSE
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json</code></pre>
</div></div>
<div class="paragraph"><p>Note that the service interface selected the <code>application/vnd.collection+json</code> format here. When more than one preference is offered, services have some freedom on which format they can return—including returning a default format that wasn&#8217;t even listed by the client! See more on this in <a href="#services-preferences">[services-preferences]</a>.</p></div>
<div class="paragraph"><p>Once the service API selects a format to use for rendering the response, it needs to map the internal data to the output representation per the specifications of the selected response format. Often this is an easy fit, but sometimes internal data is a bit tough to render and might even be left out of a response.</p></div>
<div class="paragraph"><p>Here&#8217;s an example of some internal service data that needs to be represented in responses:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "user" : <span style="color: #990000">{</span>
    "id":"<span style="color: #FF0000">q1w2e3r4t5</span>"<span style="color: #990000">,</span>
    "givenName":"<span style="color: #FF0000">Mark</span>"<span style="color: #990000">,</span>
    "familyName":"<span style="color: #FF0000">Morkelsen</span>"<span style="color: #990000">,</span>
    "nickName":"<span style="color: #FF0000">mork</span>"<span style="color: #990000">,</span>
    "telephones":<span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"type":"<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "value":"<span style="color: #FF0000">1-234-567-8901</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"type":"<span style="color: #FF0000">work</span>"<span style="color: #990000">,</span> "value":"<span style="color: #FF0000">1-987-654-3210</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, let&#8217;s assume the client has sent the following request:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /users/q1w2e3r4t5 HTTP/1.1
Host: api.example.org
Accept: application/json</code></pre>
</div></div>
<div class="paragraph"><p>A simple (but not recommended) way to represent the internal data would be to just serialize it directly:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">***</span> RESPONSE
HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>json
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "user" : <span style="color: #990000">{</span>
    "id" : "<span style="color: #FF0000">q1w2e3r4t5</span>"<span style="color: #990000">,</span>
    "givenName" : "<span style="color: #FF0000">Mark</span>"<span style="color: #990000">,</span>
    "familyName" : "<span style="color: #FF0000">Morkelsen</span>"<span style="color: #990000">,</span>
    "nickName" : "<span style="color: #FF0000">mork</span>"<span style="color: #990000">,</span>
    "telephone" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"type" : "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">1-234-567-8901</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"type" : "<span style="color: #FF0000">work</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">1-987-654-3210</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Next, let&#8217;s look at a request for a representation using the <code>text/csv</code> format:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /users/q1w2e3r4t5 HTTP/1.1
Host: api.example.org
Accept: text/csv


*** RESPONSE
HTTP/1.1 200 OK
Content-Type: application/json
...

"id","givenName","familyName","nickName","telephone_home","telephone_work"
"q1w2e3r4t5","Mark","Morkelsen","mork","1-234-567-8901","1-987-654-3210"</code></pre>
</div></div>
<div class="paragraph"><p>Notice the internal <code>telephone</code> object was rendered as a set of flat properties in the CSV response. Clients may not even know the internal shape of the data.</p></div>
<div class="paragraph"><p>Finally, here&#8217;s an example representation when the client included the <code>application/vnd.collection+json</code> media type in the request:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://example.org/users/q1w2e3r4t5</span>"<span style="color: #990000">,</span>

    "links" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"rel" : "<span style="color: #FF0000">users</span>"<span style="color: #990000">,</span> "href" : "<span style="color: #FF0000">http://example.org/users</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel" : "<span style="color: #FF0000">products</span>"<span style="color: #990000">,</span> "href" : "<span style="color: #FF0000">http://example.org/products</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"rel" : "<span style="color: #FF0000">services</span>"<span style="color: #990000">,</span> "href" : "<span style="color: #FF0000">http://example.org/services</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">],</span>

    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href" : "<span style="color: #FF0000">http://example.org/users/q1w2e3r4t5</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">,</span>
            "prompt" : "<span style="color: #FF0000">Identifier</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Mark</span>"<span style="color: #990000">,</span>
            "prompt" : "<span style="color: #FF0000">First Name</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Morkelsen</span>"<span style="color: #990000">,</span>
            "prompt" : "<span style="color: #FF0000">Last Name</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">nickName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Mork</span>"<span style="color: #990000">,</span>
            "prompt" : "<span style="color: #FF0000">Nick</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">],</span>
        "links" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"rel" : "<span style="color: #FF0000">telephones</span>"<span style="color: #990000">,</span> "prompt" : "<span style="color: #FF0000">Telephones</span>"
            "href" : "<span style="color: #FF0000">http://examples.org/users/q1w2e3r4t5/telephones</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In this last case, quite a bit of "extra" information was supplied by the representative in the API service, including mapping <code>prompt</code> values to each data point, including <code>link</code> elements that point to related data, and even moving the <code>telephone</code> data array to another, related resource.</p></div>
<div class="paragraph"><p>The key message here is that designing representative for service data should not be limited to blindly serializing the internal models.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_30">5.3.4. Discussion</h4>
<div class="paragraph"><p>During the implementation phase of a service API, it is a good practice to document the rules you are using to convert internal models to external messages. This will help share the algorithms with other developers and make it easier to debug any errors you find along the way. It is not, however, a good idea to publish this representation description to API consumers. They do not need to know the internal data or object models behind your interfaces.</p></div>
<div class="paragraph"><p>As time goes on, you are likely to encounter cases where the internal models of your service change. In many cases these changes should <em>not</em> result in changes to your external messages. For example, when the internal model property <code>user.id</code> is changed to <code>user.identifier</code>, there is no need to change the external property.</p></div>
<div class="paragraph"><p>However, some internal model changes include new properties (<code>user.hatsize</code>), and these new properties may be reflected in the external messages when those changes do not result in breaking existing API consumers. Adding a field at the end of a <code>text/csv</code> row might be fine, but rearranging the field order in the rows (e.g., inserting the new field as the first field in the row) is likely a bad idea.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If you anticipate the internal models will change frequently, be sure to select a representation format that is designed to reduce the impact of such changes. For example, Collection+JSON is good for varying models (all properties are represented as <code>data.name</code> and <code>data.value</code>), but SIREN and HAL (since they bind to object properties directly) are not.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>While you can hardcode your service interface to <em>always</em> emit the same format (HAL, SIREN, etc.), it is usually a good idea to honor the HTTP content negotiation process (see <a href="#services-conneg">[services-conneg]</a>) to allow API consumers to indicate their format preferences at runtime using the <code>Accept</code> request header. See <a href="#services-preferences">[services-preferences]</a> for additional details on how to handle a client&#8217;s media type preferences.</p></div>
<div class="paragraph"><p>I typically support at least two and try to support three or more, depending on the situation. First, it is a good idea to select one media type with a high <a href="http://amundsen.com/hypermedia/hfactor">Hypermedia Factor score</a>, for example, Collection+JSON or SIREN (see <a href="#clients-hypermedia">[clients-hypermedia]</a> for more on H-Factors). Second, it is a good idea to support a simple serialization format like JSON, XML, and/or CSV since many API consumers will be able to use these simple formats quickly. To support additional formats, you can add any other formats you and/or your API consumers prefer to use.</p></div>
<div class="paragraph"><p>If appropriate, it can also be helpful to support an HTML representation of your service API. It can help service developers while they test the interface design. It can also help API consumers who want to "play around" with the API without investing lots of time in coding an API client. Finally, the HTML format can be a solid choice as one of the high H-Factor media types in your service collection.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_30">5.3.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-preferences">[services-preferences]</a>
</p>
</li>
<li>
<p>
<a href="#services-conneg">[services-conneg]</a>
</p>
</li>
<li>
<p>
<a href="#data-modify-production">[data-modify-production]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-actions">5.4. Expressing Internal Functions as External Actions</h3>
<div class="paragraph"><p>Once you adopt the practice of standardizing responses using structured media types (SMTs), you also need to address the challenge of properly expressing the internal functionality of the service(s) behind your interface. To do this, you need to rely on a practice of expressing not just the service&#8217;s data models but also that service&#8217;s action models—the functions of the service that need to be accessed via the external API.</p></div>
<div class="sect3">
<h4 id="_problem_30">5.4.1. Problem</h4>
<div class="paragraph"><p>How do you decide which internal functions within the service need to be exposed via the API, and how do you express those methods in a consistent manner for API consumers to find and operate as expected? What formats and/or patterns are available for converting internal service functions into external interface actions?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_30">5.4.2. Solution</h4>
<div class="paragraph"><p>The most direct way to expose a service&#8217;s internal functions as external actions is to represent those functions using hypermedia controls (see <a href="#clients-hypermedia">[clients-hypermedia]</a>). For example, in HTML the function name (<code>&lt;form name="approveUser" &#8230;&gt;</code>), input arguments (<code>&lt;input&gt;</code> controls), and output return values can be used to represent the internal service function.  However, it is not always possible (or even a good idea) to bind external actions directly to internal service operations.</p></div>
<div class="paragraph"><p>It is usually better to rely upon established external vocabularies when expressing internal service functions. For example, an internal data parameter might be named <code>firstName</code>. But that same parameter would be expressed as <code>givenName</code> in the external interface (see <a href="#design-vocabularies">[design-vocabularies]</a>). The API code can handle the translation between internal and external names. This has the advantage of shielding the external interface from internal changes to the service. To extend the example, updates to the service might result in <code>firstName</code> changing to <code>fNameValue</code>. In this case, only the middleware code needs to be updated, not the actual external interface.</p></div>
<div class="paragraph"><p>Finally, some internal actions—especially ones involving complicated computations or processes—are best expressed in a more simplified way. A service (<code>onboardingSvc</code>) might need to contact multiple dependent services (<code>userSvc</code>, <code>customerRelationsSvc</code>, and <code>accountSalesSvc</code>) and pass data between them in order to complete a task. It is often better to express this externally as a single action (<code>sendOnboardingData</code>) instead of multiple dependent actions (see the following example for details).</p></div>
<div class="paragraph"><p>Essentially, treat the act of designing the process interactions of your API as an independent activity. You can be as creative/inventive as you wish. Design a good interface; don&#8217;t just echo the service internals. Assume that there may be a "translation" step between the API exchange and the internal service innovation. Above all, work to maintain a loose coupling between the underlying service and the service interface you publish.</p></div>
</div>
<div class="sect3">
<h4 id="_example_29">5.4.3. Example</h4>
<div class="paragraph"><p>In a direct translation from internal function to external action, you can start with an example of a service function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">approveUser</span></span><span style="color: #990000">(</span>userId<span style="color: #990000">,</span> nickname<span style="color: #990000">,</span> approver<span style="color: #990000">,</span>level<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> approval <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

  approval<span style="color: #990000">.</span>userId <span style="color: #990000">=</span> userId<span style="color: #990000">;</span>
  approval<span style="color: #990000">.</span>nickname <span style="color: #990000">=</span> nickname<span style="color: #990000">;</span>
  approval<span style="color: #990000">.</span>approver <span style="color: #990000">=</span> approver<span style="color: #990000">;</span>
  approval<span style="color: #990000">.</span>level <span style="color: #990000">=</span> level<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> data<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>approval<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And then translate these internal elements into an HTML <code>FORM</code> object in a response message:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"approveUser"</span> <span style="color: #009900">enctype</span><span style="color: #990000">=</span><span style="color: #FF0000">"application/x-www-form-urlencoded"</span>
  <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/users/approvals"</span>
  <span style="color: #009900">target</span><span style="color: #990000">=</span><span style="color: #FF0000">"approvalDisplay"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"userNick"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"string"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"mork"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"approverName"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"string"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mr. Roboto"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"approveLevel"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"string"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"nominal"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Approve User"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;iframe</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"approvalDisplay"</span> /<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>However, as we already discussed, direct translation is not usually a good idea. Here&#8217;s an example that relies on a well-known external vocabulary (in this case, values from the <a href="https://schema.org">Schema.org library</a>) to express the external action using a standardized vocabulary even though that vocabulary is not supported by the underlying service.</p></div>
<div class="paragraph"><p>Consider this simple internal method template for updating an existing user object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">updateUser</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> fname<span style="color: #990000">,</span> lname<span style="color: #990000">,</span> email<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

  <span style="color: #990000">...</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> userObject
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, let&#8217;s look at the interface action (expressed as a Collection+JSON template) using property names taken from the Schema.org library:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "collection" <span style="color: #990000">{</span>
    "template" : <span style="color: #990000">{</span>
      "data" : <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">identifier</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">,</span> "prompt" : "<span style="color: #FF0000">User ID</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Mark</span>"<span style="color: #990000">,</span> "prompt" : "<span style="color: #FF0000">First Name</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Morkelsen</span>"<span style="color: #990000">,</span> "prompt" : "<span style="color: #FF0000">Last Name</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">email</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">mork@example.org</span>"<span style="color: #990000">,</span> "prompt" : "<span style="color: #FF0000">Email</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, the code that accepts the update action can handle the translation between internal and external names. For this example, the method that maps to the external form uses the Schema.org property names (<code>identifier</code>, <code>givenName</code>, <code>familyName</code>, and <code>email</code>) and stores the values of these parameters into the local user object properties (<code>id</code>, <code>fname</code>, <code>lname</code>, and <code>email</code>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">updateAction</span></span><span style="color: #990000">(</span>identifier<span style="color: #990000">,</span> givenName<span style="color: #990000">,</span> familyName<span style="color: #990000">,</span> email<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> user <span style="color: #990000">=</span> data<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>identifier<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    user<span style="color: #990000">.</span>id <span style="color: #990000">=</span> identifier<span style="color: #990000">;</span>
    user<span style="color: #990000">.</span>fname <span style="color: #990000">=</span> givenName<span style="color: #990000">;</span>
    user<span style="color: #990000">.</span>lname <span style="color: #990000">=</span> familyName<span style="color: #990000">;</span>
    user<span style="color: #990000">.</span>email <span style="color: #990000">=</span> email<span style="color: #990000">;</span>
    user <span style="color: #990000">=</span> data<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>user<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> user<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>There may also be scenarios when the interface has external actions that do not map directly to internal functions. Consider the following external action:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"declineContract"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">action</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"customerId"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"q1w2e3r4t5"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"contractId"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"o9i8u7y6.t5r4"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"salesRepName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mandy Miningham"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"reviewerName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mark Morkelsen"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"reasonCode"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Q201.B"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Unable to locate collateral<span style="font-weight: bold"><span style="color: #0000FF">&lt;/textarea&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Decline Contract"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There is no <code>declineContract</code> method in the underlying service code behind this interface. However, there are a handful of actions that must be completed when a contract is declined:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a <code>declined</code> log record.
</p>
</li>
<li>
<p>
Update the <code>customer</code> record.
</p>
</li>
<li>
<p>
Update the <code>contract</code> record.
</p>
</li>
<li>
<p>
Update the <code>salesRep</code> record.
</p>
</li>
<li>
<p>
Update the <code>reviewer</code> record.
</p>
</li>
<li>
<p>
Update the <code>nationalCredit</code> agency.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this case, the service API most likely has a set of functions it needs to perform against several dependent services. Some of these functions might be local (e.g., internal objects in the service code), and some might be remote (e.g., other external services like the <code>nationalCredit</code> agency).  All these details are "hidden" from the API consumer.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The last example doesn&#8217;t show any handling of possible errors, failed data updates, etc.  For more on how to handle these cases, see <a href="#workflow">[workflow]</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_31">5.4.4. Discussion</h4>
<div class="paragraph"><p>Adopting the practice of "designing the external actions" is a great way to improve the loose coupling aspect of your API. This is especially true when you create external actions that have no direct service equivalent, since changes to the underlying service need not be reflected directly in these independent actions. Basically, the more work you do to design interface actions, the less likely it will be that future service changes—even seemingly breaking changes—will adversely affect the API.</p></div>
<div class="paragraph"><p>Sometimes a service will have a sequence of internal operations (<code>intializeCustomer</code>, <code>collectUserData</code>, <code>collectBankData</code>, and <code>finalizeCustomerData</code>). Whenever <span class=".keep-together">possible</span>, it is a good idea to express these internal functions as a single external action where you collect all the important data and then let the API code sort out the sequence of actions. This can be done as a single "form" with all the inputs or, if needed, you can use the "work in progress" workflow (see <a href="#workflow-wip">[workflow-wip]</a>). This avoids dealing with future changes in the order of the sequence, or adding or removing steps.</p></div>
<div class="paragraph"><p>There are times when internal services rely on Boolean flags to control operations. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">approveUser</span></span><span style="color: #990000">(</span>bool<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>bool<span style="color: #990000">===</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> results<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It is not a good idea to expose Boolean operations for external actions. This limits your ability to modify or expand this list over time. Instead, it is a good idea to expose enumerators (expressed here in HAL-FORMS) and let clients and services decide how they want to render these values internally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "_templates" : <span style="color: #990000">{</span>
    "default" : <span style="color: #990000">{</span>
      ...
      "properties" : <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>
          "name" : "<span style="color: #FF0000">approveUser</span>"<span style="color: #990000">,</span>
          "prompt" : "<span style="color: #FF0000">User Approval</span>"<span style="color: #990000">,</span>
          "options" : <span style="color: #990000">{</span>
            "selectedValues" : <span style="color: #990000">[</span>"No"<span style="color: #990000">],</span>
            "inline" : <span style="color: #990000">[</span>"No"<span style="color: #990000">,</span>"Yes"<span style="color: #990000">]</span>
          <span style="color: #990000">}</span>
        <span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, code within the API can translate the <code>"Yes"</code> / <code>"No"</code> values to <code>true</code> or <code>false</code> before calling the underlying service. In addition, if future changes to the service result in a possible <code>pending</code> status, the <code>options</code> element of the form can be updated without any other changes to the API.</p></div>
<div class="paragraph"><p>In most of my API implementations, I write up a small "mapping" function that automates the task of translating internal and external names using a set of declarations. That way I only need to update the rules in a single location for the entire API.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_31">5.4.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#data-relations">[data-relations]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-preferences">5.5. Advertising Support for Client Response Preferences</h3>
<div class="paragraph"><p>The HTTP protocol provides a handful of content-related parameters that clients can use to indicate preferences. HTTP supports a collection of header parameters, the <code>OPTIONS</code> method, and link relation values. However, sometimes you need a more extensive way to identify and document client preferences for interactions. The solution is to rely on a mix of HTTP protocol options and a few additional semantic references via a separate, addressable preferences resource.</p></div>
<div class="sect3">
<h4 id="_problem_31">5.5.1. Problem</h4>
<div class="paragraph"><p>How can a service advertise to API consumers all their possible preference options in a consistent and scalable way? What HTTP headers are available? When does it make sense to use the HTTP <code>OPTIONS</code> method? And when is it best to rely on link relation and other values to signal a service API&#8217;s capabilities?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_31">5.5.2. Solution</h4>
<div class="paragraph"><p>One of the advantages of using the HTTP protocol for accessing network services is that HTTP has a wide range of "tuneable" values that clients and servers can use to negotiate the details of request and response parameters. Essentially, services can "advertise" one or more selectable aspects of the message exchange, and clients can use this information to inform services of their preferences—all at runtime.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>You&#8217;ll notice that this list contains elements from a wide range of sources, such as the HTTP protocol, an HTML <code>FORMS</code> property, and even a named link relation value. The work of advertising selectable response options has a checkered history, so we have to make do with the possibilities before us.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The following is a quick review of all the "tuneable" values in HTTP and how clients and services can use them to customize message exchanges:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>Accept</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/vxcG8">HTTP <code>Accept</code> header</a> can be used to return a list of supported response media types. Although it is not required, the values in this list should be from the media types listed in the <a href="https://oreil.ly/5ePjT">IANA Media Types document</a> or some other source.
</p>
</dd>
<dt class="hdlist1">
<code>Allow</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/Ku60c">HTTP <code>Allow</code> header</a>  is used to return a list of supported HTTP methods for the service. The values in this list should be taken from the <a href="https://oreil.ly/dXZ1d">IANA Hypertext Transfer Protocol Method Registry</a>.
</p>
</dd>
<dt class="hdlist1">
<code>enctype</code>
</dt>
<dd>
<p>
The <code>enctype</code> property of <a href="https://oreil.ly/dvo4t">HTML forms</a>  can be used to return a list of supported request media types. Although it is not required, the values in this list should be from the media types listed in the <a href="https://oreil.ly/hD5CN">IANA Media Types document</a> or some other source.
</p>
</dd>
<dt class="hdlist1">
<code>charset</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/idWYs">HTTP <code>charset</code> parameter</a>  can be used to indicate the list of supported character sets for response bodies. The values in this list should be taken from the <a href="https://oreil.ly/yMJjy">IANA Character Sets document</a>.
</p>
</dd>
<dt class="hdlist1">
<code>encoding</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/GVk6K">HTTP <code>encoding</code> parameter</a> can be used to return a list of supported encodings for response bodies. The values in this list should come from the <a href="https://oreil.ly/MNZRU">IANA Content Encoding Registry</a>.
</p>
</dd>
<dt class="hdlist1">
<code>language</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/0muZk">HTTP <code>language</code> tag</a> can be used to return a list of supported natural languages for response bodies. The list of valid values should be taken from the <a href="https://oreil.ly/7YGxV">IANA Language Subtag Registry</a>.
</p>
</dd>
<dt class="hdlist1">
<code>profile</code>
</dt>
<dd>
<p>
The <a href="https://oreil.ly/7daeB"><code>profile</code> link relation value</a>  can be used to return a list of supported profiles for responses. The contents of this element can be a list of valid URIs that represent supported vocabularies or other descriptive documents (see <a href="#services-vocabularies">[services-vocabularies]</a> for details).
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>There is another client preference value that HTTP supports: <code>accept-ranges</code>. This allows clients to signal to services that they can support range values for returning responses via the <code>range</code> header. You can check out the <a href="https://oreil.ly/auRyS">HTTP specification</a> for details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>These should be accessible for client applications via the HTTP <code>OPTIONS</code> method or a resource representation returned when following the <a href="https://oreil.ly/TztQq"><code>"meta"</code> link relation value (<code>rel="meta"</code>)</a>. See the example for details.</p></div>
<div class="paragraph"><p>Clients can request the service&#8217;s supported client preferences and then use values from this response in their request to indicate to the service which formats, languages, encodings, etc. they wish the service to use in responses.</p></div>
<div class="paragraph"><p>Even when there is only one possible response that the service supports (e.g., <code>"language":"en"</code>), the service should still return the full <code>meta</code> resource in order to help clients discover the values for these important parameters.</p></div>
<div class="paragraph"><p>It is a good idea to support a link on the "Home" resource of your service interface that points to the client preferences <code>meta</code> resource. This <code>meta</code> resource is where clients can expect to find the list of (and possible values for) all the client preferences that service supports.</p></div>
<div class="paragraph"><p><a href="#fig0502">[fig0502]</a> is a diagram of the interaction model for supporting the <code>meta</code> resource list of client preference options.</p></div>
<div class="imageblock" id="fig0502">
<div class="content">
<img src="images/rwcb_0502.png" alt="images/rwcb_0502.png" width="80%" />
</div>
<div class="title">Figure 7. <code>meta</code> preference recipe</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For details on the <code>meta</code> client preferences resource, check out the online collection of <a href="https://oreil.ly/RKhJ8">ALPS documents</a> associated with this book.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The following section shows examples of what is returned by the API when the <code>meta</code> link is activated.</p></div>
</div>
<div class="sect3">
<h4 id="_example_30">5.5.3. Example</h4>
<div class="paragraph"><p>When requested, the <code>meta</code> resource representation should list all the possible client preference parameters supported by the API along with all the acceptable values for each. It is, of course, possible that the service API does not support all (or maybe any) of the client preference options. The content of the response will vary accordingly.</p></div>
<div class="paragraph"><p>Here is an example (in HAL format) of the response to the <code>meta</code> link or executing the <code>HTTP OPTIONS</code> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "_links" : <span style="color: #990000">{</span>
    "self" : <span style="color: #990000">{</span>"href" : "<span style="color: #FF0000">http://api.example.com/user-service/meta-preferences</span>"<span style="color: #990000">},</span>
    "home": <span style="color: #990000">{</span>"href" : "<span style="color: #FF0000">http://api.example.com/user-service/</span>"<span style="color: #990000">},</span>
    "profile" :
   <span style="color: #990000">{</span>"href" :
    "https://webapicookbook.github.io/alps-documents/meta/meta-preferences.json"
      <span style="color: #990000">}</span>
  <span style="color: #990000">},</span>
  "allow" : "<span style="color: #FF0000">GET PUT PATCH DELETE HEAD OPTIONS</span>"<span style="color: #990000">,</span>
  "accept" : "<span style="color: #FF0000">application/vnd.hal+json application/vnd.collection+json</span>"<span style="color: #990000">,</span>
  "enctype" : "<span style="color: #FF0000">application/x-www-form-urlencoded application/json</span>"<span style="color: #990000">,</span>
  "charset" : "<span style="color: #FF0000">utf-8, iso-8859-1;q=0.7</span>"<span style="color: #990000">,</span>
  "encoding" : "<span style="color: #FF0000">deflate gzip compress</span>"<span style="color: #990000">,</span>
  "language" : "<span style="color: #FF0000">en es fr</span>"<span style="color: #990000">,</span>
  "profile" : "<span style="color: #FF0000">https://alps.example.org/fhir-4.0.1</span>"
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>While it is not required (by the HTTP specification) to include a body in the <code>OPTIONS</code> response, it is a good practice to return this <code>meta-preferences</code> representation anyway. In cases where the <code>OPTIONS</code> are specific to a single resource, services can modify the <code>meta-preferences</code> response accordingly. For example, a download link might support more than one response format. Here is an example <code>OPTIONS</code> response in SIREN format:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
OPTIONS /file-system/download HTTP/1.1
Host: api.example.org
...

*** RESPONSE ***
HTTP/1.1 200 OK
Content-Type: application/vnd.siren+json
Content-Length: XX
Cache-Control: max-age=604800
Allow: GET PUT DELETE HEAD OPTIONS
Accept: application/zip application/gzip
Accept-Charset: utf-8
Accept-Encoding: compress
Accept-Language: en
Link: &lt;https://webapicookbook.github.io/alps-documents/about/about.json&gt;; \
  rel="profile"

{
  "class" : [ "meta preferences" ],
  "links" : [
    { "rel" : ["self"], "href" : "http://api.example.org/file-system/download"},
    { "rel" : ["home"], "href" : "http://api.example.org/file-system/"},
    { "rel" : ["profile"],
      "href" : "https://api.example.org/profiles/meta-preferences.json"}
  ],
  "properties" : {
    "allow" : "GET PUT DELETE HEAD OPTIONS",
    "accept" : "application/zip application/gzip",
    "enctype" : "application/json",
    "charset" : "utf-8",
    "encoding" : "compress",
    "language" : "en",
    "profile" : "https://alps.example.org/downloads/"
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>In the <code>OPTIONS</code> response, you can see that both the header space and the response body contain the list of client preference parameters. It is a good idea to include both sets of information since some client applications may only parse the header collection and skip the content in the response body.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_32">5.5.4. Discussion</h4>
<div class="paragraph"><p>It is rare that a single service interface supports the full range of the client preferences listed here. The most common ones that clients are interested in are: <code>allow</code>, <code>accept</code>, <code>enctype</code>, and sometimes <code>language</code>. The <code>charset</code> and <code>encoding</code> preferences are rarely indicated.</p></div>
<div class="paragraph"><p>Even if the service interface supports only one value for the preference item, that item should be listed in the <code>meta-preferences</code> response. In this way, the <code>meta-preferences</code> response becomes the runtime documentation of service options, and that means API consumers will be able to rely on this response to get an up-to-date listing of these parameters.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Be sure to include an item in your API documentation that tells developers that your interface supports <code>OPTIONS</code> and/or the <code>meta</code> link relation value.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>There is a downside to relying solely on HTTP <code>OPTIONS</code> to communicate supported client preferences. The HTTP specification explicitly states that <code>OPTIONS</code> is noncacheable. If you have lots of API consumers sending <code>OPTIONS</code> requests, you may run into scaling problems for your API. However, offering a standalone <code>meta-preferences</code> resource (for example, <code>&lt;link rel="meta" href="http://api.example.org/meta-preferences/" /&gt;</code>) means you can mark that resource with a long cache lifetime and reduce the expense of composing and returning client preference responses.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_32">5.5.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabulary-formats">[services-vocabulary-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-conneg">5.6. Supporting HTTP Content Negotiation</h3>
<div class="paragraph"><p>One of the unique aspects of the HTTP protocol is the ability to select preferred response body formats. Borrowed from the email specifications, the <code>content-type</code> header implementation for HTTP has led to the creation of almost 1,500 different media types registered in the official IANA Media Types registry, with more being added each year. The challenge is knowing which media type to use, when to use it, and how to make it possible for both clients and services to work out the details of content negotiation.</p></div>
<div class="sect3">
<h4 id="_problem_32">5.6.1. Problem</h4>
<div class="paragraph"><p>HTTP allows clients and services to engage in "content negotiation"—the process of selecting which media type to use when exchanging messages. How does this work? What is the different between proactive and reactive content negotiation? And what do service interfaces need to do to support content negotiation when it is <span class=".keep-together">appropriate</span>?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_32">5.6.2. Solution</h4>
<div class="paragraph"><p>An important feature of HTTP is the ability to support multiple response formats. This allows the same resource to return HTML for some consumers, CSV for others, and so forth. Even more powerful is HTTP&#8217;s support for negotiating the response format at runtime. In other words, API consumers and providers can work out just which message format is used in a response at the very time the request is made.</p></div>
<div class="paragraph"><p>There are two main "types" of content negotiation described in the HTTP specification: <a href="https://oreil.ly/3Q9FP">proactive and reactive</a>. Each has advantages and <span class=".keep-together">challenges</span>.</p></div>
<div class="sect4 xxx">
<h5 id="_proactive_content_negotiation">5.6.2.1. Proactive content negotiation</h5>
<div class="paragraph"><p><a href="https://oreil.ly/CCqJm">Proactive content negotiation (PCN)</a> is the easiest to implement for HTTP services. With PCN, API clients send a list of one or more preferred media types for responses, and the server, using the provided list, proactively decides which media type to use. This is sometimes called "server-driven content <span class=".keep-together">negotiation</span>."</p></div>
<div class="paragraph"><p>Clients indicate their response preferences using the <code>Accept</code> header in requests, and servers indicate their final section using the <code>Content-Type</code> header in responses (see the examples later in this recipe).</p></div>
<div class="paragraph"><p>In PCN, clients <em>advise</em> servers of their preference, and the servers make the final determination of the response format. It should be noted that it is possible that the service will respond on a format that was <em>not</em> included in the client&#8217;s <code>Accept</code> header. Using the JSON example here, if the service does not support any JSON formats, that service might respond with <code>text/plain</code> or <code>application/HTML</code>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_reactive_content_negotiation">5.6.2.2. Reactive content negotiation</h5>
<div class="paragraph"><p>An alternative to proactive content negotiation by the service is <a href="https://oreil.ly/RJTOv">reactive content negotiation (RCN)</a>. In RCN, the service sends the client a list of possible representation formats, and the client is expected to select the preferred format from the list and make the request a second time, specifying which response format has been selected. This puts the power of selection squarely in the hands of the client application but also means an additional "round trip" is made each time.</p></div>
<div class="paragraph"><p>RCN works well when there are lots of variables (language, message format, encoding scheme, etc.), but the details of how server and client interact to select the preferred response format are not spelled out in the HTTP specification.  A common approach is for servers to respond with HTTP status code <code>300 Multiple Choices</code>, with a response body that lists options for clients to review. The <a href="https://oreil.ly/0AP9l"><code>300 Multiple Choices</code> response</a> often carries a series of <code>Link</code> headers, and possibly a <code>Location</code> header in case the client wants to just redirect automatically.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_31">5.6.3. Example</h4>
<div class="paragraph"><p>Both proactive and reactive content negotiation are supported by HTTP. The following are some examples.</p></div>
<div class="sect4 xxx">
<h5 id="_proactive_content_negotiation_2">5.6.3.1. Proactive content negotiation</h5>
<div class="paragraph"><p>In PCN, the client sends a list of preferred response formats in the <code>Accept</code> header, and the server determines the final selection:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /list HTTP/1.1
Accept: application/vnd.siren+json, application/vnd.hal+json, application/json
...

**** RESPONSE ****
200 OK HTTP/1.1
Content-Type: application/json
....</code></pre>
</div></div>
<div class="paragraph"><p>In this case, the server selected <code>application/json</code> as the media type. Clients can provide additional preference information in the form of a "quality" or <code>q</code> value, for <span class=".keep-together">example</span>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /list HTTP/1.1
Accept: application/vnd.hal+json;q=0.8, application/json;q=0.4
...

**** RESPONSE ****
200 OK HTTP/1.1
Content-Type: application/json
....</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the client indicated a higher preference for the <code>application/vnd.hal+json</code> media type. However, the server still selected <code>application/json</code> as the response format.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For more on quality (<code>q</code>) values, check out the <a href="https://oreil.ly/RDTl5">HTTP specification</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect4 xxx">
<h5 id="_reactive_content_negotiation_2">5.6.3.2. Reactive content negotiation</h5>
<div class="paragraph"><p>In RCN, the server returns a list of supported representations, and the client makes the final selection and resends the request:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /search HTTP/1.1

**** RESPONSE ****
HTTP/1.1 300 Multiple Choices
Link: &lt;http://api.example.org/html/search&gt;;rel="alternate html"
Link: &lt;http://api.example.org/api/search&gt;;rel="alternate api"
Location: http://api.example.org/html/search</code></pre>
</div></div>
<div class="paragraph"><p>Another RCN response returns the link values as HTML <code>anchor</code> tags in the body:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /search HTTP/1.1

**** RESPONSE ****
HTTP/1.1 300 Multiple Choices
Content-Type: text/html

&lt;html&gt;
  &lt;title&gt;Multiple Choices&lt;/title&gt;
  &lt;body&gt;
    &lt;h1&gt;Multiple Choices&lt;/h1&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href="http://api.example.org/html/search&gt;HTML&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href="http://api.example.org/api/search&gt;API&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_33">5.6.4. Discussion</h4>
<div class="paragraph"><p>When services support multiple representation formats, the most common approach is to use proactive (server-driven) content negotiation.  This is the simplest interaction even though it is possible the client may not receive its preferred format.</p></div>
<div class="paragraph"><p>RCN has some major drawbacks. Servers are essentially guessing what format to return. It is great when both client and service support the same formats, but there is little to do when there is no direct match. The usual choice is for services to just return whatever <em>they</em> prefer. The only real alternative is for services to return <code>406 Not Acceptable</code> when they can&#8217;t match a client&#8217;s <code>Accept</code> preferences.</p></div>
<div class="paragraph"><p>A drawback for PCN is that clients often don&#8217;t know what the server supports. Services can solve this problem by supporting the "meta" services pattern that allows <span class=".keep-together">services</span> to advertise client preferences (see <a href="#services-preferences">[services-preferences]</a>).</p></div>
<div class="paragraph"><p>I rarely encounter the reactive version of content negotiation in the wild. Because response details are not well specified, I don&#8217;t recommend using it for M2M use cases unless both parties have worked out all the details ahead of time.</p></div>
<div class="paragraph"><p>One way to avoid the content negotiation dance is to dedicate URL spaces for each representation format. For example:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>http://api.example.org/siren/search</em>
</p>
</li>
<li>
<p>
<em>http://api.example.org/hal/search</em>
</p>
</li>
<li>
<p>
<em>http://api.example.org/collection-json/search</em>
</p>
</li>
<li>
<p>
<em>http://api.example.org/html/search</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Of course, the drawback here is that service interfaces need to support many more URL paths.</p></div>
<div class="paragraph"><p>In my experience the most effective approach is to document supported formats in the API design-time documentation, then advertise client preferences (see <a href="#services-preferences">[services-preferences]</a>) and rely on proactive content negotiation at runtime.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_33">5.6.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-media-types">[design-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>
</p>
</li>
<li>
<p>
<a href="#services-preferences">[services-preferences]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-vocabularies">5.7. Publishing Complete Vocabularies for Machine Clients</h3>
<div class="paragraph"><p>When creating services that will be accessed by other services (e.g., M2M interfaces), it is important to make sure both parties have a solid "understanding" of each other. That means each message is complete and both parties recognize what is in the message. This is the essence of RESTful implementations. <a href="https://oreil.ly/dxgtv">Roy Fielding explains it this way</a>: "A RESTful API (done right) is just a website for clients with a limited vocabulary."</p></div>
<div class="sect3">
<h4 id="_problem_33">5.7.1. Problem</h4>
<div class="paragraph"><p>How can we make sure an API consumer will "understand" service responses adequately? What does it mean to send messages that are "self-describing"? What needs to be included when describing messages?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_33">5.7.2. Solution</h4>
<div class="paragraph"><p>The best way to make sure an API consumer "understands" messages from the API provider is to produce a <em>complete</em> vocabulary document that lists all the important data and action properties that may appear in a message. Leonard Richardson refers to these values as <a href="https://oreil.ly/ABEku">"magic strings"</a>. These are strings that services say "mean something" and that API providers and consumers can use to "tell each other" important information. In this book, I refer to these collections of magic strings as <em>vocabularies</em> or sometimes <em>profiles</em>.</p></div>
<div class="paragraph"><p>The <code>profile</code> link relation type is defined in <a href="https://oreil.ly/7daeB">RFC 6906</a> as to "allow clients to learn about additional semantics (constraints, conventions, extensions) that are associated with the resource representation." Applying a profile to a resource does not <em>change</em> the meaning of the contents in a message. Instead, profiles provide <em>additional</em> information about the message.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">A Profile by Any Other Name</div>
<div class="paragraph"><p>I&#8217;ve seen several terms used to identify this definitive list of data and action properties such as "dictionary" and "glossary," even "schema." But I would not use the terms "data dictionary" or "data model." That&#8217;s because service vocabularies define more than just the data properties of a service or properties of named objects. They also define all the action details, including links, forms, and query strings.</p></div>
</div></div>
<div class="paragraph"><p>A service profile contains <em>all</em> the identifiers it uses with messages. For example, consider the following HTML FORM:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"create-template"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://api.example.org/users"</span>
  <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span> <span style="color: #009900">enctype</span><span style="color: #990000">=</span><span style="color: #FF0000">"application/x-www-form-urlencoded"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"id"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"q1w2e3r4"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"familyName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mark"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"givenName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Morkelson"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"telephone"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"+1-555-123-4567"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"mork@example.org"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"status"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"active"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The vocabulary information in this form is: <code>create-template</code>, <code>id</code>, <code>familyName</code>, <code>givenName</code>, <code>telephone</code>, <code>email</code>, and <code>status</code>. Both the API service and the API consumer need to recognize and "understand" what these values represent. Notice that I did not include the <em>values</em> for those elements (e.g., <code>id=q1w2e3r4</code>), just the names. Also, I did not include the media type&#8217;s structural elements in my list (e.g., <code>name</code>, <code>action</code>, <code>method</code>, <code>enctype</code>, etc.).</p></div>
<div class="paragraph"><p>It is not enough just to identify the vocabulary elements. You also need to offer some explanation of what they represent and how they may appear in a message. For example, the <code>create-template</code> semantic value may appear as the <code>name</code> value of a <code>form</code> element in HTTP messages. This identifies the form clients can use to add new records to the system.</p></div>
<div class="paragraph"><p>You can also include additional information in your semantic profile documents, such as the source of the string value. For example, <code>familyName</code> is defined in the online dictionary <a href="https://oreil.ly/bKUaB">Schema.org</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_32">5.7.3. Example</h4>
<div class="paragraph"><p>The following are some example vocabulary documents (aka semantic profiles) for the <code>person</code> API listed in <a href="https://oreil.ly/SamLR">the book&#8217;s repo</a>. Here&#8217;s some sample output from that service:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "collection": <span style="color: #990000">{</span>
    "version": "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href": "<span style="color: #FF0000">http://localhost:8181</span>"<span style="color: #990000">,</span>
    "title": "<span style="color: #FF0000">BigCo Activity Records</span>"<span style="color: #990000">,</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://localhost:8181/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">Home</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://localhost:8181/list/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">List</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "id": "<span style="color: #FF0000">22s3k36pkn4</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">person</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">http://localhost:8181/22s3k36pkn4</span>"<span style="color: #990000">,</span>
        "data": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">22s3k36pkn4</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">id</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mockery</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">],</span>
        "links": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>
            "name": "<span style="color: #FF0000">read</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://localhost:8181/22s3k36pkn4</span>"<span style="color: #990000">,</span>
            "rel": "<span style="color: #FF0000">read</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">Read</span>"
          <span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "queries": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">filter</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">http://localhost:8181/filter/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">filter</span>"<span style="color: #990000">,</span>
        "prompt": "<span style="color: #FF0000">Search</span>"<span style="color: #990000">,</span>
        "data": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "template": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">id</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>At minimum, you should list all the semantic identifiers and include a description (see <a href="#table0502">[table0502]</a>).</p></div>
<div class="tableblock" id="table0502">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. Person API semantic profile</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Identifier </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>id</code></p></td>
<td align="left" valign="top"><p class="table">Record identifier for a person record</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>givenName</code></p></td>
<td align="left" valign="top"><p class="table">Given name for a person record</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>familyName</code></p></td>
<td align="left" valign="top"><p class="table">Family name for a person record</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>person</code></p></td>
<td align="left" valign="top"><p class="table">Indicates a person record</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>home</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the Home view</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>list</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the List view</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>read</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to a single person record</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>filter</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to filter the List view</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>As additional information, you can also list where—in the message—each element is likely to appear (see <a href="#table0503">[table0503]</a>).</p></div>
<div class="tableblock" id="table0503">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 3. Person API semantic profile with element locations</caption>
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top">Identifier </th>
<th align="left" valign="top"> Description </th>
<th align="left" valign="top"> Element</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>id</code></p></td>
<td align="left" valign="top"><p class="table">Record identifier for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>givenName</code></p></td>
<td align="left" valign="top"><p class="table">Given name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>familyName</code></p></td>
<td align="left" valign="top"><p class="table">Family name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>person</code></p></td>
<td align="left" valign="top"><p class="table">Indicates a person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>collection</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a collection of records</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>item</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a single record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>home</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the Home view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>list</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>read</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to a single person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>filter</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to filter the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>It is important to remember that the third column in <a href="#table0503">[table0503]</a> ("Element") will likely contain different elements depending on the media type returned. For example, if the service returned <code>person</code> representations using the <code>application/forms+json</code> media type, the table would look like <a href="#table0504">[table0504]</a>.</p></div>
<div class="tableblock" id="table0504">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 4. Person API semantic profile with media type locations</caption>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<thead>
<tr>
<th align="left" valign="top">Identifier </th>
<th align="left" valign="top"> Description </th>
<th align="left" valign="top"> Element (Cj) </th>
<th align="left" valign="top"> Element (Fj)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>id</code></p></td>
<td align="left" valign="top"><p class="table">Record identifier for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>givenName</code></p></td>
<td align="left" valign="top"><p class="table">Given name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>familyName</code></p></td>
<td align="left" valign="top"><p class="table">Family name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>person</code></p></td>
<td align="left" valign="top"><p class="table">Indicates a person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>collection</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a collection of records</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>item</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a single record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>home</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the Home view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>list</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>read</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to a single person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>filter</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to filter the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Notice that for the FormsJSON format, some semantic values appear as structural elements in JSON (<code>id</code>, <code>givenName</code>, <code>familyName</code>, and <code>person</code>), and others appear as value elements (<code>collection</code>, <code>item</code>, <code>list</code>, <code>home</code>, <code>read</code>, and <code>filter</code>). This mix of structure and value is what makes each media type unique. If your service supports more than one media type, you&#8217;ll need to supply semantic profile information that properly "maps" semantic elements to message elements:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "person": <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "id": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "name": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">http://localhost:8181/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "title": "<span style="color: #FF0000">Home</span>"<span style="color: #990000">,</span>
        "method": "<span style="color: #FF0000">GET</span>"<span style="color: #990000">,</span>
        "properties": <span style="color: #990000">[]</span>
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "id": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span>
        "name": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">http://localhost:8181/list/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">list collection</span>"<span style="color: #990000">,</span>
        "title": "<span style="color: #FF0000">List</span>"<span style="color: #990000">,</span>
        "method": "<span style="color: #FF0000">GET</span>"<span style="color: #990000">,</span>
        "properties": <span style="color: #990000">[]</span>
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "id": "<span style="color: #FF0000">filter</span>"<span style="color: #990000">,</span>
        "name": "<span style="color: #FF0000">filter</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">http://localhost:8181/filter/</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">filter collection</span>"<span style="color: #990000">,</span>
        "title": "<span style="color: #FF0000">Search</span>"<span style="color: #990000">,</span>
        "method": "<span style="color: #FF0000">GET</span>"<span style="color: #990000">,</span>
        "properties": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "links": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>
            "id": "<span style="color: #FF0000">read_22s3k36pkn4</span>"<span style="color: #990000">,</span>
            "name": "<span style="color: #FF0000">read</span>"<span style="color: #990000">,</span>
            "href": "<span style="color: #FF0000">http://localhost:8181/22s3k36pkn4</span>"<span style="color: #990000">,</span>
            "rel": "<span style="color: #FF0000">read item</span>"<span style="color: #990000">,</span>
            "title": "<span style="color: #FF0000">Read</span>"<span style="color: #990000">,</span>
            "method": "<span style="color: #FF0000">GET</span>"<span style="color: #990000">,</span>
            "properties": <span style="color: #990000">[]</span>
          <span style="color: #990000">}</span>
        <span style="color: #990000">],</span>
        "id": "<span style="color: #FF0000">22s3k36pkn4</span>"<span style="color: #990000">,</span>
        "givenName": "<span style="color: #FF0000">Mork</span>"<span style="color: #990000">,</span>
        "familyName": "<span style="color: #FF0000">Mockery</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_34">5.7.4. Discussion</h4>
<div class="paragraph"><p>Essentially, semantic profiles carry the domain elements (<code>person</code>, <code>list</code>, <code>filter</code>, etc.) of the service. You can think of semantic profiles as a method for documenting the service domain.</p></div>
<div class="paragraph"><p>It is worth pointing out that these semantic profiles do not explain <em>how</em> the <code>filter</code> hypermedia control works—just that it might appear in the response. Semantic profiles assume the API consumer application understands that media type is independent of the profile. This separation between understanding message formats and understanding the semantics <em>within</em> the message is an important feature of well-designed hypermedia services.</p></div>
<div class="paragraph"><p>When your service doesn&#8217;t use a registered media type and instead uses a serialization formation like plain JSON or XML, services generally embed the semantics of the domain into the structure of the message. For example, here&#8217;s a possible response for the <code>person</code> service in XML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;list&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;home</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"collection"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;list</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"collection"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;filter</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"get"</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"collection"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;givenName&gt;&lt;/givenName&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;familyName&gt;&lt;/familyName&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/filter&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;person</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"item read"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;familyName&gt;</span></span>...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/familyName&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;givenName&gt;</span></span>...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/givenName&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/person&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/list&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The semantic profile mapping would look like <a href="#table0505">[table0505]</a>.</p></div>
<div class="tableblock" id="table0505">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 5. Person API semantic profile with both JSON and XML location hints</caption>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<thead>
<tr>
<th align="left" valign="top">Identifier </th>
<th align="left" valign="top"> Description </th>
<th align="left" valign="top"> Element (Cj) </th>
<th align="left" valign="top"> Element (Fj) </th>
<th align="left" valign="top"> Element (XML)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><code>id</code></p></td>
<td align="left" valign="top"><p class="table">Record identifier for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
<td align="left" valign="top"><p class="table">ATTRIBUTE</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>givenName</code></p></td>
<td align="left" valign="top"><p class="table">Given name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>familyName</code></p></td>
<td align="left" valign="top"><p class="table">Family name for a person record</p></td>
<td align="left" valign="top"><p class="table"><code>name</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>person</code></p></td>
<td align="left" valign="top"><p class="table">Indicates a person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table">KEY</p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>collection</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a collection of records</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>item</code></p></td>
<td align="left" valign="top"><p class="table">Identifies a single record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>home</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the Home view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>list</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>read</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to navigate to a single person record</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><code>filter</code></p></td>
<td align="left" valign="top"><p class="table">Hypermedia control to filter the List view</p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code></p></td>
<td align="left" valign="top"><p class="table"><code>rel</code>, <code>name</code>, <code>id</code></p></td>
<td align="left" valign="top"><p class="table">ELEMENT</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>In this case, the domain semantics are so intertwined with the message format that changes in the internal domain elements may break structural changes in the external interface (e.g., renaming elements, adding/removing attributes, etc.). Whenever possible, keep the message details (the external interface) independent of the domain details (internal functionality). When I see cases where the domain semantics appear as structural elements within a response, this sets off alarm bells for me to rethink my message design to make sure I&#8217;m not leaking internal details to the external interface. See <a href="#services-actions">[services-actions]</a> for more on this topic.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_34">5.7.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-media-types">[services-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabulary-formats">[services-vocabulary-formats]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-vocabulary-formats">5.8. Supporting Shared Vocabularies in Standard Formats</h3>
<div class="paragraph"><p>When service interfaces adopt the practice of using standard structured media types (SMTs) for exchanging messages, they also need to standardize the manner in which the domain-specific properties and actions (or <em>semantics</em>) of the service are expressed at runtime.  This is similar to the message format challenge. The solution is to rely on standardized formats to express meaning. The real work is to express internal data or object models as consistent external semantic models.</p></div>
<div class="sect3">
<h4 id="_problem_34">5.8.1. Problem</h4>
<div class="paragraph"><p>How can we standardize the way in which the meaning of content is transferred between machines? What formats are available for this work, and what is the pattern for expressing internal data and process models as standardized semantic models?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_34">5.8.2. Solution</h4>
<div class="paragraph"><p>Just as API consumers rely on standardized protocols (e.g., HTTP) and standardized message formats (e.g., SIREN, Collection+JSON, etc.), they also can benefit from standardized vocabularies. That means listing all the data properties and action names in a standard format that the client understands.</p></div>
<div class="paragraph"><p>This means there needs to be a single source for all the possible names of things that might appear in your API; for example, any value that might appear in attributes like <code>id</code>, <code>name</code>, <code>class</code>, <code>rel</code>, or similar structural elements. A collection of these values can cover a topic or domain (like "User Management" or "Accounting").</p></div>
<div class="paragraph"><p>There are a couple of options for carrying vocabulary data in a standardized form. One of the oldest known solutions is to use a <a href="https://www.w3.org/RDF">Resource Description Framework (RDF)</a> format like <a href="https://oreil.ly/jmQS3">RDF/XML</a>, <a href="https://oreil.ly/UV1eM">Turtle</a>, and <a href="https://oreil.ly/sRV7J">JSON-LD</a>. There are a handful of schema-centric RDF languages, including <a href="https://oreil.ly/YTvwl">OWL</a> and <a href="https://oreil.ly/8XOy6">RDF Schema</a>, too. The JSON-LD format is the one I see more often when APIs use an RDF-based format.</p></div>
<div class="paragraph"><p>It is also possible to use schema documents: <a href="https://oreil.ly/OK7jO">XSD</a> for XML messages and <a href="https://json-schema.org">JSON Schema</a> for JSON-based messages. While these formats are well established with lots of tooling, it is worth noting that common uses of XSD and JSON Schema are limited to defining a vocabulary&#8217;s data property names and usually don&#8217;t include action names (e.g., names of forms, link relation identifiers, etc.).</p></div>
<div class="paragraph"><p>The format I use to document vocabularies is the <a href="https://oreil.ly/6DLZn">Application-Level Profile Semantics (ALPS)</a>  format. There are serializations of ALPS for XML, JSON, and even YAML.</p></div>
</div>
<div class="sect3">
<h4 id="_example_33">5.8.3. Example</h4>
<div class="paragraph"><p>The following is an RDF version of a <code>person</code> expressed in the <a href="https://oreil.ly/jVQRj">FOAF (friend of a friend)</a> vocabulary:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
@prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .
@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .

&lt;#JW&gt;
    a foaf:Person ;
    foaf:name "James Wales" ;
    foaf:mbox &lt;mailto:jwales@bomis.com&gt; ;
    foaf:homepage &lt;http://www.jameswales.com&gt; ;
    foaf:nick "Jimbo" ;
    foaf:depiction &lt;http://www.jameswales.com/aus_img_small.jpg&gt; ;
    foaf:interest &lt;http://www.wikimedia.org&gt; ;
    foaf:knows [
        a foaf:Person ;
        foaf:name "Angela Beesley"
    ] .

&lt;http://www.wikimedia.org&gt;
    rdfs:label "Wikimedia"</code></pre>
</div></div>
<div class="paragraph"><p><a href="#fig0503">[fig0503]</a> is a diagram of that same RDF document using the <a href="https://oreil.ly/UAPe8">":isSemantic" visualization service</a>.</p></div>
<div class="imageblock" id="fig0503">
<div class="content">
<img src="images/rwcb_0503.png" alt="images/rwcb_0503.png" width="80%" />
</div>
<div class="title">Figure 8. FOAF RDF rendering of a person</div>
</div>
<div class="paragraph"><p>For another approach, the following is a portion of the ALPS document that details the <code>person</code> service API we&#8217;ve been referring to throughout this recipe. See <a href="#design-profiles">[design-profiles]</a> for details on the ALPS format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$schema": "<span style="color: #FF0000">https://alps-io.github.io/schemas/alps.json</span>"<span style="color: #990000">,</span>
  "alps":
  <span style="color: #990000">{</span>
    "version": "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "title": "<span style="color: #FF0000">Person Service API</span>"<span style="color: #990000">,</span>

    "descriptor" : <span style="color: #990000">[</span>
     ...
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span>
        "title":"<span style="color: #FF0000">Home (starting point) of the person service</span>"<span style="color: #990000">,</span>
        "tag":"<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">],</span>
        "doc" : <span style="color: #990000">{</span>"value" : "<span style="color: #FF0000">Person API starting point</span>"<span style="color: #990000">}</span>
     <span style="color: #990000">},</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span>
        "title":"<span style="color: #FF0000">List of person resources</span>"<span style="color: #990000">,</span>
        "tag":"<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#person</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goFilter</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goItem</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doCreate</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">],</span>
        "doc" : <span style="color: #990000">{</span>"value" : "<span style="color: #FF0000">List of person resources</span>"<span style="color: #990000">}</span>
     <span style="color: #990000">},</span>
     <span style="color: #990000">{</span>"id": "<span style="color: #FF0000">item</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">semantic</span>"<span style="color: #990000">,</span>
        "title":"<span style="color: #FF0000">Single person resource</span>"<span style="color: #990000">,</span>
        "tag":"<span style="color: #FF0000">taxonomy</span>"<span style="color: #990000">,</span>
        "descriptor": <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#person</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goHome</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goList</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goFilter</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#goItem</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doUpdate</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doStatus</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">#doRemove</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">],</span>
        "doc" : <span style="color: #990000">{</span>"value" : "<span style="color: #FF0000">A single person resource</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">},</span>
      ...
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p><a href="#fig0504">[fig0504]</a> is a graphical representation of the full <code>person</code> profile using the <a href="https://oreil.ly/G7Rnn">"app-state-diagram (ASD)" tool</a>.</p></div>
<div class="imageblock" id="fig0504">
<div class="content">
<img src="images/rwcb_0504.png" alt="images/rwcb_0504.png" width="80%" />
</div>
<div class="title">Figure 9. ALPS rendering of a person</div>
</div>
<div class="paragraph"><p>A key difference between RDF and ALPS is that RDF focuses on the relationship between <em>data</em> items, and ALPS focuses on the relationship between <em>action</em> items. One vocabulary format that bridges that gap pretty well is the <a href="https://oreil.ly/yEGsL">Hydra ontology</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_35">5.8.4. Discussion</h4>
<div class="paragraph"><p>Service APIs can use semantic profile URLs as <em>identifiers</em> without needing to fully understand what is contained in a semantic profile document. For example, by including a profile URL in the header collection for responses, the service API is telling API consumers what vocabulary that service API "speaks":</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /shopping/ HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Link: &lt;http://docs.alps.io/shopping-v2.json&gt;; rel="profile"</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the API service is "advertising" that it supports version 2 of the <code>shopping</code> profile. For more on how API providers and consumers can negotiate for profile support, see <a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>.</p></div>
<div class="paragraph"><p>Profiles that detail the semantics of an interface do not fill the same role as schema documents. Schemas are used to describe objects or document messages. Semantic profiles are used to describe the way these objects (or documents) interact with each other. Publishing a profile document helps developers (and machines) understand the problem space—the possibilities within an API. Depending on the message formats you are using, you may also want to publish schema documents to help people and machines understand the types of objects and documents that will be passed around within the problem space. See <a href="#clients-schema">[clients-schema]</a> for more on how to take advantage of schema documents for APIs.</p></div>
<div class="paragraph"><p>It is also worth mentioning that semantic profile documents like ALPS are not the same thing as API definition documents such as OpenAPI, AsyncAPI, Protobuf, SOAP, etc. Semantic profiles provide a complete vocabulary of properties and actions for a collection of APIs (those that support that profile). API definition documents provide details on just how a single instance of a service API is implemented—the one that lives at <em>http://api.example.org/shopping</em>, for example.</p></div>
<div class="paragraph"><p>An important part of proper support for semantic profiles is mapping the profile elements to media type elements in the messages that are exchanged. See <a href="#services-vocabularies">[services-vocabularies]</a> for more on how to document profile/media type mapping.</p></div>
<div class="paragraph"><p>It is a good idea to include semantic profile documents in all your service API documentation. This helps API consumers by providing a detailed list of vocabulary elements and can provide important hints to API consumers on how to navigate the "problem space" your service supports. See <a href="#services-metadata">[services-metadata]</a> for a more comprehensive list of assets services APIs should provide to consumers.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_35">5.8.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profile-negotiation">[clients-profile-negotiation]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#services-conneg">[services-conneg]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-definitions">5.9. Publishing Service Definition Documents</h3>
<div class="paragraph"><p>Most service APIs should publish a Service Definition Document (SDD) that explicitly describes the shared interface that both API providers and API consumers need to understand in order to successfully interact. Today, the most common way to do this is to publish your API&#8217;s definition in one of several standard formats.</p></div>
<div class="sect3">
<h4 id="_problem_35">5.9.1. Problem</h4>
<div class="paragraph"><p>What are the common SDD formats? How can you easily share SDDs with API consumers? What URLs and/or link relation values should be used when sharing SDDs? Along with direct links in the API, should links to SDDs be listed in other locations? Appear in other documents?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_35">5.9.2. Solution</h4>
<div class="paragraph"><p>For most APIs, there is a fixed set of URLs and message bodies that are shared at runtime. These fixed "endpoints" and "objects" can be documented in a number of different formats based on the style of the service interface implementation.</p></div>
<div class="paragraph"><p>The most common API styles (and their related SDDs) are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
HTTP CRUD
</dt>
<dd>
<p>
OpenAPI, Web Application Description Language (WADL)
</p>
</dd>
<dt class="hdlist1">
Event-driven
</dt>
<dd>
<p>
AsyncAPI, CloudEvents
</p>
</dd>
<dt class="hdlist1">
Remote procedure
</dt>
<dd>
<p>
Protocol buffers, XML-RPC, JSON-RPC
</p>
</dd>
<dt class="hdlist1">
Remote data query
</dt>
<dd>
<p>
Schema Definition Language (for GraphQL), OData
</p>
</dd>
<dt class="hdlist1">
Remote messaging
</dt>
<dd>
<p>
Web Service Definition Language (WSDL)
</p>
</dd>
<dt class="hdlist1">
Hypermedia
</dt>
<dd>
<p>
Application-Level Profile Semantics (ALPS)
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Typically, SDDs are designed to streamline the work of generating human-readable documentation and/or generating API consumer code. Sometimes SDDs are actually generated <em>from</em> code. For example, both OpenAPI and WSDL can be generated from existing source code. As of this writing, many of the formats are authored "by hand" as part of the service interface design process.</p></div>
<div class="paragraph"><p>However the document is created, it is a good idea to publish that document at an easily found location. This will help API client application developers quickly get up to speed on consuming the service API successfully. The best way to do this is to return a link to the SDD in HTTP responses either as a <code>link</code> header, within the response body, or both. RFC 8631 defines a link relation value of <a href="https://oreil.ly/MNR2H"><code>service-desc</code></a> to use when identifying links that point to SDD documents. It is also a good idea to return a pointer to the SDD in a <code>link</code> header in response to an HTTP <code>OPTIONS</code> request. See the examples in this recipe for details.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>It is a good idea to include a link to the SDD document in your API metadata document (see <a href="#services-metadata">[services-metadata]</a>).</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_example_34">5.9.3. Example</h4>
<div class="paragraph"><p>There are three good places to advertise your API&#8217;s SDD location: the HTTP <code>link</code> response header, as part of your interface&#8217;s service metadata, and as part of the HTTP <code>OPTIONS</code> response.</p></div>
<div class="sect4 xxx">
<h5 id="_sdds_in_http_responses">5.9.3.1. SDDs in HTTP responses</h5>
<div class="paragraph"><p>You can return a pointer to the API&#8217;s SDD as a <code>link</code> header in any API response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>HTTP/1.1 200 OK
Content-Type: application/vnd.hal+json
Link: &lt;http://api.example.org/service-desc&gt;; rel=service-desc
...</code></pre>
</div></div>
<div class="paragraph"><p>You can also return this information in the body of the response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
...

{ "collection" : {
  "links" : [
    {"rel": "service-desc", "href": "http://api.example.org/service-desc"}
  ]
  ...
}}</code></pre>
</div></div>
<div class="paragraph"><p>When the format supports it, you can return the SDD location in both the header and body of a response.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_sdds_in_service_metadata_responses">5.9.3.2. SDDs in service metadata responses</h5>
<div class="paragraph"><p>You can also return the location of the SDD in your API&#8217;s metadata document (see <a href="#services-metadata">[services-metadata]</a>). The format I recommend for service metadata is <em>APIs.json</em>, and that specification has reserved keywords for the most common SDD formats.</p></div>
<div class="paragraph"><p>Here&#8217;s a snippet of an <em>APIs.json</em> document that cites support for an OpenAPI SDD:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">Index</span>"<span style="color: #990000">,</span>
  "created": "<span style="color: #FF0000">2014-04-07</span>"<span style="color: #990000">,</span>
  "modified": "<span style="color: #FF0000">2020-09-03</span>"<span style="color: #990000">,</span>
  "url": "<span style="color: #FF0000">http://example.com/apis.json</span>"<span style="color: #990000">,</span>
  "specificationVersion": "<span style="color: #FF0000">0.14</span>"<span style="color: #990000">,</span>
  "apis": <span style="color: #990000">[</span>
  <span style="color: #990000">{</span>
    "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
    "humanURL": "<span style="color: #FF0000">http://example.com</span>"<span style="color: #990000">,</span>
    "baseURL": "<span style="color: #FF0000">http://api.example.com</span>"<span style="color: #990000">,</span>
    "properties": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">OpenAPI</span>"<span style="color: #990000">,</span> "url": "<span style="color: #FF0000">http://example.com/openapi.json</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
  ...
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you are using an SDD format that is not currently covered by the <em>APIs.json</em> specification, you can add your own format as an extension, too.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect4 xxx">
<h5 id="_sdds_in_http_options_responses">5.9.3.3. SDDs in HTTP OPTIONS responses</h5>
<div class="paragraph"><p>You can include the SDD in a <code>link</code> header and/or link the body of the <code>OPTIONS</code> response too:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
OPTIONS / HTTP/1.1
Host: api.example.org
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.siren+json
Content-Length: XX
Cache-Control: max-age=604800
Allow: GET PUT DELETE HEAD OPTIONS
Accept: application/zip application/gzip
Accept-Charset: utf-8
Accept-Encoding: compress
Accept-Language: en
Link: &lt;https://api.example.org/service-desc&gt;; rel="service-desc"</code></pre>
</div></div>
<div class="paragraph"><p>See <a href="#services-preferences">[services-preferences]</a> for more on using the <code>OPTIONS</code> method.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_36">5.9.4. Discussion</h4>
<div class="paragraph"><p>It is a good idea to store the SDD document in the root folder of the service interface when possible. It can also be helpful to name the document <em>service-desc</em>. If you do these two things consistently, your API consumers can "assume" the location of the SDD, which will make it easier on API developers.</p></div>
<div class="paragraph"><p>The formats collection is not an exhaustive list. The reader may be using other SDD formats, and some large organizations even have their own in-house SDDs that they use. I&#8217;ve included the SDDs that, in my experience, have appeared most often "in the wild."</p></div>
<div class="paragraph"><p>In some cases, the service supports multiple interface styles (e.g., HTTP CRUD and GraphQL). In that case, you can return multiple SDD documents in the header or body of your responses:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>HTTP/1.1 200 OK
Content-Type: application/vnd.hal+json
Link: &lt;http://api.example.org/openapi/service-desc&gt;; rel="service-desc"; \
type="application/openapi+json"
Link: &lt;http://api.example.org/graphql/service-desc&gt;; rel=service-desc"; \
type="application/sdl+json"
...</code></pre>
</div></div>
<div class="paragraph"><p>You can use the <code>type</code> property of the <code>Link</code> header to indicate the expected format of the response (see the preceding example). The challenge here is that most SDD formats do not have their own media type identifier string registered with the <a href="https://oreil.ly/EEAst">IANA</a>. For my own work, I&#8217;ve adopted a set of media type identifiers and include them in my API documentation. This is less than ideal but works as expected. Hopefully, by the time you are reading this book, more SDD formats will have acquired their own registered media type identifiers.</p></div>
<div class="paragraph"><p>Note that there isn&#8217;t an agreed standard SDD format for hypermedia-style APIs. For now, I recommend including an ALPS document as part of the API&#8217;s <code>profile</code> (see <a href="#services-vocabularies">[services-vocabularies]</a>).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_36">5.9.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-metadata">5.10. Publishing API Metadata</h3>
<div class="paragraph"><p>As the number of application interfaces on the open web grows, there is a need for a common format and common vocabulary for describing metadata <em>about</em> the API. This is especially important when service providers want to communicate important details about the API without the need for physical meetings, interactions, and/or bespoke description and documentation efforts. Luckily, there is a strong contender for carrying this information: <a href="https://oreil.ly/Imjf1">the <em>APIs.json</em> specification</a>.</p></div>
<div class="sect3">
<h4 id="_problem_36">5.10.1. Problem</h4>
<div class="paragraph"><p>How can we represent important metadata about a service interface (supported formats, vocabularies, documentation, security, etc.) in a standardized way that allows API consumers to easily find and understand the metalevel details of the interface?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_36">5.10.2. Solution</h4>
<div class="paragraph"><p>A very dependable way to catalog and publish API metadata is to use the <a href="https://oreil.ly/gQtxo"><em>APIs.json</em> open specification</a>. It has a vocabulary and structural layout that covers most of the important metadata elements for APIs (basic definitions, properties of the API, important URLs, key contacts and maintainers, etc.). It is also extensible so API providers can, when needed, expand the <em>APIs.json</em> document (in a backward-compatible way) to fit their needs.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">APIs.json, APIs.yaml, and APIS.txt</div>
<div class="paragraph"><p><em>APIs.json</em> documents can be formatted as JSON, YAML, or TXT files. You can learn more about <em>APIs.json</em> by visiting the <a href="http://apisjson.org">specification site</a>. You can also find a publicly hosted version of a search engine for <em>APIs.json</em> documents at <a href="http://apis.io">http://apis.io</a>.</p></div>
</div></div>
<div class="paragraph"><p>The <em>APIs.json</em> specification defines several key sections of the document:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Root
</dt>
<dd>
<p>
The name, description, URL, and other basic information about the API
</p>
</dd>
<dt class="hdlist1">
APIs
</dt>
<dd>
<p>
The list of APIs identified in the document
</p>
</dd>
<dt class="hdlist1">
Tools
</dt>
<dd>
<p>
The list of open source tooling available as part of operations
</p>
</dd>
<dt class="hdlist1">
Specifications
</dt>
<dd>
<p>
The list of open specifications adopted as part of operations
</p>
</dd>
<dt class="hdlist1">
Resources
</dt>
<dd>
<p>
The list of resources available for API operations
</p>
</dd>
<dt class="hdlist1">
Common
</dt>
<dd>
<p>
A list of common properties for use across all APIs and tools
</p>
</dd>
<dt class="hdlist1">
Include
</dt>
<dd>
<p>
Other <em>APIs.json</em> documents to include in this document
</p>
</dd>
<dt class="hdlist1">
Maintainers
</dt>
<dd>
<p>
A collection of persons and/or organizations maintaining this API
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Providers can document the API&#8217;s metadata in a single document (named <em>apis.json</em>) available at the root folder of the service (e.g., <a href="http://api.example.org/apis.json">http://api.example.org/apis.json</a>). APIs an also provide a link relation value that can be included in an HTTP header and/or within the body of an HTTP response. The <code>service-meta</code> relation value (defined in <a href="https://oreil.ly/ymnrn">RFC 8631</a>) is the recommended value to use when pointing to the API&#8217;s <em>APIs.json</em> document.</p></div>
<div class="paragraph"><p>It&#8217;s a good idea to support a link on the "Home" resource of your service interface that points to the <code>service-meta</code> resource (see <a href="#fig0505">[fig0505]</a>).</p></div>
<div class="imageblock" id="fig0505">
<div class="content">
<img src="images/rwcb_0505.png" alt="images/rwcb_0505.png" width="80%" />
</div>
<div class="title">Figure 10. API metadata recipe</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For details on the <code>service-meta</code> <em>APIs.json</em> resource, check out the online collection of <a href="https://oreil.ly/RKhJ8">ALPS documents</a> associated with this book.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_example_35">5.10.3. Example</h4>
<div class="paragraph"><p>Here is a short example of an <em>APIs.json</em> document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>apis<span style="color: #990000">+</span>json
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">Index</span>"<span style="color: #990000">,</span>
  "description": "<span style="color: #FF0000">This is an example APIs.json file.</span>"<span style="color: #990000">,</span>
  "image": "<span style="color: #FF0000">https://api.example.org/logo.jpg</span>"<span style="color: #990000">,</span>
  "tags": <span style="color: #990000">[</span>"Application Programming Interface"<span style="color: #990000">,</span>"API"<span style="color: #990000">],</span>
  "created": "<span style="color: #FF0000">2014-04-07</span>"<span style="color: #990000">,</span>
  "modified": "<span style="color: #FF0000">2020-09-03</span>"<span style="color: #990000">,</span>
  "url": "<span style="color: #FF0000">http://example.com/apis.json</span>"<span style="color: #990000">,</span>
  "specificationVersion": "<span style="color: #FF0000">0.14</span>"<span style="color: #990000">,</span>
  "apis": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>
      "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">This provides details about a specific API.</span>"<span style="color: #990000">,</span>
      "humanURL": "<span style="color: #FF0000">http://example.com</span>"<span style="color: #990000">,</span>
      "baseURL": "<span style="color: #FF0000">http://api.example.com</span>"<span style="color: #990000">,</span>
      "tags": <span style="color: #990000">[</span>"API"<span style="color: #990000">,</span>"Application Programming Interface"<span style="color: #990000">],</span>
      "properties": <span style="color: #990000">[</span>
         <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Documentation</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">https://example.com/documentation</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">OpenAPI</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">http://example.com/openapi.json</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">],</span>
      "contact": <span style="color: #990000">[{</span>"FN": "<span style="color: #FF0000">APIs.json</span>"<span style="color: #990000">,</span>"email": "<span style="color: #FF0000">info@apisjson.org</span>"<span style="color: #990000">}]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "specifications": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">OpenAPI</span>"<span style="color: #990000">,</span> "url": "<span style="color: #FF0000">https://openapis.org</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">JSON Schema</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">https://json-schema.org/</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "common": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Signup</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">https://example.com/signup</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Authentication</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">http://example.com/authentication</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Login</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">https://example.com/login</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "maintainers": <span style="color: #990000">[{</span>"FN": "<span style="color: #FF0000">Mark Morkelson</span>"<span style="color: #990000">,</span>"email": "<span style="color: #FF0000">mork@example.org</span>"<span style="color: #990000">}]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph pagebreak-before less_space"><p>Services can advertise availability of the <em>APIs.json</em> document in HTTP responses:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>HTTP/1.1 200 OK
Content-Type: HTML
Link: &lt;http://api.example.org/apis.json&gt;; rel=service-meta
...

&lt;html&gt;
  &lt;head&gt;
    &lt;link rel="service-meta" href="http://api.example.org/apis.json" /&gt;
  &lt;/head&gt;
  &lt;body&gt;
  ...
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div></div>
<div class="paragraph"><p>API client applications can also automatically "look" for <em>APIs.json</em> documents by calling to the default location of the file as stated in the specification:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /apis.json HTTP/1.1
Accept: application/apis+json, application/yaml, text/plain
Host: http://api.example.org</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_discussion_37">5.10.4. Discussion</h4>
<div class="paragraph"><p>It is important to note that the <em>APIs.json</em> specification is meant to carry related information about a service interface, but it is not meant to <em>describe</em> or <em>define</em> that interface in detail. Other formats, such as OpenAPI, AsyncAPI, Protobuf, etc., were designed for that purpose. See <a href="#services-definitions">[services-definitions]</a> for details on service definition formats and how to share them with API consumers.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>As of this writing, the <em>APIs.json</em> specification is not yet finalized. However, I&#8217;ve found the format (and the related search engine) stable and useful, and I encourage readers to keep an eye on this <span class=".keep-together">specification</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>One of the reasons to adopt the <em>APIs.json</em> format for service metadata is that there is a related open source project that provides a search engine that uses the <em>APIs.json</em> format as input. You can find the <a href="https://oreil.ly/SYgMp">current edition of the <em>APIs.json</em> search engine project online</a>. As of this writing, you can fork or download this project and start up your own API search engine to host <em>APIs.json</em> documents.</p></div>
<div class="paragraph"><p>An added feature of the <em>APIs.json</em> search engine project is support for its own API dedicated to automating the uploading and validation of <em>APIs.json</em> documents for that search engine. This would make it possible to create an automated process for registering APIs with target API search engines.</p></div>
<div class="paragraph"><p>The <em>APIs.json</em> specification contains more than 50 reserved words. Most of them are known as "Properties Elements" and are used for the <code>type</code> values for entries in the <code>common</code> section of an <em>APIs.json</em> document. Here are just a few samples:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Signup</code>
</p>
</li>
<li>
<p>
<code>Login</code>
</p>
</li>
<li>
<p>
<code>TermsOfService</code>
</p>
</li>
<li>
<p>
<code>InterfaceLicense</code>
</p>
</li>
<li>
<p>
<code>PrivacyPolicy</code>
</p>
</li>
<li>
<p>
<code>Security</code>
</p>
</li>
<li>
<p>
<code>StatusPage</code>
</p>
</li>
<li>
<p>
<code>Pricing</code>
</p>
</li>
<li>
<p>
<code>Rate Limits</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can also add your own names to this list of "Properties Elements" as extensions to the specification.</p></div>
<div class="paragraph"><p>Another specification that could be used to carry API metadata is the <a href="https://oreil.ly/fzSoX">JSON Home specification</a>. However, this specification proposal has not been updated in several years, and I have not seen examples of JSON Home "in the wild" as often as I have seen the <em>APIs.json</em> specification discussed here.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_37">5.10.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-definitions">[services-definitions]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-health">5.11. Supporting Service Health Monitoring</h3>
<div class="paragraph"><p>One of the advantages of using microservices on the web is that you don&#8217;t have to program all the functionality yourself; you can rely on the creativity of others. However, adding dependent services to your own increases the likelihood of failure on a distributed network. A good way to monitor the status of dependent services is to make regular "health checks" to other services to make sure they are up and running properly.</p></div>
<div class="sect3">
<h4 id="_problem_37">5.11.1. Problem</h4>
<div class="paragraph"><p>How can we consistently and regularly monitor the status (or health) of services on the web to make sure they are up and running and performing as expected? What are the common values we should monitor to assess the health of a service? What is the standard format for passing those status values? How do we advertise support for health monitoring, and how do we share that status data?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_37">5.11.2. Solution</h4>
<div class="paragraph"><p>Health and status monitoring of services running on the web is a common challenge. The good news is that there has been lots of good work in the area of standardizing this process over the last few years. There is currently an expired draft document called <a href="https://oreil.ly/QPgD7">"Health Check Response Format for HTTP APIs"</a>. This specification was first published in 2018, and I&#8217;ve been using it as a guide for implementing health and status checking for quite some time.</p></div>
<div class="paragraph"><p>The Health Check specification defines several properties, including these basics:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>status</code>
</dt>
<dd>
<p>
Indicates the service status (<code>pass</code>, <code>fail</code>, <code>warn</code>)
</p>
</dd>
<dt class="hdlist1">
<code>version</code>
</dt>
<dd>
<p>
Public version of the service
</p>
</dd>
<dt class="hdlist1">
<code>releaseId</code>
</dt>
<dd>
<p>
Service release/version
</p>
</dd>
<dt class="hdlist1">
<code>notes</code>
</dt>
<dd>
<p>
Array of notes relevant to current state of health
</p>
</dd>
<dt class="hdlist1">
<code>output</code>
</dt>
<dd>
<p>
Raw error output, in case of <code>fail</code> or <code>warn</code> states
</p>
</dd>
<dt class="hdlist1">
<code>checks</code>
</dt>
<dd>
<p>
An object providing detailed health statuses of additional downstream systems
</p>
</dd>
<dt class="hdlist1">
<code>links</code>
</dt>
<dd>
<p>
An object containing link relations and URIs for external links that <em>may</em> contain more information about the health of the service
</p>
</dd>
<dt class="hdlist1">
<code>serviceId</code>
</dt>
<dd>
<p>
A unique identifier of the service
</p>
</dd>
<dt class="hdlist1">
<code>description</code>
</dt>
<dd>
<p>
A human-friendly description of the service
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <code>checks</code> object represents a collection of related "downstream" services. It is a bit of a "look ahead" to the health of other dependent services. This object has several more properties defined, and you can review the specification for details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Here are some additional things to keep in mind when implementing the Health Check specification:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Health resource
</dt>
<dd>
<p>
Services should expose an "endpoint" that can be used to request a health status document. The spec suggests (but does not require) that services use <code>/health</code> as the URL for this.
</p>
</dd>
<dt class="hdlist1">
Health link relation value
</dt>
<dd>
<p>
Although not mentioned in the specification document, I also use the <code>health-check</code> link relation value to identify the URL that will return the health status information.
</p>
</dd>
<dt class="hdlist1">
Health media type
</dt>
<dd>
<p>
When returning the health status information, services should use the <code>application/health+json</code> media type identifier and return a valid (based on the specification) health status document.
</p>
</dd>
<dt class="hdlist1">
Caching
</dt>
<dd>
<p>
Services should include an HTTP caching directive with the response (<code>max-age</code>, <code>ETag</code>, etc.) to reduce the impact of frequent requests (and avoid a denial of service attack vector). Of course, clients should honor the caching directives, too.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>See the examples for details.</p></div>
<div class="paragraph"><p>It is a good idea to support a link on the "Home" resource of your service interface that points to the <code>health</code> resource (see <a href="#fig0506">[fig0506]</a>).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For details on the <code>health</code> Health Checks resource, check out the online collection of <a href="https://oreil.ly/RKhJ8">ALPS documents</a> associated with this book.</p></div>
</td>
</tr></table>
</div>
<div class="imageblock" id="fig0506">
<div class="content">
<img src="images/rwcb_0506.png" alt="images/rwcb_0506.png" width="80%" />
</div>
<div class="title">Figure 11. Service health recipe</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_36">5.11.3. Example</h4>
<div class="paragraph"><p>A typical <code>application/health+json</code> response looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>health<span style="color: #990000">+</span>json
Cache<span style="color: #990000">-</span>Control<span style="color: #990000">:</span> max<span style="color: #990000">-</span>age<span style="color: #990000">=</span><span style="color: #993399">3600</span>
ETag<span style="color: #990000">:</span> <span style="color: #FF0000">"w</span><span style="color: #CC33CC">\i</span><span style="color: #FF0000">8u7y6t5r4e3w2"</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "status": "<span style="color: #FF0000">pass</span>"<span style="color: #990000">,</span>
  "version": "<span style="color: #FF0000">1</span>"<span style="color: #990000">,</span>
  "releaseId": "<span style="color: #FF0000">1.2.2</span>"<span style="color: #990000">,</span>
  "notes": <span style="color: #990000">[</span>""<span style="color: #990000">],</span>
  "output": ""<span style="color: #990000">,</span>
  "serviceId": "<span style="color: #FF0000">f03e522f-1f44-4062-9b55-9587f91c9c41</span>"<span style="color: #990000">,</span>
  "description": "<span style="color: #FF0000">health of authz service</span>"<span style="color: #990000">,</span>
  "checks": <span style="color: #990000">{</span>
    "cassandra:responseTime": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "componentId": "<span style="color: #FF0000">dfd6cf2b-1b6e-4412-a0b8-f6f7797a60d2</span>"<span style="color: #990000">,</span>
        "componentType": "<span style="color: #FF0000">datastore</span>"<span style="color: #990000">,</span>
        "observedValue": <span style="color: #993399">250</span><span style="color: #990000">,</span>
        "observedUnit": "<span style="color: #FF0000">ms</span>"<span style="color: #990000">,</span>
        "status": "<span style="color: #FF0000">pass</span>"<span style="color: #990000">,</span>
        "affectedEndpoints" : <span style="color: #990000">[</span>
          "/users/{userId}"<span style="color: #990000">,</span>
          "/customers/{customerId}/status"<span style="color: #990000">,</span>
          "/shopping/{anything}"
        <span style="color: #990000">],</span>
        "time": "<span style="color: #FF0000">2018-01-17T03:36:48Z</span>"<span style="color: #990000">,</span>
        "output": ""
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    ...
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note the use of <code>cache-control</code> and <code>ETag</code> headers to instruct client applications to retain local copies of the document to reduce traffic loads to the service.</p></div>
<div class="sect4 xxx">
<h5 id="_health_check_information_in_options_responses">5.11.3.1. Health check information in OPTIONS responses</h5>
<div class="paragraph"><p>You can "advertise" support for the health check pattern by including a <code>link</code> relation value in responses. I do this for all my <code>OPTIONS</code> responses:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
OPTIONS / HTTP/1.1
Accept: application/vnd.collection+json, application/html, application/json
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Link: &lt;http://api.example.org/health&gt;; rel="health-check"
...</code></pre>
</div></div>
</div>
<div class="sect4 xxx">
<h5 id="_health_check_information_in_service_meta_responses">5.11.3.2. Health check information in service-meta responses</h5>
<div class="paragraph"><p>I also include support for health checks in my service metadata document (see <a href="#services-metadata">[services-metadata]</a>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>apis<span style="color: #990000">+</span>json
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">Index</span>"<span style="color: #990000">,</span>
  "description": "<span style="color: #FF0000">This is an example APIs.json file.</span>"<span style="color: #990000">,</span>
  "image": "<span style="color: #FF0000">https://api.example.org/logo.jpg</span>"<span style="color: #990000">,</span>
  "tags": <span style="color: #990000">[</span>"Application Programming Interface"<span style="color: #990000">,</span>"API"<span style="color: #990000">],</span>
  "created": "<span style="color: #FF0000">2014-04-07</span>"<span style="color: #990000">,</span>
  "modified": "<span style="color: #FF0000">2020-09-03</span>"<span style="color: #990000">,</span>
  "url": "<span style="color: #FF0000">http://example.com/apis.json</span>"<span style="color: #990000">,</span>
  "specificationVersion": "<span style="color: #FF0000">0.14</span>"<span style="color: #990000">,</span>
  "apis": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>
      "name": "<span style="color: #FF0000">Example API</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">This provides details about a specific API.</span>"<span style="color: #990000">,</span>
      "humanURL": "<span style="color: #FF0000">http://example.com</span>"<span style="color: #990000">,</span>
      "baseURL": "<span style="color: #FF0000">http://api.example.com</span>"<span style="color: #990000">,</span>
      "tags": <span style="color: #990000">[</span>"API"<span style="color: #990000">,</span>"Application Programming Interface"<span style="color: #990000">],</span>
      "properties": <span style="color: #990000">[</span>
         <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Documentation</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">https://example.com/documentation</span>"<span style="color: #990000">},</span>
         <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">OpenAPI</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">http://example.com/openapi.json</span>"<span style="color: #990000">}</span>
         <span style="color: #990000">{</span>"type": "<span style="color: #FF0000">Health</span>"<span style="color: #990000">,</span>"url": "<span style="color: #FF0000">http://example.com/health.json</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">],</span>
      "contact": <span style="color: #990000">[{</span>"FN": "<span style="color: #FF0000">APIs.json</span>"<span style="color: #990000">,</span>"email": "<span style="color: #FF0000">info@apisjson.org</span>"<span style="color: #990000">}]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  ...
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the "health" type in <em>APIs.json</em> is an extension value not included in the <em>APIs.json</em> specification. See <a href="#services-metadata">[services-metadata]</a> for details.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_38">5.11.4. Discussion</h4>
<div class="paragraph"><p>In most cases, health checks are helpful when they stick to the basics. Reporting <code>pass</code>, <code>fail</code>, and <code>warn</code> is usually more than enough for service consumers. It is not a good idea to try to use health checks as a debugging or diagnostic tool. The health check reflects the state of the <em>interface</em>, not the service behind that interface.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is based on the draft-06 version of the "Health Check Response Format for HTTP APIs" document. By the time you read this book, there may be new drafts or the final approved RFC may be published. Be sure to keep an eye on this specification document to stay informed on changes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Some readers might want to set up a "callback" health endpoint that allows others to subscribe to regular responses from your service. This is not recommended. As the number of users of your service grows, it is possible that you&#8217;ll get hundreds, possibly thousands of callback requests to handle. This can easily overwhelm your service. For that reason, stick to offering an HTTP <code>GET</code> endpoint that has a <code>cache-control</code> value that reduces the impact of lots of health requests. It would be the ultimate irony that health checks cause the service to be unable to meet your service-level agreements!</p></div>
<div class="paragraph"><p>The specification points out that responses for health checks are "dynamic"; the contents of the response may be customized based on the calling context. For example, anonymous requests might return only the <code>status</code> value (<code>pass</code>, <code>fail</code>, <code>warn</code>), but authorized requests (e.g., admin users) might see detailed information on the status of the service.</p></div>
<div class="paragraph pagebreak-before less_space"><p>The specification does not provide lots of details on extending the <code>application/health+json</code> responses. If you want to include additional information, not covered by the defined properties, be sure to do it in a backward-compatible manner, and provide links to human-readable documentations explaining your extension.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_38">5.11.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#services-errors">[services-errors]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-errors">5.12. Standardizing Error Reporting</h3>
<div class="paragraph"><p>All service interfaces encounter errors. The challenge is handling them properly. The first step is to <em>report</em> the initial error in a way that is consistent and usable for API consuming applications. That&#8217;s what RFC 7807 does.</p></div>
<div class="sect3">
<h4 id="_problem_38">5.12.1. Problem</h4>
<div class="paragraph"><p>What is the best way for web-based services to report runtime errors? What information should be returned to the caller when errors occur? What is the best format for returning that information? What can services do to make sure error reporting does not result in unexpected halting or "crashing" of the API client application that experiences the error?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_38">5.12.2. Solution</h4>
<div class="paragraph"><p>Error reporting is a critical part of implementing stable, usable service interfaces. It is important to handle it in a way that, whenever possible, allows both the API provider and consumer to resolve any errors and continue to function as designed. The key to this is reporting errors in a standardized way: a way that API consumers will recognize ("oh, that&#8217;s an error") and that gives them the opportunity to resolve the error.</p></div>
<div class="paragraph"><p>An excellent way to report errors to API consumers is to use the <a href="https://oreil.ly/4isUg">"Problem Details" media type defined in RFC 7807</a>. When you use this media type for reporting errors, clients are more likely to recognize the error and can be more prepared for resolving the problem described in the message (see the example in this recipe).</p></div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Errors Are Built In</div>
<div class="paragraph"><p>In some cases, message formats have error reporting as part of the design. For example, the CollectionJSON format includes an <code>error</code> object. When the format accounts for error reporting directly in the message, it is better to report errors within that format instead of using an RFC 7807 message to report the same information.</p></div>
</div></div>
<div class="paragraph"><p>The key to success is to treat errors as an "alternate response" instead of a failed request. In other words, always include error reporting as a <em>feature</em> of your service interface, not a failure condition.</p></div>
</div>
<div class="sect3">
<h4 id="_example_37">5.12.3. Example</h4>
<div class="paragraph"><p>The Problem Details specification (RFC 7807) defines a small set of elements:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>type</code>
</dt>
<dd>
<p>
A URI reference (RFC 3986) that identifies the problem type
</p>
</dd>
<dt class="hdlist1">
<code>title</code>
</dt>
<dd>
<p>
A short, human-readable summary of the problem type
</p>
</dd>
<dt class="hdlist1">
<code>status</code>
</dt>
<dd>
<p>
The HTTP status code generated by the service (this is a number, not a string)
</p>
</dd>
<dt class="hdlist1">
<code>detail</code>
</dt>
<dd>
<p>
A human-readable explanation specific to this occurrence of the problem
</p>
</dd>
<dt class="hdlist1">
<code>instance</code>
</dt>
<dd>
<p>
A URI reference that identifies the specific  occurrence of the problem (optional)
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The specification defines a default value for <code>type</code>: <code>"about:blank"</code>. If a URI appears in the <code>type</code> property, the specification encourages this URI to point to a human-readable message for that problem type.</p></div>
<div class="paragraph"><p>Here&#8217;s a typical problem details message:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">403</span> Forbidden
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>problem<span style="color: #990000">+</span>json
Content<span style="color: #990000">-</span>Language<span style="color: #990000">:</span> en</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "type": "<span style="color: #FF0000">https://example.com/probs/out-of-credit</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">You do not have enough credit.</span>"<span style="color: #990000">,</span>
  "detail": "<span style="color: #FF0000">Your current balance is 30, but that costs 50.</span>"<span style="color: #990000">,</span>
  "instance": "<span style="color: #FF0000">/account/12345/msgs/abc</span>"<span style="color: #990000">,</span>
  "status": <span style="color: #993399">403</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It is possible to extend problem detail records using your own properties:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">403</span> Forbidden
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>problem<span style="color: #990000">+</span>json
Content<span style="color: #990000">-</span>Language<span style="color: #990000">:</span> en</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "type": "<span style="color: #FF0000">https://example.com/probs/out-of-credit</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">You do not have enough credit.</span>"<span style="color: #990000">,</span>
  "detail": "<span style="color: #FF0000">Your current balance is 30, but that costs 50.</span>"<span style="color: #990000">,</span>
  "instance": "<span style="color: #FF0000">/account/12345/msgs/abc</span>"<span style="color: #990000">,</span>
  "status": <span style="color: #993399">403</span><span style="color: #990000">,</span>
  "balance": <span style="color: #993399">30</span><span style="color: #990000">,</span>
  "accounts": <span style="color: #990000">[</span>"/account/12345"<span style="color: #990000">,</span> "/account/67890"<span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the URL in the <code>type</code> element should point to a document that defines the use and meaning of the <code>out-of-credit</code> problem. This documentation should also include definitions of the <code>balance</code> and <code>accounts</code> elements. In this way, the <code>type</code> property points to a semantic profile for this problem representation. See <a href="#services-vocabularies">[services-vocabularies]</a> for details on semantic profiles.</p></div>
<div class="paragraph"><p>The <code>type</code>, <code>title</code>, and <code>status</code> of the problem detail message are "fixed"—always the same, no matter which API or service returns the message. However, the <code>detail</code> and <code>instance</code> properties are specific to the current case. Here is an illustration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP<span style="color: #990000">/</span><span style="color: #993399">1.1</span> <span style="color: #993399">403</span> Forbidden
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>problem<span style="color: #990000">+</span>json
Content<span style="color: #990000">-</span>Language<span style="color: #990000">:</span> en</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "type": "<span style="color: #FF0000">https://example.com/probs/out-of-credit</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">You do not have enough credit.</span>"<span style="color: #990000">,</span>
  "detail": "<span style="color: #FF0000">Your current balance is 20, but that costs 50.</span>"<span style="color: #990000">,</span>
  "instance": "<span style="color: #FF0000">/account/12345/msgs/q1w2e3</span>"<span style="color: #990000">,</span>
  "status": <span style="color: #993399">403</span><span style="color: #990000">,</span>
  "balance": <span style="color: #993399">20</span><span style="color: #990000">,</span>
  "accounts": <span style="color: #990000">[</span>"/account/r4er3w2"<span style="color: #990000">,</span> "/account/y6t5r4"<span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now compare this problem details response to the previous one. In both cases, the <code>type</code>, <code>title</code>, and <code>status</code> values are the same. But the <code>details</code>, <code>instance</code>, <code>balance</code>, and <code>accounts</code> values are different.</p></div>
<div class="paragraph"><p>The RFC 7807 specification registers both <code>application/problem+json</code> and <code>application/problem+xml</code> media type identifiers. However, it does not supply any examples for an XML version of the problem details message. The following response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP/1.1 403 Forbidden
Content-Type: application/problem+xml
Content-Language: en

<span style="font-weight: bold"><span style="color: #0000FF">&lt;problem-details&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;type&gt;</span></span>https://example.com/probs/out-of-credit"<span style="font-weight: bold"><span style="color: #0000FF">&lt;/type&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>You do not have enough credit.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;detail&gt;</span></span>Your current balance is 30, but that costs 50.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/detail&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;instance&gt;</span></span>/account/12345/msgs/abc<span style="font-weight: bold"><span style="color: #0000FF">&lt;/instance&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;status&gt;</span></span>403<span style="font-weight: bold"><span style="color: #0000FF">&lt;/status&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;problem-details&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>As of this writing, RFC 7807 is undergoing an update at the IETF standards committee. While this update is expected to result in a nonbreaking change, readers should keep a close eye on this specification and be prepared for any changes that may occur in the future.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_39">5.12.4. Discussion</h4>
<div class="paragraph"><p>The specification makes a point to say that problem details messages should not be used when a simple HTTP 4xx or 5xx status report would suffice. For example, if a user attempts to update an existing record and does not have rights to do so, returning a 403 response to a <code>PUT</code> would likely suffice. However, if the user sent an invalid body for a <code>PUT</code> message, it might be helpful to return a problem details response that describes the problem and offers a way to fix the error before resubmitting.</p></div>
<div class="paragraph"><p>Services should not use this format to return "debugging" information to the client application. The format is meant to share details about the <em>interface</em>, not about the underlying service behind the API.</p></div>
<div class="paragraph"><p>When creating a new problem details <code>type</code>, you should document three things:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <code>type</code> URI (e.g., <a href="http://api.example.org/problems/insufficient-funds">http://api.example.org/problems/insufficient-funds</a>)
</p>
</li>
<li>
<p>
A <code>title</code> (e.g., "Your account has insufficient funds for this transaction.")
</p>
</li>
<li>
<p>
A <code>status</code> code that is appropriate for this problem (e.g., 403)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Whenever possible, it is a good idea to limit the number of new problem details <code>types</code> you define and create ones that are general enough to be reusable.  You can also customize the problem representations using the <code>detail</code> (text) and <code>instance</code> (URL) elements of the message.</p></div>
<div class="paragraph"><p>It is also possible to indicate the use of a <code>Retry-After</code> header with a problem details response. This makes it possible to indicate retry details to API consumers when needed.</p></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_see_also_39">5.12.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#services-health">[services-health]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-registry">5.13. Improving Service Discoverability with a Runtime Service Registry</h3>
<div class="paragraph"><p>A key goal for all API interfaces is the ability to easily discover services you want to use and consistently (re)use those services across a wide range of products and applications. This recipe focuses on the work of making sure your provider service is <em>discoverable</em> and <em>reusable</em> at runtime (not design or build time) by registering with a shared Runtime Service Registry (RSR).</p></div>
<div class="sect3">
<h4 id="_problem_39">5.13.1. Problem</h4>
<div class="paragraph"><p>What should service providers do to make sure their service is easily and consistently registered with target RSRs? What internal functions should each service interface support in order to be discovered? How can services report their runtime health statistics to the RSRs? What service metadata should services supply to improve the findability of the service for both machines and people?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_39">5.13.2. Solution</h4>
<div class="paragraph"><p>Maintaining an RSR can improve the findability and reusability of running services on the web. When a service is deployed on the web (and starts up), that service should "publish" itself to one or more RSRs. This essentially tells the registry where the service is running, what kind of functionality it has, and other supportive information, such as the media types (<a href="#design-media-types">[design-media-types]</a>), shared vocabularies (<a href="#design-vocabularies">[design-vocabularies]</a>), interface definitions (<a href="#services-definitions">[services-definitions]</a>), and health status (<a href="#services-health">[services-health]</a>). You can think of RSRs as a kind of <a href="https://oreil.ly/C69bp">Domain Name System (DNS)</a> for services—a reliable place to find and connect to other services.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is focused on supporting M2M runtime discovery and use of an existing API. There are other options for supporting human-driven design- or build-time discovery such as API portals, catalogs, etc. This recipe (along with <a href="#services-metadata">[services-metadata]</a>) can be adapted to help support design- and build-time API discovery, too.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For a service to be easily discovered and (re)used on the web at runtime, it should support the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Register on startup
</dt>
<dd>
<p>
When the service is deployed, it should automatically self-register with one or more RSRs. This makes sure other services can find it when it is needed.
</p>
</dd>
<dt class="hdlist1">
Periodic health reports
</dt>
<dd>
<p>
On a regular basis (sometimes this interval is set by the RSR), the service should "ping back" to the RSR (using a URL supplied at registration) to confirm that the service is up and running. Optionally, it may report some usage statistics, like how many times it has been called in the last reporting period, number of reported errors (400/500), and response times.
</p>
</dd>
<dt class="hdlist1">
Unregister on shutdown
</dt>
<dd>
<p>
When the service goes offline (via a controlled shutdown or fatal error), it should automatically "unregister" with any associated RSRs. This ensures that other services will not try to connect to it when it is not available.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Note that all three of these actions are internal to the service and there is no need to expose this functionality as part of the usable service API interface.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_example_38">5.13.3. Example</h4>
<div class="paragraph"><p>Creating a service that supports RSRs means enabling your service to register at startup, send health pings to the RSR, and unregister at shutdown. Here is a simple example of registering with a preconfigured RSR at startup using a package called <code>discovery</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> srsResponse <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> <span style="font-weight: bold"><span style="color: #000000">srsRegister</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>Url<span style="color: #990000">:</span><span style="color: #FF0000">"..."</span><span style="color: #990000">,</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"..."</span><span style="color: #990000">,</span> <span style="color: #990000">.....</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// register this service w/ defaults</span></span>
discovery<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">register</span></span><span style="color: #990000">(</span>srsRegister<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>data<span style="color: #990000">,</span> response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  srsResponse <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">initiateKeepAlive</span></span><span style="color: #990000">(</span>srsResponse<span style="color: #990000">.</span>href<span style="color: #990000">,</span> srsResponse<span style="color: #990000">.</span>milliseconds<span style="color: #990000">);</span>
  http<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createServer</span></span><span style="color: #990000">(</span>uuidGenerator<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">listen</span></span><span style="color: #990000">(</span>port<span style="color: #990000">);</span>
  console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">info</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'uuid-generator running on port '</span><span style="color: #990000">+</span>port<span style="color: #990000">+</span><span style="color: #FF0000">'.'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph pagebreak-before less_space"><p>Upon registration, a collection of service metadata should be supplied to the RSR, such as:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>serviceURL</code>
</dt>
<dd>
<p>
URL of the service you are registering
</p>
</dd>
<dt class="hdlist1">
<code>serviceName</code>
</dt>
<dd>
<p>
Text name of the registered service
</p>
</dd>
<dt class="hdlist1">
<code>semanticProfile</code>
</dt>
<dd>
<p>
Space-separated list of profile URIs (see <a href="#design-profiles">[design-profiles]</a>)
</p>
</dd>
<dt class="hdlist1">
<code>mediaType</code>
</dt>
<dd>
<p>
Space-separated list of <code>mediaType</code> identifiers (see <a href="#design-media-types">[design-media-types]</a>)
</p>
</dd>
<dt class="hdlist1">
<code>apiDefintions</code>
</dt>
<dd>
<p>
Collection of annotated links pointing to API definition documents (see <a href="#services-definitions">[services-definitions]</a>)
</p>
</dd>
<dt class="hdlist1">
<code>tags</code>
</dt>
<dd>
<p>
Space-separated  list of searchable keywords (e.g., <code>"gdpr banking loans"</code>)
</p>
</dd>
</dl></div>
<div class="paragraph"><p>While the service is up and running, it should periodically ping the RSR to confirm that the service is still up and running. The example shows this using the <code>initiateKeepAlive(&#8230;)</code> method. This method may also send additional health information (or an <code>href</code> that points to that data; see <a href="#services-health">[services-health]</a> for more on this detail).</p></div>
<div class="paragraph"><p>Whenever the service is taken offline, either in a controlled form or due to a fatal error, it should be evicted from the RSR registry to prevent others from attempting to use that missing instance (or cluster). Here&#8217;s a NodeJS example showing how to unregister the service at shutdown:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// set up proper discovery shutdown</span></span>
process<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'SIGTERM'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  discovery<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unregister</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      uuidGenerator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'gracefully shutting down'</span><span style="color: #990000">);</span>
        process<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span><span style="color: #FF0000">{}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">setTimeout</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'forcefully shutting down'</span><span style="color: #990000">);</span>
    process<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #993399">10000</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note the added <code>setTimeout</code> method to force the service shutdown, if needed.</p></div>
<div class="paragraph"><p>Since a fatal service crash might preempt sending the <code>discovery.unregister</code> message, an RSR usually has a maximum amount of time that it will wait for a pingback. If the wait exceeds the maximum value, the RSR will most likely delete the registration entry or set its status to "down" (or some other value).</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_40">5.13.4. Discussion</h4>
<div class="paragraph"><p>Each service instance or cluster that is up and running should be listed in an RSR. For example, if an instance of a <code>netPresentValueCalculator</code> service is running on a machine in North America and another running on a machine in North Africa, that would be represented by two entries in the RSR. Conversely, the same instance of a service might be listed in multiple RSRs. For example, the instance might be registered in a registry hosted in North America as well as one hosted in Australia.</p></div>
<div class="paragraph"><p>Keep in mind that a single service (e.g., <code>computeInterest</code>) might have multiple <em>versions</em>. If those versions are running as standalone instances, each should be listed in the RSR. This allows API consumers to find the version they want to use.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The RSR quite likely will require an authenticated user in order to register your service. This is especially true for RSRs that are available on the web.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Services can use an RSR to locate and connect to internally dependent services, too. For example, if your <code>computeInterest</code> service also relies upon the external <code>taxTable</code> and <code>federalRates</code> services, your service can use an RSR to find and bind to the preferred version of each of those external services, too.</p></div>
<div class="paragraph"><p>When registering your service, it&#8217;s advantageous to provide as much metadata as possible to improve your service&#8217;s "findability." Be sure to include keywords in the <code>tags</code> field as well as the <code>serviceProfile</code>, <code>apiDefinitions</code>, and supported <code>mediaTypes</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_40">5.13.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-definitions">[services-definitions]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-jobs">[workflow-jobs]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-local-identifiers">5.14. Increasing Throughput with Client-Supplied Identifiers</h3>
<div class="paragraph"><p>It is common practice to expect servers to generate and return identifiers for any resources created by client applications. This simplifies the process of ensuring unique resource URLs, but has drawbacks. This is especially true when multistep processes are involved (create A, get unique ID from A, use that to create B, etc.).</p></div>
<div class="sect3">
<h4 id="_problem_40">5.14.1. Problem</h4>
<div class="paragraph"><p>When is it better to allow clients to supply unique identifiers, and how can that be done safely and consistently?
What is the easiest, most reliable way to support API consumer-supplied resource IDs?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_40">5.14.2. Solution</h4>
<div class="paragraph"><p>A simple and reliable way to generate unique identifiers is to use date-time stamp information or an output of a random number generator to create a string. Here&#8217;s an example using a random number generator in JavaScript:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> id <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">parseInt</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">String</span></span><span style="color: #990000">(</span>Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">random</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">substring</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">(</span><span style="color: #993399">36</span><span style="color: #990000">);</span>
<span style="font-style: italic"><span style="color: #9A1900">// id = "906lem09xu8"</span></span></tt></pre></div></div>
<div class="paragraph"><p>You can also use date-time and/or random numbers to generate a Universally Unique Identifier (UUID) (see the examples). There is a <a href="https://oreil.ly/oHXrO">specification for creating UUIDs (RFC 4122)</a> that you can use as a guide to write a simple routine. Even better, there are quite a few open source RFC 4122-compliant UUID generators for just about all programming languages. Some programming platforms even offer a direct call for generating UUIDs (e.g., NodeJS v17 supports a UUID function in the <code>cryptoAPI</code> module).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Client-supplied identifiers can make it possible to reduce sequential processing of multistep workflows and replace them with parallel processing implementations (see the example).</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Client applications should be instructed to generate their own unique identifier and either include that in the URL or supply it in the body of the HTTP <code>POST</code>, <code>PUT</code>, or <code>PATCH</code> request sent to the service API. Service APIs can then inspect the value and confirm it is unique before processing the request. If the value supplied by the client is not unique, the service can return a <code>409 Conflict</code> status code with additional information on how clients can fix the problem.</p></div>
</div>
<div class="sect3">
<h4 id="_example_39">5.14.3. Example</h4>
<div class="paragraph"><p>A very simple way to generate a unique identifier is to rely on your programming language&#8217;s random number generator. Here&#8217;s a sample implementation in JavaScript:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// generating unique identifiers</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">makeId</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rtn<span style="color: #990000">;</span>

  rtn <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">String</span></span><span style="color: #990000">(</span>Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">random</span></span><span style="color: #990000">());</span>
  rtn <span style="color: #990000">=</span> rtn<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">substring</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">);</span>
  rtn <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">parseInt</span></span><span style="color: #990000">(</span>rtn<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">(</span><span style="color: #993399">36</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> rtn<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Calling the <code>makeId()</code> function will generate compact identifier strings that look like this: <code>"1oyte4x0zep"</code>.</p></div>
<div class="paragraph"><p>Some random number generators are not quite as "random" as most of us would like. For that reason, you can mix a date-time value with a random number and generate an RFC 4122-compliant UUID value. Here is an example function that does the trick:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// generating UUIDs (Public Domain/MIT)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">generateUUID</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> d <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Date</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getTime</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> d2 <span style="color: #990000">=</span> <span style="color: #990000">((</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span> performance <span style="color: #990000">!==</span> <span style="color: #FF0000">'undefined'</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;&amp;</span>
    performance<span style="color: #990000">.</span>now <span style="color: #990000">&amp;&amp;</span> <span style="color: #990000">(</span>performance<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">()*</span><span style="color: #993399">1000</span><span style="color: #990000">))</span> <span style="color: #990000">||</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">replace</span></span><span style="color: #990000">(</span><span style="color: #FF6600">/[xy]/g</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>c<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> r <span style="color: #990000">=</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">random</span></span><span style="color: #990000">()</span> <span style="color: #990000">*</span> <span style="color: #993399">16</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>d <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      r <span style="color: #990000">=</span> <span style="color: #990000">(</span>d <span style="color: #990000">+</span> r<span style="color: #990000">)%</span><span style="color: #993399">16</span> <span style="color: #990000">|</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
      d <span style="color: #990000">=</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">floor</span></span><span style="color: #990000">(</span>d<span style="color: #990000">/</span><span style="color: #993399">16</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      r <span style="color: #990000">=</span> <span style="color: #990000">(</span>d2 <span style="color: #990000">+</span> r<span style="color: #990000">)%</span><span style="color: #993399">16</span> <span style="color: #990000">|</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
      d2 <span style="color: #990000">=</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">floor</span></span><span style="color: #990000">(</span>d2<span style="color: #990000">/</span><span style="color: #993399">16</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">===</span> <span style="color: #FF0000">'x'</span> <span style="color: #990000">?</span> r <span style="color: #990000">:</span> <span style="color: #990000">(</span>r <span style="color: #990000">&amp;</span> <span style="color: #993399">0x3</span> <span style="color: #990000">|</span> <span style="color: #993399">0x8</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">(</span><span style="color: #993399">16</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The output of UUID functions is much less likely to result in a collision, but the resulting output (e.g., <code>"e6db8698-7128-478d-8658-12c2cb9dd126"</code>) is longer than the simple example shown earlier.</p></div>
<div class="paragraph"><p>The unique values can also be shipped from the client application as part of the message body for HTTP <code>POST</code> operations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Create a New Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"create"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/persons/"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"unique-id"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"1oyte4x0zep"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mark Morkleson"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/submit&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Or as part of the URL for HTTP <code>PUT</code> operations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Create a New Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"create"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/persons/1oyte4x0zep"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"put"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mork Markleson"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/submit&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#services-idempotent-create">[services-idempotent-create]</a> for more on using HTTP <code>PUT</code> to create new resources.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is up to the server-side component to confirm that the client-supplied unique identifier is acceptable. For example, does this identifier (and a related resource) already exist? Is the identifier properly formatted (e.g., a proper length string with appropriate characters, etc.)? If, for any reason, the client-supplied identifier is not acceptable, the service interface should reject the write operation with an HTTP status of <code>409 Conflict</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_41">5.14.4. Discussion</h4>
<div class="paragraph"><p>Some client application developers will balk at the idea of supplying their own unique values. You can ease their worries by supplying a code library that generates unique identifiers and encouraging client application developers to use them as they would an SDK (software development kit).</p></div>
<div class="paragraph"><p>An optional approach to requiring client-supplied identifiers is to provide a fallback approach in the service interface that will generate the identifier if it is not provided by the client. A simple "if-test" can be used:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">addItem</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> body<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> item<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    item<span style="color: #990000">.</span>id <span style="color: #990000">=</span> id<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    item<span style="color: #990000">.</span>id <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">makeId</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
  <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This is especially handy if the API is just a thin proxy for an existing backend service.</p></div>
<div class="paragraph pagebreak-before less_space"><p>One of the advantages of relying on client-supplied identifiers is that it can help reduce the need for sequential workflow processing. For example, consider the case where three resources need to be updated: <code>customer</code>, <code>account</code>, and <code>salesRecord</code>. Also assume that the <code>account</code> record needs to have the <code>customer</code> identifier as a property, and that the <code>salesRecord</code> needs to have both the <code>customer</code> and <code>account</code> identifiers as properties. In this scenario, if the services are supplying the identifiers, your workflow might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">writeCustomer</span></span><span style="color: #990000">()</span>
  <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>customerResponse<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">writeAccount</span></span><span style="color: #990000">(</span>accountResponse<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>nextResponse<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">writeSalesRecord</span></span><span style="color: #990000">(</span>salesRecordResponse<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>finalResponse<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Final response: '</span> <span style="color: #990000">+</span> finalResponse<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span>failureCallback<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Essentially, each step must wait on the previous step to complete before continuing. However, if you rely on client-supplied identifiers, you might be able to do this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> cId <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">makeId</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> aId <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">makeId</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sId <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">makeId</span></span><span style="color: #990000">();</span>
Promise<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span>
  <span style="font-weight: bold"><span style="color: #000000">writeCustomer</span></span><span style="color: #990000">(</span>cId<span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">writeAccount</span></span><span style="color: #990000">(</span>cId<span style="color: #990000">,</span>aId<span style="color: #990000">),</span>
  <span style="font-weight: bold"><span style="color: #000000">writeSalesRecord</span></span><span style="color: #990000">(</span>cId<span style="color: #990000">,</span>aId<span style="color: #990000">,</span>sId<span style="color: #990000">)</span>
<span style="color: #990000">])</span>
<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">(()</span> <span style="color: #990000">=&gt;</span> console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'All done!'</span><span style="color: #990000">))</span>
<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>err<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">rollbackAll</span></span><span style="color: #990000">(</span>cId<span style="color: #990000">,</span>aId<span style="color: #990000">,</span>sId<span style="color: #990000">);</span>
  console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Write failed!'</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>A side effect of the client-supplied identifier recipe is that the resource identifiers are not sequential and are rarely easy for people to read or remember. This lack of sequence can make it harder for malicious coders to guess your resource identifiers. It can also make it harder for legitimate developers to navigate a collection of records. You can mitigate this second problem by allowing clients to supply "friendly IDs" that can be displayed in lists and other output while the generated identifier is hidden in the user interface:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"q1w2e3r4"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Sally-R<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"p0o9i8u7"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Jane-Q<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"6y5t4r3e"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Barb-Z<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_see_also_41">5.14.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-idempotent">[design-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#services-idempotent-create">[services-idempotent-create]</a>
</p>
</li>
<li>
<p>
<a href="#data-idempotent">[data-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-idempotent-create">5.15. Improving Reliability with Idempotent Create</h3>
<div class="paragraph"><p>While the common practice is to use HTTP <code>POST</code> to create new resources in web APIs, it is not the most reliable. In fact, when it comes to M2M interactions (e.g., no humans in the loop), using HTTP <code>POST</code> can be problematic because of the possibility of the <em>lost response</em> problem.  What is needed is a solution to creating resources that is repeatable and reliable, even when the network connections may be faulty.</p></div>
<div class="sect3">
<h4 id="_problem_41">5.15.1. Problem</h4>
<div class="paragraph"><p>When using HTTP <code>POST</code> to create new resources, it is possible to experience the lost response problem. For example, an API client sends a <code>POST</code> that transfers $500 from account A to account B, and that API client never receives an HTTP response. No <code>200 OK</code>, no <code>400 Bad Request</code>, no <code>500 Server Error</code>—nothing.</p></div>
<div class="paragraph"><p>Now what is the client to do?  Did the request ever make it to the server? Was there a server-side error that rejected the request?  What if the request made it to the server and was completed, but the <code>200 OK</code> response got dropped on the network? In that last case, repeating the request might result in executing the transfer twice.</p></div>
<div class="paragraph"><p>How can we avoid the bad effects of the lost response problem when writing data to the service?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_41">5.15.2. Solution</h4>
<div class="paragraph"><p>A lost response for HTTP <code>POST</code> actions is troublesome because the state of the server resource is unclear. Was the server updated or not? To compound the problem, the <a href="https://oreil.ly/M2ZQg">HTTP specification for <code>POST</code></a> does not define the method as <em>idempotent</em>.  That means, <a href="https://oreil.ly/35Mmc">unlike HTTP <code>PUT</code></a>, an HTTP <code>POST</code> request cannot be "repeated automatically if a communication failure occurs before the client is able to read the server&#8217;s response."</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>An important element of this recipe is the use of client-supplied unique URLs. See <a href="#services-local-identifiers">[services-local-identifiers]</a> for more details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The solution to this problem is to use <code>PUT</code> for any case where API clients want to modify the resource on a service, whether the intent is to create a new record or to update an existing record. Since HTTP <code>PUT</code> is an idempotent method, client applications can confidently repeat requests that intend to modify data on the service without the worry of "double-posting" resources by mistake.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>There are other options for supporting idempotent updates while still using HTTP <code>POST</code>. A recent example is <a href="https://oreil.ly/TTtQM">"The Idempotency-Key HTTP Header Field"</a>. I continue to encourage implementing solutions along the lines of this recipe since they work well for existing HTTP versions without the need for new headers or other extensions.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Client applications can also use the <code>If-None-Match</code> header to indicate they want to create a new resource, or the <code>If-Match</code> header when the client intends to update an existing resource.</p></div>
<div class="paragraph"><p>In this way, client applications avoid the ill effects of the list response problem.</p></div>
</div>
<div class="sect3">
<h4 id="_example_40">5.15.3. Example</h4>
<div class="paragraph"><p>The key to the lost response solution is to always support an idempotent HTTP method (<code>PUT</code>) to write data to the server. When you want client applications to create new resources, instruct them to use the <code>PUT</code> method, supply a complete URL, and include the <code>If-None-Match</code> header with a value of <code>"*"</code>.</p></div>
<div class="paragraph"><p>Here is an example of using <code>PUT</code> for creating HTTP resources:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>PUT /persons/q1w2e3r4
Host: api.example.org
Content-Type: application/json
Content-Length: XXX
If-None-Match : "*"

{"name":"Mark Morkelson"}</code></pre>
</div></div>
<div class="paragraph"><p>Upon receiving this request, the API service can check if there is already a resource at the provided URL, and "if none match" the wildcard entity tag (<code>"*"</code>), the server can create the resource and return the following response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>201 Created
Location: http://api.example.org/persons/q1w2e3r4</code></pre>
</div></div>
<div class="paragraph"><p>If, however, a resource already exists at that URL, the server can return the following response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>209 Conflict
Content-Type: text/plain

Unable to create. Resource already exists.</code></pre>
</div></div>
<div class="paragraph"><p>When client applications want to update existing resources, they need to supply that resource&#8217;s unique entity tag (provided by the server) when sending the updating <code>PUT</code> request. Here is a sample exchange:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/q1w2e3r4
Accept: text/plain

**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
ETag: "w/p0o9i8u7y6yt5r4"

{"collection": {
  "items": [
    {"href" : "/persons/q1w2e3r4", "data" : [ {"name" : "Mark Morkleson"} ]}
  ],
  "template" : { "data" : [ {"name" : "Mork Markleson"} ] }
}}

**** REQUEST ****
PUT /persons/q1w2e3r4
If-Match: "w/p0o9i8u7y6yt5r4"
Content-Type: application/x-www-form-urlencoded
Accept: application/vnd.collection+json

name=Mork%20Markleson

**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
ETag: "w/i8u7y6t5r4e3"

{"collection": {
  "items": [
    {"href" : "/persons/q1w2e3r4", "data" : [ {"name" : "Mork Markleson"} ]}
  ]
}}</code></pre>
</div></div>
<div class="paragraph"><p>Note that, for the update scenario, the <code>If-Match</code> header is sent with the value of the existing resource&#8217;s <code>ETag</code> header. The server, upon seeing the <code>PUT</code> request, can use the value of the <code>If-Match</code> header to confirm the resource exists—and that it was not altered by some other update process (which would result in a new entity tag value).  If the update fails (e.g., no existing resource or entity tag mismatch), the server can return a <code>409 Conflict</code> response.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_42">5.15.4. Discussion</h4>
<div class="paragraph"><p>Supplying a complete URL when creating records may look a bit strange to some API designers. But this is typically the way most HTTP client applications implement file uploads (images, PDF documents, etc.).</p></div>
<div class="paragraph"><p>This recipe relies on client applications interacting with HTTP headers (<code>ETag</code>, <code>If-None-Match</code>, and <code>If+Match</code>). This might be a challenge for some API consumers (e.g., browsers limited to HTML <code>FORMS</code>). You can still make this work by supplying the entity tag related information as hidden fields in server-supplied forms. Technically, you could even use HTTP <code>POST</code> for this recipe, too. The HTML browser implementation would look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Create a New Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"create"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/persons/q1w2e3r4"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"if-none-match"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"*"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mark Morkleson"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/submit&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Update an Existing Person<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"update"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/persons/q1w2e3r4"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"if-match"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"w/p0o9i8u7y6yt5r4"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Mork Markleson"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/submit&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>While this will work for HTTP <code>POST</code>, I still encourage you to implement servers to use HTTP <code>PUT</code> instead, since <code>PUT</code> is defined as idempotent (reliably repeatable) and this use of <code>POST</code> is only "treating" the interaction as repeatable by convention.</p></div>
<div class="paragraph"><p>By sticking to idempotent methods for all write operations, services can also provide support for automatic retries for updates. Most HTTP libraries support automatic retries for HTTP <code>GET</code>, but I have yet to find one that does this for <code>PUT</code> or <code>DELETE</code>, too. See <a href="#services-fallback">[services-fallback]</a> for more on this option.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_42">5.15.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-idempotent">[design-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#services-local-identifiers">[services-local-identifiers]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#data-idempotent">[data-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-fallback">5.16. Providing Runtime Fallbacks for Dependent Services</h3>
<div class="paragraph"><p>In cases where a service calls out another service, that first service is <em>dependent</em> on the second service. Since these service calls rely on the network, a long list of problems may arise. While the chances that a single dependent service call may fail might be small, if your service depends on several external services, your likelihood of failure grows—exponentially. When implementing service APIs, you need to account for this failure possibility and mitigate any problems.</p></div>
<div class="sect3">
<h4 id="_problem_42">5.16.1. Problem</h4>
<div class="paragraph"><p>In cases where a service depends upon another external service, how can you reduce the risk of failure? What patterns can you use to limit the possibility of these kinds of "fatal dependencies," and how can you work around them at runtime when they happen? How can we make sure to maintain service reliability both in the case of <em>reading</em> data from a dependent service and <em>writing</em> data to those services?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_42">5.16.2. Solution</h4>
<div class="paragraph"><p>There will be cases when an API is actually an interface that aggregates other APIs. For example, a shopping API might be implemented as a mix of three other APIs: a shopping-cart API, a payment API, and a delivery API. The danger is that one or more of these dependent APIs is unreachable at runtime due to network or local service problems. What&#8217;s needed is a well-defined "backup plan" or fallback option for each of the dependent APIs.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>It is important to keep in mind that your solutions need to take into account both the "read-from" and "write-to" scenarios.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Protecting your service interface from the failures of the network, or the failures of <em>other</em> services upon which you depend, can be mitigated through a handful of <span class=".keep-together">methods</span>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Automatic retries
</dt>
<dd>
<p>
One option is to assume the failure is temporary, and that a short pause and retry will solve the problem. Most HTTP libraries have this auto-retry feature for HTTP <code>GET</code> requests built in, but few HTTP modules support auto-retry for unsafe actions (e.g., <code>PUT</code> and <code>DELETE</code>). However, modifying your own code to handle this is not too difficult.
</p>
</dd>
<dt class="hdlist1">
Static fallback options
</dt>
<dd>
<p>
Just as you can configure (or hardcode) the initial API dependencies (for example, <code>var shoppingAPI = "http://shopping.example.com/home"</code>), you can expand the configuration to include a second, "fallback," location for the same service (<code>var shoppingAPIFallback = "http://other-shopping.example.com/home"</code>). Then, when the initial location fails to respond, you can update the runtime code to point to the alternate service. This has some implications for state management—see <a href="#design-state-transfer">[design-state-transfer]</a> for details.
</p>
</dd>
<dt class="hdlist1">
Dynamic fallback options
</dt>
<dd>
<p>
You can also write your API aggregator to be able to enlist a service registry to find another available alternative for your needed functionality. This is, essentially, a runtime service lookup similar to the runtime DNS that locates machines. Check out <a href="#services-registry">[services-registry]</a> for more details.
</p>
</dd>
<dt class="hdlist1">
Queuing requests for later replay
</dt>
<dd>
<p>
If you can&#8217;t gain a connection to either your initial service or an expected replacement service, you may be able to simply "hold on to" the request in a queue and replay it later, when the currently failing service is once again available. This requires setting up and managing a local queue and some code to process that queue&#8217;s content. Typically, the initial response in this case is an HTTP <code>202 Accepted</code> with a response body that describes details on how the API consumer can monitor the handling of the delayed request (see <a href="#workflow-accepted">[workflow-accepted]</a>). Of course, you&#8217;ll need to include this possibility in your documented interface design so that API consumers can be prepared for this kind of response.
</p>
</dd>
<dt class="hdlist1">
Give up
</dt>
<dd>
<p>
The final option is to just stop processing requests, tell the API consumer that is calling your API that you are "unable to process the request at this time," and return an HTTP <code>500</code> error. This is the safest and the least functional option. In this case, if possible, you should return a response body that indicates some estimated wait time before the API consumer can try this request again. Keep in mind that <em>your</em> <code>500 Internal Service Error</code> might trigger the API consumer to kick in its own mitigation code, which might also affect that API consumer application&#8217;s consumers, and so forth.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If the dependent service is used primarily as a simple data source (e.g., list of postal codes, countries, states/regions, product numbers, etc.), you may be able to use some of the data caching recipes covered in <a href="#data">[data]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Basically, you want to implement your API to assume failure on the part of other elements of the system you are dependent upon and incorporate at least one of the preceding mitigating solutions for each possible failure point. Ultimately, you cannot <em>prevent</em> the failures, but you may be able to mitigate its effects. To quote <a href="https://oreil.ly/fBrWj">John Gall</a>: "Any large system is going to be operating most of the time in failure mode."</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">What About the Circuit-Breaker Pattern?</div>
<div class="paragraph"><p>You might have expected to see some other solutions in this recipe such as the <a href="https://oreil.ly/VjvV8">Circuit Breaker</a>. Since this book is focused primarily on the M2M interaction level, I&#8217;ve left out many of the established code-centric solutions like the Circuit Breaker and others. See the preface for some books that I highly recommend as guides for coding microservices, including Circuit Breaker and other patterns.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_example_41">5.16.3. Example</h4>
<div class="paragraph"><p>This recipe outlines several possible solutions. Up next are examples of each.</p></div>
<div class="sect4 xxx">
<h5 id="_automatic_retries">5.16.3.1. Automatic retries</h5>
<div class="paragraph"><p>You can arrange your API calling code to automatically retry requests. The key elements to manage are:</p></div>
<div class="ulist"><ul>
<li>
<p>
The type of request failure (e.g., HTTP <code>502</code> is returned)
</p>
</li>
<li>
<p>
The type of request that was made (e.g., <code>GET</code>, <code>PUT</code>, <code>DELETE</code>)
</p>
</li>
<li>
<p>
The time to wait before trying again (e.g., 250 ms wait before retry)
</p>
</li>
<li>
<p>
The number of times to retry before giving up (e.g., retry three times)
</p>
</li>
</ul></div>
<div class="paragraph"><p>For example, internal API code might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> reqParams <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span> <span style="font-style: italic"><span style="color: #9A1900">// request params</span></span>
reqParam<span style="color: #990000">.</span>host <span style="color: #990000">=</span> <span style="color: #FF0000">"https:/api.example.com"</span>
reqParams<span style="color: #990000">.</span>url <span style="color: #990000">=</span> <span style="color: #FF0000">"/users/q1w2e3"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>body <span style="color: #990000">=</span> <span style="color: #FF0000">"mork=mamund&amp;name=Mike Morkelsen"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>method <span style="color: #990000">=</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>waitMS <span style="color: #990000">=</span> <span style="color: #993399">300</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>retryAttempts <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>successFunction <span style="color: #990000">=</span> requestSucceeded<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>failFunction <span style="color: #990000">=</span> requestFailed<span style="color: #990000">;</span>

httpLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>reqParams<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>After this fails, you may wish to repeat the attempt (with a modified wait period value) or you can attempt one of the other mitigations in this recipe (static fallback, dynamic fallback, queuing requests, or give up).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_static_fallback">5.16.3.2. Static fallback</h5>
<div class="paragraph"><p>You can update your request functionality to include attempts to call an alternate host by including the alternate location in your request collection and adding code to your request method to switch hosts and make additional request attempts:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> reqParams <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span> <span style="font-style: italic"><span style="color: #9A1900">// request params</span></span>
reqParams<span style="color: #990000">.</span>host <span style="color: #990000">=</span> <span style="color: #FF0000">"https:/api.example.com"</span>
reqParams<span style="color: #990000">.</span>url <span style="color: #990000">=</span> <span style="color: #FF0000">"/users/q1w2e3"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>body <span style="color: #990000">=</span> <span style="color: #FF0000">"mork=mamund&amp;name=Mike Morkelsen"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>method <span style="color: #990000">=</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>waitMS <span style="color: #990000">=</span> <span style="color: #993399">300</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>retryAttempts <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>successFunction <span style="color: #990000">=</span> requestSucceeded<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>failFunction <span style="color: #990000">=</span> requestFailed<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>alternateHost <span style="color: #990000">=</span> <span style="color: #FF0000">"https://alternate-api.example.com"</span><span style="color: #990000">;</span>

httpLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>reqParams<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>After that fails, you can try the other options.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_dynamic_fallback">5.16.3.3. Dynamic fallback</h5>
<div class="paragraph"><p>This one is a bit trickier since you don&#8217;t have a fixed alternate host but need to go "find" one instead. See <a href="#services-fallback">[services-fallback]</a> for details on how to implement dynamic <span class=".keep-together">fallbacks</span>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_queuing_requests">5.16.3.4. Queuing requests</h5>
<div class="paragraph"><p>If retries and fallbacks fail, you can offer to queue the request and try it again later. This can be added as an option in your local request implementation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> reqParams <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span> <span style="font-style: italic"><span style="color: #9A1900">// request params</span></span>
reqParams<span style="color: #990000">.</span>host <span style="color: #990000">=</span> <span style="color: #FF0000">"https:/api.example.com"</span>
reqParams<span style="color: #990000">.</span>url <span style="color: #990000">=</span> <span style="color: #FF0000">"/users/q1w2e3"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>body <span style="color: #990000">=</span> <span style="color: #FF0000">"mork=mamund&amp;name=Mike Morkelsen"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>method <span style="color: #990000">=</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>waitMS <span style="color: #990000">=</span> <span style="color: #993399">300</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>retryAttempts <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>successFunction <span style="color: #990000">=</span> requestSucceeded<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>failFunction <span style="color: #990000">=</span> requestFailed<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>queuingFunction <span style="color: #990000">=</span> queueRequest<span style="color: #990000">;</span>
reqParams<span style="color: #990000">.</span>alternateHost <span style="color: #990000">=</span> <span style="color: #FF0000">"https://alternate-api.example.com"</span><span style="color: #990000">;</span>

httpLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>reqParams<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>When you do this, you will need to return an HTTP <code>202 Accepted</code> response to the API consumer along with a body that includes additional information. See <a href="#workflow-accepted">[workflow-accepted]</a> for details.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_give_up">5.16.3.5. Give up</h5>
<div class="paragraph"><p>At some point you&#8217;ll need to admit failure and just stop trying to complete the request.  In this case, you should return the appropriate response (an HTTP 5xx error) along with a response body that indicates the inability to complete the request. Since this request might be one of a series of API requests made by the API consumer, you should include any information that might be needed by the consumer to support additional rollbacks of other requests in the series. See <a href="#workflow-retry">[workflow-retry]</a> for details.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_43">5.16.4. Discussion</h4>
<div class="paragraph"><p>The good news is that the first few options listed (automatic retires, static fallbacks, and dynamic fallbacks) can all be implemented without coordination with the API client. They&#8217;re "hidden" implementation details.</p></div>
<div class="paragraph"><p>Conversely, the queuing requests option requires substantial coordination with API clients since it not only requires the client be prepared for the <code>202 Accepted</code> response, it may need to tell other services about this queuing issue. Consider the case where our service handles payment processing and some dependent service is unavailable. Returning <code>202 Accepted</code> to the API caller might create a mess on their end. Maybe they have already committed to decrementing inventory and scheduling a delivery of purchased goods. They will now need to decide if they should "unroll" those other activities, leave them in place, and not tell the calling API about it, or offer the calling API an option to wait or cancel the activities.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Don&#8217;t attempt retries on nonidemptotent HTTP methods like <code>POST</code> or <code>PATCH</code>. Instead only support these mitigations for <code>GET</code>, <code>HEAD</code>, <code>PUT</code>, and <code>DELETE</code>. In rare cases, HTTP <code>POST</code> operations can be interpreted as failures even when they are completed successfully; for example, when the target service&#8217;s <code>201 Created</code> response never makes it back to the API consumer that made the call. See <a href="#services-idempotent-create">[services-idempotent-create]</a> for more on this scenario. In the case of <code>PUT</code>, the consequence of this "false failure" is much less likely to result in corrupted or duplicate data on the target service.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>With the exception of the give up option, all the mitigations mentioned here involve some additional processing on the part of the API implementation. These added features (retries, fallbacks, queuing) will all need to be implemented locally to provide any benefit.</p></div>
<div class="paragraph"><p>Don&#8217;t make the mistake of implementing these mitigations as shared external services that get called by your API. This turns them into (possibly fatal) dependencies, too! If your API code can&#8217;t reach other underlying services to do its work, it might not be able to reach your external mitigation services, either.</p></div>
<div class="paragraph"><p>While the most common case is to use one of these mitigations for any HTTP 5xx level response, you might want to limit when you reset to these mitigations. For example, HTTP <code>408 Request Timeout</code> is a good candidate for these solutions.</p></div>
<div class="paragraph"><p>There may be new 5xx-level HTTP responses added in the future, and it may not be a good idea to engage in these mitigations for just <em>any</em> 5xx response. The ones I recommend as good candidates for retries, fallbacks, and queuing are: HTTP 500, 502, 503, and 504. Other 5xx values might be better handled by just returning the give up option right away.</p></div>
<div class="paragraph"><p>These options do not require the agreement of the underlying (failing) service. For example, your service interface can implement retries, fallbacks, or queuing mitigations without involving the service that has failed to respond in a timely manner.</p></div>
<div class="paragraph"><p>When implementing the retry option, you should check the documentation of the target service (the one you plan to send retries) to make sure you don&#8217;t program your interface code to trigger a denial of service response. Be sure not to abuse the underlying services by sending retries too often or too quickly.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>It is a good idea to keep a running history of all requests processed by your service. This is especially true in cases (like those covered in this recipe) where your service is doing additional work to store, forward, and process API consumer requests.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>When implementing the fallback options, you may need to provide additional request/response management if you plan to keep track of the activities (e.g., keep a history of past actions for the API consumer). By setting up the use of other services as a fallback, you are making the processing target a <em>variable</em>—not all requests may have been processed by the same service. If this detail matters, you will need to arrange for your service interface to keep track of—and possibly offer additional request tracking and management options for—these requests.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_43">5.16.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-caching">[data-caching]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="services-proxy">5.17. Using Semantic Proxies to Access <span class=".keep-together">Noncompliant Services</span></h3>
<div class="paragraph"><p>At the heart of the recipes in this book is the notion of supporting resilient API clients by using hypermedia-based service interfaces. But there are times when the services we need to expose to the network do not implement hypermedia interactions (e.g., an FTP upload service). In some cases, we don&#8217;t have the ability to change those services since they are operated by a third party outside our own IT ecosystem.</p></div>
<div class="sect3">
<h4 id="_problem_43">5.17.1. Problem</h4>
<div class="paragraph"><p>How can we safely expose noncompliant services in our RESTful web microservices ecosystem? When is it a good choice to create a local proxy service that wraps other, possibly remote third-party services? What does it take to create stable, reliable proxies for services we did not design and do not maintain?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_43">5.17.2. Solution</h4>
<div class="paragraph"><p>There are times when we need the functionality of an existing service, but the service design was not meant to support adaptable, evolvable interfaces in a RESTful ecosystem. In these cases, we need to create local, compliant service proxies that act as  "translation" devices between those noncompliant services and the rest of our service ecosystem.</p></div>
<div class="paragraph"><p>Typically, we need to design the <em>desired</em> service interface and then work up our own local code within the API "wrapper" that translates RESTful requests into ones that are supported by the noncompliant services. These proxies also need to translate any responses from the noncompliant services into RESTful resource representations.</p></div>
<div class="paragraph"><p>Sometimes the only challenge for an existing service is that it doesn&#8217;t operate with the preferred semantic vocabulary or it doesn&#8217;t support the desired media types for message exchange. In these cases, it isn&#8217;t too much work to introduce a kind of "semantic translation" proxy that hides the noncompliant service from API consumers.</p></div>
<div class="paragraph"><p>The proxy solution makes sense when you need to expose functionality that is "trapped" within noncompliant (see <a href="#principles">[principles]</a>) services and it is not possible (or viable) to modify those services to bring them into line with RESTful web microservices principles.</p></div>
<div class="paragraph"><p>There are three types of service proxies we&#8217;ll discuss in this recipe: the enterprise-level proxy (ELP), the custom one-off proxy (COP), and the semantic profile proxy (SPP).</p></div>
<div class="sect4 xxx">
<h5 id="_enterprise_level_proxy">5.17.2.1. Enterprise-level proxy</h5>
<div class="paragraph"><p>In some cases, you might be able to create an ELP that algorithmically translates between the noncompliant and compliant services. A good example of an ELP is IBM&#8217;s <a href="https://oreil.ly/OG0ph">CICS External Call Interface (EXCI)</a>. This solution works well when your organization has invested a great deal of effort in developing a domain-specific service platform (e.g., an accounting system) that was never implemented as a RESTful set of services.</p></div>
<div class="paragraph"><p>The ELP approach works well when you need to translate an established collection of related services (or a single monolith offering a wide range of functionality from a single source).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_custom_one_off_proxy">5.17.2.2. Custom one-off proxy</h5>
<div class="paragraph"><p>A more incremental approach is to create COP to translate existing functionality into an RWA-compliant interface. For example, you might want to add a RESTful interface to an existing FTP file upload service. The COP approach limits the effort needed to solve a compliance problem and can also be easier to modify and scale as you go along.</p></div>
<div class="paragraph"><p>Use the COP approach when you have a heterogeneous mix of services you need to bring into compliance or when you anticipate a small set of services needing this kind of attention.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_semantic_profile_proxy">5.17.2.3. Semantic profile proxy</h5>
<div class="paragraph"><p>Sometimes the only barrier to interoperability for an external service is its inability to "speak" in a language the other parts of your system understand. For example, you might be dependent on services that only exchange messages in <code>text/csv</code> instead of a hypermedia format like SIREN or Collection+JSON. Or the responses may not be expressed in your organization&#8217;s preferred vocabulary (e.g., FHIR for health data or BIAN for banking information).  In these cases, you might be able to set up an SPP to "normalize" the data exchanges.</p></div>
<div class="paragraph"><p>SPP implementations can be as simple as converting XML to SIREN or as complex as adding hypermedia forms to a set of exchanges originally designed to only support CSV files. For this reason, it is sometimes difficult to estimate the level of effort needed to design and implement an SPP solution. You might be able to use an ELP-like approach to establish standardized transformations for messages. For example, you might be able to write an XLST transformation proxy that converts between Collection+JSON and XML.</p></div>
<div class="paragraph"><p>No matter which approach you are using (SPP, COP, or ELP), all service proxies need to deal with the following elements:</p></div>
<div class="ulist"><ul>
<li>
<p>
Create a semantic profile that delineates the domain in use (<a href="#services-vocabularies">[services-vocabularies]</a>)
</p>
</li>
<li>
<p>
Publish an API definition document outlining the functionality of your proxy (<a href="#services-definitions">[services-definitions]</a>)
</p>
</li>
<li>
<p>
Write code that implements all the external actions using the underlying services, internal functions (<a href="#services-actions">[services-actions]</a>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Essentially, writing a service proxy is the work of designing, defining, and implementing a new service interface. The key difference here is that there is already a working service that relies upon another, noncompliant implementation.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_42">5.17.3. Example</h4>
<div class="paragraph"><p>Each proxy model (ELP, COP, and SPP) requires a slightly different implementation approach.</p></div>
<div class="sect4 xxx">
<h5 id="_cop_example">5.17.3.1. COP example</h5>
<div class="paragraph"><p>This is an example of a COP implementing a RESTful proxy for an FTP file upload service. The following is the underlying service interface we need to "cover," along with a RESTful interface implementation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// HTTP upload external action</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">httpUpload</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> uploader <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">httpService</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> file <span style="color: #990000">=</span> uploader<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> file<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// FTP client service</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">ftpUpload</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> client <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ftpService</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">put</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> results<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// proxy function for file uploads</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">proxyUpload</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> file <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpUpload</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ftpUpload</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> results<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph pagebreak-before less_space"><p>Here&#8217;s a RESTful interface for uploading files (in HTML):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /upload-file/ HTTP/1.1
Accept: text/html
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: text/html
....

&lt;form method="post" action="https://api.example.org/uploads/"
  enctype="multipart/form-data" &gt;
  &lt;input type="file" name=file" value="daily-batch.txt" /&gt;
  &lt;input type="submit" value="Upload" /&gt;
&lt;/form&gt;

**** REQUEST ****
POST /uploads/ HTTP/1.1
Accept: text/html
...

Content-Disposition: form-data; name="file";
...

**** RESPONSE
HTTP/1.1 200 OK
Content-Type: text/html
....

&lt;p&gt;File has been uploaded&lt;/p&gt;</code></pre>
</div></div>
</div>
<div class="sect4 xxx">
<h5 id="_elp_example">5.17.3.2. ELP example</h5>
<div class="paragraph"><p>In the case of a enterprise-level proxy (ELP), you can approach this as a translation gateway similar to the one used for the Wireless Application Protocol (WAP) example cited earlier in this recipe. Other examples of algorithmic proxies are ones that convert XML-based messages to JSON-based formats, natural language translators (English to Spanish, etc.), and even protocol translators like the preceding FTP&lt;&#8594;HTTP proxy or the WAP&lt;&#8594;HTTP example referred to earlier.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_spp_example">5.17.3.3. SPP example</h5>
<div class="paragraph"><p>Simple SPPs (e.g., format translators) are usually easy to implement as long as the responses from the underlying service are consistent and the level of customization for output formats is not too high. For example, you might have an XSLT implementation that consistently converts XML to Collection+JSON:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>results = convert(xmlDocument, xsltCollectionJSON);</code></pre>
</div></div>
<div class="paragraph"><p>However, you might need to inject hypermedia controls in the responses, too. This works well if the underlying service provides a status interface (e.g., a CRUD-style model). In that case, you can simply code-in the standard Create-Read-Update-Delete operations in the transformation script.</p></div>
<div class="paragraph"><p>Finally, if you need to convert the vocabulary of the underlying service (e.g., <code>firstName &#8594; givenName</code>, etc.), you&#8217;ll need to do more work. Usually, it is difficult to use a transformation language with XSLT. Instead you may need to write additional conversion code that runs separately from any format translations.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_44">5.17.4. Discussion</h4>
<div class="paragraph"><p>Implementing COP works when the functionality you want to expose is limited to and/or focused on a small set of static operations. ELPs should be reserved for large-scale efforts to convert an existing investment into a more modern, accessible set of external actions. I&#8217;ve worked on a handful of ELP-type projects and most of them take quite a bit more effort than expected, and almost all of them have a limited lifetime before some other technology supersedes them.</p></div>
<div class="paragraph"><p>It is rare for service proxies to scale at speed. Most of the time, the work of translating between the two interfaces is a fiddly business of string manipulation and protocol hoping. For this reason, translation proxies should be limited to parts of the system that do not require a high transaction volume or a low latency. Queue-based implementations are usually a common target of service proxying.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Implementing an ELP is not something to take on unless you are sure you have sufficient resources. Not just money, but also the time it will take to complete the first release and maintain it going forward.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>When implementing an ELP translator, your semantic profile and API definition files document the gateway-level semantics, not the domain-level semantics of the information that passes through the gateway. In this way, implementing an ELP is very close to designing, defining, and implementing a new message protocol or an end-to-end programming framework.</p></div>
<div class="paragraph"><p>In general, protocol translation proxies (FTP&lt;&#8594;HTTP, etc.) are relatively easy to implement because application-level protocols are mature and stable specifications. There are lots of "rabbit holes" when it comes to metadata (HTTP headers, dealing with FTP status codes, etc.), but most of the time you can smooth these over with generic responses.</p></div>
<div class="paragraph"><p>Conversely, SPPs are often the most challenging proxies to successfully implement. Often the poorly specified vocabularies, ambiguous meanings of terms, and long-standing organizational knowledge buried in local service implementations all conspire to make building stable SPPs a daunting task. The smaller the vocabulary (e.g., the target domain), the more likely you are to succeed.</p></div>
<div class="paragraph"><p>In my experience, there are two types of successful service proxies. The first is one that works "just well enough" and just long enough until a better, more stable solution comes along (e.g., a new product) to replace it; and the sooner the better. The other successful proxy implementation is one that has been around for years, humming along, and no one has any idea how it works. None of the original designers or programmers are around anymore, and only a fool would ever attempt to modify any part of that mysterious (but stable) proxy.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_44">5.17.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-definitions">[services-definitions]</a>
</p>
</li>
<li>
<p>
<a href="#data-extend">[data-extend]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data">6. Distributed Data</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>First step in breaking the data centric habit, is to stop designing systems as a collection of data services,  and instead design for business capabilities.
</q></p>
<p data-type="attribution">Irakli Nadareishvili, JPMorgan Chase</p>
</blockquote>
<div class="paragraph"><p>This chapter is devoted to recipes for data-centric service interfaces. Data-centric interfaces need to follow all the same principles covered in <a href="#services">[services]</a> along with some additional details that come from the responsibility of storing and managing data. These details involve assuring data integrity, hiding internal data models and implementation technology, and dealing with a wide range of possible network failures without invalidating any existing data. This is especially important now that data can easily travel around the world and come into contact with regulations such as <a href="https://gdpr-info.eu">General Data Protection Regulation (GDPR)</a> and others.</p></div>
<div class="paragraph"><p>Not all services need to manage their own data, but most have some level of data support responsibilities. The challenge of data-centric services is that they typically support persistent data. Even when a service goes offline, the data must continue to exist and/or be accessible by other services. In some cases the service interface has the task of mixing locally managed data with data from other external services. This compounds the integrity and reliability problem since the target interface must now rely on <em>other</em> data services to complete the request work. And, especially in the case of writing data, the more services involved in an action, the more likely an error and the more complicated it is to rectify any problems.</p></div>
<div class="paragraph"><p>Supporting distributed data in a hypermedia environment (see <a href="#fig0601">[fig0601]</a>)  means representing data responses as messages and returning hypermedia controls to communicate possible actions on that returned data. It also means presenting a common information retrieval query language (IRQL) independent of any internal custom data query technology, such as SQL, GraphQL, etc. Editing data on the network also means supporting idempotency for all changes in order to improve the likelihood of successful writes. Lastly, enabling distributed data on the web means you need to support the ability to modify and extend backend data models without breaking the service interface.</p></div>
<div class="imageblock" id="fig0601">
<div class="content">
<img src="images/rwcb_0601.png" alt="images/rwcb_0601.png" width="80%" />
</div>
<div class="title">Figure 12. Hypermedia data recipes</div>
</div>
<div class="sidebarblock" id="data-least-power">
<div class="content">
<div class="title">The Rule of Least Power</div>
<div class="paragraph"><p>The recipes in this chapter were selected to highlight common challenges, identify common principles, and generally offer advice on how to implement APIs that follow <a href="https://oreil.ly/o9L8r">Tim Berners-Lee&#8217;s "Rule of Least Power"</a>: "[T]he less powerful the language, the more you can do with the data stored in that language."</p></div>
</div></div>
<div class="paragraph"><p>Data services are hard; no doubt. The solutions here try to use the least powerful "data languages" in order to support the most you can do with the stored data.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For additional background on designing and implementing data-centric services, see <a href="#background-data">[background-data]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="data-hiding">6.1. Hiding Your Data Storage Internals</h3>
<div class="paragraph"><p>Data storage technology has changed dramatically over the decades. At the same time, interface designers often need to create APIs that make it possible to interact with data services written using technology and features clearly designed for local access instead of distributed network support. A guiding principle in creating data-centric services is to hide the technology behind the interface and to always present APIs that "speak the language of the API consumer," not the language of the data storage technology.</p></div>
<div class="sect3">
<h4 id="_problem_44">6.1.1. Problem</h4>
<div class="paragraph"><p>What is the best way to ensure APIs for data-centric services don&#8217;t "leak" the underlying storage and query technology used by that service? How can we shield API consumers from changes in foundational data technology over time? When does it make sense to expose the syntax of current storage tech, and when does it make sense to adopt a more generic query, data management, and storage language for your service interfaces?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_44">6.1.2. Solution</h4>
<div class="paragraph"><p>As a rule, it is good idea to <em>hide</em> the data storage technology from your API consumers. They should not know whether you are using SQL-based tech, GraphQL, or simple filed-based storage. Ideally, you should design your interfaces in a way that allows you to change the underlying data storage without adversely affecting existing API consumers. The best way to do this is to make sure the service interface focuses on the "job to be done" (e.g., <code>updateCustomer</code> or <code>findUnpaidInvoices</code>) instead of relying on "data-language" (e.g., <code>writeToDB(customerObject)</code> or <code>queryData(&#x27;invoices where balance&gt;0&#x27;)</code> in your external interface.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">New Data Service, Anyone?</div>
<div class="paragraph"><p>The exception to this rule comes up when you are designing and implementing a data management service itself. If your goal is to create the next GraphQL clone or improve on the technology of Apache Lucene, then you need to design and implement your own data platform, including storage, query, and data management languages. That&#8217;s a big job but certainly a worthy one. But designing a data engine is not the same job as supporting data services for a user management interface.</p></div>
</div></div>
<div class="paragraph"><p>When adding data functionality to your API, it is best to expose domain-specific actions as your external interface and keep your chosen data technology hidden as part of your API&#8217;s internal implementation details.</p></div>
</div>
<div class="sect3">
<h4 id="_example_43">6.1.3. Example</h4>
<div class="paragraph"><p>Consider the case of a service that needs to support updating existing objects in a handful of stored collections (e.g., <code>customers</code>, <code>salesReps</code>, <code>products</code>, etc.). Let&#8217;s also assume that our internal service exposes a generic method (<code>update(object)</code>) where the object is one of the ones mentioned previously.</p></div>
<div class="paragraph"><p>For classic HTTP implementations, you can supply a FORM that supports modifying existing records:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /customers/q1w2e3 HTTP/1.1
Accept: application/vnd.siren+json
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.siren+json
ETag: "w\p0o9i8u7"
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> "class": <span style="color: #990000">[</span>"customer"<span style="color: #990000">],</span>
  "properties": <span style="color: #990000">{</span>
    "id": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">,</span>
    "companyName": "<span style="color: #FF0000">BigCo, Inc.</span>"<span style="color: #990000">,</span>
    ...
  <span style="color: #990000">},</span>
  "actions": <span style="color: #990000">[</span>
    "name": "<span style="color: #FF0000">update</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">application/x-www-form-urlencoded</span>"<span style="color: #990000">,</span>
    "method": "<span style="color: #FF0000">PUT</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://api.example.org/customers/q1w2e3r4</span>"<span style="color: #990000">,</span>
    "fields": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">companyName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">BigCo, Inc.</span>"<span style="color: #990000">,</span>
      ...
    <span style="color: #990000">]</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, you don&#8217;t know what data technology is used to implement the update—and that&#8217;s the way it should be. For example, on first release, the data tech might have been an SQLite database. But now the data storage is implemented using GraphQL. The good news is this change in data platforms could be implemented without adversely affecting the clients using the API.</p></div>
<div class="paragraph"><p>Exposing data writes (create, update, delete) are pretty easy to do without leaking the underlying technology. But it is a bit more challenging when it comes to safely exposing queries as external actions. Too often it is too easy to slip into just exposing a generic query engine in your service interface. That makes the initial release faster but opens you up to challenges when the underlying tech changes or the underlying table/relationship layout changes. Plus, the data <em>provider</em> perspective is not always the same as the data <em>consumer</em> perspective. It is always better to put the consumer&#8217;s needs above the provider&#8217;s.</p></div>
<div class="paragraph"><p>Exposing the underlying query language is a bad idea. Soon you&#8217;ll be spending time managing the query language instead of managing the problem domain defined by the service interface. Whenever possible, it is a better idea to expose simple links (and possibly forms) that describe the query. This follows the "Rule of Least Power" mentioned at the start of this chapter.</p></div>
<div class="paragraph"><p>For example, let&#8217;s assume a case where your service interface needs to support finding all <code>customers</code> with outstanding balances more than 30 days, 60 days, and 90 days past due. Here is an example implementation:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET / HTTP/1.1
Host: api.customers.org
Accept: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Customers</span>"<span style="color: #990000">,</span>
  "links" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
  "items" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
  "queries" : <span style="color: #990000">[</span>
   <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">unpaid30</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
   <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">unpaid60</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
   <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">unpaid90</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that there is no indication of the data storage or query technology in the service interface. Another possible, slightly more involved, solution would be:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET / HTTP/1.1
Host: api.customers.org
Accept: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Customers</span>"<span style="color: #990000">,</span>
  "links" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
  "items" : <span style="color: #990000">[</span>...<span style="color: #990000">]</span>
  "queries" : <span style="color: #990000">[</span>
   <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">unpaid</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"
    "data" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">days</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">30</span>"<span style="color: #990000">,</span> "required": "<span style="color: #FF0000">true</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
   <span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Adding required parameters to your API means that changing it in the future will be more difficult. If the underlying service changes from using <code>days</code> as a query value to <code>months</code>, your interface will need to be modified to 1) continue to support <code>days</code> and do a local conversion or 2) introduce a backward-incompatible breaking change. Whenever possible, avoid required parameters.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The required parameter could be made optional if the interface also offered the promise to supply a default value (e.g., <code>"30"</code>) if no value was passed in the query. This would simplify the query interface, but add more to the implementation.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_45">6.1.4. Discussion</h4>
<div class="paragraph"><p>Hiding data tech for writes is usually not a problem. Using HTTP to pass a message (e.g., <code>customer</code>, <code>product</code>, etc.) with an HTTP method is all you need to support it. See <a href="#data-idempotent">[data-idempotent]</a> for more on data writes.</p></div>
<div class="paragraph"><p>Hiding data tech for queries can be a challenge. It is easy to end up exposing whatever query technologies are used by the service itself. This is especially true if the API is the only layer between the API consumer and the data storage itself. Consider the folly of the following data-centric API code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">sqlExecute</span></span><span style="color: #990000">(</span>connectionString<span style="color: #990000">,</span> sqlStatement<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sql <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">sqlConnection</span></span><span style="color: #990000">(</span>connectionString<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> sql<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">query</span></span><span style="color: #990000">(</span>sqlStatement<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> results<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And now here&#8217;s the (terrible) HTTP interface to match:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>POST /data/ HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json
Content-Type: application/x-www-form-urlencoded
...

sqlConnection=user=mork,pw=m04k,server=db1,database=products&amp;
sqlStatement=select%20*%20from%20products</code></pre>
</div></div>
<div class="paragraph"><p>The apparent good news is that the interface designer gets a fully functional data-centric interface without doing much work. The bad news is that what we have here is a security and evolvability nightmare. Don&#8217;t do this!</p></div>
<div class="paragraph"><p>There may be times when you want to implement an API that relies on an independent query language like Lucene or some other IRQL. In those cases, exposing the query language is much less of a risk. See <a href="#data-formats">[data-formats]</a> for more on how to safely implement language-specific query support.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_45">6.1.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-structured-types">[design-structured-types]</a>
</p>
</li>
<li>
<p>
<a href="#services-model-leaks">[services-model-leaks]</a>
</p>
</li>
<li>
<p>
<a href="#data-relations">[data-relations]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-idempotent">6.2. Making All Changes Idempotent</h3>
<div class="paragraph"><p>One of the important responsibilities of data services and their interfaces is to ensure data integrity. This can be a challenge when using HTTP over the web, especially when the network is slow or unreliable. This recipe describes how you can improve the reliability of your data writes over HTTP.</p></div>
<div class="sect3">
<h4 id="_problem_45">6.2.1. Problem</h4>
<div class="paragraph"><p>There are times when data writes over HTTP fail, either due to a faulty network or inconsistency in the data to be written. What is the best way to improve the reliability of data writes at a distance when using HTTP?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_45">6.2.2. Solution</h4>
<div class="paragraph"><p>The simplest way to improve the reliability of data writes on the web is to limit write actions to rely only on the HTTP <code>PUT</code> method. Do not use <code>PATCH</code> or <code>POST</code> to write data over HTTP. The HTTP method <code>PUT</code> is idempotent—it was designed to return the same results, even when repeated multiple times. Neither <code>POST</code> or <code>PATCH</code> have this <span class=".keep-together">feature</span>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">A PATCH Is Not a PATCH</div>
<div class="paragraph"><p>The HTTP Method Registry entry for HTTP <code>PATCH</code> identifies the method as <a href="https://oreil.ly/K8MJD">non-idempotent</a>. However, the <a href="https://oreil.ly/8Ff8t">full specification</a> points out that "a <code>PATCH</code> request can be issued in such a way to be idempotent." Despite this observation, I continue to recommend using only <code>PUT</code> for data writes over HTTP, as I find implementing <code>PATCH</code> more of a challenge than simply using <code>PUT</code>.</p></div>
</div></div>
<div class="paragraph"><p>The <a href="https://oreil.ly/qdr0A">HTTP <code>PUT</code> method</a> was designed such that "the state of the target resource be created or replaced with the state defined by the representation." For this reason, I use <code>PUT</code> when attempting to <em>create</em> new data records and when <em>updating</em> existing data records.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For details on how to use HTTP <code>PUT</code> to create instead of using HTTP <code>POST</code>, see <a href="#services-idempotent-create">[services-idempotent-create]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Service interfaces should always make HTTP <code>PUT</code> actions <em>conditional</em> requests. To do this, when HTTP <code>PUT</code> is used to create a new data resource, the <code>If-None-Match: *</code> header should be sent. This ensures that the record will only be created if there is no resource at the URL used in the request.</p></div>
<div class="paragraph"><p>When using HTTP <code>PUT</code> to update an existing data resource, the API client should send the <code>If-Match: "&#8230;"</code> header with the value set to the <code>Etag</code> header received when reading the record to update. This will make sure that the <code>PUT</code> will only be completed when the entity tags (<code>ETag</code> in the response and <code>If-Match</code> in the request) are the same.</p></div>
<div class="paragraph"><p>While including the existing record&#8217;s entity tag values (or the <em>*</em> wildcard), you can make sure the HTTP request only completes when the conditions are right. Using entity tags in this way also makes it possible to resend the same request multiple times without fear of overwriting an update from another API client. In the case of using HTTP <code>PUT</code> for creating records, resending the record will not inadvertently overwrite a new record. Finally, in cases where the API consumer gets an initial failure (or a missing response entirely), that client can confidently resend the update without worrying that it will overwrite someone else&#8217;s work.</p></div>
<div class="paragraph"><p>Since HTTP <code>PUT</code> is idempotent, it can be safely repeated with confidence. This is especially handy in M2M scenarios where humans would not be able to intercept and sort out any failed request problems.</p></div>
</div>
<div class="sect3">
<h4 id="_example_44">6.2.3. Example</h4>
<div class="paragraph"><p>The following are several examples of using HTTP <code>PUT</code> for creating and updating an existing resource record.</p></div>
<div class="sect4 xxx">
<h5 id="_using_http_put_to_create_a_new_resource">6.2.3.1. Using HTTP PUT to create a new resource</h5>
<div class="paragraph"><p>Here is a quick example of using HTTP <code>PUT</code> to create a new data resource:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /tasks/q1w2e3r4 HTTP/1.1
Host: api.example.org
Content-Type: application/x-www-form-urlencoded
If-None-Match: *
Accept: application/vnd.hal+json
...

id=q1w2e3r4&amp;title=Meet%20with%Dr.%Bison

**** RESPONSE ****
HTTP/1.1 201 Created
ETag: "w/p0o9i8u7"
Location: http://api.example.org/tasks/q1w2e3r4

**** REQUEST ****
GET /tasks/q1w2e3r4 HTTP/1.1
Host: api.example.org
ETag: "w/p0o9i8u7"
Accept: application/vnd.hal+json

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.hal+json
ETag: "w/p0o9i8u7"
....

{
  "_links": {...},
  "id": "q1w2e3r4",
  "title": "Meet with Dr. Bison",
  "dateCreated": "2022-09-21"
}</code></pre>
</div></div>
</div>
<div class="sect4 xxx">
<h5 id="_using_http_put_to_update_an_existing_resource">6.2.3.2. Using HTTP PUT to update an existing resource</h5>
<div class="paragraph"><p>Note that, in the first response (<code>201 Created</code>), the <code>ETag</code> was included. This provides the API client application the proper value for the <code>ETag</code> used in the following <code>GET</code> request.</p></div>
<div class="paragraph"><p>Now let&#8217;s assume the API client wants to update that same <code>task</code> record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /tasks/q1w2e3r4 HTTP/1.1
Host: api.example.org
Content-Type: application/json
Accept: application/vnd.hal+json
ETag: "w\p0o9i8u7"
...

{ "id": "q1w2e3r4", "title": "Meet with Dr. Bison at 16:00"}

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.hal+json
ETag: "w\y6t5r4e3"
...

{
  "_links": {...},
  "id": "q1w2e3r4",
  "title": "Meet with Dr. Bison at 16:00",
  "dateCreated": "2022-09-21"
}</code></pre>
</div></div>
<div class="paragraph"><p>Note the updated <code>ETag</code> value that was returned in the update response. This represents the new edition of the task resource representation.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Entity tags (<code>ETag</code> headers) are unique for each <em>representation</em> of the resource. For example, the <code>ETag</code> for a <code>person</code> resource returned as an HTML document is not the same as the <code>ETag</code> for the same <code>person</code> returned as a JSON document.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect4 xxx">
<h5 id="_handling_a_failed_http_put_update">6.2.3.3. Handling a failed HTTP PUT update</h5>
<div class="paragraph"><p>Finally, let&#8217;s look at a case where the API client application attempts to update the resource again. But this time, the resource was updated by another client application somewhere else. For that reason, the update will fail and needs to be repeated:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /tasks/q1w2e3r4 HTTP/1.1
Host: api.example.org
Content-Type: application/json
Accept: application/vnd.hal+json
ETag: "w\p0o9i8u7"
...

{ "id": "q1w2e3r4", "title": "Meet with Dr. Bison at 16:30"}

**** RESPONSE ****
HTTP/1.1 412 Conflict
Content-Type: application/problem+json

{
  "type": "https://api.example.org/probs/lost-update",
  "title": "The resource has already been updated",
  "detail": "The title properties do not match",
  "instance": "http://api.example.org/tasks/q1w2e3r4",
}</code></pre>
</div></div>
<div class="paragraph"><p>When a <code>412 Conflict</code> is returned, the API client application should immediately make a <code>GET</code> request to retrieve the updated record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /q1w2e3r4 HTTP/1.1
Host: api.example.org
Accept: application/vnd.hal+json
ETag: "w/o9i8u7y6"
...
{
  "_links": {...},
  "id": "q1w2e3r4",
  "title": "Meet with Dr. Bison at downtown office",
  "dateCreated": "2022-09-21"
}</code></pre>
</div></div>
<div class="paragraph"><p>With the refreshed record in hand, the API client can now resubmit the update request:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.hal+json
ETag: "w/o9i8u7y6"
...

{
  "_links": {...},
  "id": "q1w2e3r4",
  "title": "Meet with Dr. Bison at the downtown office at 16:00",
  "dateCreated": "2022-09-21"
}</code></pre>
</div></div>
<div class="paragraph"><p>In this last example, the failed response was caused by a previous update from another client application. This is often referred to as the <a href="https://www.w3.org/1999/04/Editing">"lost update problem"</a>. Fixing this problem requires performing a <code>GET</code> request on the existing record and then modifying <em>that</em> record before resending the <code>PUT</code> request.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_handling_network_failures">6.2.3.4. Handling network failures</h5>
<div class="paragraph"><p>Another possible error condition is a network failure. In this case, either the update never reaches the server or the server&#8217;s response never reaches the client. You can think of this as the <a href="https://blog.container-solutions.com/why-i-stopped-using-post">"lost response problem"</a>. Fixing this problem is easier, if not more reliable. The API client can simply resend the existing request in hopes that the server is once again reachable. If the repeated attempts fail, the API client needs to log the error and stop bothering the target server.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_46">6.2.4. Discussion</h4>
<div class="paragraph"><p>Making all write actions idempotent (via HTTP <code>PUT</code>) doesn&#8217;t remove possible failures. Instead, using HTTP <code>PUT</code> makes handling the error conditions encountered on the web less complicated and more easily resolved.</p></div>
<div class="paragraph"><p></p></div>
<div class="sidebarblock less_space">
<div class="content">
<div class="title">Handling 410 Gone</div>
<div class="paragraph"><p>It is possible that an API client will attempt to use HTTP <code>PUT</code> to update a record that has already been removed by some other API consumer via an HTTP <code>DELETE</code> request. In this case, the API client should have received a <code>410 Gone</code> response and logged the condition for later inspection.</p></div>
</div></div>
<div class="paragraph"><p>Data service interfaces should always return entity tags (<code>ETag</code>) in responses. This value is the best way for both API provider and consumers to ensure resource integrity when attempting any write requests. It is important that data-centric service interfaces <em>reject</em> any attempt to modify resource state (via <code>PUT</code>, <code>POST</code>, <code>PATCH</code>, and <code>DELETE</code>) that does not include an entity tag header (<code>If-None-Match</code> for create, and <code>If-Match</code> for update and delete).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>While I focus on <code>If-None-Match</code> and <code>If-Match</code> headers, the HTTP specification also defines <code>If-Modified-Since</code> and <code>If-Unmodified-Since</code> headers based on date-time stamps. I continue to recommend using the headers based on entity tags instead of date-stamps, but both approaches are acceptable.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>There will be times when an update fails and there is no simple machine-driven way to resolve the problem. In this case, the API consumer application should write a log record or send a text/email message indicating the failure and ask a human to deal with the problem.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_46">6.2.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-idempotent">[design-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#clients-identifier">[clients-identifier]</a>
</p>
</li>
<li>
<p>
<a href="#services-idempotent-create">[services-idempotent-create]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-relations">6.3. Hiding Data Relationships for External Actions</h3>
<div class="paragraph"><p>When following the principle of hiding data technology from the service interface, it is also important to hide any data model relationships employed by that technology. This recipe helps you keep the data relationships hidden from the API while still supporting those relationships at runtime.</p></div>
<div class="sect3">
<h4 id="_problem_46">6.3.1. Problem</h4>
<div class="paragraph"><p>What&#8217;s the best design to hide any data model relationships (e.g., <code>person</code> as one or more address records) from the service interface? Is there a way to support the backend relationships without exposing the data model or data technology behind that interface?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_46">6.3.2. Solution</h4>
<div class="paragraph"><p>The safest approach to writing data that includes entity relationships in the underlying data model is to represent the data properties using a "flat view" of the associated data. For example, in our <code>person</code> and <code>address</code> case, a single write operation would contain all the fields needed for both entities. It would be up to either the API code or the code in the service <em>behind</em> the API to split the single message into as many write operations as needed.</p></div>
<div class="paragraph"><p>It is also a helpful practice to include in the write response a pointer that allows the client to add another related entity. For instance, the response from a successful write of a new <code>person</code> and <code>address</code> entity might include a link or form to "Add another address" in the stored model.</p></div>
</div>
<div class="sect3">
<h4 id="_example_45">6.3.3. Example</h4>
<div class="paragraph"><p><a href="#fig0602">[fig0602]</a> is an example entity-relationship diagram showing how <code>person</code> records and <code>address</code> records are related in the underlying data model of the <code>person</code> interface.</p></div>
<div class="imageblock" id="fig0602">
<div class="content">
<img src="images/rwcb_0602.png" alt="images/rwcb_0602.png" width="80%" />
</div>
<div class="title">Figure 13. Person-address relationship</div>
</div>
<div class="paragraph"><p>And here is the Collection+JSON template from the published API:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Persons</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "items": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "template": <span style="color: #990000">{</span>
    "data": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">person</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">person</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Markelson</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">person</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">address</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">city</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">address</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">state</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Maryland</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">address</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">postal_code</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345-6789</span>"<span style="color: #990000">,</span> "type": "<span style="color: #FF0000">address</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, both the <code>person</code> and <code>address</code> data properties are included in a single write message. A minor implementation detail has been added: the inclusion of the <code>type</code> property that provides hints on how the data might be organized in data storage. This is purely optional.</p></div>
<div class="paragraph"><p>Behind the scenes, the API code might turn this into two write operations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> http<span style="color: #990000">.</span>request<span style="color: #990000">.</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toJSON</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> person <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">personFilter</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> adddress <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">addressFilter</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
address<span style="color: #990000">.</span>person_id <span style="color: #990000">=</span> person<span style="color: #990000">.</span>id<span style="color: #990000">;</span>

Promise<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span><span style="font-weight: bold"><span style="color: #000000">writePerson</span></span><span style="color: #990000">(</span>person<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #000000">writeAddress</span></span><span style="color: #990000">(</span>address<span style="color: #990000">)]).</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">(...);</span></tt></pre></div></div>
<div class="paragraph"><p>In this case, the write operations of both the parent record (<code>person</code>) and related child record (<code>address</code>) are sent in a single HTTP request allowing the API code to sort out the details. The response to a successful write request can be a representation that includes a link to continue to add more child records:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Persons and Addresses</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">person collection</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">List persons</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">address create</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">,</span> "prompt": "<span style="color: #FF0000">Add another address</span>"<span style="color: #990000">},</span>
    ...
  <span style="color: #990000">],</span>
  "items": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "queries": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "template": <span style="color: #990000">{</span>...<span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Another way to hide the underlying data model relationships is to use the "Work in Progress" recipe to collect all the related information (<code>person</code>, <code>addresses</code>, <code>online-contacts</code>, etc.) incrementally as a series of HTTP write requests. Then, once all the data is collected, offer a "submit" operation to ship the complete collection as a final HTTP request. For more on this, see <a href="#workflow-wip">[workflow-wip]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The key to using this recipe is to model the interface operations independently of any internal data models. This will allow interface designers the freedom to change the API details and/or the storage details in future releases without requiring a breaking change.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_47">6.3.4. Discussion</h4>
<div class="paragraph"><p>While the example here illustrates a single relationship (<code>person</code> and <code>address</code>), this recipe works for any number of entity relation models. For example, the following is a single write request that might be modeled as three storage collections (<code>company</code>, <code>contact</code>, and <code>salesRep</code>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"createEntry"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"PUT"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"companyId"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"p0o9i8"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"company"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"companyName"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"BigCo, Inc"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"company"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"contactId"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"y6t5r4: class="</span><span style="color: #009900">contact</span><span style="color: #FF0000">" /&gt;</span>
<span style="color: #FF0000">  &lt;input name="</span><span style="color: #009900">contactName</span><span style="color: #FF0000">" value="</span><span style="color: #009900">Mork</span> <span style="color: #009900">Markleson</span><span style="color: #FF0000">" class="</span><span style="color: #009900">contact</span><span style="color: #FF0000">" /&gt;</span>
<span style="color: #FF0000">  &lt;input name="</span><span style="color: #009900">salesRepId</span><span style="color: #FF0000">" value="</span><span style="color: #009900">w2e3r4</span><span style="color: #FF0000">" class="</span><span style="color: #009900">salesRep</span><span style="color: #FF0000">" /&gt;</span>
<span style="color: #FF0000">  &lt;input type="</span><span style="color: #009900">submit</span><span style="color: #FF0000">" /&gt;</span>
<span style="color: #FF0000">&lt;/form&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Note that the last data property in this write message is a reference to a <code>saleRepId</code> and no other data properties for <code>salesRep</code>. In this case, this is a reference to an existing <code>saleRep</code> resource. The interface and/or service layers are expected to know how to deal with this situation. The data model (e.g., an SQL engine) might call for just a reference field (as shown here) or, in a document interface model (e.g., a file-based engine), the <code>salesRep</code> data may need to be read from storage and then included in the final storage document.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>It is a good idea to log the complete message that was submitted by the client application. This is especially handy if clients request to "back out" or cancel a write operation.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In the preceding example, the "entity hint" pattern (<code>class="company"</code>) is employed. This is a handy way to provide additional metadata to the API layer (or backend service) on how the client expects the data properties to be "grouped." But it has its <span class=".keep-together">limits</span>. As long as the grouping is supplied by the party in charge of collecting the data properties, it can work well. But it has a kind of "leaky" quality to it.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>It is important that client applications not become too tied to any data storage "hints" that appear in responses. This is because the storage modeling might change at some future point, rendering those "hints" incorrect at best and dangerous at worst.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Typically, M2M interactions can handle large payloads (ones that include several entity relations) better than human-to-machine interactions. People have a hard time keeping lots of data in their heads, and really long input forms can be trouble for users. If you are designing a human-to-machine interface, feel free to use the "flat" model approach shown here. If you are designing a human-to-machine interface, consider using the "Work in Progress" <a href="#workflow-wip">[workflow-wip]</a> instead.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_47">6.3.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#data-extend">[data-extend]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-contains">6.4. Leveraging HTTP URLs to Support "Contains" <span class=".keep-together">and "AND" Queries</span></h3>
<div class="paragraph"><p>HTTP has a simple information retrieval query language (IRQL) built into the protocol. The URL query string can be used to support a simple, yet powerful search tool by implementing the "contains" predicate along with the "AND" search condition. This recipe shows you how to quickly and easily add solid search support to your service interfaces.</p></div>
<div class="sect3">
<h4 id="_problem_47">6.4.1. Problem</h4>
<div class="paragraph"><p>What&#8217;s the easiest way to add IRQL support to HTTP APIs? What search operators, conditions, and predicates are needed for most HTTP queries?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_47">6.4.2. Solution</h4>
<div class="paragraph"><p>The simplest search support you can implement for your HTTP interfaces is to leverage the URL query string pattern for name/value pairs (<code>?name=value</code>). For HTTP URLs, the implementation you need to support queries is to treat the <code><em>=</em></code> (equals) <span class=".keep-together">operator</span> that separates a name/value pair to actually check for "contains" or "in" rather than a strict "equals" check.</p></div>
<div class="paragraph"><p>Assume you have the following two records in some storage:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">ID</p></td>
<td align="left" valign="top"><p class="table">NAME</p></td>
<td align="left" valign="top"><p class="table">CITY</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">q1w2e3</p></td>
<td align="left" valign="top"><p class="table">Mork</p></td>
<td align="left" valign="top"><p class="table">Middletown</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">e3r4t5</p></td>
<td align="left" valign="top"><p class="table">Mick</p></td>
<td align="left" valign="top"><p class="table">Morganville</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>By implementing <code><em>=</em></code> as contains, you can implement the following queries:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p><code>?ID=q1w2e3</code> returns the first record</p></div>
<div class="paragraph"><p><code>?ID=e3</code> returns both rows</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>In the first query, the search returns the same results as when the <code><em>=</em></code> operator is implemented as "equals." However, the second query shows that the <code><em>=</em></code> operator is really implemented to return any row in which the supplied value (<code>e3</code>) is "contained" within the supplied field (<code>ID</code>).</p></div>
<div class="paragraph"><p>You can also leverage the <code><em>&amp;</em></code> reserved character in HTTP queries to implement the "AND" search condition. That means:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p><code>ID=3e&amp;NAME=Mi</code> would return only the second row from the preceding table.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The <a href="https://oreil.ly/POh1U">URI specification</a> indicates that the query portion of the URI is defined as case-sensitive (e.g., X=m is not the same query as x=M). However, in most implementations that I encounter, the query portion is implemented as case-insensitive. I recommend only implementing case-sensitive searches where absolutely necessary, and when doing so, you make this implementation detail easily discovered to reduce confusion and frustration for your API users.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Implementing your HTTP search support  using name/value pairs with <code><em>=</em></code> operation supporting "contains" and the <code><em>&amp;</em></code> supporting "AND" is the simplest IRQL you can implement for your HTTP APIs, and in my experience is often the only one you need. For more on URI query syntax, check out the related <a href="https://oreil.ly/lG9mx">IETF specification</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_example_46">6.4.3. Example</h4>
<div class="paragraph"><p>Most hypermedia formats support some version of query forms. Here are some snippets of representations using the data properties in the preceding table.</p></div>
<div class="paragraph"><p>HTML support IRQL using FORMS:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&lt;form method="GET" action="http://api.example.org/persons/" rel="search"&gt;
  &lt;input name="ID" value="e3" /&gt;
  &lt;input name="NAME" value="" /&gt;
  &lt;input name="CITY" value="Mo" /&gt;
  &lt;input type="submit" /&gt;
&lt;/form&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Which would be serialized as the following HTTP request:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /persons/?ID=e3&amp;NAME=&amp;CITY=Mo HTTP/1.1
Host: api.example.org
...</code></pre>
</div></div>
<div class="paragraph"><p>Note that all three fields in the form are converted to name/value pairs in the URL, even the field (NAME) with no search value. Be sure to account for this in your interface implementation. For example, you might not pass this name to the search service unless you are sure the search service ignores empty values.</p></div>
<div class="paragraph"><p>Here&#8217;s how the same query looks using the Collection+JSON format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Persons</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "item": <span style="color: #990000">[</span>...<span style="color: #990000">]</span>.
  "queries": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">search</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">http://api.example.org/persons/</span>"<span style="color: #990000">,</span>
      "data": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">ID</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">e3</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">NAME</span>"<span style="color: #990000">,</span> "value": ""<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">CITY</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mo</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "template" : <span style="color: #990000">{</span>...<span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>The Collection+JSON example here would result in the same HTTP <code>GET</code> request shown in the previous HTML example.</p></div>
<div class="paragraph"><p>As a final example, the HAL media type does not support inline forms but it does support <a href="https://oreil.ly/WOELi">inline URI templates</a>. Here is an example of the same query as a HAL link template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "_links": <span style="color: #990000">{</span>
    "search": <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">http://api.example.org/persons{?ID,NAME,CITY}</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that, while HAL supports URI templates, these templates do not support including the values inline.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_48">6.4.4. Discussion</h4>
<div class="paragraph"><p>Technically, any string value in the URL between the <code>?</code> and the <code>#</code> (or the end of the URL) is considered the query portion of the URL. You are free to insert any content there you wish. However (again), if you create your own query syntax, you&#8217;ll need to make sure your API clients understand this syntax before they attempt to create and submit a query. I recommend against creating a new query string format.</p></div>
<div class="paragraph"><p>It is valid to include the same <code>name</code> in a name/value pair multiple times in the same query:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>?city=northville&amp;city=southland</code></pre>
</div></div>
<div class="paragraph"><p>Be sure to take this into account when you implement query support in your API.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Creative Queries</div>
<div class="paragraph"><p>There are lots of creative ways to use the HTTP query string to support IRQL features. I&#8217;ve stuck to the simplest support here since that is often sufficient. It is also the one most commonly understood by HTTP client applications. Implementing other operators (not-equals, less-than, greater-than, etc.) is certainly possible. So is supporting features such as BETWEEN, LIKE, and so forth. However, the IETF has not established standards for expressing these in URIs and, if you really need them, you can move on to other query technologies, like Lucene, SQL, and others. See <a href="#data-formats">[data-formats]</a> for more on this topic.</p></div>
</div></div>
<div class="paragraph"><p>A common (anti)pattern for implementing IRQL requests over HTTP is to include a single URI query string property (e.g., <code>?q=</code> or <code>?query=</code>) followed by a custom data query. Typically, it looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /?query=select * from users where id='q1w2e3r4'</code></pre>
</div></div>
<div class="paragraph"><p>Or sometimes the query value is URL encoded:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /?query=select%20%2A%20from%20users%20where%20id%3D%27q1w2e3r4%27</code></pre>
</div></div>
<div class="paragraph"><p>In both cases, you&#8217;re basically smuggling a data query as part of the URL. This is usually a bad idea. Lots of things can (eventually) go wrong:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
The query is too long.
</dt>
<dd>
<p>
The length of the query gets so long it may be truncated by some server or gateway along the way.
</p>
</dd>
<dt class="hdlist1">
The query contains reserved characters.
</dt>
<dd>
<p>
The query content may include a <a href="https://oreil.ly/NTNnw">reserved URI character</a>, which invalidates the request.
</p>
</dd>
<dt class="hdlist1">
URL encoding introduces errors.
</dt>
<dd>
<p>
Encoding the query can result in the service behind the API to misunderstand the query, returning unexpected results.
</p>
</dd>
<dt class="hdlist1">
The query exposes a security problem.
</dt>
<dd>
<p>
If you are using an exact data query (e.g., SQL statement), you&#8217;re creating an opening for others to exploit a potential security hole, resulting in data theft or damage.
</p>
</dd>
<dt class="hdlist1">
The query introduces tight coupling.
</dt>
<dd>
<p>
By exposing a direct query tied to the data storage model (e.g., SQL, OData, etc.), you&#8217;re creating a tight coupling between the data model and the API. For <span class=".keep-together">example</span>, changes to the data model (adding/removing/renaming fields) can break the API.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_see_also_48">6.4.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-forms">[clients-forms]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-response">[data-response]</a>
</p>
</li>
<li>
<p>
<a href="#data-limits">[data-limits]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-metadata">6.5. Returning Metadata for Query Responses</h3>
<div class="paragraph"><p>It is a good practice to return more than just the query <em>results</em> when returning data-centric HTTP responses. You can include information that helps API consumers better evaluate the quality of the response as well as determine if the query needs to be modified and resubmitted to get the desired results.</p></div>
<div class="sect3">
<h4 id="_problem_48">6.5.1. Problem</h4>
<div class="paragraph"><p>What&#8217;s the best way to represent HTTP IRQL results? What types of metadata should be considered when returning the results of a data-centric HTTP query? How should that metadata be represented in the query response?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_48">6.5.2. Solution</h4>
<div class="paragraph"><p>For most data queries, it is not enough to just return the resulting data. It can also be important to return metadata about the query to help client applications that made the request better understand the quality and usefulness of the returned data. In this section, we show a set of metadata values that should be considered as part of the response representation for HTTP queries (see <a href="#fig0603">[fig0603]</a>).</p></div>
<div class="imageblock" id="fig0603">
<div class="content">
<img src="images/rwcb_0603.png" alt="images/rwcb_0603.png" width="80%" />
</div>
<div class="title">Figure 14. Query metadata recipe</div>
</div>
<div class="paragraph"><p>How you deliver these metadata values depends on the number of properties you are returning. If a small set of these values is returned, you can include the values in the body of the response. If there are just a couple values to be returned, you can include them with the actual data response as additional data properties. If there are several relevant metadata values, you can return an HTTP link (either in the body or the header collection) that points to a resource that contains all the query metadata. You can also implement a mix of both. See the "Examples" section for details on how to return these values:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Query status (<code>q-status</code>)
</dt>
<dd>
<p>
This is a simple description of the status of the requested query. Usually this response would be "completed successfully," but if the query was malformed, timed out, or in some other way halted, this string can contain details on what occurred along with possible changes to the query in order to complete successfully. Note that this is not the same as the "error" status of an unsuccessful HTTP request (aka an HTTP 400 response). See <a href="#data-response">[data-response]</a> for details.
</p>
</dd>
<dt class="hdlist1">
Query sent (<code>q-sent</code>)
</dt>
<dd>
<p>
This is typically a copy of the HTTP query string or HTTP request body sent by the API client application to the service interface. This can be used to remind humans of the query that was sent as well as allow machines to validate that the service interface parsed the submitted query properly.
</p>
</dd>
<dt class="hdlist1">
Actual query executed (<code>q-executed</code>)
</dt>
<dd>
<p>
In some cases the service interface may modify the query information it received in order to submit that query to the data storage. For example, a simple HTTP name/value pair query might be converted into an SQL "SELECT&#8230;" statement. This property contains that resulting modified query. NOTE: this may introduce security problems (see the "Discussion" section).
</p>
</dd>
<dt class="hdlist1">
Number of returned records (<code>q-returned</code>)
</dt>
<dd>
<p>
The number of records returned in this response. This may be a subset of the total number of records matching the query criteria (see <code>q-count</code>). For example, the total records found might be 11,000, but the number of records returned in this response might be 1,000.
</p>
</dd>
<dt class="hdlist1">
Estimated size of the result set (<code>q-count</code>)
</dt>
<dd>
<p>
This holds the estimated total number of records selected in the query. For example, a query might result in thousands of selected records, but only the first 100 are returned to the client that initiated the request. If the estimated number is quite high, this may indicate the query is too general and needs to be adjusted (see "Query suggestions").
</p>
</dd>
<dt class="hdlist1">
Elapsed time for query execution (<code>q-seconds</code>)
</dt>
<dd>
<p>
This is the total time (in seconds) that it took for the service behind the interface to execute the query. This can be handy as a diagnostic value. For example, is the query service running slowly? Was this particular query "costly" in terms of resources?
</p>
</dd>
<dt class="hdlist1">
Date/time the query was executed (<code>q-datetime</code>)
</dt>
<dd>
<p>
You should always return the recorded date/time the query was executed. This is especially true if the query response will be cached for later review.
</p>
</dd>
<dt class="hdlist1">
Results relevance (<code>q-score</code>)
</dt>
<dd>
<p>
If available, it can be helpful to pass along any indication of the relevance of the query results that may be returned from the query engine. For example, Lucene supports returning the <a href="https://oreil.ly/Hqswl">"score" of the query</a> (usually at the document level). If there is any characterization of the "relevance" of a query, it can be handy to return it in the response metadata.
</p>
</dd>
<dt class="hdlist1">
Data source(s) (<code>q-source</code>)
</dt>
<dd>
<p>
In some cases, it might be handy to return the data sources that were used in fulfilling the query. This can be helpful for those who want to "tweak" the query to improve results. Note that this may introduce security and/or coupling problems; see the "Discussion" section for details.
</p>
</dd>
<dt class="hdlist1">
Query suggestions (<code>q-suggest</code>)
</dt>
<dd>
<p>
If the query returns too many records, or none at all, there might be suggestions you can return to help client applications improve the quality of their results. These might be suggestions to include or exclude certain fields, add/remove ranges, etc.
</p>
</dd>
<dt class="hdlist1">
Replay URL (<code>q-location</code>)
</dt>
<dd>
<p>
If the query is stored for later use by the interface or the underlying service, you can generate a unique URL that can make it easy to replay the same query. This replay might be just a return of the same result set or a repeated query using the same (stored) query parameters.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You don&#8217;t need to include all these data fields in your query metadata. Select the ones that make sense for each use case. For example, if the query was designed to return just one record (<code>?id=q1w2e3r4</code>), you might include just the date/time metadata.</p></div>
</div>
<div class="sect3">
<h4 id="_example_47">6.5.3. Example</h4>
<div class="paragraph"><p>When you want to return query metadata, you can use three possible locations:</p></div>
<div class="ulist"><ul>
<li>
<p>
The HTTP response header collection
</p>
</li>
<li>
<p>
The HTTP response body
</p>
</li>
<li>
<p>
A link to a separate HTTP resource that contains all the query metadata
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can also do a mix of all of these.</p></div>
<div class="paragraph"><p>You can pass the query metadata in the HTTP header collection:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ***
HTTP/1.1 /persons/?id=q1w2e3r4 200 OK
Q-Status: successful
Q-DateTime: 2024-12-12:00:12:0012TZ
...</code></pre>
</div></div>
<div class="paragraph"><p>You can also return query metadata as part of the HTTP response body:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ***
HTTP/1.1 /persons/?id=q1 200 OK
Content-Type: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Person</span>"<span style="color: #990000">,</span>
  "metadata" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-sent</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">?id=q1</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-datetime</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">2024-12-12:00:12:0012TZ</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-status</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">result set too large, query canceled</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-seconds</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">120</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-count</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">10000+</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">q-suggest</span>"<span style="color: #990000">,</span>
      "value": "<span style="color: #FF0000">reduce return set with additional query parameters</span>"<span style="color: #990000">},</span>
  <span style="color: #990000">]</span>
  ...
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>If the query metadata is extensive, or if you want to reduce the amount of information in the query response, you can include a link to the query metadata in the header and/or the body of the response representation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>HTTP/1.1 /persons/?id=q1 200 OK
Content-Type: text/html
Link: <span style="font-weight: bold"><span style="color: #0000FF">&lt;http:</span></span><span style="color: #FF0000">//</span><span style="color: #009900">api</span>.<span style="color: #009900">example</span>.<span style="color: #009900">org</span><span style="color: #FF0000">/queries/</span><span style="color: #009900">u7y6t5r4</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>;rel="query-metadata"
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Person&lt;/title
  &lt;meta name="query-metadata" href="http://api.example.org/queries/u7y6t5r4" /&gt;
  ...
  &lt;body&gt;
    &lt;a href="http://api.example.org/queries/u7y6t5r4"&gt;Query Metadata&lt;/a&gt;
    ...
  &lt;/body&gt;
&lt;/html&gt;</tt></pre></div></div>
<div class="paragraph"><p>In this example, the query metadata is returned when the client application follows the <code>query-metadata</code> link (<em>http://api.example.org/queries/u7y6t5r4</em>). Here is an example of a <code>query-metadata</code> response in HAL format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "_links": <span style="color: #990000">{</span>
    "self": <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">http://api.example.org/queries/u7y6t5r4</span>"<span style="color: #990000">},</span>
  <span style="color: #990000">},</span>
  "q-status": "<span style="color: #FF0000">success</span>"<span style="color: #990000">,</span>
  "q-sent": "<span style="color: #FF0000">?state=MN</span>"<span style="color: #990000">,</span>
  "q-executed": "<span style="color: #FF0000">SELECT * from persons where contains(state,'MN')</span>"<span style="color: #990000">,</span>
  "q-count": "<span style="color: #FF0000">750</span>"<span style="color: #990000">,</span>
  "q-seconds": "<span style="color: #FF0000">.5</span>"<span style="color: #990000">,</span>
  "q-datetime": "<span style="color: #FF0000">2024-12-12:12:12:12</span>"<span style="color: #990000">,</span>
  "q-score": "<span style="color: #FF0000">100%</span>"<span style="color: #990000">,</span>
  "q-source": "<span style="color: #FF0000">bigco.persons</span>"<span style="color: #990000">,</span>
  "q-suggest":  "<span style="color: #FF0000">none</span>"<span style="color: #990000">,</span>
  "q-location"<span style="color: #990000">,</span> "http://api.example.org/queries/t5y6r4u7"
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Of course, you can mix and match these options by including some basic data in the headers (e.g., <code>Q-DateTime</code>), some in the body (e.g., <code>q-status</code>, <code>q-count</code>, <code>q-suggest</code>, etc.), and all of the information in a separate <code>query-metadata</code> resource (via an HTTP link).</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_49">6.5.4. Discussion</h4>
<div class="paragraph"><p>Returning query metadata is a "mixed bag" of good and bad. Too much metadata—for example, actual query executed, query sources—can expose too much information about your services and data technology, creating security challenges and introducing the possibility of tight coupling. At the same time, having no metadata at all can result in inefficient queries, challenges responding to invalid (or malformed) requests, and generally make it hard for API consumers to easily and safely craft quality queries. You&#8217;ll need to use caution and experience to find the right balance in each unique case.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Are These Standard Metadata Properties?</div>
<div class="paragraph"><p>This recipe introduces a handful of query metadata properties (<code>q-status</code>, etc.). These are not standardized and are not registered header or link relation values. They are values I&#8217;ve used over the years for the projects I&#8217;ve worked on, and I&#8217;ve found them handy. It is possible you have some metadata values of your own, too. Feel free to use them (after documenting them properly using <a href="#design-profiles">[design-profiles]</a>) and share them with the wider community.</p></div>
</div></div>
<div class="paragraph"><p>Ultimately, it is the service <em>behind</em> the interface that is responsible for protecting itself against malformed or malicious queries. However, the service interface can often take on some of that responsibility, too. Remember that it is the <em>interface</em> that defines the limits of HTTP responses. You can (and should) adopt documented limits to query responses (record count, execution time, etc.). See <a href="#data-limits">[data-limits]</a> for more on this topic.</p></div>
<div class="paragraph"><p>The <code>q-location</code> metadata property is meant to hold a "quick link" to the query results. You can use this to recall a previously executed (and saved) query or as a way to re-execute the saved query parameters to get updated results.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Resist the temptation to load the query metadata with service-specific internal information (e.g., debugging, performance statistics, etc.). This kind of data <em>should not</em> be shared at the HTTP level with other services and API client applications. Limit the shared values in <code>query-metadata</code> to those that are directly related to the API consumer&#8217;s needs, not the underlying service&#8217;s needs.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Supporting a <code>query-metadata</code> resource link is a good idea if you have lots of query metadata and/or the query is used often (whether accessing an old result or generating a new one). For cases where you are using a simple HTTP name/value query to return a single record, this additional resource may not be very helpful.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_49">6.5.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#services-vocabulary-formats">[services-vocabulary-formats]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#services-errors">[services-errors]</a>
</p>
</li>
<li>
<p>
<a href="#data-response">[data-response]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-progress">[workflow-progress]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-response">6.6. Returning HTTP 200 Versus HTTP 400 for <span class=".keep-together">Data-Centric Queries</span></h3>
<div class="paragraph"><p>When implementing data-centric APIs, there will be some cases where the response body contains no records. In these cases, it is important to return the proper HTTP status code: the one that accurately communicates the meaning behind the empty collection in the response.</p></div>
<div class="sect3">
<h4 id="_problem_49">6.6.1. Problem</h4>
<div class="paragraph"><p>When returning an HTTP response to a data-centric request, what is the proper HTTP status code to use when the response collection is empty?  Should the response always be <code>200 OK</code>? Or always be a 404 or some other 4xx status code? How do you decide which class of status codes to return, and what is the best way to handle "empty" responses to data-centric HTTP requests?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_49">6.6.2. Solution</h4>
<div class="paragraph"><p>Like any other HTTP request, the HTTP status code is an important way to indicate the condition of the response that was returned. And, even when the HTTP request is essentially a data query, the same rule applies. If the request was properly formatted and the server was able to parse and process the response, the HTTP status code should be in the 2xx class. However, if the server was unable to fulfill, understand, or process the request due to errors either in the requests or in the service tasked with fulfilling that request, the HTTP status should be either 4xx (due to a client-side problem) or 5xx (due to a service-side problem).</p></div>
<div class="paragraph"><p>There are some minor variations on this general rule. See the following list for details:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>200 OK</code>
</dt>
<dd>
<p>
If the request was well-formed, and was meant to return a collection of records that meet a filter rule (e.g., <code>/persons/?status=pending</code>), and the result of fulfilling the request is an empty collection (e.g., the service can find no records that match the search criteria), the HTTP status should be <code>200 OK</code>.
</p>
</dd>
<dt class="hdlist1">
<code>404 Not Found</code>
</dt>
<dd>
<p>
If the request is meant to return a single, existing resource (e.g., <code>/persons/?id=q1w2e3</code>) and that URL points to a resource that <em>does not exist</em>, then the API should return an HTTP <code>404 Not Found</code> status code with details.
</p>
</dd>
<dt class="hdlist1">
<code>4xx Bad Request</code>
</dt>
<dd>
<p>
If the client application has made an invalid request (e.g., a bad URL, improperly formed data query, etc.), then the API should return a <code>400 Invalid Request</code> response (along with details on how to correct the problem).
</p>
</dd>
<dt class="hdlist1">
<code>5xx Server Error</code>
</dt>
<dd>
<p>
If the client request was correct but the underlying service is unable to fulfill the request due to a server-side problem (e.g., unable to reach the data store, network failures, etc.), then the API should return a <code>5xx</code> class status code with details.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Using URL query strings to return a single resource is a weak design pattern that should be avoided. Instead of using <code>persons/?id=q1w2e3</code> to return an existing HTTP resource, a better design choice would be <code>/persons/q1w2e3</code>.</p></div>
<div class="paragraph"><p>Of course, we don&#8217;t always get to choose our URL designs; we sometimes need to learn to work with URLs designed by other people for services we do not control.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In general, return <code>200 OK</code> with an empty collection for any well-formed queries. Reserve 4xx and 5xx status codes for cases where the client or service encounters an error. The single-resource query that returns 404 is the exception to this rule.</p></div>
</div>
<div class="sect3">
<h4 id="_example_48">6.6.3. Example</h4>
<div class="paragraph"><p>There are four common cases to deal with when determining the proper HTTP status code for "empty" responses to a data-centric query.</p></div>
<div class="sect4 xxx">
<h5 id="_return_200_ok_when_the_filter_criteria_results_in_an_empty_collection">6.6.3.1. Return 200 OK when the filter criteria results in an empty collection</h5>
<div class="paragraph"><p>When returning an empty collection in response to a data-centric HTTP request, you should use the <code>200 OK</code> status along with some metadata about the query (see <a href="#data-metadata">[data-metadata]</a> for details):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/?status=pending HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json
...

**** RESPONSE ***
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Persons</span>"<span style="color: #990000">,</span>
  "metadata": <span style="color: #990000">[</span>
    "name": "<span style="color: #FF0000">q-status</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">success</span>"<span style="color: #990000">,</span>
    "name": "<span style="color: #FF0000">q-sent</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">?status=pending</span>"<span style="color: #990000">,</span>
    "name": "<span style="color: #FF0000">q-count</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">0</span>"
  <span style="color: #990000">],</span>
  "items": <span style="color: #990000">[]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Note the query metadata (see <a href="#data-metadata">[data-metadata]</a>) in the response body. Adding this kind of information in the response can clarify the meaning of the "empty collection" that was returned.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_return_404_when_the_query_string_points_to_a_resource_that_does_not_exist">6.6.3.2. Return 404 when the query string points to a resource that does not exist</h5>
<div class="paragraph"><p>When using the URL query string to locate an existing resource, you should return HTTP status <code>404 Not Found</code> to indicate that the requested HTTP resource does not exist:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
GET /persons/?id=q1w2e3 HTTP/1.1
Accept: text/html
...

**** RESPONSE ****
HTTP/1.1 404 Not Found
Content-Type: text/html
...

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Not Found<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Not Found<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"error"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      Unable to locate the requested resource
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"q-sent"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>?id=q1w2e3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Remember that this use of HTTP 404 is limited to cases where the URL plus query is <em>designed</em> to return a single resource instead of a collection of data rows or resources.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_return_4xx_when_the_client_application_has_sent_an_invalid_request">6.6.3.3. Return 4xx when the client application has sent an invalid request</h5>
<div class="paragraph"><p>In cases where the client application has sent an invalid request, you should return the appropriate 4xx status code with hints on how the client can fix the problem:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/?hatsize=13 HTTP/1.1
Accept: application/vnd.collection+json
...

**** RESPONSE ****
HTTP/1.1 400 Bad Request
Content-Type: application/vnd.collection+json
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Persons List</span>"<span style="color: #990000">,</span>
  "error": <span style="color: #990000">{</span>
    "title": "<span style="color: #FF0000">Data Filter Error</span>"<span style="color: #990000">,</span>
    "message": "<span style="color: #FF0000">The data property 'hatsize' does not exist</span>"
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that in this example, the request is not malformed at the HTTP level. Instead, the data service cannot process the request since the data in the query is invalid. Of course, there may be cases where the HTTP request itself is invalid, which will result in a 4xx response.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_return_5xx_when_the_service_cannot_fulfill_a_valid_request">6.6.3.4. Return 5xx when the service cannot fulfill a valid request</h5>
<div class="paragraph"><p>There will be cases where the client sends a valid query but the underlying service is unable to properly fulfill the request. For example, the service interface cannot reach the source data or the underlying data request take too long to process, etc. In these cases, the API should return the proper 5xx class status code along with information on the state of the service interface:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/?status=active HTTP/1.1
Accept: application/vnd.hal+json
...

**** RESPONSE ****
HTTP/1.1 504 Gateway Timeout
Content-Type: application/problem+json
....</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "type": "<span style="color: #FF0000">https://api.example.org/problems/time-out</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">Data query timed out.</span>"<span style="color: #990000">,</span>
  "detail": "<span style="color: #FF0000">The remote data storage took too long to reply.</span>"<span style="color: #990000">,</span>
  "instance": "<span style="color: #FF0000">/persons/?status=active</span>"<span style="color: #990000">,</span>
  "q-status": "<span style="color: #FF0000">failed</span>"<span style="color: #990000">,</span>
  "q-seconds": "<span style="color: #FF0000">120</span>"<span style="color: #990000">,</span>
  "q-suggest": "<span style="color: #FF0000">Try again later.</span>"
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Note the use of the HTTP problem details media type (see <a href="#services-errors">[services-errors]</a>) along with query metadata (see <a href="#data-metadata">[data-metadata]</a>) to improve the quality of information returned to the client application.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_50">6.6.4. Discussion</h4>
<div class="paragraph"><p>When attempting to decide whether to use 200 or 4xx for data-centric responses, be sure to take into account whether the request is designed to return <em>collections</em> or designed to return a <em>single resource</em>. In the first case, an empty response is "OK." In the single resource case, an empty response means the resource was <em>not found.</em></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Returning 4xx and 5xx responses in your service interfaces may result in exposing internal details of your network or services. When crafting HTTP error responses, always be careful not to reveal too many details on where (and how) your data is stored.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In some cases, your API might be calling other service interfaces that do not follow this recipe. For example, a service might return 404 when the collection query results in zero rows returned. Whenever possible, <em>do not</em> echo this behavior back to your own API clients. Instead, modify the return you pass on to downstream clients to follow the "200 OK" rule. This will result in a more consistent and reliable interface for your APIs.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_50">6.6.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#services-errors">[services-errors]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-formats">6.7. Using Media Types for Data Queries</h3>
<div class="paragraph"><p>Implementing data query support for your service interfaces can be challenging because you&#8217;re often forced into selecting—and exposing as part of your interface—a single data technology (SQL, GraphQL, Lucene, etc.). This runs counter to the notion of creating loosely coupled APIs that hide the underlying implementation details.</p></div>
<div class="paragraph"><p>One alternative is to create your own local data query language; one that is not tied to a single data technology. However, doing this can lead you into creating and maintaining a complete data language, which can result in a new, tight coupling. While this seems easy at first, it can become impractical at scale.</p></div>
<div class="paragraph"><p>This recipe offers a way to decouple data technology from your interface while still taking advantage of powerful established data query languages.</p></div>
<div class="sect3">
<h4 id="_problem_50">6.7.1. Problem</h4>
<div class="paragraph"><p>What&#8217;s the best way to implement data query support for a service interface? Do you need to select one of the existing query languages (SQL, GraphQL, Lucene, etc.)? Or do you invent your own data query language that is not tied to a single backend technology? How can you support more than one query language for the same service interface? Is there a way to support well-known data query languages without locking your API into a single tightly coupled backend service? What happens when that backend service changes in the future (e.g., migrates from SQL to GraphQL)?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_50">6.7.2. Solution</h4>
<div class="paragraph"><p>Balancing the desire for loosely coupled implementations for your APIs against the power of embracing a well-known data query language like SQL or GraphQL can be a challenge. There is a rather simple solution that I have found helpful. However, I rarely see it employed by others. That solution is to implement your data query language support over HTTP as a <em>media type</em>. Elsewhere in this book, I&#8217;ve discussed the power of using registered media types (RMTs) (see <a href="#design-media-types">[design-media-types]</a>) and semantic profile documents (SPDs) (see <a href="#design-profiles">[design-profiles]</a>), as well as the advantage of supporting content negotiation (see <a href="#services-conneg">[services-conneg]</a>). The same principles can be applied to supporting negotiable data query languages, too.</p></div>
<div class="paragraph"><p>The first step is to adopt the policy of using media type definitions for data query languages. This has already been done for the SQL format with <a href="https://oreil.ly/MFkwv">RFC 6922</a>. That specification documents the <code>application/sql</code> media type as a way to submit SQL queries over HTTP (see the "Example" section).</p></div>
<div class="paragraph"><p>Although not officially registered, I&#8217;ve used the same technique to support other query languages for my APIs, including:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>application/prs.solr+json</em> for <a href="https://oreil.ly/IE1CE">Solr</a>
</p>
</li>
<li>
<p>
<em>application/prs.odata+json</em> for <a href="https://oreil.ly/uiQ5e">OData</a>
</p>
</li>
<li>
<p>
<em>application/prs.graphql+json</em> for <a href="https://oreil.ly/3dN9f">GraphQL</a>
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>As of the writing of this book, there are no registered media types in the IANA registry for Solr, OData, and GraphQL. I use an unregistered media type identifier that contains the <a href="https://oreil.ly/YMMQQ"><code>prs.</code> prefix</a> (indicating a "personal" or "vanity" registration). Be sure to monitor the IANA Media Type Registry to learn when these and other data query languages register their official media type identifiers.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The key to making this recipe work is to leverage HTTP request bodies to send the data query. For example, the API client can craft a valid query using the designated language (SQL, OData, etc.). That message becomes the body in an HTTP <code>POST</code> or <code>PUT</code> request (see <a href="#services-idempotent-create">[services-idempotent-create]</a>) sent to the service interface. The API accepts the request and then, if needed, converts that into a form usable by the underlying data engine and executes the query, returning the results to the API caller.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Using <code>PUT</code>/<code>POST</code> to submit data queries means it&#8217;s possible to easily store and replay those same queries in the future. See <a href="#workflow-replays">[workflow-replays]</a> for a recipe that shows you how to do this.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>By converting your data query requests to media type requests, you also get to take advantage of HTTP content negotiation (see <a href="#services-conneg">[services-conneg]</a>). You can include supported data query media types in your service metadata (see <a href="#services-metadata">[services-metadata]</a>) and list the media type strings in your client preferences responses (see <a href="#services-preferences">[services-preferences]</a>).</p></div>
</div>
<div class="sect3">
<h4 id="_example_49">6.7.3. Example</h4>
<div class="paragraph"><p>Here&#8217;s the HTTP exchange for submitting as data query using SQL:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>**** REQUEST ****
PUT /person/queries/q1w2e3r4 HTTP/1.1
Host: api.example.org
If-None-Match: *
Content-Type: application/sql
Accept: text/html
...

SELECT id,name,city FROM persons where city LIKE '%ville%'

**** RESPONSE ****
HTTP/1.1 301 Moved Permanently
Location: http://api.example.org/person/results/p0o9i8u7

**** REQUEST ****
GET person/queries/p0o9i8u7 HTTP/1.1
Accept: text/html

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: text/html
ETag: "w/o9p0i8y6"
...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Persons<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">query-metadata</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"q-status"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>success<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"q-sent"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        SELECT id,name,city FROM persons where city LIKE '%ville%'
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"results"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      ...
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that the query was sent using the <code>application/sql</code> content type to communicate to the service interface which query engine to use for this request. You can also see the use of query metadata (see <a href="#data-metadata">[data-metadata]</a>) in the response. See <a href="#services-idempotent-create">[services-idempotent-create]</a> for details on how to use <code>PUT</code> to create new resources instead of <code>POST</code>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Two Resources Are Better than One</div>
<div class="paragraph"><p>In all the examples in this recipe, the <code>PUT</code> request used to create a new resource <span class=".keep-together">(<code>/person/queries/q1w2e3r4</code>)</span> creates a <em>data query</em> resource and then uses that data query resource to create the <em>data results</em> resource (<code>person/results/p0o9i8u7</code>). These are two separate resources. One holds the query. The other holds the results. The results resource can be called to return the static results from the data query. The query resource can be used to rerun the query against the data source and retrieve a new result set (and possibly a new URL). For more on this, see <a href="#workflow-replays">[workflow-replays]</a>.</p></div>
</div></div>
<div class="paragraph"><p>If the interface supports it, the same query could be crafted using Solr:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /person/queries/q1w2e3r4 HTTP/1.1
Host: api.example.org
If-None-Match: *
Content-Type: application/prs.solr
Accept: text/html
...

fl=id name city
city:ville</code></pre>
</div></div>
<div class="paragraph pagebreak-before less_space"><p>Or maybe an OData query:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /person/queries/q1w2e3r4 HTTP/1.1
Host: api.example.org
If-None-Match: *
Content-Type: application/prs.odata
Accept: text/html
...

$select=id, name, city
$filter=contains(city,'ville')</code></pre>
</div></div>
<div class="paragraph"><p>OData has its own rules for how to craft queries for use in HTTP <code>POST</code> and <code>GET</code> requests. It should be noted that, as of OData 4.1, the rules have changed significantly, too. I have adopted this format (which is slightly easier to read than the current version) and, depending on what version the backend OData engine is running, will rewrite the query to be compliant with the engine. Adopting this, or a similar approach, can keep your service interface stable, even when the backend query engine changes over time.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>I found this article <a href="https://oreil.ly/sBPaa">by John Gathogo</a> covering the use of OData over HTTP very helpful.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For one more example, here&#8217;s the same request crafted for the GraphQL query engine:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /person/queries/q1w2e3r4 HTTP/1.1
Host: api.example.org
If-None-Match: *
Content-Type: application/prs.graphql
Accept: text/html
...

{
  person(city: {regex: "/ville/"}) {
    id
    name
    city
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>Like the OData query engine, GraphQL has its own rules for sending data queries via HTTP <code>POST</code> and <code>GET</code>. Be sure to check the documentation and, if needed, insert a rewrite step to convert the <code>application/prs.graphql</code> message to one acceptable to the GraphQL engine.</p></div>
<div class="paragraph"><p>The thing to keep in mind for this recipe is that your goal is to create a stable, decoupled way to submit technology-specific data queries.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_51">6.7.4. Discussion</h4>
<div class="paragraph"><p>Communicating data queries via a media type encapsulates the data technology to a strongly typed message format. It also makes it possible to implement multiple data query languages for the same data store without making changes to the interface. That means you can implement support for <code>application/sql</code> when you first release the API and, if needed, you can also safely add support for Solr or GraphQL at some future date.</p></div>
<div class="paragraph"><p>It bears repeating that the recipe shown here uses <code>PUT</code> to create a new resource, not <code>POST</code>. However, the underlying service <em>may</em> need to use <code>POST</code> against, for example, a GraphQL or OData query. Or it might use <code>GET</code> for Solr, for example.  The <code>PUT</code> method used here is just for our service interface and is independent of any HTTP request made to backend services.</p></div>
<div class="paragraph"><p>It might seem better to just adopt the HTTP conventions of the data engine directly and <em>not</em> introduce an additional media type implementation for your data query support. This is fine as long as you don&#8217;t plan on changing your query engine in the future and you don&#8217;t plan to honor any breaking changes the query engine makes in the coming years. Even though there is some up-front cost (establishing a media type string, setting up an HTTP <code>PUT</code>/<code>POST</code> endpoint, implementing a rewriter, etc.), adopting this recipe can pay off over time.</p></div>
<div class="paragraph"><p>The <a href="https://oreil.ly/Jp3Mr">SPARQL query language</a> was designed to be used over HTTP. Since it already has its own set of associated media types, supporting SPARQL fits well into this recipe.</p></div>
<div class="paragraph"><p>It should be noted that there is no rule that requires the SQL query language to be applied only to SQL-based storage. It is certainly possible to maintain support for SQL queries after you have converted all your SQL databases to file-based storage. The key is to treat the query language as a separate layer in your interface implementation. That way, if needed, you can change backend storage without changing the service interface.</p></div>
<div class="paragraph"><p>Be careful to not fall into the trap of designing your own data query language. Unless you plan on creating your own unique data engine, it is better to use this media type pattern to create a kind of interoperability between data services and query languages. This offers lots of possibilities without introducing a new language that you may not have the resources to support over time.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_51">6.7.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-media-types">[design-media-types]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#services-conneg">[services-conneg]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-ignore">6.8. Ignoring Unknown Data Fields</h3>
<div class="paragraph"><p>Sometimes the data messages being exchanged have more data properties than expected or desired. In those cases, it is a good idea to just ignore the "additional" data properties and continue to process the parts of the message you are interested in.</p></div>
<div class="sect3">
<h4 id="_problem_51">6.8.1. Problem</h4>
<div class="paragraph"><p>There will be times when the data messages exchanged between services contain more data properties than the API consumer wants. For example, a service designed to manage email addresses may be talking to a data service that returns complete addresses for physical and electronic delivery. What is the best way for the consuming service to ensure data integrity when it only reads/writes the properties it knows about? Does the consuming service only return the properties that were modified? Or does it return all fields, even ones it does not understand?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_51">6.8.2. Solution</h4>
<div class="paragraph"><p>When reading and then updating a data record from another service, you should always exchange the <em>complete</em> data record, even when that record contains fields you did not edit and/or don&#8217;t understand. This is true when you are updating the record yourself and returning it to the source. It is also true when you are forwarding the data record to another service for processing and supporting updates from the forwarding service.</p></div>
<div class="paragraph"><p>In general, it is not a good idea to strip data from an incoming data message if you (or some other service you are passing the data from) also support <em>writing</em> that data back to the source. For example, attempting to write partial values to a data store can lead to cases where the updated values are not compatible with the unedited values. That means that the stored data loses integrity, or the write is rejected. Both results diminish the reliability of your service.</p></div>
<div class="paragraph pagebreak-before less_space"><p>At the heart of this solution is what is loosely referred to as the "Must Ignore" rule. When receiving a message from another party, just ignore the parts of the message you don&#8217;t understand. Operate on the parts you were designed to understand, and return the entire block if you are attempting an update.</p></div>
</div>
<div class="sect3">
<h4 id="_example_50">6.8.3. Example</h4>
<div class="paragraph"><p>Consider the case shown in <a href="#fig0604">[fig0604]</a> where you create an interface that supports reading/writing email addresses for users (<code>emailUpdater</code>).</p></div>
<div class="imageblock" id="fig0604">
<div class="content">
<img src="images/rwcb_0604.png" alt="images/rwcb_0604.png" width="80%" />
</div>
<div class="title">Figure 15. Email updater</div>
</div>
<div class="paragraph"><p>However, it turns out your interface gets its source data from another service (<code>addressManager</code>) that holds lots of information about email and physical delivery addresses for users (<a href="#fig0605">[fig0605]</a>).</p></div>
<div class="imageblock" id="fig0605">
<div class="content">
<img src="images/rwcb_0605.png" alt="images/rwcb_0605.png" width="80%" />
</div>
<div class="title">Figure 16. ALPS document for the address manager API</div>
</div>
<div class="paragraph"><p>When requested, the <code>emailUpdater</code>  gets the record identifier from the API caller (<code>GET</code> <a href="http://api.emailupdater.org/q1w2e3r4">http://api.emailupdater.org/q1w2e3r4</a>) and uses that to make a call to the <code>address&#x200b;Ma&#x2060;nanger</code>, which returns the following  message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /q1w2e3r4 HTTP/1.1
Host: api.addressManager.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Content-Length: XX
ETag: "w\u7y6t5r4"</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title" : "<span style="color: #FF0000">Address Manager</span>"<span style="color: #990000">,</span>
  "links" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "items" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">http://api.addressmanager.org/q1w2e3r4</span>"<span style="color: #990000">,</span>
      "rel" : "<span style="color: #FF0000">address</span>"<span style="color: #990000">,</span>
      "data" : <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">name</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork Mickelson</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">city</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">state</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">email</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">mork@example.org</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "template": <span style="color: #990000">{</span>...<span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Next, the <code>emailUpdater</code> modifies the email as requested and returns the <em>complete</em> address record to <code>addressManager</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /q1w2e3r4 HTTP/1.1
Host: api.addressManager.org
Accept: application/vnd.collection+json
Content-Type: application/vnd.collection+json
If-Match: "w\u7y6t5r4"
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"template": <span style="color: #990000">{</span>
  "data": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">name</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork Mickelson</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">city</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">state</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">email</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">mickle@example.org</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Content-Length: XX
ETag: "w\i8u7y6t5"</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title" : "<span style="color: #FF0000">Address Manager</span>"<span style="color: #990000">,</span>
  "links" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "items" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"href": "<span style="color: #FF0000">http://api.addressmanager.org/q1w2e3r4</span>"<span style="color: #990000">,</span>
      "rel" : "<span style="color: #FF0000">address</span>"<span style="color: #990000">,</span>
      "data" : <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">name</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork Mickelson</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">city</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">state</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">email</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">mickle@example.org</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "template": <span style="color: #990000">{</span>...<span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, imagine that—at some future point—the <code>addressManager</code> adds some new data properties to its messages (e.g., <code>telephone</code> and <code>sms</code>). The <code>emailUpdater</code> can continue to do the same task of modifying the one field it knows about and simply passing back <em>all</em> the fields it was returned. In this way, the service behind the <code>emailUpdater</code> interface does not need to be modified each time a new field is added by the <code>addressManager</code> service.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_52">6.8.4. Discussion</h4>
<div class="paragraph"><p>The idea of ignoring elements of a message is a handy way to add resilience to services and APIs that interact with other interfaces. When you are working with other service interfaces that you do not control, you can&#8217;t be sure of what is going on behind the scenes. You only know what the interface promises. Over time it is possible that the interface will change and, as long as it doesn&#8217;t change the promises you count on, adding/removing fields or actions outside the scope of your needs is of no real interest to you.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">The "Must Ignore" Rule</div>
<div class="paragraph"><p>This pattern of passing along any fields you don&#8217;t understand instead of removing them is a key element in supporting future compatibility for services and interfaces. The web itself was built with this assumption in mind, too. A good document for reading more about what is loosely called the "Must Ignore" rule can be found in the document "Extending and Versioning Languages Part 1" from the <a href="https://oreil.ly/cLnAV">W3C website</a>.</p></div>
</div></div>
<div class="paragraph"><p>This recipe depends on the ability of a service to recognize and use hypermedia forms in responses. Like all service interfaces, data services should return hypermedia-rich messages (see <a href="#design-hypermedia">[design-hypermedia]</a> and <a href="#clients-hypermedia">[clients-hypermedia]</a>) that include instruction on how callers can execute additional actions. If you are using a return format that does not support hypermedia (e.g., HAL, CSV, plain JSON, etc.), then you should return a pointer to another document that contains action descriptions (e.g., HAL-FORMS, XML/JSON Schema, ALPS, etc.).</p></div>
<div class="paragraph"><p>This recipe is closely related to <a href="#data-proxy">[data-proxy]</a> (about pass-through proxies). In fact, you can see this recipe as advice for API consumers that might be talking to an interface that is acting (behind the scenes) as a data proxy. Of course, your service will never actually <em>know</em> if it is talking to a data proxy. Your service will just know that it is talking to a service interface that is fulfilling action promises.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_52">6.8.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#clients-incoming">[clients-incoming]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-proxy">[data-proxy]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-caching">6.9. Improving Performance with Caching Directives</h3>
<div class="paragraph"><p>HTTP has a rich caching model built into the protocol. For data-centric services, this caching model can improve perceived performance and reduce latency—all without much effort.</p></div>
<div class="sect3">
<h4 id="_problem_52">6.9.1. Problem</h4>
<div class="paragraph"><p>When the service depends on remote data sources, it can lead to perceived poor performance due to slow networks and, at times, network-related failures. How can you improve the perceived performance of your service even when you depend on remote data-centric services that you do not control? How can the HTTP caching model be used on both the service and client side to improve reliability and availability of runtime services?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_52">6.9.2. Solution</h4>
<div class="paragraph"><p>When your service interface relies on other, remote, services for data, the easiest way to improve perceived performance is by leveraging the HTTP caching models built into the protocol. That means service providers need to mark every response with caching metadata to help consumers understand the lifetime of the response. This also means service consumers need to check for, and honor, the caching metadata in order to improve the quality of API responses.</p></div>
<div class="sidebarblock less_space">
<div class="content">
<div class="title">Keep Your Data Close</div>
<div class="paragraph"><p>Caches can be kept on the provider&#8217;s machine, a third-party Content Delivery Network (CDN) machine, or even on the API consumer&#8217;s machine. The closer the cache is to the client, the faster the perceived speed of your service.</p></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For a better understanding of the HTTP caching model, see the HTTP specifications for <a href="https://oreil.ly/E6Z6E">caching in RFC 7234</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In this recipe, I&#8217;ll only be covering the caching model metadata for HTTP 1.1 and later. Caching directives are also sprinkled throughout the HTTP header collection that work for HTTP 1.0 services: <code>Age</code>, <code>Expires</code>, and <code>Pragma</code>. See the HTTP caching specification for details.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For a full list of caching directives, see the <a href="https://oreil.ly/qk3ab">HTTP Cache Directive Registry</a>.</p></div>
</td>
</tr></table>
</div>
<div class="sect4 xxx">
<h5 id="_response_caching_metadata_for_service_providers">6.9.2.1. Response caching metadata for service providers</h5>
<div class="paragraph"><p>Service providers can mark their responses with caching metadata. Typically, this means indicating the caching scope (<code>public</code> or <code>private</code>), the maximum length the response can be held (<code>max-age</code>), and how responses should be handled (<code>no-store</code>, <code>no-cache</code>, <code>must-revalidate</code>, etc.). This works well for responses that don&#8217;t change very often; for example, things like static lookup lists or written documentation that rarely changes.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If you are consuming a data-centric service API that does not use caching directives, try to encourage them to add caching support to their responses. This can be especially effective if you are in an enterprise setting where the data-centric services are authored and supported by another team within your company.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph pagebreak-before less_space"><p>For cases where the response contains information that might change frequently, you can use directives that tell API consumers to check back with the origin server before replaying cached responses. Service interface providers can return the <code>ETag</code> along with <code>Cache-Control: must-revalidate</code> to tell API consumers that they should craft conditional requests (<code>GET</code> or <code>PUT</code>/<code>DELETE</code>) by returning the value of the <code>ETag</code> in the <code>If-Match</code> header.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Immutable Caching</div>
<div class="paragraph"><p>A cache directive named <code>immutable</code> can be used to help API consumers better understand that the response has a long, dependable life. This is typically used for subresources like news photos accompanying text. Data-centric services can use this directive when returning long-lived responses like static lists, product images, etc. To learn more about how to use this directive, see <a href="https://oreil.ly/Nw1k9">RFC 8246</a>.</p></div>
</div></div>
<div class="paragraph"><p>This pattern also works well if service providers anticipate that API consumers will send updates (<code>PUT</code>/<code>POST</code>/<code>PATCH</code>/<code>DELETE</code>) for the same resource and want to make sure the action is not completed if the server&#8217;s version of the resource has already been modified.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_caching_metadata_for_api_consumers">6.9.2.2. Caching metadata for API consumers</h5>
<div class="paragraph"><p>When sending requests to a service interface, API consumers can use caching metadata to qualify the type of response that the consumer is willing to accept. For example, including the directive <code>Cache-Control: max-age=600, min-fresh=300</code> in an API request tells the provider that the consumer wants to make sure the response is no older than 10 minutes (<code>max-age=600</code>) and has at least another 5 minutes of "freshness" left (<code>min-fresh=300</code>).</p></div>
<div class="paragraph"><p>These kinds of caching directives make sense when the API consumer wants to be sure to get a response that can be held for a while in order to reduce "refresh churn" on the client side.</p></div>
<div class="paragraph"><p>API consumers can also use caching metadata in the request to force service interfaces to deliver a "brand-new" response by using the <code>Cache-Control: no-cache</code> directive. This is handy when the API consumer wants the most recent resource representation in order to, for example, edit that record.</p></div>
<div class="paragraph"><p>Clients can also use the <code>Cache-Control:max-stale, stale-if-error</code> directives to tell service interfaces it&#8217;s OK to return a "stale" copy of the resource if that is the only one available. This is a good idea when the API consumer wants to fulfill a read-only request (no editing anticipated) and would rather get an old response instead of having to report a 4xx or 5xx status.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_51">6.9.3. Example</h4>
<div class="paragraph"><p>What follows are examples of applying caching metadata to provider responses and client requests. There is also an extended example that walks through a scenario where both client and server are using caching metadata to improve both the responsiveness and quality of the interchange.</p></div>
<div class="sect4 xxx">
<h5 id="_example_provider_response_caching_metadata">6.9.3.1. Example provider response caching metadata</h5>
<div class="paragraph"><p>Here is a simple response with caching metadata added:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /provinces/list HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Content-Length: NN
Date: Tue, 15 Nov 2022 08:12:31 GMT
Cache-Control: public, max-age=600
...</code></pre>
</div></div>
<div class="paragraph"><p>This response caching metadata tells the API consumers that the response is cacheable by any proxy (<code>public</code>), and that it can be stored (and replayed) for up to 10 minutes following receipt of the response.</p></div>
<div class="paragraph"><p>The following shows how a service interface can provide caching metadata that instructs API consumers to craft conditional requests (<code>GET</code> or <code>PUT</code>/<code>DELETE</code>) using the HTTP entity tag header and the <code>must-revalidate</code> directive:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /user/q1w2e3r4 HTTP/1.1
Host: api.example.org
Accept: application/vnd.siren+json
...

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.siren+json
Content-Length: NN
ETag: "w/p0o9i8u7y6t5"
Date: Tue, 15 Apr 2022 11:12:13 GMT
Cache-Control: public, max-age=300, must-revalidate, stale-if-error
...</code></pre>
</div></div>
<div class="paragraph"><p>In this case, API consumers are told they can keep the current response for up to five minutes and, if asked for it, they first need to confirm with the backend server that both server and cache have the same version (via the <code>ETag</code> header) before returning the cached copy to the API consumer. Note the use of the <code>stale-if-error</code> directive, which tells the cache holder that, in cases where the validation request fails (e.g., a network error), it is OK to return this copy of the response, even if the "freshness date" has passed.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_consumer_request_caching_metadata">6.9.3.2. Consumer request caching metadata</h5>
<div class="paragraph"><p>The following is an example of an API request where the consumer wants to make sure the response is no older than 10 minutes (<code>max-age=600</code>) and has at least another 5 minutes of "freshness" left (<code>min-fresh=300</code>):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /users/list HTTP/1.1
Host: api.example.org
Accept: application/vnd.hal+json
Cache-Control: max-age=600, min-fresh=300</code></pre>
</div></div>
<div class="paragraph"><p>API consumers can also use caching directives in the request to force service interfaces to deliver a "brand-new" response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /users/q1w2e3r4 HTTP/1.1
Host: api.example.org
Accept: application/vnd.hal+json
Cache-Control: no-cache</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of an API consumer telling the service interface it is OK to send a "stale" copy of the resource if that is the only one available right now:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /users/q1w2e3r4 HTTP/1.1
Host: api.example.org
Accept: application/vnd.hal+json
Cache-Control: max-stale, stale-if-error</code></pre>
</div></div>
</div>
<div class="sect4 xxx">
<h5 id="_extended_caching_metadata_example">6.9.3.3. Extended caching metadata example</h5>
<div class="paragraph"><p>When service interfaces return caching metadata in HTTP responses, it is important that the API consumer honor those directives and use them as intended. For example, API providers might indicate the response can be locally cached for up to 10 minutes after receipt (<code>Cache-Control: max-age=600</code>). When true, the API consumer should save a copy of this response and replay that stored response whenever that resource is needed within the time window indicated.</p></div>
<div class="paragraph"><p>Consider a case where there is a service that keeps track of <code>customer</code> data and one that keeps track of <code>order</code> data. Your service returns an aggregation of those two data sources in the form of a <code>customer-order</code> read-only service. As the API consumer for <code>customer</code> and <code>order</code> APIs, you should honor the caching metadata returned by these services.</p></div>
<div class="paragraph pagebreak-before less_space"><p>Here&#8217;s the request for a single record from the <code>customer</code> service:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /customer/e3r4t5y6 HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json
Cache-control: no-cache

**** RESPONSE ****
HTTP/1.1 200 OK
Host: api.example.org
Content-Type: application/vnd.collection+json
Cache-Control: private, max-age=600, must-revalidate
ETag: "w/i8u7y6t5r4er3"</code></pre>
</div></div>
<div class="paragraph"><p>And here&#8217;s the request for related content from the <code>orders</code> service:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /orders/filter?customer=e3r4t5y6 HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json
Cache-control: max-stale

**** RESPONSE ****
HTTP/1.1 200 OK
Host: api.example.org
Content-Type: application/vnd.collection+json
Cache-Control: private, max-age=1800
ETag: "w/u7y6t5r4e3w2"</code></pre>
</div></div>
<div class="paragraph"><p>Note that, in the first case, the request to the <code>customer</code> service asks for a "fresh" copy of the resource (<code>Cache-Control: no-cache</code>). But in the case of the list of related records (the <code>order</code> service), the request says it will accept a stale response if that is all that is available (<code>Cache-Control: max-stale</code>). This is a common arrangement. Individual records (ones that might be updated) often need to be "fresh" copies, but related lists could be "not so fresh." However, when a single resource from the <code>order</code> service is needed, it would be wise to mark that request <code>Cache-Control: no-cache</code> in order to get the most recent one.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_53">6.9.4. Discussion</h4>
<div class="paragraph"><p>It is good practice for all services to provide caching metadata in responses. This is especially important for data-centric services where it is likely that the responses (essentially, the data records) will be reused often.</p></div>
<div class="paragraph"><p>The rate of expected data change (e.g., how often a record is modified) is a good guide for how long the resource can be cached.  If the underlying data is not changed often—for example, a list of states or provinces, street addresses, etc.—then the caching period for this data can be relatively long: hours or days. But if the base data is more volatile—say, the contents of a shopping cart—then the caching period should be very short: possibly only a few seconds.</p></div>
<div class="paragraph"><p>API clients should use the <code>no-cache</code> directive sparingly. It is essentially a "cache-buster" that can add additional burden to service interfaces. If the client expects to <em>edit</em> the resource, it makes sense to use the <code>no-cache</code> directive to get the most recent copy of the data. Otherwise, the client should just allow the provider to send the default (cached, if available) response.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Your Mileage May Vary</div>
<div class="paragraph"><p>An important caching-related header not covered in this recipe is the <a href="https://oreil.ly/vZtk4"><code>Vary</code> header</a>. This header can be used to indicate which HTTP elements (besides the URL, host, and method) should be considered when caching a response. For example, <code>Vary: Authorization</code> indicates that the response can only be replayed if the values of <code>Authorization</code> on subsequent requests match. Another common <code>Vary</code> directive includes things like <code>accept-language</code>, <code>content-type</code>, or other negotiable elements.</p></div>
<div class="paragraph"><p>Providers should keep these things in mind when marking a response with <code>Cache-Control</code> directives to make sure the wrong representation is not "replayed."</p></div>
</div></div>
<div class="paragraph"><p>In cases where the data is long-lived (static lists, stable documents, etc.), API consumers can use caching to build up their own local copy of commonly used data records. This is a kind of "low-fidelity" replication pattern. For more along these lines, see <a href="#workflow-replays">[workflow-replays]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_53">6.9.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-local-identifiers">[services-local-identifiers]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-modify-production">6.10. Modifying Data Models in Production</h3>
<div class="paragraph"><p>At some point you may need to update the data model your service is using to create resources. When that happens, you need to come up with a way to modify your data model without breaking any existing data consumers.</p></div>
<div class="sect3">
<h4 id="_problem_53">6.10.1. Problem</h4>
<div class="paragraph"><p>How can you safely update your service&#8217;s data model after it has already been released into production? What aspects of the model can be changed without breaking API consumers? What happens if you update your model in a new release and need to roll back that model change?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_53">6.10.2. Solution</h4>
<div class="paragraph"><p>The most effective approach for supporting data model changes for production data services is to design the data store to support changes from the very start. That means modifications are not "bolted on" or an "afterthought," but are actually part of the original design.</p></div>
<div class="paragraph"><p>A good way to build in model changes for your data storage is to adopt a two-tier approach to modeling data through the use of <em>explicit and implicit data properties</em>. Explicit fields are part of the model or schema (e.g., <code>{"familyName" : "Quarkus"}</code>). Implicit fields are part of a name-value collection associated with the model (e.g., <code>{"nvp":  [{ "name": "familyName", "value": "Quarkus" }]}</code>). When you create an array or collection property that can hold an arbitrary number of name and value elements, you build in the ability to add new properties to your data model without changing the existing model or schema.</p></div>
<div class="paragraph"><p>A key advantage to this approach is that new properties can be added to the name-value collection without requiring schema updates for all your API consumers. It also means that, if you release a new edition of your service API that collects additional data fields and then need to back out that release, your data model does not need to change and you don&#8217;t lose all the data collected in the new name-value pair fields. Then, when you fix any bugs and create a new release, you can take advantage of the previously collected data. Essentially, you&#8217;re creating a data modeling pattern that supports both forward and backward compatibility.</p></div>
</div>
<div class="sect3">
<h4 id="_example_52">6.10.3. Example</h4>
<div class="paragraph"><p>Usually, local data stores are modeled as a strongly typed data object. For example, the following is a <code>person</code> storage object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">John</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <code>person</code> message can be defined by the following schema document:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$id": "<span style="color: #FF0000">https://api.example.org/person.schema.json</span>"<span style="color: #990000">,</span>
  "$schema": "<span style="color: #FF0000">https://json-schema.org/draft/2020-12/schema</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">Person</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">object</span>"<span style="color: #990000">,</span>
  "additionalProperties": <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  "properties": <span style="color: #990000">{</span>
    "givenName": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">The person's first name.</span>"
    <span style="color: #990000">},</span>
    "familyName": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">The person's last name.</span>"
    <span style="color: #990000">},</span>
    "age": <span style="color: #990000">{</span>
      "description": "<span style="color: #FF0000">Age in years. Must be equal to or greater than zero.</span>"<span style="color: #990000">,</span>
      "type": "<span style="color: #FF0000">integer</span>"<span style="color: #990000">,</span>
      "minimum": <span style="color: #993399">0</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The JSON Schema examples used in this pattern all have their <code>additionalProperties</code> value set to <code>false</code>. XML-based schemas have this as the default, too.</p></div>
</td>
</tr></table>
</div>
<div class="sect4 xxx">
<h5 id="_adding_a_new_property">6.10.3.1. Adding a new property</h5>
<div class="paragraph"><p>Now assume we want to add a new property—<code>middleName</code>—to this <code>person</code> object. If we add a new field in the schema, we run the risk of breaking existing API consumers. We&#8217;d need to make sure to roll out updates for all consuming services at the same time. This might be possible for services where all the API consumers and producers are maintained by the same team (or two teams in close coordination), but even this can be tricky.  Instead, we can employ the name-value pair pattern to add the new property to the <code>person</code> object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">John</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">23</span><span style="color: #990000">,</span>
  "nvp" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">middleName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Seymore</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And here&#8217;s the new schema for this model:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "$id": "<span style="color: #FF0000">https://example.com/person.schema.json</span>"<span style="color: #990000">,</span>
  "$schema": "<span style="color: #FF0000">https://json-schema.org/draft/2020-12/schema</span>"<span style="color: #990000">,</span>
  "title": "<span style="color: #FF0000">Person</span>"<span style="color: #990000">,</span>
  "type": "<span style="color: #FF0000">object</span>"<span style="color: #990000">,</span>
  "additionalProperties": <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
  "properties": <span style="color: #990000">{</span>
    "givenName": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">The person's first name.</span>"
    <span style="color: #990000">},</span>
    "familyName": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
      "description": "<span style="color: #FF0000">The person's last name.</span>"
    <span style="color: #990000">},</span>
    "age": <span style="color: #990000">{</span>
      "description": "<span style="color: #FF0000">Age in years which must be equal to or greater than zero.</span>"<span style="color: #990000">,</span>
      "type": "<span style="color: #FF0000">integer</span>"<span style="color: #990000">,</span>
      "minimum": <span style="color: #993399">0</span>
    <span style="color: #990000">},</span>
    "nvp" : <span style="color: #990000">{</span>
      "type" : "<span style="color: #FF0000">array</span>"<span style="color: #990000">,</span>
      "items" :  <span style="color: #990000">{</span> "$ref": "<span style="color: #FF0000">#/$defs/nvp</span>"<span style="color: #990000">},</span>
      "description" : "<span style="color: #FF0000">List of name/value pairs.</span>"<span style="color: #990000">,</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">},</span>
  "$defs": <span style="color: #990000">{</span>
    "nvp": <span style="color: #990000">{</span>
      "type": "<span style="color: #FF0000">object</span>"<span style="color: #990000">,</span>
      "required": <span style="color: #990000">[</span> "name"<span style="color: #990000">,</span> "value" <span style="color: #990000">],</span>
      "properties": <span style="color: #990000">{</span>
        "name": <span style="color: #990000">{</span>
          "type": "<span style="color: #FF0000">string</span>"<span style="color: #990000">,</span>
          "description": "<span style="color: #FF0000">The name of the property.</span>"
        <span style="color: #990000">},</span>
        "value": <span style="color: #990000">{</span>
          "type":<span style="color: #990000">[</span>"number"<span style="color: #990000">,</span>"string"<span style="color: #990000">,</span>"boolean"<span style="color: #990000">,</span>"object"<span style="color: #990000">,</span>"array"<span style="color: #990000">,</span> "null"<span style="color: #990000">],</span>
          "description": "<span style="color: #FF0000">The value of the property.</span>"
        <span style="color: #990000">}</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, instead of a "strongly typed" schema for our data model, we have a "mildly typed" approach. Any properties we wish to add to the model can be placed in the <code>npv</code> array, and the resulting object will still pass validation for the published schema.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_a_single_access_function">6.10.3.2. A single-access function</h5>
<div class="paragraph"><p>This two-tier approach can make it a bit challenging for services to manage when trying to locate a desired property. The question becomes: "I am looking for the <code>middleName</code> field. Is that an implicit or explicit property?"  You can hide the dual nature of your data model with a single access function that can look in both places automatically. Here&#8217;s one example implementation in JavaScript:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// return a single property</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// whether explicit or implicit</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// args = {name:n,message:m,nameValuePair:p}</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span>args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a <span style="color: #990000">=</span> args <span style="color: #990000">||</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> n <span style="color: #990000">=</span> a<span style="color: #990000">.</span>name <span style="color: #990000">||</span> <span style="color: #FF0000">""</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> m <span style="color: #990000">=</span> <span style="color: #990000">(</span>a<span style="color: #990000">.</span>message <span style="color: #990000">||</span> local<span style="color: #990000">.</span>m<span style="color: #990000">)</span> <span style="color: #990000">||</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p <span style="color: #990000">=</span> <span style="color: #990000">(</span>a<span style="color: #990000">.</span>nameValuePair <span style="color: #990000">||</span> local<span style="color: #990000">.</span>p <span style="color: #990000">)</span> <span style="color: #990000">||</span> <span style="color: #FF0000">"nvp"</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> r <span style="color: #990000">=</span> undefined<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>m<span style="color: #990000">===</span><span style="color: #FF0000">{}</span> <span style="color: #990000">||</span> n<span style="color: #990000">===</span><span style="color: #FF0000">""</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    r<span style="color: #990000">=</span>undefined<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>m<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">hasOwnProperty</span></span><span style="color: #990000">(</span>n<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
      r<span style="color: #990000">=</span>m<span style="color: #990000">[</span>n<span style="color: #990000">];</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>m<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">hasOwnProperty</span></span><span style="color: #990000">(</span>p<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
          r <span style="color: #990000">=</span> m<span style="color: #990000">[</span>p<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>i<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #0000FF">return</span></span> i<span style="color: #990000">.</span>name<span style="color: #990000">===</span>n<span style="color: #FF0000">}</span><span style="color: #990000">)[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>value<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #FF0000">{</span>
          r <span style="color: #990000">=</span> undefined<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> r<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, whether the property is explicit or implicit, the same function call can be used:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>name<span style="color: #990000">:</span><span style="color: #FF0000">"givenName"</span><span style="color: #990000">,</span> message<span style="color: #990000">:</span>person<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>name<span style="color: #990000">:</span><span style="color: #FF0000">"middleName"</span><span style="color: #990000">,</span> message<span style="color: #990000">:</span>person<span style="color: #FF0000">}</span><span style="color: #990000">));</span></tt></pre></div></div>
<div class="paragraph"><p>This implicit model works for complex values, too:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">John</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span><span style="color: #990000">,</span>
  "nvp" : <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">hatsize</span>"<span style="color: #990000">,</span> "value" : <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">middleName</span>"<span style="color: #990000">,</span> "value" : "<span style="color: #FF0000">Seymore</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">nicknames</span>"<span style="color: #990000">,</span> "value" : <span style="color: #990000">[</span>"J"<span style="color: #990000">,</span>"JJ"<span style="color: #990000">,</span>"Johnboy"<span style="color: #990000">,</span>"Jack"<span style="color: #990000">]},</span>
    <span style="color: #990000">{</span>"name" : "<span style="color: #FF0000">address</span>"<span style="color: #990000">,</span> "value": <span style="color: #990000">{</span>"street":"<span style="color: #FF0000">123 main</span>"<span style="color: #990000">,</span> "city": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">,</span>
      "state": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">,</span> "zip": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">}}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span>;</tt></pre></div></div>
</div>
<div class="sect4 xxx">
<h5 id="_support_for_multiple_schema_versions">6.10.3.3. Support for multiple schema versions</h5>
<div class="paragraph"><p>There&#8217;s another advantage to this pattern when you use a single-access function, as shown previously. Since it does not matter where the property is located in the message, the same client application can be coded to support multiple schema instances of the <code>person</code> message.</p></div>
<div class="paragraph"><p>For example, your service can update the data model to make <code>middleName</code> an explicit field:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "givenName": "<span style="color: #FF0000">John</span>"<span style="color: #990000">,</span>
  "middleName": "<span style="color: #FF0000">Seymore</span>"<span style="color: #990000">,</span>
  "familyName": "<span style="color: #FF0000">Doe</span>"<span style="color: #990000">,</span>
  "age": <span style="color: #993399">21</span>
<span style="color: #990000">}</span>;</tt></pre></div></div>
<div class="paragraph"><p>And the same <code>find</code> function works as expected:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>name<span style="color: #990000">:</span><span style="color: #FF0000">"middleName"</span><span style="color: #990000">,</span> message<span style="color: #990000">:</span>person<span style="color: #FF0000">}</span><span style="color: #990000">));</span></tt></pre></div></div>
</div>
<div class="sect4 xxx">
<h5 id="_reverting_models">6.10.3.4. Reverting models</h5>
<div class="paragraph"><p>Finally, in cases where you need to revert to a previous model/schema, you can move properties that are explicit in one model and represent them as implicit in another model with minimal side effects.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_54">6.10.4. Discussion</h4>
<div class="paragraph"><p>This pattern is primarily designed to make it easy for services to safely support internal data model changes over time. It is not recommended that you expose these models directly via your service API. Instead, you should represent your resources using a well-defined media type (see <a href="#services-media-types">[services-media-types]</a> for details).</p></div>
<div class="paragraph"><p>It may seem like a good idea to simply add new explicit fields to JSON-based objects and rely on the JSON Schema&#8217;s default behavior of ignoring additional properties when validating objects. This, however, can lead to problems. First, JSON Schema and XML Schema behaviors are not the same. By default, XML rejects messages with unknown elements. Second, assuming that JSON Schema documents will always have their <code>additionalProperties</code> value set to <code>true</code> is dangerous. Some data consumer teams might write their own local JSON Schema that sets this value to <code>true</code> and start rejecting messages with unknown properties. Finally, by adopting this explicit/implicit model, you make it clearer to API consumers that some fields have been added. This makes it easier for consumers to ignore them when appropriate and gives them a clear path toward discovering new properties in the future.</p></div>
<div class="paragraph"><p>If you end up supporting multiple model schemas at runtime (e.g., some previously implicit properties are upgraded to explicit), be sure to link to the correct revision of the JSON (or XML) schema documents, since client applications may be relying on schema documents at runtime (see <a href="#clients-schema">[clients-schema]</a>).</p></div>
<div class="paragraph"><p>This recipe doesn&#8217;t explain how to <em>store</em> the explicit and implicit data properties, since the details change depending on what data format you are using. JSON documents can be structured to fit the given example objects directly. However, in cases where data is stored using SQL tables, you can create a table to hold the explicit fields and then add the implicit properties in a standalone table (<code>nameValuePairs</code>), where each row has an index field pointing to the explicit row along with the name and value for that implicit property. See <a href="#fig0606">[fig0606]</a>.</p></div>
<div class="imageblock" id="fig0606">
<div class="content">
<img src="images/rwcb_0606.png" alt="images/rwcb_0606.png" width="80%" />
</div>
<div class="title">Figure 17. Explicit table and implicit table</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Accepting unknown implicit fields can be a security risk. It&#8217;s crucial that all services that attempt to read/write data check both the name and value contents to protect themselves from any attempt to place dangerous values in data storage.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is important to remember that services that support writing data using this recipe will need to know which fields are explicit and which are implicit. An easy approach is to keep a list of explicit fields as a guide when writing a record. If any field appears that is not listed, you can assume it is an implicit field that should be added to the <code>nvp</code> collection.  You may also be able to use a local schema document to guide the write operation.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_54">6.10.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-extend">[design-extend]</a>
</p>
</li>
<li>
<p>
<a href="#design-modify">[design-modify]</a>
</p>
</li>
<li>
<p>
<a href="#clients-schema">[clients-schema]</a>
</p>
</li>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#services-model-leaks">[services-model-leaks]</a>
</p>
</li>
<li>
<p>
<a href="#data-hiding">[data-hiding]</a>
</p>
</li>
<li>
<p>
<a href="#data-ignore">[data-ignore]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-extend">6.11. Extending Remote Data Stores</h3>
<div class="paragraph"><p>There are times when you want to use the data from another service even though that service does not store all the data properties you need. In cases like this, it may be possible to <em>extend</em> that remote data source with your own local property storage using an associative key.</p></div>
<div class="sect3">
<h4 id="_problem_54">6.11.1. Problem</h4>
<div class="paragraph"><p>How can you safely and effectively extend an existing data store (one that you don&#8217;t control) with additional property values? When is this a good idea? How can you maintain data integrity between the remote and local data stores?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_54">6.11.2. Solution</h4>
<div class="paragraph"><p>In cases where you want to extend an existing remote data store with additional values, you can establish a local data store that contains the additional values, and an associative key that links the two data stores together.</p></div>
</div>
<div class="sect3">
<h4 id="_example_53">6.11.3. Example</h4>
<div class="paragraph"><p>To start, let&#8217;s lay out an example remote and local data store and then make the <span class=".keep-together">association</span>.</p></div>
<div class="paragraph"><p>As an example, assume you are using a remote data store that keeps track of <code>user&#x200b;Ac&#x2060;counts</code>. It has a <code>uniqueId</code> property along with a collection of other properties, such as <code>givenName</code>, <code>familyName</code>, <code>email</code>, etc.:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /users/q1w2e3r4 HTTP/1.1
Host: user-accounts.example.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****
HTTP/1.1. 200 OK
Host : user-accounts.example.org
Content-Type: application/vnd.collection+json
Content-Length: XXX</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://user-accounts.example.org/users/q1w2e3r4</span>"<span style="color: #990000">,</span>

    "links" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href" : "<span style="color: #FF0000">http://user-accounts.example.org/users/q1w2e3r4</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">uniqueId</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">givenName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Marquis</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">familyName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Quarkus</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">email</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">user@example.org</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Also assume you are creating a service that keeps track of the request history for users of your shopping site. You want to track things like <code>visitorId</code>, <code>pageUrl</code>, <code>dateTime</code>, <code>dwellTime</code>, etc.:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /history/p0o9i8u7/1 HTTP/1.1
Host: shopping.example.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****`
HTTP/1.1. 200 OK
Host : shopping.example.org
Content-Type: application/vnd.collection+json
Content-Length: XXX</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://shopping.example.org/history/p0o9i8u7/1</span>"<span style="color: #990000">,</span>

    "links" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href" : "<span style="color: #FF0000">http://shopping.example.org/history/p0o9i8u7/1</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">historyId</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">p0o9i8u7</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">pagerUrl</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">dwellTime</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">30000ms</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">dateTime</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">20230203T141529Z</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, you want to be able to share this request history with users on demand. Essentially, you need to merge both the <code>userAccount</code> and <code>requestHistory</code> data <span class=".keep-together">properties</span>.</p></div>
<div class="paragraph"><p>A direct way to do this is to use the runtime URL of the remote data store (<em>http://user-accounts.example.org/users/q1w2e3r4</em>) as the associative key and add that to the local record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /history/p0o9i8u7/1 HTTP/1.1
Host: shopping.example.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****`
HTTP/1.1. 200 OK
Host : shopping.example.org
Content-Type: application/vnd.collection+json
Content-Length: XXX</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" :
  <span style="color: #990000">{</span>
    "version" : "<span style="color: #FF0000">1.0</span>"<span style="color: #990000">,</span>
    "href" : "<span style="color: #FF0000">http://shopping.example.org/history/p0o9i8u7/1</span>"<span style="color: #990000">,</span>

    "links" : <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
    "items" : <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "href" : "<span style="color: #FF0000">http://shopping.example.org/history/p0o9i8u7/1</span>"<span style="color: #990000">,</span>
        "data" : <span style="color: #990000">[</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">historyId</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">p0o9i8u7</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">pagerUrl</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">dwellTime</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">30000ms</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">dateTime</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">20230203T141529Z</span>"<span style="color: #990000">},</span>
          <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">associativeKey</span>"<span style="color: #990000">,</span>
            "value": "<span style="color: #FF0000">http://user-accounts.example.org/users/q1w2e3r4</span>"<span style="color: #990000">}</span>
        <span style="color: #990000">]</span>
      <span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now, when you want to construct a resource that includes both your locally stored data and fields from the remote data source, you just need to use the <code>associativeKey</code> in your local store to retrieve the related data.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_55">6.11.4. Discussion</h4>
<div class="paragraph"><p>It is possible that the remote service may not respond when you attempt to retrieve the associated resource. In this case, you may be able to use a local copy (see <a href="#data-caching">[data-caching]</a>) instead.</p></div>
<div class="paragraph"><p>It is also possible that the remote service is up and running but unable to find the resource you are requesting. For example, that resource might have been deleted. In this case, your service needs to either supply default data to replace the missing information, or return a 400-level response telling the calling application that the information is no longer available. If the local data is no longer useful when the remote resource is missing, you can delete your local data associated with that record.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Just because a remote service reports 404 does not mean that the data has been deleted. It may just be <em>temporarily</em> missing. Don&#8217;t be too quick to delete your local data if the remote service reports a 4xx level response. If, however, the remote service responds with a <code>410 Gone</code>, you can be confident this condition is permanent.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It is not a good idea to create local data properties with the same name as properties in the remote data store. For example, if the remote resource has an <code>email</code> field that contains the user&#8217;s personal email address (<a href="mailto:marquis@example.org">marquis@example.org</a>) and you want to store a work email instead (<a href="mailto:work@example.org">work@example.org</a>), don&#8217;t create a local <code>email</code> property with the desired value. Instead, create a uniquely named local property (<code>workEmail</code>) and use that to hold your value.</p></div>
<div class="paragraph"><p>Even if your local service displays a single resource that is a mix of both local and remote properties, it is not a good idea to try to enforce any data integrity for the combined record. For example, you might want to enforce a rule that any local resource that has an <code>email</code> property also <em>must</em> have a <code>fullName</code> property. If one of the properties is part of the remote resource (<code>email</code>) and the other is part of the local resource (<code>fullName</code>), you can&#8217;t be assured that both records will enforce the same rules.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">But My Schema!?!</div>
<div class="paragraph"><p>In cases where service interfaces are returning responses made from multiple sources, using schema documents to validate messages gets complicated quickly. This is especially true if you are using a storage service that supports field selection (e.g., OData, GraphQL, etc.). See Recipes <a href="#clients-outgoing">4.12</a> and <a href="#clients-incoming">4.13</a> for more on using schema documents for APIs.</p></div>
</div></div>
<div class="paragraph"><p>It is rarely a good idea to use your local resource to hold copies of the values of some remote resource properties.  The values of the remote properties might change, and your local service will not know about the updates. See Recipes <a href="#data-caching">6.9</a> and <a href="#data-proxy">6.13</a> for more on this topic.</p></div>
<div class="paragraph"><p>Over time, it is likely that your local data store will contain resources with "broken" associations—the <code>associativeKey</code> URL returns a 4xx or 5xx status. If needed (e.g., to recover space), you can create a job or script that crawls your local data store and removes any local records that no longer have remote associations. However, it is often important to retain your local data (to keep a complete history, etc.), and in that case, your local service should just ignore the association and/or replace the values with the local default (e.g., "No Longer Available," etc).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_55">6.11.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-extend">[design-extend]</a>
</p>
</li>
<li>
<p>
<a href="#design-modify">[design-modify]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#clients-outgoing">[clients-outgoing]</a>
</p>
</li>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#data-hiding">[data-hiding]</a>
</p>
</li>
<li>
<p>
<a href="#data-caching">[data-caching]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-limits">6.12. Limiting Large-Scale Responses</h3>
<div class="paragraph"><p>For data services that get a large amount of traffic and/or serve up lots of content, limiting the size of the responses can be an effective way to support API clients "at scale." Conversely, failing to regulate the size and/or count of data returned from queries against large data sets can easily bog down your data service and, if this is a critical data set, adversely affect many other dependent services.</p></div>
<div class="sect3">
<h4 id="_problem_55">6.12.1. Problem</h4>
<div class="paragraph"><p>How can you make sure query responses from data-centric services remain responsive even as the data set grows?  What are common controls to the size of the data collections returned? When is it important to impose limits on returns from large data sets?</p></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_solution_55">6.12.2. Solution</h4>
<div class="paragraph"><p>The best way to ensure that your service interface for data-centric services does not suffer performance problems as the data set grows is to limit the number of records returned in HTTP responses. The proper way to do this is to set (and properly document) a <em>default</em> maximum records value for all data queries. Even if the backend data service does not already set limits on response collections, it is a good idea for you to implement response limits for the service interface that stands between the API client and the underlying service.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe addresses the ability to limit returns in a query to underlying data stores. You can also use the page navigation recipe (<a href="#workflow-navigation">[workflow-navigation]</a>) to implement a more interactive way to control query returns for large data sets.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Most data engines support the ability to limit the number of records returned in a single response. For example, OData supports the <code>$top</code> directive and the <code>maxpagesize</code> setting. GraphQL supports the use of <code>first:nn</code>. SQL supports the <code>TOP</code> and <code>LIMIT</code> directives. And Lucene has the <code>rows</code> query parameter. So, for cases where your service interface is crafting the query for the underlying data service, you can make sure to employ these settings in your data requests.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>You should <em>always</em> include a maximum value in your queries to data storage, and you should always replace any client-supplied limit values that are out of range (e.g., set too high). Sending data queries without indicating a maximum record count can introduce performance and possibly security problems.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can make the return limit a part of the query that API clients commit (in other words, allow API clients to determine the limit value). You can also set the limit value within the service interface <em>before</em> you send the query to the underlying service (essentially you edit the client query before sending it). It is also possible (but a bit more work) to support both options. That is, to allow API clients to set the limit value and, once submitted to the service interface, that code can look for the limit value. If the limit value does not exist, the code can insert the default value; or if the limit value does exist but is outside of acceptable limits (e.g., set to 10,000,000), the service interface code can modify the value accordingly.</p></div>
<div class="paragraph"><p>In cases where the underlying data source does not support a maximum count setting, you will need to implement your own return limits at the service interface level. That means accepting the return collection from the underlying data source and then, if needed, truncating the collection at the maximum record count.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Whether you communicate the limits via the actual query to the data store or implement the limit by truncating the collection returned to the API caller, you should <em>always</em> indicate the use of the limit value in the query metadata (see <a href="#data-metadata">[data-metadata]</a>) returned to the API caller.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_example_54">6.12.3. Example</h4>
<div class="paragraph"><p>There are two ways to implement return count limits on data-centric service <span class=".keep-together">interfaces</span>:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>DirectLimit</code>
</dt>
<dd>
<p>
Include the limit directive in the data query sent to the data store.
</p>
</dd>
<dt class="hdlist1">
<code>TruncatedLimit</code>
</dt>
<dd>
<p>
Truncate the resulting data collection within the service interface.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Next up are examples of each method.</p></div>
<div class="sect4 xxx">
<h5 id="_implementing_direct_limits">6.12.3.1. Implementing direct limits</h5>
<div class="paragraph"><p>The easiest way to support direct limits is to simply allow API client applications to send in the proper directives with each data query. For example, here&#8217;s a query using the Solr search engine. Note the use of the <code>limit=100</code> setting:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/search/?q=%22Bob%22&amp;rows=100 HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Q-Status=success
Q-Returned=100
Q-Count=10000
...</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the <code>rows=100</code> query parameter was sent by the client application to the service interface. But there will be times when the client application does not send the limit value. In that case, it is up to the service interface to send the limit value to the data store. Here is an example using the OData engine:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /persons/search/?$search=%22Bob%22 HTTP/1.1
Host: api.example.org
Accept: application/vnd.collection+json

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Q-Status=success
Q-Sent=$search=%22Bob%22
Q-Executed=$search=%22Bob%22$top=100
Q-Returned=100
Q-Count=10000
...</code></pre>
</div></div>
<div class="paragraph"><p>Note the use of the <code>q-sent</code> and <code>q-executed</code> query metadata values (see <a href="#data-metadata">[data-metadata]</a>). In cases where the service interface modifies the client query before sending it to the data store, these two metadata properties should be returned as either HTTP headers or as part of the response body.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_implementing_truncated_limits">6.12.3.2. Implementing truncated limits</h5>
<div class="paragraph"><p>There will be times when the service interface has to communicate the maximum return limit from a data query. Sometimes this maximum value is hardcoded into the data store, and sometimes the data store has no maximum limits at all. In both cases, it is important for the service interface to protect itself against return sets that are "too large" (whatever that means for the client making the query). This usually means adding support for <em>truncating</em> the data collection returned from the data store (in the API code) before sending the results to the client application.</p></div>
<div class="paragraph"><p>Implementing data set truncation at the service interface layer will vary based on the programming languages, return formats, and other factors. A crude solution is to simply walk through the returned collection and retain the maximum number of records to return:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">executeQuery</span></span><span style="color: #990000">(</span>dataStoreAddress<span style="color: #990000">,</span> dataQuery<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ix<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> maxLimit<span style="color: #990000">=</span><span style="color: #993399">100</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> responseCollection <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> dataCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRequest</span></span><span style="color: #990000">(</span>dataStoreAddress<span style="color: #990000">,</span> dataQuery<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>let item of dataCollection<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>ix<span style="color: #990000">&gt;</span>maxLimit<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      responseCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>item<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    ix<span style="color: #990000">++;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> responseCollection<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>In some cases, you may be able to retain the complete collection and implement local page navigation against the saved data collection. See <a href="#workflow-navigation">[workflow-navigation]</a> for details.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Once the service interface has created its own local copy of the collection (limited to the maximum allowed record count), the API can return the results shown in the direct limit example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Q-Status=truncated
Q-Returned=100
Q-Count=10000
...</code></pre>
</div></div>
<div class="paragraph"><p>Note the use of the <code>q-status=truncated</code> metadata property to help the API client understand the meaning of the results.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_56">6.12.4. Discussion</h4>
<div class="paragraph"><p>The safest approach for implementing data request limits is to set the limit in the API code using the parameters in the underlying query language.  If you allow client applications to set the limit value, <em>always</em> check it to make sure it does not fall outside acceptable limits (e.g., set to <code>-100</code> or <code>1000000</code>).</p></div>
<div class="paragraph"><p>Using the truncated limit approach has its drawbacks. For example, you do not get to control how large a data set may be returned to you from the underlying data source. Even if your API limits response collections to 100 records, you may still need to wait for the underlying (unlimited) data source to search for and return 100,000 records before you can implement your internal truncation routine. In the case of very large return sets, your API performance is likely to suffer.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Limits Are Not Pages</div>
<div class="paragraph"><p>It is important to not confuse query limits (like the ones discussed here) with page sizes (covered in <a href="#workflow-navigation">[workflow-navigation]</a>). For example, you might set your API query limit to 1,000, and the client application might set its page-size value to 100. In that case, the client will be expecting no more than 100 records in any single returned response.</p></div>
</div></div>
<div class="paragraph"><p>Whenever you modify a direct limit query or invoke a truncated limit on a return set, you should communicate this information back to the requesting application (preferably using query metadata [<a href="#data-metadata">[data-metadata]</a>]).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_56">6.12.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#clients-forms">[clients-forms]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-health">[services-health]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-response">[data-response]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-navigation">[workflow-navigation]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-accepted">[workflow-accepted]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="data-proxy">6.13. Using Pass-Through Proxies for Data Exchange</h3>
<div class="paragraph"><p>There are times when services want to edit a subset of the fields in a stored record (e.g., the <code>address</code> data in a <code>person</code> record). In these cases, it is important to make sure that changes to the subset of fields does not result in invalidating the data in the complete record. At the same time, "upstream" clients do not need to know the details of the source ("downstream") services. This is where the pass-through proxy recipe can help.</p></div>
<div class="sect3">
<h4 id="_problem_56">6.13.1. Problem</h4>
<div class="paragraph"><p>How can you maintain data storage integrity when other services want to edit just a portion of your storage record?  When updating a partial set of data fields in a record (e.g., the <code>address</code> fields in a <code>person</code> record), what can you do to make sure the full set of fields in the record contain no conflicts? And when you discover internal data inconsistencies, what response should you return to the service attempting the invalidate update?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_56">6.13.2. Solution</h4>
<div class="paragraph"><p>A good rule to follow is to <em>always</em> pass complete storage data records back and forth between services. This is the easiest, most reliable way to ensure information integrity of the record. Even if there is a service that wants to edit just a portion of the record (for example, the <code>address</code> portion of a <code>person</code> record), that service should be sent a complete record, modify the portion of the record it wants to work with, then return the entire record to the data service for validation and storage.</p></div>
<div class="paragraph"><p>In cases where the consuming service is an intermediate (or pass-through) service between two other parties, (e.g., an <code>address</code> service that exchanges data with a <code>person</code> service), that service should still exchange complete records with the <code>person</code> service. This can be done by reading a <code>person</code> record, extracting the <code>address</code> portion to send along, holding on to the related <code>person</code> record, and, upon receiving the updated <code>address</code> information,  loading the <code>address</code> data into the held <code>person</code> record and sending that back to the <code>person</code> service. Of course, the <code>address</code> service needs to be <span class=".keep-together">prepared</span> for a failed write to the <code>person</code> service and report that back to the <code>address</code> consumer when appropriate.</p></div>
<div class="sidebarblock less_space">
<div class="content">
<div class="title">It&#8217;s Turtles All the Way Down</div>
<div class="paragraph"><p>The example given here (<code>person</code> and <code>address</code>) is a reminder that API consumers can never be certain whether they are talking to a "pass-through" service or "storage" service. In fact, you can imagine another service called the <code>telephone</code> service that allows consumers to update the telephone value of an <code>address</code> record. Now we have three layers to deal with (<code>telephone</code>, <code>address</code>, and <code>person</code>). For all we know, the <code>person</code> service may be changed in the future from a "storage" type to a "pass-through" type. That would be <em>four</em> layers of data exchange.</p></div>
</div></div>
<div class="paragraph"><p>Services that are built to edit subsets of data (<code>address</code> for a <code>person</code>) may be limited to updates and not be able to support create or delete actions. For example, the only way to create an additional <code>address</code> or remove an existing <code>address</code> for a <code>person</code> is to use the <code>person</code> service directly.</p></div>
<div class="paragraph"><p>Note that it is a good idea to keep track of update metadata when exchanging subsets of records. See <a href="#data-metadata">[data-metadata]</a> for details.</p></div>
</div>
<div class="sect3">
<h4 id="_example_55">6.13.3. Example</h4>
<div class="paragraph"><p><a href="#fig0607">[fig0607]</a> is a sequence diagram that gives you an omniscient view of how the three services interact in our example. Of course, each participant (<code>apiClient</code>, <code>addressAPI</code>, and <code>personAPI</code>) only knows about its direct neighbors. For example, <code>apiClient</code> only knows about <code>addressAPI</code>, <code>personAPI</code> only knows about <code>addressAPI</code>, and <code>addressAPI</code> knows about both other parties.</p></div>
<div class="imageblock" id="fig0607">
<div class="content">
<img src="images/rwcb_0607.png" alt="images/rwcb_0607.png" width="80%" />
</div>
<div class="title">Figure 18. Pass-through data recipe</div>
</div>
<div class="paragraph"><p>The following is an example of an <code>address</code> service interacting with the <code>person</code> service to support updating the <code>address</code> subset info for a <code>person</code>.</p></div>
<div class="paragraph"><p>First, the <code>address</code> service receives a request for a record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /q1w2e3r4 HTTP/1.1
Host: api.address.org
Accept: application/vnd.collection+json</code></pre>
</div></div>
<div class="paragraph"><p>The <code>address</code> service then needs to contact the <code>person</code> service for a record:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /q1w2e3r4 HTTP/1.1
Host: api.person.org
Accept: application/vnd.collection+json

**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Content-Length: nn
ETag: "w\p0o9i8u7y6"
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection" : <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Person Service</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "items": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span> "href": "<span style="color: #FF0000">https://api.person.org/q1w2e3r4</span>"<span style="color: #990000">,</span>
      "data": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">fullName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork Markleson</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">streetAddress</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main St</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">cityTown</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">stateProvince</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">postalCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Now the <code>address</code> service can store a copy of the <code>person</code> record locally (be sure to store the response headers, too) and then respond to the caller with the subset of <code>address</code> fields:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 200 OK
Content-Type: application/vnd.collection+json
Content-Length: nnn
ETag: "w\y6t5r4e3w2"</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span> "collection" : <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Address Service</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "items": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span> "href": "<span style="color: #FF0000">https://api.address.org/q1w2e3r4</span>"<span style="color: #990000">,</span>
      "data": <span style="color: #990000">[</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main St</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">municipality</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">region</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
        <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #990000">}</span>
  <span style="color: #990000">],</span>
  "template": <span style="color: #990000">{</span>
    "rel": "<span style="color: #FF0000">edit</span>"<span style="color: #990000">,</span>
    "data": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main St</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">municipality</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">region</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345</span>"<span style="color: #990000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>There are a couple of things to notice here. First, the <code>address</code> service has generated its own <code>ETag</code> value, one that matches the <code>address</code> representation. This can be used in case more than one party attempts to update this record (see <a href="#data-idempotent">[data-idempotent]</a> for details on the lost update problem).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>In this example, both the <code>address</code> service and the <code>person</code> service use the same <code>id</code> value <em>and</em> use that value in the URL. This is not always the case and should be taken into account. You may need to keep track of two different identifiers and two separate URLs when working as a pass-through service.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Second, note that the field <em>names</em> used by the <code>address</code> service do not need to be the same as those used by the <code>person</code> service. It is handy if they <em>are</em>, but quite often we don&#8217;t control these things and a translation step is needed to pass data from one party to the next.</p></div>
<div class="paragraph"><p>Next, the <code>address</code> service can wait for someone to send an update record back:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /q1w2e3r4 HTTP/1.1
Host: api.address.org
Content-Type: application/vnd.collection+json
Content-Length: nn
If-Match: "w\y6t5r4e3w2"
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>"template": <span style="color: #990000">{</span>
  "data": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">street</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main St, Apt 3G</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">municipality</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">region</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">zipCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345-6789</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Then the <code>address</code> service must load the data from the caller into its own local copy of the <code>person</code> record and pass that along to the <code>person</code> service:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /q1w2e3r4 HTTP/1.1
Host: api.person.org
Content-Type: application/vnd.collection+json
Content-Length: nn
If-Match: "w\p0o9i8u7y6"
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>"template": <span style="color: #990000">{</span>
  "data": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">fullName</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Mork Markleson</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">streetAddress</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">123 Main St, Apt 3G</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">cityTown</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">Byteville</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">stateProvince</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">MD</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"name": "<span style="color: #FF0000">postalCode</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">12345-6789</span>"<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 204 No Content</code></pre>
</div></div>
<div class="paragraph"><p>Assuming all goes well, the <code>person</code> service returns a 2xx response to the <code>address</code> service, and the <code>address</code> service does the same to its caller.</p></div>
<div class="paragraph"><p>If, however, there was a problem writing to the <code>person</code> service, the appropriate status code will be returned to the <code>address</code> service and then passed along to the caller:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
HTTP/1.1 412 Precondition Failed
Content-Type: application/vnd.collection+json
Content-Length: nn</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">Person Service</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "error": <span style="color: #990000">{</span>
     "title": "<span style="color: #FF0000">Unable to update record</span>"<span style="color: #990000">,</span>
     "code": "<span style="color: #FF0000">http://api.person.org/reasons/precondition</span>"<span style="color: #990000">,</span>
     "message": "<span style="color: #FF0000">The record you are trying to update has been changed.</span>"<span style="color: #990000">,</span>
     "data" <span style="color: #990000">[{</span>"name": "<span style="color: #FF0000">id</span>"<span style="color: #990000">,</span> "value": "<span style="color: #FF0000">q1w2e3r4</span>"<span style="color: #990000">}]</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>You may need to alter the <code>error</code> information depending on the type of error and where in the chain (storage service, pass-through service) you are reporting.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_57">6.13.4. Discussion</h4>
<div class="paragraph"><p>The concept of a pass-through data interface is only important to the interface that is acting as a proxy between two services (as in the preceding <code>address</code> service example). Consumers of pass-through proxies don&#8217;t need to know anything about the pass-through nature of the target service. The same goes for any service interface that is <em>behind</em> the pass-through proxy.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>As an alternative to the pass-through proxy recipe, services can ignore unknown data fields (see <a href="#data-ignore">[data-ignore]</a>).</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>A key element of this recipe is to be sure that pass-through proxies keep track of the connection between the "downstream" (source) record and the "upstream" (exposed) record. To do this, be sure to always store a complete copy of the "downstream" record, including metadata fields such as <code>ETag</code> and other related resource integrity information.  The best way to do that is to store the complete HTTP response, not just the body. See <a href="#data-metadata">[data-metadata]</a> for details.</p></div>
<div class="paragraph"><p>As an implementation detail, it is always a good idea for the pass-through proxy to use a translation step to handle any differences between the data property list for the proxy interface and the data property list for the source service:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">fetchPerson</span></span><span style="color: #990000">(</span>url<span style="color: #990000">,</span>propertyMap<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> personRecord <span style="color: #990000">=</span> person<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>url<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> addressRecord <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mapProperties</span></span><span style="color: #990000">(</span>personRecord<span style="color: #990000">,</span> propertyMap<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> addressRecord<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <code>mapProperties(personRecord, propertyMap)</code> step does the work of pulling the expected fields from the source ("downstream") record and constructing a valid exposed ("upstream") record. In some cases this is not just a one-to-one renaming of data properties (<code>person.givenName = +address.firstName</code>). In some cases, fields are combined or split between interfaces:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> address<span style="color: #990000">.</span>fullName <span style="color: #990000">=</span> person<span style="color: #990000">.</span>familyName<span style="color: #990000">+</span> <span style="color: #FF0000">", "</span><span style="color: #990000">+</span> person<span style="color: #990000">.</span>givenName</tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Source Today, Pass-Through Tomorrow</div>
<div class="paragraph"><p>Since we don&#8217;t control all the services on the web, we can&#8217;t always know whether an interface is connected to a data source service or a data pass-through service. In fact, a service might start as a data source and later become a pass-through. From the interface point of view, it doesn&#8217;t matter.  Interfaces should continue to make promises about message exchanges independent of the implementation details of the services behind that interface.</p></div>
</div></div>
<div class="paragraph"><p>Pass-through proxies need to be prepared for cases where a poorly managed "downstream" source will change its response (e.g., add/remove/rename data fields). This can&#8217;t be prevented, but you can mitigate the problem by always inspecting the incoming downstream record to make sure it contains the data properties the "upstream" interface has promised. If not, the pass-through proxy should return a <code>502 Bad Gateway</code> response with a body indicating the problem:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /q1w2e32r4 HTTP/1.1
Host api.address.org
Accept: application/vnd.collection+json
...

**** RESPONSE ****
HTTP/1.1 502 Bad Gateway
Content-Type: application/vnd.collection+json
Content-Length: nn
...</code></pre>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "links": <span style="color: #990000">[</span>...<span style="color: #990000">],</span>
  "error": <span style="color: #990000">{</span>
    "title": "<span style="color: #FF0000">Invalid Response</span>"<span style="color: #990000">,</span>
    "code": "<span style="color: #FF0000">SRC-077</span>"<span style="color: #990000">,</span>
    "message": "<span style="color: #FF0000">Data source is missing the [givenName] data property</span>"
  <span style="color: #990000">}</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that in this example, only the details related directly to the current interface exchange (<code>client</code> and <code>address</code> service) are included in the status report. There is no mention of the "downstream" source (<code>person</code> service).</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_57">6.13.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#design-extend">[design-extend]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-proxy">[services-proxy]</a>
</p>
</li>
<li>
<p>
<a href="#data-hiding">[data-hiding]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-proxy">[workflow-proxy]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="workflow">7. RESTful Workflow</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>Productivity is never an accident. It is always the result of a commitment to excellence, intelligent planning, and focused effort.
</q></p>
<p data-type="attribution">Paul J. Meyer</p>
</blockquote>
<div class="paragraph"><p>For many, the ultimate goal of creating service interface APIs is to foster flexible and robust <em>workflow</em> solutions that mix existing services in unique ways to solve new problems. In fact, this goal is embodied in the keystone principle discussed in <a href="#principles">[principles]</a>. The process of linking services together is not a great challenge when these services were designed from the start to work in concert. However, enlisting services that were not built as a group, know nothing of each other, and are oblivious to the solution being created is a much bigger challenge. This second approach depends on important implementation details that make a number of activities possible, such as sharing solution state, progressing through multiple steps to accomplish a goal, and tracking/displaying that progress. Anytime you mix service interfaces together, there is a chance of execution errors that might require rerunning some steps, undoing others, and knowing when this is needed.</p></div>
<div class="paragraph"><p>Often, we build our own services as a related collection. In fact, if the same team is building more than one service, those services are bound to have hidden dependencies that are difficult to untangle. Keeping this tangle at bay takes discipline, design, and determination.</p></div>
<div class="paragraph"><p>The bad news is that designing and supporting successful workflow on the web requires additional effort. The good news is that, as long as you implement each individual service with a simple API and establish a general processing and tracking model that all services support, you can create a resilient, flexible, and evolvable workflow environment that clients can safely use to solve new and interesting <span class=".keep-together">problems</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For more background on the important elements of a well-designed and -implemented workflow on the web, see <a href="#background-workflow">[background-workflow]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Supporting a hypermedia workflow (see <a href="#fig0701">[fig0701]</a>) means focusing on common patterns like page navigation, works in progress, most recently used, etc. It also means supporting a generalized hypermedia-driven workflow via jobs and tasks, along with some optimization techniques to keep things flowing. Finally, there is a second-level set of activities centered around managing the workflow process itself. These four elements (patterns, generalized flow, optimization, and management) make up a healthy hypermedia workflow system.</p></div>
<div class="imageblock" id="fig0701">
<div class="content">
<img src="images/rwcb_0701.png" alt="images/rwcb_0701.png" width="80%" />
</div>
<div class="title">Figure 19. Hypermedia workflow recipes</div>
</div>
<div class="paragraph"><p>This chapter contains two types of recipes. The first type is a set of common workflows like list navigation, work-in-progress patterns, forms handling, and similar patterns (Recipes <a href="#workflow-related">7.8</a> to <a href="#workflow-replays">7.14</a>). You can use these prototype patterns as a guide when you create your own semantic profiles (<a href="#design-profiles">[design-profiles]</a>) for your service interfaces.</p></div>
<div class="paragraph"><p>The second set of recipes here describe a general workflow interaction language that you can use to enlist selected independent services and track the progress of these multiple-service solutions. This is a much more abstract set of patterns that cover everything from how you can design in workflow support for your services to the actual implementation of workflow-compliant services.</p></div>
<div class="paragraph"><p>Finally, you&#8217;ll find several entries here that detail general principles and patterns for dealing with coordinating and managing these services. These include dealing with errors, rollbacks, and even some internal patterns to help scaling and proxying other service interfaces.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>You&#8217;ll find that many of the recipes in this chapter depend upon, or call back to, other recipes from earlier in the book. If you skipped over those chapters, this is a good time to follow the threads back to see where some of these workflow-solution recipes have their roots.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="workflow-compliant">7.1. Designing Workflow-Compliant Services</h3>
<div class="paragraph"><p>A shared goal of many service interface designers is the ability to easily connect multiple services to form a workflow. These are often called <em>composable</em> services. This recipe describes a set of basic design features every workflow-compliant (composable) service should have.</p></div>
<div class="sect3">
<h4 id="_problem_57">7.1.1. Problem</h4>
<div class="paragraph"><p>What does it take to design a workflow-compliant service? What are the key features every composable service interface shares? How can you make it safe, cheap, and easy to implement workflow using these composable services?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_57">7.1.2. Solution</h4>
<div class="paragraph"><p>The key to designing workflow-compliant services is to offer a consistent set of actions and make it easy to share state data among services. These elements—shared actions and shared state—are at the heart of stable, composable service interfaces.</p></div>
<div class="paragraph"><p>In addition to a shared set of actions and state data, workflow-compliant services support shared identifiers for the job (as <code>correlation-id</code>) and as each task within the workflow job (as <code>request-id</code>).</p></div>
<div class="sect4 xxx">
<h5 id="_workflow_actions">7.1.2.1. Workflow actions</h5>
<div class="paragraph"><p>In hypermedia-driven services, actions are expressed at input forms. Each form describes all that is needed to complete the action: the URL, the HTTP method, the supported media types, and the complete set of inputs.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#workflow-partial-submit">[workflow-partial-submit]</a> for details on how to design better forms.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>While actions can be very specific (e.g., <code>onboardCustomer</code>, <code>computeSalesTax</code>, etc.), they can also be generic (<code>writeRecord</code>, <code>filterData</code>, etc.), but they <em>must</em> be completely described with all the inputs and related HTTP metadata included (see the "Example" section).</p></div>
<div class="paragraph"><p>The list of actions also needs to support the following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Execute
</dt>
<dd>
<p>
The actual work to be done (e.g., <code>applySalesTax</code>).
</p>
</dd>
<dt class="hdlist1">
Repeat
</dt>
<dd>
<p>
Repeat the work again in an idempotent manner (e.g., <code>applySalesTax</code> can be safely repeated and still be the same expected results).
</p>
</dd>
<dt class="hdlist1">
Revert
</dt>
<dd>
<p>
The ability to undo a completed action (e.g., <code>revertSalesTax</code>).
</p>
</dd>
<dt class="hdlist1">
Continue
</dt>
<dd>
<p>
The ability to stop a workflow and then, after some pause, continue where you left off to complete the work.
</p>
</dd>
<dt class="hdlist1">
Rerun
</dt>
<dd>
<p>
The ability to start from the beginning of a set of tasks in a workflow and rerun all the steps even if the workflow has been run before.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>It is a good idea for all workflow-compliant services to support all these actions, even if the action doesn&#8217;t "do anything" (e.g., no support for Revert). That will make supporting them easier over time.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>All these actions <em>should</em> have an associated URL and an associated FORM. The first three actions apply to each step (referred to here as a <em>task</em>) within a workflow. The last two items apply to the complete set of tasks (called a <em>job</em>).</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_shared_state">7.1.2.2. Shared state</h5>
<div class="paragraph"><p>Two other actions that are needed for workflow-compliant service interfaces are:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
ReadState
</dt>
<dd>
<p>
The ability to load up related state properties for use by each <em>task</em> in the <em>job</em>.
</p>
</dd>
<dt class="hdlist1">
WriteState
</dt>
<dd>
<p>
The ability to store the related state properties for use by other <em>tasks</em> within the same <em>job</em>.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>See <a href="#workflow-state">[workflow-state]</a> for details on how to handle shared state for HTTP workflows.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Both actions need an associated URL that points to a shared HTTP resource. This resource URL should be passed to each <em>task</em> in the workflow. It is up to each service to know how to recognize state values in the state resource and, when needed, update existing properties or add new properties to the state resource. Often, the properties in this resource are used to fill in the FORMS exposed by the composable service&#8217;s actions.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For an example of a generic workflow engine via a job control language, see <a href="#workflow-jobs">[workflow-jobs]</a>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect4 xxx">
<h5 id="_correlation_ids_for_tasks_and_jobs">7.1.2.3. Correlation IDs for tasks and jobs</h5>
<div class="paragraph"><p>Each workflow job and each task within that job needs unique identifiers, typically a UUID or some other globally unique value. The <code>jobID</code> value should be used as the correlation identifier. This can be passed in the HTTP <code>correlation-id</code> header. The <code>taskID</code> value should be used as the request identifier. This can be passed in the HTTP <code>request-id</code> header. Like the <code>correlation-id</code>, the <code>request-id</code> should be included in both the HTTP request and the HTTP response.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The <code>correlation-id</code> and <code>requestid</code> headers are not standard, registered header values. Your organization might use some other header values or possibly even a different way to properly track workflow jobs and tasks. Whatever your organization does, the key to success is consistency and good documentation.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Workflow-compliant services support both <code>correlation-id</code> for the job and <code>request-id</code> for each task in the job.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_56">7.1.3. Example</h4>
<div class="paragraph"><p>Consider a composable service that computes sales taxes for a shopping cart of goods. This service (along with other workflow-compliant services) can be used as a task in a job to handle checking out from a shopping site. The following is an imaginary DSL example of what that might look like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** Checkout Job
***
READ sharedState WITH urlState
EXECUTE shoppingCartService-&gt;checkOutForm WITH sharedSTATE
IF-NOT-OK EXIT
EXECUTE salesTaxService-&gt;applyTaxesForm WITH sharedSTATE
IF-NOT-OK EXECUTE shoppingCartService-&gt;revertCheckoutForm WITH sharedSTATE
STORE sharedState WITH urlState
EXIT
***
*** End Job</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the <code>sharedState</code> is loaded into the client application. That application then attempts to execute the <code>shoppingCartService&#8594;checkOutForm</code> and the <code>salesTaxService&#8594;applyTaxesForm</code>, and then store the resulting <code>sharedState</code>. Note the support for the <code>shoppingCartService&#8594;revertCheckoutForm</code> in case something goes wrong when applying the sales taxes.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_58">7.1.4. Discussion</h4>
<div class="paragraph"><p>Any service interface that offers an action that writes data to the shared state <em>should</em> offer a way to reverse that action. This may be as simple as restoring the old values in the shared state resources (as in our <code>applySalesTax</code> example) or as complex as launching another job to undo some set of steps related to the action that needs to be reversed. See <a href="#workflow-jobs">[workflow-jobs]</a> for more discussion on handling related jobs.</p></div>
<div class="paragraph"><p>Service interfaces for each task <em>should</em> support calls to Repeat  and Revert  even if the Execute action has not yet been called. For example, calls to Revert <em>should not</em> result in an error (unless the actual revert action experiences a problem). This means services should "know" whether the Execute  action has been previously completed. If yes, the calls to Revert will likely require some processing. If the Execute  action was not yet completed, calls to Revert  should just return <code>200 OK</code> without any processing. Think of Revert  like a <code>DELETE</code> action. Deleting an already-removed resource doesn&#8217;t create any new problems, so a return of <code>200 OK</code> is an acceptable response.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Revert Them All</div>
<div class="paragraph"><p>If any task  fails or times out (e.g., reaches <code>taskMaxTTL</code>), the <em>job</em> is invalid and the <span class=".keep-together">Cancel</span> action should be called. This should result in a call to Revert  all the tasks in the job. This vastly simplifies implementing cross-service rollbacks or undo (see <a href="#workflow-undo">[workflow-undo]</a>).</p></div>
</div></div>
<div class="paragraph pagebreak-before less_space"><p>Support for the Repeat  of an action should be easy to handle since (as discussed in <a href="#design-idempotent">[design-idempotent]</a>) all service actions should be idempotent. If you find you&#8217;re having trouble safely repeating an action, you probably have a nonidempotency problem to <span class=".keep-together">untangle</span>.</p></div>
<div class="paragraph"><p>Support for shared state means that each job has a state document that is passed between tasks within the job. It might seem like a better idea to use a database record for shared state, but it is not. Shared state should be supported as a standalone HTTP resource that supports idempotent updates and possibly varying representation media types. This is the only set of properties that should be shared between services in a job. See <a href="#design-state-transfer">[design-state-transfer]</a> for more on this topic.</p></div>
<div class="paragraph"><p>If there are many steps in a job (some of which might take lots of time), and that job gets stopped for some reason (e.g., problems with one of the tasks that needs to be fixed by a person), then the ability to Continue where the job left off is very useful. It can save time and computing resources.</p></div>
<div class="paragraph"><p>Support for the Rerun action is handy when you want to force-restart a job that has multiple tasks. For example, you might find that after running a job, you notice that the results are not quite what you expected. You might be able to fix some state information and then rerun the complete job to get the proper results.</p></div>
<div class="paragraph"><p>Although not covered here, you can create job <em>templates</em> where the tasks are the same but the contents of the shared state resource vary. This makes it possible to quickly define and run jobs based on configuration data (via the shared state resource). If you plan to do a lot of this kind of work, see <a href="#workflow-jobs">[workflow-jobs]</a> for an example of a generic RESTful job control language that makes defining and running jobs easier.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_58">7.1.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#data-proxy">[data-proxy]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state">[workflow-state]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-jobs">[workflow-jobs]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-state">7.2. Supporting Shared State for Workflows</h3>
<div class="paragraph"><p>Workflow-compliant services need to support the ability to share state properties between services. This recipe defines a simple and effective way to share state without the need to share domain-specific data or data models.</p></div>
<div class="sect3">
<h4 id="_problem_58">7.2.1. Problem</h4>
<div class="paragraph"><p>How can you design services to safely share data between each other without creating unnecessary tight coupling to data models or domain-specific service information? What does a minimum design for shared state look like?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_58">7.2.2. Solution</h4>
<div class="paragraph"><p>The most straightforward way to share data between services is to use a <em>shared state resource</em>. This is a standalone HTTP resource that contains all the data related to a workflow job. Each workflow-compliant service that is responsible for a task in the job should be able to read and, in some cases, write to that shared state resource.</p></div>
<div class="paragraph"><p>Usually, this shared state resource is used by services as a source for filling in HTTP FORMS that describe an action (e.g., <code>onboardNewUser</code>). Sometimes, the results of an action (e.g., <code>applySalesTax</code>) are written to the shared state resource.</p></div>
<div class="paragraph"><p>Once the job is completed, this shared state resource should be archived for possible later reference.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This shared state resource is not the same as the workflow progress resource (see <a href="#workflow-progress">[workflow-progress]</a>). You will need both when implementing a robust HTTP workflow system.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>An easy way to create shared state resources is to use a unique identifier (usually the job identifier) as the public URL of the resource:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>&lt;link rel="sharedState" href="http://api.example.org/shared-state/u7y6t5r4e3 /&gt;</code></pre>
</div></div>
<div class="paragraph"><p>This URL should be passed around with each HTTP request and response related to the job being executed.</p></div>
</div>
<div class="sect3">
<h4 id="_example_57">7.2.3. Example</h4>
<div class="paragraph"><p>You can pass the URL for the shared state resource as part of the HTTP header <span class=".keep-together">collection</span>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /onboarding/job1
Accept: application/vnd.collection+json
Link: &lt;http://api.example.org/state/q1w2e3r4t5&gt;&gt;;rel="sharedState"

**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
Length: XX

{"collection" : {
  {"title": "Pricing Update Job q1w2e3r4t5",
  "links" : [...],
  "items" : [...]
}}</code></pre>
</div></div>
<div class="paragraph"><p>Or you can pass the shared state URL as part of the message body:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /onboarding/job1
Accept: application/vnd.collection+json

**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
Length: XX

{"collection" : {
  {"title": "Pricing Update Job q1w2e3r4t5",
  "links" : [
    {"rel": "sharedState", "href": "http://api.example.org/state/q1w2e3r4t5"}
  ],
  "items" : [...]
}}</code></pre>
</div></div>
<div class="paragraph"><p>The shared state resource can be "primed" with data before the job is started. For example, if you are running a job to update the prices of a select set of items in your warehouse, you can load an array of product identifiers along with price increase information into the shared state resource:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Shared State for Job ID q1w2e3r4t5"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"read, sharedState"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://api.example.org/shared-state/q1w2e3r4t5"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"create, sharedState"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://api.example.org/shared-state/q1w2e3r4t5/form"</span><span style="color: #FF0000">}</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"filter, sharedState"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://api.example.org/shared-state/q1w2e3r4t5/search"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">],</span>
  <span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"pid-00122356"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://api.example.org/shared-state/q1w2e3r4t5#pid-00122356"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"currentPrice"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"10"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"updatedPrice"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"11"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"state"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"pending"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span> <span style="color: #FF0000">""</span><span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Once the document is loaded, the job can be started. Here is the pseudocode:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>FOR-EACH item in http://api.example.org/shared-state/q1w2e3r4t5
  updatePrice(item)
END-EACH</code></pre>
</div></div>
<div class="paragraph"><p>In this case, the <code>item</code> is read, the function (<code>updatePrice</code>) uses the item data to look up the product in the catalog, and (assuming the <code>currentPrice</code> agrees with the one in the shared state document) the <code>updatedPrice</code> is applied. The shared state document is then modified to indicate the status of the work (e.g., from <code>pending</code> to <code>completed</code>), and any notes are supplied in <code>text</code> (e.g., "applied successfully" or "currentPrice does not agree," etc.).</p></div>
<div class="paragraph"><p>Each time the job completes a loop and modifies the shared state document, it should write the updated document to the same URL (using an idempotent HTTP <code>PUT</code>). This will make sure to most accurately record the state of the work in progress. This makes it easy to support the progress resource (see <a href="#workflow-progress">[workflow-progress]</a>) and helps in diagnosing any problems encountered along the way (see <a href="#workflow-help">[workflow-help]</a>).</p></div>
<div class="paragraph"><p>Once the work is completed, the resulting shared state resource can be archived for later reference.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_59">7.2.4. Discussion</h4>
<div class="paragraph"><p>In the preceding example, the data properties (<code>currentPrice</code>, <code>updatedPrice</code>, <code>status</code>, and <code>text</code>) must be semantic identifiers that are agreed upon ahead of time. This is typically handled through a shared vocabulary (see <a href="#design-vocabularies">[design-vocabularies]</a>).</p></div>
<div class="paragraph"><p>Note that in the preceding example, the task was described using idempotent language. For example, the target property of the change is expressed as <code>updatedPrice</code> and not <code>percentIncrease</code>. This makes supporting repeating and reverting changes much easier.</p></div>
<div class="paragraph"><p>You might think a simple name-value pair document is all that is needed for your shared state resource. This may work, but it is much better to include lots of metadata to help services keep track of what work needs to be done and how much has been completed. Whenever possible, make your shared state resource a full-fledged HTTP resource, not just a serialized data file.</p></div>
<div class="paragraph"><p>Often, you will need to use the shared state document as a source for filling in a data input form for another service. The easiest way to do this is to write a <em>mapping</em> function that takes the form and the shared state data as inputs, and applies the shared state properties to the form automatically:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sharedState <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRead</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"http://api.example.org/state/q1w2e3r4t5"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> inputForm <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpRead</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"http://api.example.org/users/onboardingform"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> completedForm <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">propertyMap</span></span><span style="color: #990000">(</span>sharedState<span style="color: #990000">,</span> inputForm<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> results <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">httpExecute</span></span><span style="color: #990000">(</span>completedForm<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>One of the advantages of the shared state recipe is that, over time, you can add new state data to the document without needing to update any existing services that rely on the resource. Each service can use the contents of the state resource as it sees fit. This loosens the coupling between the services and the state, and leads to a more configuration-based kind of implementation.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_59">7.2.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-state-transfer">[design-state-transfer]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-local-identifiers">[services-local-identifiers]</a>
</p>
</li>
<li>
<p>
<a href="#data-extend">[data-extend]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-code">7.3. Describing Workflow as Code</h3>
<div class="paragraph"><p>When you want to enlist multiple service interfaces to compose a single solution, you need some way to describe the list of services and the ways they can interact. There are multiple approaches. This recipe shows the simplest method: source code behind a solution interface.</p></div>
<div class="sect3">
<h4 id="_problem_59">7.3.1. Problem</h4>
<div class="paragraph"><p>What is the least complicated way to compose a solution with multiple existing independent service interfaces using service component source code? When does it make sense to use source code instead of some other, more abstract and flexible approach?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_59">7.3.2. Solution</h4>
<div class="paragraph"><p>When you have a rather simple workflow solution and/or one that will not change over time and does not support customization, it usually makes sense to describe that workflow solution using source code within a single service interface. That means creating an interface that has all the features of your desired solution and then, behind the interface, using source code to enlist and execute other remote services to complete the work.</p></div>
<div class="paragraph"><p>In this way, you present a stable, straightforward API for the consumer applications and allow yourself maximum design and build flexibility behind that stable interface. Over time, the enlisted services might change their own APIs or you might replace one service (e.g., the <code>taxComputation</code> service) with another one (e.g., <code>newTaxComputation</code>). As long as you do not change the external interface, you can make substantial changes to the internal implementation without breaking your promise to the solution consumers. See <a href="#services-model-leaks">[services-model-leaks]</a> for details.</p></div>
</div>
<div class="sect3">
<h4 id="_example_58">7.3.3. Example</h4>
<div class="paragraph"><p>Consider an organization that needs to support an onboarding workflow for new employees. Let&#8217;s also assume that, independently, multiple parts of the organization have online services that support their team&#8217;s responsibilities. That means you have a set of valuable service interfaces you can use to compose a solution in source code.</p></div>
<div class="paragraph"><p>One source code solution that gathers the needed inputs and then calls a set of external services to handle the work might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span>TK check code—ma<span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">// provide input screens to gather important data</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> stateData <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">collectInputs</span></span><span style="color: #990000">(</span>personalData<span style="color: #990000">,</span> backgroundCheck<span style="color: #990000">,</span>
      healthInsurance<span style="color: #990000">,</span> salaryDetails<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// execute work in parallel</span></span>
Promise<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">([</span><span style="font-weight: bold"><span style="color: #000000">apiPersonalData</span></span><span style="color: #990000">(</span>stateData<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #000000">apiBackgroundCheck</span></span><span style="color: #990000">(</span>stateData<span style="color: #990000">),</span>
    <span style="font-weight: bold"><span style="color: #000000">apiHealthInsurance</span></span><span style="color: #990000">(</span>stateData<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #000000">apiSalaryDetails</span></span><span style="color: #990000">(</span>stateData<span style="color: #990000">)])</span>
  <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">then</span></span><span style="color: #990000">((</span>results<span style="color: #990000">)</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">emitSuccessResponse</span></span><span style="color: #990000">(</span>results<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #0000FF">catch</span></span><span style="color: #990000">(</span>error <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">emitFailedResponse</span></span><span style="color: #990000">(</span>results<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, the required inputs are collected and then a set of parallel calls are made to external service interfaces to handle each required task in the workflow. The successful results are then returned to the caller using either the <code>emitSuccessResponse(results)</code> method or, if there were any processing or network problems, via the <code>emitFailedResponse(results)</code> method.</p></div>
<div class="paragraph"><p>The internal code can be exposed via HTTP as follows:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>*** REQUEST ***
GET /onboarding/jobs/
Accept: text/html
Link: &lt;http://webapicookbook.com/profiles/jobs&gt;;rel=profile
...

*** RESPONSE ***
200 OK
Content-Type: text/html
Link: &lt;http://webapicookbook.com/profiles/jobs&gt;;rel=profile
...

&lt;html&gt;
  ...
  &lt;h1&gt;Onboard New Employee&lt;/h1&gt;
  &lt;form name="submit-job" action="/onboarding/q1w2e3r4" method="put"&gt;
  ...
  &lt;/form&gt;
&lt;/html&gt;

*** REQUEST ***
PUT /onboarding/jobs/q1w2e3r4
Content-Type: application/x-www-form-urlencoded
Accept: text/html
Link: &lt;http://webapicookbook.com/profiles/jobs&gt;;rel=profile

jobID=q1w2e3r4&amp;...

*** RESPONSE ***
202 Accepted
Content-Type: text/html
Link: &lt;http://webapicookbook.com/profiles/jobs&gt;;rel=profile

&lt;html&gt;
  ...
   &lt;h1&gt;Job q1w2e3r4&lt;/h1&gt;
   &lt;div name="progress"&gt;
      &lt;span id="jobStatus"&gt;pending&lt;/span&gt;
      ...i
      &lt;a href="..." rel="refresh"&gt;Check Job Status&lt;/a&gt;
   &lt;/div&gt;
&lt;/html&gt;</code></pre>
</div></div>
<div class="paragraph"><p>In this HTTP exchange, the API consumer requests the resource that supplies the FORM inputs for describing an onboarding job. Then, after filling in the FORM, it is submitted to the URL (supplied in the form) that will execute the job. Notice that <code>202 Accepted</code> is returned by the workflow engine while the job is in process.</p></div>
<div class="paragraph"><p>The API consumer can use the <code>refresh</code> URL to monitor the status of the job, and eventually, the response will be either a <code>200 OK</code> or a 4xx/5xx status code indicating the completion of the job run.</p></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_discussion_60">7.3.4. Discussion</h4>
<div class="paragraph"><p>Note that this example uses the javascript <code>promise.all()</code> construct. That assumes all the services can run in parallel and they don&#8217;t have a fixed sequence. If you need to implement a workflow that has one or more sequential steps, you should treat each fixed step as <em>separate</em> workflow elements (see <a href="#workflow-compliant">[workflow-compliant]</a> for details).</p></div>
<div class="paragraph"><p>The work of collecting inputs can be handled using <a href="#workflow-wip">[workflow-wip]</a> and/or <a href="#workflow-partial-submit">[workflow-partial-submit]</a>.</p></div>
<div class="paragraph"><p>Errors can be tricky. In some cases, you may need to support a <em>rollback</em> option to undo the work already completed within the workflow. See <a href="#workflow-undo">[workflow-undo]</a> for a way to support the "undo" option in your workflows.</p></div>
<div class="paragraph"><p>While using source code is a common way to solve network workflow problems, it has its limits. For example, any changes to the workflow will likely require additional rounds of design, code, test, and deployment. Depending on your resource availability (e.g., money and time), changes can become costly bottlenecks in your workflow.</p></div>
<div class="paragraph"><p>Even when you have sufficient resources, using source code as your workflow language can result in many one-off solutions that are not easily reusable (e.g., <code>onboar&#x2060;d&#x200b;Employee</code>, <code>onboardPartTimeEmployee</code>, <code>onboardTemporaryWorker</code>, etc.). If you need to add customizations to existing solutions and/or want to create more robust workflows, check out Recipes <a href="#workflow-dsl">7.4</a> and <a href="#workflow-document">7.5</a>. For a more complex, but more flexible solution, see <a href="#workflow-jobs">[workflow-jobs]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_60">7.3.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-model-leaks">[services-model-leaks]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-dsl">[workflow-dsl]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-document">[workflow-document]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="workflow-dsl">7.4. Describing Workflow as DSL</h3>
<div class="paragraph"><p>When you are writing a lot of workflow solutions, relying on source code may not scale well. In these cases, it can be better to use a workflow-aware domain-specific language (DSL) to design, code, test, and deploy your solutions.</p></div>
<div class="sect3">
<h4 id="_problem_60">7.4.1. Problem</h4>
<div class="paragraph"><p>What does a workflow-aware DSL look like, and when does it make sense to use it instead of native code implementations? What are the advantages and challenges of supporting a workflow DSL for your organization?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_60">7.4.2. Solution</h4>
<div class="paragraph"><p>As mentioned in <a href="#workflow-code">[workflow-code]</a>, using native source code as your workflow language works well when you have rather straightforward solutions that  don&#8217;t require much customization and/or rarely change over time. However, in cases where your workflows need to be more flexible or when you need to support lots of workflow solutions within an organization, it is usually better to adopt an approach that assumes a workflow-aware environment that supports general workflow processes and lowers the barrier for creating, testing, and deploying them into production.</p></div>
</div>
<div class="sect3">
<h4 id="_example_59">7.4.3. Example</h4>
<div class="paragraph"><p>Here&#8217;s an example of handling the ordering and checkout of groceries using <a href="https://twitter.com/hyper_cli">HyperCLI</a>, a hypermedia DSL that I created for this book:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># complete grocery checkout

# load job config
CONFIG LOAD grocery.config
grocery.exitOnError = true

# load shared state
REQUEST WITH-URL $$sharedstateURL$$
STACK PUSH WITH-RESPONSE ##sharedState#

# get update cart
REQUEST WITH-URL $$scartURL$$
REQUEST WITH-FORM cartCheckout WITH-STACK
STACK PUSH WITH-RESPONSE ##sharedState##

# get shipping details
REQUEST WITH-URL $$shippingURL$$
REQUEST WITH-FORM bookShipping WITH-STACK
STACK PUSH WITH-RESPONSE ##sharedState##

# settle payment
REQUEST WITH-URL $$paymentURL$$
REQUEST WITH-FORM settlePayment WITH-STACK
STACK PUSH WITH-RESPONSE ##sharedState##

# update shared state
REQUEST WITH-URL $$sharedStateURL$$
REQUEST WITH-FORM updateState WITH-STACK

# end job</code></pre>
</div></div>
<div class="paragraph"><p>In this example, three tasks are completed (<code>cartCheckout</code>, <code>bookShipping</code>, and <code>settlePayment</code>). At the start and end of the script, the shared state is first loaded then, after it is updated by the three tasks, saved again. Note also the <code>grocery.config</code> file loaded at the start. This holds the various URLs needed to complete the job.</p></div>
<div class="paragraph"><p>A hypermedia DSL like the one shown in this example can streamline workflow authoring since many of the details (e.g., handling HTTP requests, locating and filling in forms in a response, etc.) are handled by the DSL directly. If you were using code (see <a href="#workflow-code">[workflow-code]</a>), you&#8217;d need to deal with this yourself (possibly through a shared code library).</p></div>
<div class="paragraph"><p>Alternatively, you can use shell scripting (MS-DOS, Linux bash, etc.) to do the same work. It takes a bit more effort but can be quite effective. You need to lean on a handful of utilities, like <code>cURL</code> for handling HTTP, <code>xslt</code> and/or <code>jq</code> for parsing XML and JSON, respectively, and a heavy dose of <code>grep</code>, <code>awk</code>, and other string manipulation tools.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_61">7.4.4. Discussion</h4>
<div class="paragraph"><p>DSLs can make it safer and easier to create workflow scripts since they constrain the possible actions due to the limited power of the language itself. This can also be a bit of a frustration for programmers who are used to a fully operational programming language like Java, NodeJS, etc.</p></div>
<div class="paragraph"><p>Using shell scripting and utilities offers more power and flexibility than a dedicated DSL like the one shown in this example, but with great power comes great responsibility. It may be harder to craft a safe, effective shell script and you are more likely to introduce bugs along the way.</p></div>
<div class="paragraph"><p>Whether you use a dedicated DSL or pull together your own using command-line shell scripting, expressing workflow as script, can reduce the turnaround time it takes to code, test, and deploy your workflow solutions.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_61">7.4.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-local-identifiers">[services-local-identifiers]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-code">[workflow-code]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-document">[workflow-document]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-document">7.5. Describing Workflow as Documents</h3>
<div class="paragraph"><p>The most robust and resilient way to describe service workflow is using declarative documents. This recipe provides an example of what a declarative, document-based workflow language looks like.</p></div>
<div class="sect3">
<h4 id="_problem_61">7.5.1. Problem</h4>
<div class="paragraph"><p>You want to describe workflow in a declarative way—one that does not involve a step-by-step execution plan, but instead, describes all the work to be done and allows document consumers to decide how to accomplish the work. What does that document look like? What are the required elements of such a document, and what are the limits to using this approach to supporting workflow in a hypermedia environment?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_61">7.5.2. Solution</h4>
<div class="paragraph"><p>The best way to describe workflow in a declarative way is to create a workflow vocabulary (see <a href="#design-vocabularies">[design-vocabularies]</a>) that outlines the properties and actions needed to fulfill all the requirements of a workflow-compliant service, as defined in <a href="#workflow-compliant">[workflow-compliant]</a>. That means supporting both tasks and jobs as well as supporting shared state. The documents also need to make it easy for consumers and producers to use <code>correlation-id</code> and <code>request-id</code> headers to track and manage the work being done.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>For more on how to describe and enable declarative workflow, see <a href="#workflow-jobs">[workflow-jobs]</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Declarative documents for workflow include all the necessary properties and actions (see the example) needed to carry out the work. These documents are typically expressed as HTTP resources (e.g., <em>http://api.example.org/jobs/q1w2e3r4</em>). They may also be expressed as messages in a queue (see <a href="#workflow-scaling">[workflow-scaling]</a>). This is especially useful if the number and/or rate of jobs to process is large, or the traffic for job processing is sporadic, tends to cause bottlenecks, or experience wait times.</p></div>
</div>
<div class="sect3">
<h4 id="_example_60">7.5.3. Example</h4>
<div class="paragraph"><p>The following is a sample document that describes a workflow job following the recommendations of <a href="#workflow-compliant">[workflow-compliant]</a> (in an HTML representation):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Shopping Checkout Workflow<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Shopping Checkout Workflow<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"job"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobID"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>q1w2e3r4t5<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobStatus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>working<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobDateCreated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:00<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobDateUpdated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:30<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobMaxTTL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>300<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobDescription"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Job<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobSharedStateURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Shared State<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobProgressURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Shared State<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobSuccessURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Success<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobFailedURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Failed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobContinueURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Continue<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobRestartURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Restart"<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobCancelURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Cancel"<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"tasks"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskID"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>p0o9i8u7y6<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskStatus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDateCreated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:00<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDateUpdated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:30<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskMaxTTL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>60<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDescription"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>ComputeTaxes<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskMessage"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Success (200)<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Task<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskStartURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Start<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskRollbackURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Rollback<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskRerunURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Rerun<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskCancelURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Cancel<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        ...
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskID"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>u8y7t6r5e4<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskStatus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>pending<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDateCreated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:00<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDateUpdated"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>2023-02-23:14:00:30<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskMaxTTL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>60<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskDescription"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Schedule Shipping<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Task<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskStartURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Start<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskRollbackURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Rollback<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskRerunURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Rerun<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskCancelURL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Cancel<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>This document/vocabulary can be used by a <em>workflow-engine</em> application to handle all the details of running and monitoring the job. See <a href="#workflow-jobs">[workflow-jobs]</a> for more on how to handle each action element.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_62">7.5.4. Discussion</h4>
<div class="paragraph"><p>The advantage of using declarative documents for workflows is that you are separating the description details from the processing code. This makes it possible to change the code frequently and improve it over time without needing to change the document format or contents.</p></div>
<div class="paragraph"><p>Document-driven workflows are effective when you are dealing with workflow-compliant service interfaces, as described in this book. If you are trying to enlist non-compliant services, you probably need to use a DSL (<a href="#workflow-dsl">[workflow-dsl]</a>) or code (<a href="#workflow-code">[workflow-code]</a>) approach instead.</p></div>
<div class="paragraph"><p>Be careful to <em>not</em> introduce imperative-style step-by-step processing into your workflow documents. Elements like branching (<code>if..then..else</code>), variable-checking (<code>when $state.value==="13"</code>), and other similar constructs turn your declaration document into an imperative programming language. These decision elements should be kept within the <em>tasks</em> (the service being used) and not within the <em>job</em> document.  If you think you need this level of programming, you probably need to use a DSL (<a href="#workflow-dsl">[workflow-dsl]</a>) or maybe a code-based (<a href="#workflow-code">[workflow-code]</a>) approach instead.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_62">7.5.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-code">[workflow-code]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-document">[workflow-document]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-jobs">7.6. Supporting RESTful Job Control Language</h3>
<div class="paragraph"><p>One of the persistent challenges for creating multiservice workflows on the web is a consistent and robust language for describing and implementing workflow. This recipe provides a basic set of actions and metadata for orchestrating independent workflows on the open web.</p></div>
<div class="sect3">
<h4 id="_problem_62">7.6.1. Problem</h4>
<div class="paragraph"><p>When you have a lot of workflow processing to deal with, it can be helpful to implement a generic workflow engine that supports managing multiple jobs and tasks. What does it take to support a robust job control language (JCL), and how can you confidently mix and control independent service interfaces that might be running in various places across the web?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_62">7.6.2. Solution</h4>
<div class="paragraph"><p>As your use of workflow grows, you&#8217;ll need a consistent way to describe, manage, and execute those workflow jobs. I&#8217;ve already covered the basics of workflow-compliant, composable services (see <a href="#workflow-compliant">[workflow-compliant]</a>). Now, here&#8217;s a recipe that defines a robust and reliable JCL for the web.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>I&#8217;ve used various versions of this RESTful JCL recipe a number of times over the years, each tuned for local needs. What I&#8217;m including here is a generic recipe that takes into account lots of features used in the past, bringing them together in a single place. Feel free to tweak and adjust this recipe to fit your specific needs.</p></div>
</td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Wait, What About iPAAS?</div>
<div class="paragraph"><p>There are definitely other workflow platforms you can use to meet your interoperability needs. In the limited space we have here, I&#8217;ve chosen to focus on a hypermedia-driven solution since that is one that I rarely see in use, even though I&#8217;ve had great success with it in the past. Most other solutions result in hardcoding connections and parameter sharing while a REST-based approach achieves the same ends without the tightly coupled implementation.</p></div>
</div></div>
<div class="paragraph"><p>This recipe provides a basic set of actions and metadata for coordinating independent services on the open web. It also includes actions for managing (list, filter, add, update, and remove) job records. <a href="#fig0702">[fig0702]</a> shows the RESTful job control workflow.</p></div>
<div class="imageblock" id="fig0702">
<div class="content">
<img src="images/rwcb_0702.png" alt="images/rwcb_0702.png" width="80%" />
</div>
<div class="title">Figure 20. RESTful job control workflow</div>
</div>
<div class="sect4 xxx">
<h5 id="_executing_workflow_with_restful_jcl">7.6.2.1. Executing workflow with RESTful JCL</h5>
<div class="paragraph"><p>There are two key elements to defining and executing workflow records:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Tasks
</dt>
<dd>
<p>
A task is a single action in a workflow (<code>computeTaxes</code>, <code>DoCreditCheck</code>, <code>UpdateCustomerAccounts</code>, etc.) A task supports execute (<code>taskStartURL</code>), repeat (<code>taskRerunURL</code>), revert (<code>taskRollbackURL</code>), and cancel (<code>taskCancelURL</code>).
</p>
</dd>
<dt class="hdlist1">
Jobs
</dt>
<dd>
<p>
Each job contains one or more tasks. The set of tasks in each job <em>must</em> be able to run in parallel. A job supports restart (<code>jobRestartURL</code>), continue (<code>jobConti&#x2060;n&#x200b;ueURL</code>), and cancel (<code>jobCancelURL</code>). It also has a URL to call when the job completes successfully (<code>jobSuccessURL</code>) and when the job fails (<code>jobFailedURL</code>).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>To run a job, the job document should be submitted to a workflow engine. Upon receiving the document, the workflow engine will return a <code>202 Accepted</code> (see <a href="#workflow-accepted">[workflow-accepted]</a>) while the tasks are processed and will eventually return a <code>200 OK</code> or a 4xx/5xx HTTP status with the completed response. Upon completion of a job, that job document <em>may</em> be archived for future reference (or re-execution), and the appropriate link (<code>jobSuccessURL</code> or <code>jobFailedURL</code>) <em>should</em> be activated.</p></div>
<div class="paragraph"><p>Compliant workflow engines <em>must</em> be prepared to handle <code>jobCancelURL</code>, <code>jobConti&#x2060;n&#x200b;ueURL</code>, and <code>jobRestartURL</code>. They should also support <code>taskStartURL</code>, <code>taskRollbackURL</code>, <code>taskRerunURL</code>, and <code>taskCancelURL</code> properties, as well as monitor or update progress via <code>taskStatus</code> and <code>jobStatus</code>. The engines <em>should</em> also monitor the <code>jobMaxTTL</code> and <code>taskMaxTTL</code> values, and cancel jobs whenever the maximum runtime has been exceeded.</p></div>
<div class="paragraph"><p>Tasks that need to be run in a fixed sequence <em>must</em> be separated into individual job documents, and those job documents can be run in fixed order as each job successfully completes.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_managing_restful_jcl_records">7.6.2.2. Managing RESTful JCL records</h5>
<div class="paragraph"><p>Along with the work for <em>running</em> workflows, you also need to support authoring, filtering, and removing workflow documents. A handful of actions are included in this recipe to handle workflow document management:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>jobList</code>
</dt>
<dd>
<p>
Return a list of job records
</p>
</dd>
<dt class="hdlist1">
<code>jobFilter</code>
</dt>
<dd>
<p>
Search for job records
</p>
</dd>
<dt class="hdlist1">
<code>jobRead</code>
</dt>
<dd>
<p>
Return a single job record
</p>
</dd>
<dt class="hdlist1">
<code>jobCreate</code>
</dt>
<dd>
<p>
Add a new job record to the collection
</p>
</dd>
<dt class="hdlist1">
<code>jobUpdate</code>
</dt>
<dd>
<p>
Modify an existing job record
</p>
</dd>
<dt class="hdlist1">
<code>jobRemove</code>
</dt>
<dd>
<p>
Delete an existing job record
</p>
</dd>
</dl></div>
<div class="paragraph"><p>You&#8217;ll notice that this list does not include actions for adding, editing, and removing task records. In this case, the <code>jobItem</code> is the smallest manageable resource in the system. If you wish, you can implement another set of management actions (essentially applying <a href="#workflow-navigation">[workflow-navigation]</a>) at the task level. In my experience, this is rarely needed.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_shared_state_correlation_ids_and_progress">7.6.2.3. Shared state, correlation IDs, and progress</h5>
<div class="paragraph"><p>An element not shown here is support for passing state between tasks. See <a href="#workflow-state">[workflow-state]</a> for details on how to implement that.</p></div>
<div class="paragraph"><p>Another important element is sharing <code>jobID</code> and <code>taskID</code> via headers at runtime. As covered in <a href="#workflow-compliant">[workflow-compliant]</a>, each workflow-compliant service <em>must</em> share a <code>jobID</code> (as <code>Correlation-ID</code> header) and <code>taskID</code> (as <code>Request-ID</code> header) for every action within the job.</p></div>
<div class="paragraph"><p>Workflow-compliant services used for this recipe should support progress reporting (see <a href="#workflow-progress">[workflow-progress]</a>) and possibly the "call for help" pattern (<a href="#workflow-help">[workflow-help]</a>).</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_63">7.6.3. Discussion</h4>
<div class="paragraph"><p>RESTful JCL only works if all the services you enlist as tasks follow the rules laid out in <a href="#workflow-compliant">[workflow-compliant]</a>. The good news is you can implement workflow-compliant services without having to also support a full local job control language. RESTful JCL comes <em>after</em> authoring workflow-compliant services. If you&#8217;re just starting out on the road to workflow systems, consider focusing on compliant service interfaces first, then moving on to exploring JCL options.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Are You Sure You Want to Do This?</div>
<div class="paragraph"><p>Implementing a general job control system like the one described here is not a simple task. Existing alternatives to this recipe are available as off-the-shelf software and as online SAAS (software as a service) implementations. Choosing to "roll your own" JCL is a decision not to be made lightly. If you need to support multiple hosting platforms (including your own local servers), this recipe can be helpful. If, however, you are only hosting services that run on a single platform (e.g., AWS, Azure, Google, etc.), using their workflow tooling may be a better choice.</p></div>
</div></div>
<div class="paragraph"><p>Workflow authoring services <em>may</em> be separate from workflow execution services. The editor and the engine don&#8217;t need to be hosted within the same service interface. In fact, it can be advantageous to keep the editing work and the execution work separate since they can move forward at their own individual paces.</p></div>
<div class="paragraph"><p>The premise of this recipe is that you want to create workflows that take advantage of service interfaces you have not created and do not control (see <a href="#principles">[principles]</a>). Even if you are working with services built by other teams inside your own organization, RESTful JCL can improve your success in reusing existing services from other parts of the company.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe works well when you commit to describing your workflow as documents (<a href="#workflow-document">[workflow-document]</a>). It is much harder to pull off if you are relying on code (<a href="#workflow-code">[workflow-code]</a>) or DSL (<a href="#workflow-dsl">[workflow-dsl]</a>) to express workflow.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_see_also_63">7.6.4. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#services-vocabularies">[services-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-help">[workflow-help]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-progress">7.7. Exposing a Progress Resource for Your Workflows</h3>
<div class="paragraph"><p>When executing and monitoring workflow jobs, it is a good idea to offer up a progress report on the job so that API consumers and producers can see how things are going and what, if any, problems were encountered. This recipe provides an example progress resource you can use for your workflow implementations.</p></div>
<div class="sect3">
<h4 id="_problem_63">7.7.1. Problem</h4>
<div class="paragraph"><p>How can I keep an eye on long-running workflow jobs? Where can I go to monitor transaction details or check for errors? What does it take to create a general workflow progress resource that works whether you are describing your workflows using code (<a href="#workflow-code">[workflow-code]</a>), a DSL (<a href="#workflow-dsl">[workflow-dsl]</a>), or documents (<a href="#workflow-document">[workflow-document]</a>)?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_63">7.7.2. Solution</h4>
<div class="paragraph"><p>Like so many other solutions offered in this book, you can often solve your problem with an HTTP metadata resource (see Recipes <a data-type="xref" href="#services-preferences" data-xrefstyle="select:labelnumber">#services-preferences</a>, <a data-type="xref" href="#services-health" data-xrefstyle="select:labelnumber">#services-health</a>, and <a data-type="xref" href="#services-errors" data-xrefstyle="select:labelnumber">#services-errors</a>). In this case, we&#8217;ll create a workflow-progress resource that holds any and all execution data related to a workflow job and its tasks (see Recipes <a href="#workflow-compliant">7.1</a> and <a href="#workflow-jobs">7.6</a> for more on jobs and tasks for workflow).</p></div>
<div class="paragraph"><p>Every workflow job should have an associated progress resource. This resource can be tied to the job using the <code>jobID</code>, which is often the same as the <code>correlation-id</code> value stored in an HTTP header. That resource can be a collecting point for any progress reporting or other tracking for the job. You should track both the job metadata and the metadata for each task  in the job as they are executed. <a href="#fig0703">[fig0703]</a> illustrates the workflow progress.</p></div>
<div class="imageblock" id="fig0703">
<div class="content">
<img src="images/rwcb_0703.png" alt="images/rwcb_0703.png" width="80%" />
</div>
<div class="title">Figure 21. Workflow progress</div>
</div>
<div class="paragraph"><p>Important job metadata is:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>jobID</code>
</dt>
<dd>
<p>
Unique identifier for the job resource (often the <code>correlation-id</code>)
</p>
</dd>
<dt class="hdlist1">
<code>jobURL</code>
</dt>
<dd>
<p>
URL of the job resource document
</p>
</dd>
<dt class="hdlist1">
<code>jobDescription</code>
</dt>
<dd>
<p>
Human-readable text that describes the job
</p>
</dd>
<dt class="hdlist1">
<code>jobStatus</code>
</dt>
<dd>
<p>
Indicates job status (pending, working, completed, or failed)
</p>
</dd>
<dt class="hdlist1">
<code>jobDateCreated</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) the job resource was first created
</p>
</dd>
<dt class="hdlist1">
<code>jobDateUpdated</code>
</dt>
<dd>
<p>
Indicates the last date/time (UTC) the job resource was modified
</p>
</dd>
<dt class="hdlist1">
<code>jobMaxTTL</code>
</dt>
<dd>
<p>
Indicates the maximum amount of time (in seconds) this resource is considered valid
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Important task  metadata is:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>taskID</code>
</dt>
<dd>
<p>
Unique identifier for this task (often the <code>request-id</code>)
</p>
</dd>
<dt class="hdlist1">
<code>taskURL</code>
</dt>
<dd>
<p>
URL of the task resource
</p>
</dd>
<dt class="hdlist1">
<code>taskDescription</code>
</dt>
<dd>
<p>
Human-readable text that describes the task
</p>
</dd>
<dt class="hdlist1">
<code>taskStatus</code>
</dt>
<dd>
<p>
Indicates task status (pending, working, completed, or failed)
</p>
</dd>
<dt class="hdlist1">
<code>taskStartDateTime</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) the task started
</p>
</dd>
<dt class="hdlist1">
<code>taskStopDateTime</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) the task stopped
</p>
</dd>
<dt class="hdlist1">
<code>taskMaxTTL</code>
</dt>
<dd>
<p>
Indicates the maximum amount of time (in seconds) this task is considered valid
</p>
</dd>
<dt class="hdlist1">
<code>taskMessage</code>
</dt>
<dd>
<p>
Human-readable text that contains any messages related to the task
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The last item for each task (<code>taskMessage</code>) can contain multiple lines of progress reporting, such as each attempt to complete the task. Writing text lines into the <code>taskMessage</code> field is often sufficient for most monitoring needs. Another useful way to record that is to include the HTTP request details (URL, headers, and body) as well as the HTTP response details (HTTP status, headers, and body).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>If you include the HTTP details as part of your progress resource, you may be exposing a security leak. Make sure only duly authorized users can read this part of the progress resource.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can format the progress resource for display in any of the common media types (HTML, Collection+JSON, HAL, SIREN, UBER, etc.). When displaying the progress data, you should also include a refresh link and caching data to give the API consumer hints on the freshness of the resource.</p></div>
</div>
<div class="sect3">
<h4 id="_example_61">7.7.3. Example</h4>
<div class="paragraph"><p>Here is a sample progress resource formatted in Collection+JSON:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">****</span> REQUEST <span style="color: #990000">****</span>
GET <span style="color: #990000">/</span>jobs<span style="color: #990000">/</span>q1w2e3r4t5<span style="color: #990000">;</span>progress
Accept<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>collection<span style="color: #990000">+</span>json
<span style="color: #990000">...</span>

<span style="color: #990000">****</span> RESPONSE <span style="color: #990000">****</span>
<span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>collection<span style="color: #990000">+</span>json
Link<span style="color: #990000">:</span> <span style="color: #990000">&lt;&lt;</span>http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//api.example.org/jobs/q1w2e3r4t5;progress&gt;&gt;; rel="refresh"</span></span>
Cache<span style="color: #990000">-</span>control<span style="color: #990000">:</span> max<span style="color: #990000">-</span>age <span style="color: #993399">10000</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">public</span></span>

<span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Job q1w2e3r4t5 Progress"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"refresh"</span><span style="color: #990000">,</span><span style="color: #FF0000">"href"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.example.org/jobs/q1w2e3r4t5;progress"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">],</span>
  <span style="color: #FF0000">"items"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"q1w2e3r4t5"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"job"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobID"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"q1w2e3r4t5"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobURL"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.example.org/jobs/q1w2e3r4t5"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobDescription"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Employee Onboarding Job"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobStatus"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"working"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobDateCreated"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2024-05-01:13:12:11"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobDateUpdated"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2024-05-01:13:15:14"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"jobMaxTTL"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"30000"</span><span style="color: #FF0000">}</span>
     <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"u8y7t6r5"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"task"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[...]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"5r4e3w2q"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"task"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[...]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"p0o9i8u7"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"task"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"taskID"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"p0o9i8u7"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"taskURL,</span>
<span style="color: #FF0000">        "</span>value<span style="color: #FF0000">":"</span>http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//api.example.org/jobs/q1w2e3r4t5#p0o9i8u7"},</span></span>
      <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"taskDescription, "</span>value<span style="color: #FF0000">":"</span>Credit Check<span style="color: #FF0000">"},</span>
<span style="color: #FF0000">      {"</span>name<span style="color: #FF0000">":"</span>taskStatus<span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"completed"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"taskStartDateTime, "</span>value<span style="color: #FF0000">":"</span><span style="color: #993399">2024</span><span style="color: #990000">-</span><span style="color: #993399">05</span><span style="color: #990000">-</span><span style="color: #993399">01</span><span style="color: #990000">:</span><span style="color: #993399">13</span><span style="color: #990000">:</span><span style="color: #993399">13</span><span style="color: #990000">:</span><span style="color: #993399">11</span><span style="color: #FF0000">"},,</span>
<span style="color: #FF0000">      {"</span>name<span style="color: #FF0000">":"</span>taskStopDateTime<span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2024-05-01:13:14:11"</span><span style="color: #FF0000">}</span><span style="color: #990000">,,</span>
      <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"taskMaxTTL, "</span>value<span style="color: #FF0000">":"</span><span style="color: #993399">5000</span><span style="color: #FF0000">"},</span>
<span style="color: #FF0000">      {"</span>name<span style="color: #FF0000">":"</span>taskMessage<span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span><span style="color: #990000">:</span><span style="color: #FF0000">"completed successfully."</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Note that in this example, only basic progress information is shared for each task (e.g., <code>"completed successfully"</code>). This reduces the chances of leaking personal data or other intellectual property that might be a breach of security.</p></div>
<div class="paragraph"><p>Once a job is completed, you should archive these progress records for later review, as needed.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_64">7.7.4. Discussion</h4>
<div class="paragraph"><p>The simple goal of workflow progress resources is to offer additional feedback to API callers as the jobs and tasks execute. For that reason, it is a good idea to keep workflow progress resources very basic. Don&#8217;t try to include too much data, and be sure to not include any internal or private programming information as this can constitute a security leak.</p></div>
<div class="paragraph"><p>Workflow progress resources <em>should not</em> be used as trace logs for your services, and they <em>should not</em> include any internal values and/or debugging information. If you need that kind of detail, use something available within your programming/platform internals, and do not expose that information via HTTP.</p></div>
<div class="paragraph"><p>You might be tempted to include several links in the progress document that allow the caller to restart a task, perform a rollback, or run other workflow management options. This is not a good practice. If you are using code (<a href="#workflow-code">[workflow-code]</a>) or DSL (<a href="#workflow-dsl">[workflow-dsl]</a>) to describe your workflow, these added features can cause conflict and confusion at runtime.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_64">7.7.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-preferences">[services-preferences]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-related">7.8. Returning All Related Actions</h3>
<div class="paragraph"><p>There are times when the list of possible actions is quite long. In some cases, there may be more than a dozen possible state transitions (links or forms) available from a single response. Returning all those forms (with default values filled in) for each request can be very costly and affect service response times.</p></div>
<div class="paragraph"><p>Instead of returning all possible state transitions on every request, you can create a  separate resource response that does that independently of the current workflow or state of the application. This reduces response payload size, increases response times, and standardizes a repeatable way to get an up-to-date list of available transitions.</p></div>
<div class="sect3">
<h4 id="_problem_64">7.8.1. Problem</h4>
<div class="paragraph"><p>For some applications, the possible number of state transitions (or links) at any single moment can be quite long. Common workflow interactions—like paging through a list (see <a href="#workflow-navigation">[workflow-navigation]</a>), for example—can have lots of valid possible actions at a single moment, such as <code>top</code>, <code>next</code>, <code>previous</code>, <code>last</code>, <code>item</code>, <code>create</code>, <code>refresh</code>, and <code>self</code>. That does not include any transitions to other collections or other related activities (<code>list-users</code>, <code>list-companies</code>, <code>list-reports</code>, etc.).</p></div>
<div class="paragraph"><p>Listing all these options with every response can be tedious and take up quite a bit of payload space. What is needed is a standardized way to ask for all the possible transitions as a separate step (e.g., a transition!) to reduce the payload size without reducing the available information.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_64">7.8.2. Solution</h4>
<div class="paragraph"><p>A simple way to solve the "too many links in the response" challenge is to expose a separate resource that always lists all the possible actions at any single moment in time for the application. You can do this via the <a href="https://oreil.ly/lQuev"><code>related</code> IANA link relation value</a>. Now, the service interface can be designed to offer helpful links within the body of the payload and then offer all the other possible links as a separate resource (see the example).</p></div>
<div class="paragraph"><p>An advantage of this approach is that the service behind the interface can take into account various context-related variables when assembling the contents of the <code>related</code> resource. This includes the state of the data behind the service (is data available right now?), the state of application processing (is the service in maintenance mode?), the state of the client application (is the client in the middle of a set of actions?), and even the calling context identity (is the logged-in user an admin?).</p></div>
<div class="paragraph"><p><a href="#fig0704">[fig0704]</a> is a simple diagram of the <code>related</code> link that you can add to each response. See the "Example" section for details.</p></div>
<div class="imageblock" id="fig0704">
<div class="content">
<img src="images/rwcb_0704.png" alt="images/rwcb_0704.png" width="80%" />
</div>
<div class="title">Figure 22. Related workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_62">7.8.3. Example</h4>
<div class="paragraph"><p>By adding a <code>related</code> link to your response, you can "bury" the additional transitions that you don&#8217;t want to expose in the default response. In this example, the <code>self</code> transition is always added to responses. Now, there is also a <code>related</code> link that clients can use to get a more complete list of all the possible actions:</p></div>
<div class="listingblock">
<div class="title">Link to request related available actions</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "collection" : <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span>
        "rel" : "<span style="color: #FF0000">home self</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"$comment" : "<span style="color: #FF0000">link that points to the list of related actions</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">related</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example/org/related</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/list</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "queries": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "template": <span style="color: #990000">{</span> ... <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The <code>text/uri-list</code> IANA media type is an excellent format for returning lists of related links.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>When the client application follows the <code>related</code> link, the response returns a complete list of all the possible actions for the current calling context:</p></div>
<div class="listingblock">
<div class="title">List of requested related available actions</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "collection" : <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span>
        "rel" : "<span style="color: #FF0000">related</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"$comment" : "<span style="color: #FF0000">list of related available actions</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/list</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">filter</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/filter</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">create</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/create-form</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">needs-approval</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/list?status=needs-approval</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "queries": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "template": <span style="color: #990000">{</span> ... <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It is worth pointing out that in these two examples, the <code>list</code> link relation appears in both lists. There is no rule that says a link can occur in only one location. Also, the contents of the <code>related</code> resource can change over time. The list of links can reflect the current state of the service, the clients, and the user context.</p></div>
<div class="paragraph"><p>When service interfaces support the <code>related</code> pattern, client applications can easily be coded to "search" for a link or form that was not initially represented in the service interface response. For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// get root response and perform checkout</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> output <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">request</span></span><span style="color: #990000">(</span>apiRootUrl<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> link <span style="color: #990000">=</span> output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findLink</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"checkout"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>link <span style="color: #990000">===</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  link <span style="color: #990000">=</span> output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findLink</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"related"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>link <span style="color: #990000">!===</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      link output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findLink</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"checkout"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>link <span style="color: #990000">!===</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">runCheckout</span></span><span style="color: #990000">(</span>output<span style="color: #990000">,</span> stateVariables<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">runUnableToCheckout</span></span><span style="color: #990000">(</span>output<span style="color: #990000">,</span> stateVariables<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If you wish, you can also write API consumer code that "hides" the use of <code>related</code> behind a facade. Then all you need to write in the client code is <code>output.findLink("related");</code>, and the code can look in the local response first and, if needed, attempt to activate the <code>related</code> link to see if it can be found there.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_65">7.8.4. Discussion</h4>
<div class="paragraph"><p>This recipe is similar to <a href="#workflow-mru">[workflow-mru]</a> in that it helps to optimize link finding for client applications. Humans are really good at finding links and/or crafting their own from scratch, but machines are not. This recipe is a way to compensate for machine shortcomings without having to rely on some form of artificial intelligence.</p></div>
<div class="paragraph"><p>Using the <code>related</code> recipe makes sense when there are a lot of possible transitions at any given moment. Interface designers can focus on creating a usable set of responses without having to include all possible transitions for all possible responses. This reduces clutter and disagreements about just what links or forms should be included in responses.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_65">7.8.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-mru">[workflow-mru]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-mru">7.9. Returning Most Recently Used Resources</h3>
<div class="paragraph"><p>You can make it easier on API consumers when you include a list of the most recently used links/forms in your responses. This can help programmers better understand common uses of your service interface and make it easier for developers to access the common links they need to solve their problems.</p></div>
<div class="sect3">
<h4 id="_problem_65">7.9.1. Problem</h4>
<div class="paragraph"><p>It can be a challenge for developers and designers to agree on what links and forms should be returned in hypermedia responses. Designers typically try to create an interface that is both usable and useful. This usually means leaving some details out. Developers and architects often aim for "completeness" and want to include all possible options in each response (see <a href="#workflow-related">[workflow-related]</a>). What&#8217;s a good way to balance these two options and still include helpful links in responses? What happens if the kinds of links commonly needed by users change over time?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_65">7.9.2. Solution</h4>
<div class="paragraph"><p>This recipe is closely connected to <a href="#workflow-related">[workflow-related]</a>. That recipe offers a way to <code>stash</code> lots of related links in a separate document to keep the responses reasonably small, but still offer a way to access all the possible actions. However, if taken too far, most hypermedia responses will contain a single link (<code>related</code>), and now all clients need to do additional HTTP requests to get things done. Not a good idea. Instead, it can be helpful to keep track of the most recently used (MRU) resource links and include those in responses.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">A Window into MRUs</div>
<div class="paragraph"><p>The idea of identifying and exposing the most recently used application options became common with the graphical user interfaces of the '80s and '90s. As application menu options got longer, there was a move to improve the interface by reducing options presented to the user. Introducing the MRU pattern allowed applications to offer up the most recently edited documents, used commands, or even requested applications. This MRU concept is also used for caching services to keep track of most recently requested resources.</p></div>
</div></div>
<div class="paragraph"><p>This recipe can be used in conjunction with <a href="#workflow-related">[workflow-related]</a> to include additional links in commonly used responses. In this approach, the service interface can keep track of commonly requested resources and include a link to them in responses. For example, if client applications typically follow up a request for the <code>list</code> resource with a second request for the <code>add</code> resource, service interfaces can track that pattern and automatically include the <code>add</code> resource link as part of the <code>list</code> resource response.</p></div>
<div class="paragraph"><p>This tracking of commonly used resources can be done at the application level or user level. This makes it possible to customize the MRU list for the calling context—including the access rights of the logged-in user.</p></div>
<div class="paragraph"><p>Keeping track of MRUs for a context (service wide or consumer specific) takes a bit of work but is not very complicated. A history list of the recently requested resources is all that is needed. As each resource is requested, that link is placed in a list (URL and count). When it is time to represent a resource response, the service interface can consult the MRU listing and (after filtering for access context, if needed), inject the last most recent links into the response.</p></div>
<div class="paragraph"><p>Returning MRUs can reduce the reliance on <a href="#workflow-related">[workflow-related]</a> and help new developers learn the most common actions for the service. The list of MRUs is usually presented as normal links in the response (<a href="#fig0705">[fig0705]</a>). But you can also create an <code>mru</code> resource (similar to the <code>related</code> resource from <a href="#workflow-related">[workflow-related]</a>).</p></div>
<div class="imageblock" id="fig0705">
<div class="content">
<img src="images/rwcb_0705.png" alt="images/rwcb_0705.png" width="80%" />
</div>
<div class="title">Figure 23. MRU workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_63">7.9.3. Example</h4>
<div class="paragraph"><p>Here&#8217;s an example response (in Collection+JSON) that shows both the MRU link (<code>"name":"mru"</code>) and a few of the most recently used links (the ones with <code>rel</code> set to <code>mru</code>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>
  "collection" : <span style="color: #990000">{</span>
    "links": <span style="color: #990000">[</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">self</span>"<span style="color: #990000">,</span>
        "rel" : "<span style="color: #FF0000">home self</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"$comment" : "<span style="color: #FF0000">link that points to the MRU list</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">mru</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example/org/mru</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>"$comment" : "<span style="color: #FF0000">some MRU links in the response</span>"<span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">list</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">mru collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/list</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">pending</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">mru collection</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/list?status=pending</span>"
      <span style="color: #990000">},</span>
      <span style="color: #990000">{</span>
        "name": "<span style="color: #FF0000">home</span>"<span style="color: #990000">,</span>
        "rel": "<span style="color: #FF0000">mru home</span>"<span style="color: #990000">,</span>
        "href": "<span style="color: #FF0000">https://api.example.org/</span>"
      <span style="color: #990000">}</span>
    <span style="color: #990000">],</span>
    "items": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "queries": <span style="color: #990000">[</span> ... <span style="color: #990000">],</span>
    "template": <span style="color: #990000">{</span> ... <span style="color: #990000">}</span>
  <span style="color: #990000">}</span>
<span style="color: #990000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Services that support the MRU recipe should return at least the MRU link in every response. This reminds clients where they can go for additional details. It is also valid to return the first few MRUs (see the example) in responses. These included MRUs should reflect the current user context (e.g., the most recently used links by the currently logged-in user) as well as the current service context (e.g., the most recently used links that are valid at this time). Not all of the most recently used links might be valid at a given moment. For example, it might not be possible to query the list of customers while database maintenance is underway on the service.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_66">7.9.4. Discussion</h4>
<div class="paragraph"><p>The work of tracking the most recently used URLs can be handled by creating a simple first in, first out (FIFO) stack of a fixed length (I use a depth of three to five for most cases). After completing the request, you can add the URL value to the stack and, if needed, drop URLs off the "bottom" of the list as it grows too long.  Then you can just return this list of URLs in your response.</p></div>
<div class="paragraph"><p>Don&#8217;t try to "remember" too much about the previous requests. For example, it is not a good idea to include header information or attempt to derive the "intent" of the request with other metadata. Just keep the links and return those.</p></div>
<div class="paragraph"><p>The MRU pattern is a great way to help API consumers know which are the more frequent calls for your service. You can think of MRUs as a kind of "help" feature for novice users. You can implement them that way by offering a "toggle" option where consumers can turn MRUs on or off in responses. See <a href="#services-preferences">[services-preferences]</a> for a recipe that supports this kind of toggle option.</p></div>
<div class="paragraph"><p>You can also use <a href="#services-preferences">[services-preferences]</a> to hold a variable on how long the list of MRUs should be in each response. Typically returning three to five MRUs is more than enough and makes a good default value.</p></div>
<div class="paragraph"><p>It is a good idea to share the MRU values as simple links—not forms. This keeps down the amount of work the server-side code needs to do to include them and reduces the amount of content in the responses.</p></div>
<div class="paragraph"><p>When rendering the MRUs in your response, you can make things easy for API consumers by identifying the list using common link relation values (<code>"mru"</code>), a block within the response (<code>&lt;div id="mru"&gt;&#8230;&lt;/div&gt;</code>), or some other method common to the response format.</p></div>
<div class="paragraph"><p>It is not a good idea to return MRU values in HTTP headers (using a <code>link</code> element). The MRU list might get long and is best rendered in the body of the message. Alternatively, you can include a single <code>link</code> element that points to a standalone MRU list:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /users/list HTTP/1.1
Host: api.company.org
Accept: application/vnd.siren
Authentication: BASIC o9eir8tu5ry6362yeir...

**** RESPONSE ****
200 OK HTTP/1.1
Content-Type: application/vnd.siren
Link: &lt;https://company.org/users/mru&gt;;rel="mru"

...</code></pre>
</div></div>
<div class="paragraph"><p>If your service supports user identities, you can build in support for tracking MRUs by identity, too. This adds another level of customization to the response list.</p></div>
<div class="paragraph"><p>Even if you don&#8217;t want to keep track of the actual commonly used URLs, you can use the MRU recipe to return URLs that are likely to be handy, like the home URL or the collection list URL, etc.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_66">7.9.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-related">[workflow-related]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-wip">7.10. Supporting Stateful Work in Progress</h3>
<div class="paragraph"><p>There are times when you need to gather quite a bit of data from API consumers, and a single FORM resource is not enough. In these cases, a set of related steps for data collection and review is handy. This recipe offers a "work-in-progress" pattern for collecting data and submitting the final results.</p></div>
<div class="sect3">
<h4 id="_problem_66">7.10.1. Problem</h4>
<div class="paragraph"><p>How can you collect a large amount of data in small related chunks and then submit the collected result in a single step? What does the data collection involve with multiple people filling in the same resource? What if the collection process is expected to take a long time due to waiting on data from other parties?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_66">7.10.2. Solution</h4>
<div class="paragraph"><p>The work-in-progress (WIP) recipe is a great way to gather lots of data over a stretch of time before reviewing it and submitting the data collection for processing. A WIP approach lets you define a persistent "work document" and then, through a set of one or more interactions, continue to collect inputs until you have amassed a sufficient amount of data to submit to a service for processing.</p></div>
<div class="paragraph"><p>You can also use the WIP recipe to manage multiple document streams in flight. For example, you might need to start two or three WIP documents to complete a task like approving a customer for a credit purchase.</p></div>
<div class="paragraph"><p>Here is the list of actions in the WIP recipe:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>listWIP</code>
</dt>
<dd>
<p>
Go to the WIP list resource.
</p>
</dd>
<dt class="hdlist1">
<code>filterWIP</code>
</dt>
<dd>
<p>
Get a filtered list of WIP records.
</p>
</dd>
<dt class="hdlist1">
<code>createWIP</code>
</dt>
<dd>
<p>
Create a new WIP resource.
</p>
</dd>
<dt class="hdlist1">
<code>readWIP</code>
</dt>
<dd>
<p>
Retrieve a single WIP resource.
</p>
</dd>
<dt class="hdlist1">
<code>updateWIP</code>
</dt>
<dd>
<p>
Update a single existing WIP resource.
</p>
</dd>
<dt class="hdlist1">
<code>cancelWIP</code>
</dt>
<dd>
<p>
Cancel an existing WIP resource.
</p>
</dd>
<dt class="hdlist1">
<code>shareWIP</code>
</dt>
<dd>
<p>
Share/save an existing WIP resource.
</p>
</dd>
<dt class="hdlist1">
<code>submitWIP</code>
</dt>
<dd>
<p>
Submit (for final acceptance) a completed WIP resource.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The first two actions (<code>listWIP</code> and <code>filterWIP</code>) help in managing the list of WIP documents. The next handle the work of a single WIP document (<code>createWIP</code>, <code>readWIP</code>, <code>updateWIP</code>, and <code>cancelWIP</code>). <code>shareWIP</code> gives you the option of sending the <span class=".keep-together">document</span> to another user or machine for processing, and <code>submitWIP</code> supports sending the completed WIP document for processing.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Usually, this recipe is used in conjunction with <a href="#workflow-partial-submit">[workflow-partial-submit]</a>, which can be used to collect the input data.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><a href="#fig0706">[fig0706]</a> shows the WIP workflow.</p></div>
<div class="imageblock" id="fig0706">
<div class="content">
<img src="images/rwcb_0706.png" alt="images/rwcb_0706.png" width="80%" />
</div>
<div class="title">Figure 24. WIP workflow</div>
</div>
<div class="paragraph"><p>Take the example of employee onboarding. This may require lots of data entry from multiple parties and even the possibility of having to wait on approvals or some other data input that might not arrive for a day or two. You can use a WIP document to handle this process. You may need to collect employee data, inputs from human resource department interviews, the results of a background check from a third party, and details on an employment contract. You can use the WIP recipe to start a work document that will eventually hold all these inputs and share that with various parties within the organization to edit when they have data available. Eventually, someone with the proper authority can submit the completed data for final processing.</p></div>
</div>
<div class="sect3">
<h4 id="_example_64">7.10.3. Example</h4>
<div class="paragraph"><p>Here is an example that works through the employee onboarding scenario:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">****</span> REQUEST <span style="color: #990000">****</span>
GET <span style="color: #990000">/</span>onboarding<span style="color: #990000">/</span>
Accept<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #990000">****</span> RESPONSE <span style="color: #990000">****</span>
<span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Onboarding"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"listwip"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/"</span><span style="color: #FF0000">}</span>
    <span style="color: #990000">...</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Following the <code>listwip</code> link returns a list of any current WIP documents in progress:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">****</span> REQUEST <span style="color: #990000">****</span>
GET <span style="color: #990000">/</span>onboarding<span style="color: #990000">/</span>wip
Accept<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #990000">****</span> RESPONSE <span style="color: #990000">****</span>
<span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Onboarding WIP List"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"self"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"listwip"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"home"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
   <span style="color: #990000">],</span>
   <span style="color: #FF0000">"actions"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"createwip"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"method"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"fields"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
          <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"dateCreated"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"2024-MAY-30"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
          <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"wipowner"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Mandy Mayberry"</span><span style="color: #FF0000">}</span>
       <span style="color: #990000">]</span>
     <span style="color: #FF0000">}</span>
     <span style="color: #990000">...</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The <code>createwip</code> form can gather basic data like the date/time it was created and the user associated with creating the document, and then present an interface prompting for data collection. It might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">****</span> REQUEST <span style="color: #990000">****</span>
GET <span style="color: #990000">/</span>onboarding<span style="color: #990000">/</span>wip<span style="color: #990000">/</span>p0o9i8
Accept<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #990000">****</span> RESPONSE <span style="color: #990000">****</span>
<span style="color: #993399">200</span> OK
Content<span style="color: #990000">-</span>Type<span style="color: #990000">:</span> application<span style="color: #990000">/</span>vnd<span style="color: #990000">.</span>siren<span style="color: #990000">+</span>json

<span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Onboarding Mick Mickelsen"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"self"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"listwip"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"home"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"employee"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8/employee"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"interviews"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8/interviews"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"background"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8/background"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"contract"</span><span style="color: #990000">],</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8/contract"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
   <span style="color: #990000">],</span>
   <span style="color: #FF0000">"actions"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
     <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"cancelwip"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"method"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"DELETE"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8"</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"updatewip"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"method"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"fields"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"status"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"working"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
         <span style="color: #990000">...</span>
       <span style="color: #990000">]</span>
     <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"submitwip"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"method"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"PUT"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/onboarding/wip/p0o9i8"</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">"fields"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
         <span style="color: #FF0000">{</span><span style="color: #FF0000">"name"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"status"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"value"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"submitted"</span><span style="color: #FF0000">}</span>
       <span style="color: #990000">]</span>
     <span style="color: #FF0000">}</span>
     <span style="color: #990000">...</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph pagebreak-before less_space"><p>Notice that the body of the response contains the native WIP actions (<code>cancel</code>, <code>submit</code>, and <code>update</code>) and that the <code>link</code> section of the document includes several substeps for completing the process. Typically each step (<code>employee</code>, <code>interviews</code>, etc.) contains a form for inputs that supports the <code>updateWIP</code> action directly. In this way, each step is expressed as a resource that updates the shared state for that WIP document.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe has lots of variations and implementation options. Be sure to check out the "Discussion" section for hints on how to take advantage of this recipe.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In some cases, the work needs to be handled by some other party and that may mean sharing the WIP document. You can use the <code>shareWIP</code> action for that. Depending on how your implementation works, you might just change the "owner" property of this WIP document to allow it to appear in a new user&#8217;s list of things to process. Or you might generate an email asking someone to follow a link to complete the needed inputs. You might even generate a new resource for another system (e.g., a work ticket, etc.) and use an additional workflow to incorporate the new data into this WIP document.</p></div>
<div class="paragraph"><p>Eventually, someone needs to either select the <code>cancelWIP</code> or <code>submitWIP</code> action. Once this is done, the document can be queued for processing (see <a href="#workflow-accepted">[workflow-accepted]</a>) or be <span class=".keep-together">canceled</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_67">7.10.4. Discussion</h4>
<div class="paragraph"><p>The WIP recipe has lots of variations, and there aren&#8217;t many hints in <a href="#fig0706">[fig0706]</a>. My version has just the minimum elements, and you&#8217;ll need to enhance this recipe with others mentioned earlier.</p></div>
<div class="paragraph"><p>It is best not to get too intricate with field submissions for a WIP document. Too many dependent fields or fields that are required to be submitted together can turn a WIP workflow into a confusing stateful experience that is hard to understand, predict, or debug. Instead, make sure the service accepts <em>any</em> combination of inputs (or just one input at a time) for each <code>updateWIP</code> action. You can use the <code>submitWIP</code> action as a signal that the API consumer has completed their entry and is looking for input review.</p></div>
<div class="paragraph"><p>It can be tricky, but you can link WIP documents together to create multistep workflow without much complexity. Using the preceding example, links to each collection step (<code>employee</code>, <code>interviews</code>, etc.) could point to another WIP document (e.g., <code>interviewsWIP</code>). And that one could point to another, and so on. In this way, you can use the WIP recipe to implement a human-centric variable workflow system.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If you want to create more sophisticated machine-driven workflows, see <a href="#workflow-jobs">[workflow-jobs]</a> and <a href="#workflow-accepted">[workflow-accepted]</a> for approaches that are better suited for "headless" or automated multistep flows.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It&#8217;s a good idea to archive any completed (or even abandoned) WIP documents for future reference. You may even want to add support for reusing WIP documents in the future. See <a href="#workflow-replays">[workflow-replays]</a> for hints on how to implement a reuse pattern.</p></div>
<div class="paragraph"><p>The WIP model is a good way to implement, for example, a "ticketing" system for customer service, support, etc. You can make each set of data another resource for inputs, and display and automate the process of sharing WIPs (via <code>shareWIP</code>) based on the state of the document (e.g., fields that are still missing). This usually means establishing some checking logic within the service each time you submit data (via <code>updateWIP</code>):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> wipDocument <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">parseUpdateRequestBody</span></span><span style="color: #990000">();</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>wipDocument<span style="color: #990000">.</span>onboardingStatus <span style="color: #990000">=</span> <span style="color: #FF0000">"needs background check"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  wipDocument<span style="color: #990000">.</span>assignedTo <span style="color: #990000">=</span> <span style="color: #FF0000">"Moira"</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #000000">writeStoredItem</span></span><span style="color: #990000">(</span>wipDocument<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="paragraph"><p>You can use data points within each WIP document to help with filtering (via <code>filterWIP</code>) any outstanding documents. For example, you might add some metadata fields like <code>assignedTo</code>, <code>dueDate</code>, etc., and even automatically filter the complete list based on those fields. In this way you can create customized to-do lists for API consumers to work with.</p></div>
<div class="paragraph"><p>An easy implementation of this recipe is to just return a single WIP document with all the requested fields, possibly with dozens of inputs. For machine cases, this is not a problem at all, especially if you use <a href="#workflow-partial-submit">[workflow-partial-submit]</a> to collect the data. You can even use the single-document approach for human UI if you decorate the inputs in a way that results in a kind of "tabbed" interface (see <a href="#fig0707">[fig0707]</a>):</p></div>
<div class="listingblock pagebreak-before less_space">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;&lt;title&gt;</span></span>Onboarding Mick Mickelsen<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;&lt;/head&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"wip-actions"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"cancelWIP"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Cancel<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"updateWIP"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Update<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"submitWIP"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"..."</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Submit<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span> id="wip-inputs"&gt;
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"employee"</span> ... <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;submit</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"updateWIP"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"field1"</span> ... <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"field20"</span> ... <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"interviews"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;submit</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"updateWIP"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"field21"</span> ... <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"field37"</span> ... <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
     <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- other forms go here --&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In this example, each set of collected inputs is wrapped within an HTML FORM element that can be submitted to the WIP engine at any time. For humans, this might be rendered as shown in <a href="#fig0707">[fig0707]</a>.</p></div>
<div class="imageblock" id="fig0707">
<div class="content">
<img src="images/rwcb_0707.png" alt="images/rwcb_0707.png" width="80%" />
</div>
<div class="title">Figure 25. Human-centric HTML interface for WIP pattern</div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_see_also_67">7.10.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-contains">Recipe 6.4</a>
</p>
</li>
<li>
<p>
<a href="#workflow-navigation">[workflow-navigation]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-partial-submit">[workflow-partial-submit]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-replays">[workflow-replays]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-navigation">7.11. Enabling Standard List Navigation</h3>
<div class="paragraph"><p>Most service interfaces need to support list navigation options like getting the "next page," selecting an item from the list, etc. This recipe provides a simple pattern that can be applied to any exposed resource list.</p></div>
<div class="sect3">
<h4 id="_problem_67">7.11.1. Problem</h4>
<div class="paragraph"><p>What&#8217;s the best way to support paging through a long list of data?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_67">7.11.2. Solution</h4>
<div class="paragraph"><p>A good way to add "pagination" support to your service interface is to expose a fixed set of actions that can be applied to any resource list. This set of actions should include not only list navigation actions (first, previous, next, and last) but also actions to pick a particular item from the list and even exit the list navigation.</p></div>
<div class="paragraph"><p>Here is the list of actions your list navigation should support:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
List
</dt>
<dd>
<p>
Go to the list (usually, the start of the list).
</p>
</dd>
<dt class="hdlist1">
First
</dt>
<dd>
<p>
Move to the first page in the list.
</p>
</dd>
<dt class="hdlist1">
Previous
</dt>
<dd>
<p>
Move back to the previous page in the list.
</p>
</dd>
<dt class="hdlist1">
Next
</dt>
<dd>
<p>
Move forward to the next page in the list.
</p>
</dd>
<dt class="hdlist1">
Last
</dt>
<dd>
<p>
Move to the last page in the list.
</p>
</dd>
<dt class="hdlist1">
Select
</dt>
<dd>
<p>
Select an item from the list.
</p>
</dd>
<dt class="hdlist1">
Exit
</dt>
<dd>
<p>
Exit the list navigation.
</p>
</dd>
<dt class="hdlist1">
Home
</dt>
<dd>
<p>
Go to the "Home" resource (exiting the list).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>A common approach is to offer a link in the document with <code>rel="list"</code> or <code>rel="collection"</code> that "starts" the navigation process. The returned resource then includes links to support the other actions in the preceding list, including the ability to leave the list via <code>rel="exit"</code> and/or <code>rel="home"</code>. You don&#8217;t need to support both, but there may be cases where you can do some state cleanup and use <code>rel="exit"</code>.</p></div>
<div class="paragraph"><p>The <code>rel="select"</code> action makes it clear that API consumers can use that link to navigate to a single item resource. This is handy when not all members of the list support single reads. Think, for example, of a list of configuration values.</p></div>
<div class="paragraph"><p>You can enhance this recipe with <a href="#data-contains">[data-contains]</a> to add support for creating filtered lists. You can also use <a href="#workflow-partial-submit">[workflow-partial-submit]</a> to support editing or adding resources to the list. <a href="#fig0708">[fig0708]</a> shows the list navigation workflow.</p></div>
<div class="imageblock" id="fig0708">
<div class="content">
<img src="images/rwcb_0708.png" alt="images/rwcb_0708.png" width="80%" />
</div>
<div class="title">Figure 26. List navigation workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_65">7.11.3. Example</h4>
<div class="paragraph"><p>Usually, you&#8217;d see a resource that offers the ability to navigate a list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Manage Customers"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"home self"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"list collection"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Activating the <code>list</code> link then returns the <code>list</code> resource with accompanying actions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Customer List"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"self list collection"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"home"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"first"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/q1w2"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"next"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/t5y6"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"exit"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/p0o9"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">],</span>
  <span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
   <span style="color: #990000">...</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>In this example, we can assume this is the "first" page in the list. Note that the <code>previous</code> link is not offered here since there is no way to navigate before the start of the list. The <code>last</code> link is also missing. This is common in cases where the list is very long (thousands of records) and there is no easy way to compute the last page of a <span class=".keep-together">collection</span>.</p></div>
<div class="paragraph"><p>You&#8217;ll also notice that the <code>href</code> values for <code>first</code> and <code>next</code> are not semantically meaningful (e.g., "page1," page2," etc.). There is no need to offer link strings that humans can easily read. See the "Discussion" section for more on link values for navigation.</p></div>
<div class="paragraph"><p>The <code>exit</code> link here might point to a temporary resource that asks for confirmation of exiting the navigation (and maybe losing some collected state data). This is common when creating the list is costly and exiting would mean throwing away all that work. The <code>exit</code> link may also point to a resource that allows the API consumer to store, collect, or in some other way take advantage of accumulated state data (e.g., a list of selected records, the last one read, etc.).</p></div>
<div class="paragraph"><p>Here is a resource that might be returned once the end of the list is reached:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Customer List"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"self list collection"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/ht5r"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"home"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"first"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/q1w2"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"previous"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/t5y6"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"exit"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/p0o9"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">],</span>
  <span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
   <span style="color: #990000">...</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that there is no link for the <code>next</code> or <code>last</code> actions since they would be inappropriate here.</p></div>
<div class="paragraph"><p>Finally, if the navigation supports selecting or viewing individual resources from the list, you can use the <code>select</code> link identifier:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Customer List"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"self list collection"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/ht5r"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"home"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"first"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/q1w2"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"previous"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/t5y6"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"next"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/list/r4e3"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"exit"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/p0o9"</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">],</span>
  <span style="color: #FF0000">"items"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/aq1sw2de3"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"data"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #990000">...</span>
      <span style="color: #990000">],</span>
      <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"select item"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"/customers/aq1sw2de3"</span><span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_discussion_68">7.11.4. Discussion</h4>
<div class="paragraph"><p>Supporting lists usually seems easy at first—when the list is small. But the effort quickly ramps up as the list begins to grow. It is a good strategy to assume you are supporting a list with thousands of members and implement accordingly. Don&#8217;t assume it will be easy to access, filter, or display list contents. Do your best to limit the effort involved in responding to list requests, and you&#8217;ll avoid lots of problems.</p></div>
<div class="paragraph"><p>It is common to want to offer metadata controls that allow API consumers to control the list of each page of data (e.g., 50, 100, etc.). You can use client preferences (see <a href="#services-preferences">[services-preferences]</a>) to handle that. Be sure to always have a default value for page size, too. A reasonable value varies depending on the list of each resource returned in the list. Usually, 50 is a good start.</p></div>
<div class="paragraph"><p>When returning resources in a list, you don&#8217;t need to include the complete resource. Often it is a good idea to just return basic information like summary data, commonly used fields, and a link to a detailed view (via <code>select</code> links).</p></div>
<div class="paragraph"><p>Keep in mind it may be costly to generate a <code>list</code> resource. For example, listing all the computers connected to the server on the network might be a long process. In this case, you can compute partial lists—enough to complete a single page—and only compute the following pages if and when the API consumer asks for another one.</p></div>
<div class="paragraph"><p>It may seem like a good idea to support navigation that allows API consumers to "go to page 11" in your list. But this can be an expensive request. It assumes you already know the contents of the complete list. If you are listing all the users in a live chat room, that membership is likely to change frequently. Even in cases where the list is fixed, if it is quite long (thousands of items), you may be forced to spend vital runtime resources trying to navigate to page 133 in a list of 600 pages.</p></div>
<div class="paragraph"><p>You can enhance your list navigation support by adding search capabilities (see <a href="#data-contains">[data-contains]</a>). However, it can be difficult to navigate through a filtered list of data. If you offer this option, it may make sense to internally create a single snapshot of the filter collection, store it in memory, and use that in-memory list as your source for navigation. Of course, now you need to pay the cost of creating a complete filtered collection before you can offer the first page of data!</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_68">7.11.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-response">[data-response]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-mru">[workflow-mru]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-state-watch">[workflow-state-watch]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="workflow-partial-submit">7.12. Supporting Partial Form Submit</h3>
<div class="paragraph"><p>While input forms are a key element of any hypermedia-driven system, they can be tricky to navigate, especially for machines or automated processes. This recipe offers a simple, standard way to handle form input that reduces the chances for rejected inputs and runtime. This recipe was inspired by UX pioneer Donald Norman, who said, "Think of each action by the user as an attempt to step in the right direction."</p></div>
<div class="sect3">
<h4 id="_problem_68">7.12.1. Problem</h4>
<div class="paragraph"><p>Input forms, especially complex ones, can be difficult for users to successfully complete, especially when the user is a <em>machine</em> rather than a person. Features like dependent drop-down lists, detailed client-side validation, and just long lists of input increase the likelihood that the submission will be rejected by the server. How can you design and implement input forms that are easier to navigate and more likely to be completed successfully? How can you make input forms more "machine-friendly"?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_68">7.12.2. Solution</h4>
<div class="paragraph"><p>You can do a great deal to improve input forms by supporting the Partial Form Submit (PFS) recipe. The notion of PFS is that the forms can be submitted to the server even if they have not yet been completed. This allows the client application to fill in just parts of the form, save those inputs to the server, and then add more inputs along the way. Once all the inputs have been filled in, the client application can execute a "final submit"—telling the service that all inputs are complete and signaling the service to do any post-input processing.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is related to the work-in-progress (WIP) recipe (see <a href="#workflow-wip">[workflow-wip]</a>). But this recipe doesn&#8217;t support long-running (e.g., hours/days), multipage input processes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The PFS recipe is particularly useful for machine-driven client applications since they can submit one input field at a time and ask the server to validate and store that one input. This makes fixing validation errors much simpler for the machine-driven client. Implementing PFS means returning an input form with a collect of inputs and a set of submission options, including:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>partialSubmit</code>
</dt>
<dd>
<p>
Submit this form and hold on to the inputs. It is not yet complete.
</p>
</dd>
<dt class="hdlist1">
<code>resetSubmit</code>
</dt>
<dd>
<p>
Clear any inputs you have so we can start again.
</p>
</dd>
<dt class="hdlist1">
<code>refreshSubmit</code>
</dt>
<dd>
<p>
Return the current state of the form (including any supplied inputs).
</p>
</dd>
<dt class="hdlist1">
<code>cancelSubmit</code>
</dt>
<dd>
<p>
Cancel the input process completely and clear any inputs you have.
</p>
</dd>
<dt class="hdlist1">
<code>finalSubmit</code>
</dt>
<dd>
<p>
The client app is done supplying inputs; submit this for final processing.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>As each input is submitted (via <code>partialSubmit</code>), the service can check to make sure it contains valid content. If it does, the server should store the inputs and then return an updated form to the client application that includes the filled-in values as well as any remaining empty inputs. This continues until the client application selects <code>cancelSubmit</code> or <code>finalSubmit</code>. At any time, the client application can also use <code>resetSubmit</code> to reset the form and start the process form the beginning.</p></div>
<div class="paragraph"><p><a href="#fig0709">[fig0709]</a> shows the PFS workflow.</p></div>
<div class="imageblock" id="fig0709">
<div class="content">
<img src="images/rwcb_0709.png" alt="images/rwcb_0709.png" width="80%" />
</div>
<div class="title">Figure 27. Partial Form Submit workflow</div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_example_66">7.12.3. Example</h4>
<div class="paragraph"><p>Consider the following HTML input form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"search-users"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/users/filter"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"GET"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"type"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option&gt;</span></span>customer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option&gt;</span></span>prospect<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"region"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option&gt;</span></span>west<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option&gt;</span></span>south<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"name"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"salesRep"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"partialSubmit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"refreshSubmit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"resetSubmit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"cancelSubmit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"finalSubmit"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now, let&#8217;s assume that we have written an autonomic bot that looks for all the records where the <code>type</code> is set to "customers" and the <code>salesRep</code> value contains "Mork." This bot is pretty simple and fills in values one at a time before executing a <code>finalSubmit</code> action. So our bot would make the following three HTTP requests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /users/filter?type=customer&amp;submit=partialSubmit
GET /users/filter/?salesRep=Mork&amp;submit=partialSubmit
GET /users/filter/?submit=finalSubmit</code></pre>
</div></div>
<div class="paragraph"><p>As each input is sent individually, the service interface can perform validation and provide feedback. For example, if the bot tried to send <code>type=friend</code> as the first input, the service can send an HTTP 400 status response to help the client fix the problem and try again (via <code>refreshSubmit</code> to reload the form).</p></div>
<div class="paragraph"><p>Note that the PFS recipe does not assume <em>all</em> inputs are required to execute the <code>finalSubmit</code> action. Also, once <code>finalSubmit</code> has been sent, the service interface can still perform a validation that might result in a 400 HTTP status with corrective action required.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_69">7.12.4. Discussion</h4>
<div class="paragraph"><p>The key point of this recipe is to make it easy for users of any kind to submit data to the server. By separating "save my data" from "process this submission," you can simplify interactions and make it easier to fix errors in the input. This really pays off when you are using an automated client to submit that data.</p></div>
<div class="paragraph"><p>This recipe actually makes it harder to create input forms that require "dependent input validation." For example, it is difficult to support any rule that states, "If you select <code>customer</code> in <code>inputA</code>, you <em>must</em> not fill in any value for <code>inputB</code> and so forth." In this case, you can write code on the server that uses the <code>finalSubmit</code> action to validate these dependencies and return error messages with hints for solving the problem. If at all possible, you should avoid these cases, as they can be very difficult for automated clients to resolve.</p></div>
<div class="paragraph"><p>Since the server is returning the form each time with more inputs filled in, it is also possible for client applications to modify values for already-submitted fields. This is perfectly fine and can be especially handy for human users as they may recognize mistakes made earlier in the process.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_69">7.12.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-forms">[clients-forms]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-formats">[data-formats]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-mru">[workflow-mru]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-wip">[workflow-wip]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-accepted">[workflow-accepted]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-state-watch">7.13. Using State-Watch to Enable Client-Driven Workflow</h3>
<div class="paragraph"><p>While most recipes for workflow services focus on examples where the <em>service</em> knows the end goal through code (<a href="#workflow-code">[workflow-code]</a>), DSL (<a href="#workflow-dsl">[workflow-dsl]</a>), or document (<a href="#workflow-document">[workflow-document]</a>), there are times when the servers do not know what goal the API consumer (client) has in mind. In these cases, you can use this recipe to create a service workflow where the end goal is known by the client alone and the services provide information to help that client determine when the goal is reached.</p></div>
<div class="sect3">
<h4 id="_problem_69">7.13.1. Problem</h4>
<div class="paragraph"><p>There are times when the client application knows the desired end state and the services do not. In these cases, how do you design workflow to meet client (API consumer) needs? When is this client-driven goal applicable? What are the pitfalls of allowing client applications to "drive the workflow"?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_69">7.13.2. Solution</h4>
<div class="paragraph"><p>The solution to this problem of client-driven workflow was first mentioned in <a href="#clients-goals">[clients-goals]</a> when we talked about Defined End Goals (DEGs) and Defined State Goals (DSGs). This recipe focuses on how to enable DSGs. The key to making this work is making sure there is service interface support for sharing client-selected state variables. That means supporting a way for client applications to <em>tell services</em> what data to return.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">But GraphQL?!?</div>
<div class="paragraph"><p>The data-centric protocol <a href="https://graphql.org">GraphQL</a> is an excellent example of a platform that supports client-driven queries. I won&#8217;t be using GraphQL in my example here, but if you already have GraphQL in place in your technology mix, you can apply this recipe using that platform.</p></div>
</div></div>
<div class="sect4 xxx">
<h5 id="_what_is_state_watching">7.13.2.1. What is state-watching?</h5>
<div class="paragraph"><p>Consider an example where a client application (<code>temp03</code>) needs to monitor the temperature sensors in a large building. That client application "knows" a range of proper temperatures for, let&#8217;s say, the third floor of the building. It also knows that it needs to monitor the temperature sensors on that floor and operate the thermostat for the same zone. This means the client needs to get feedback on each <code>thermo-sensor</code> on the floor and access to control the <code>thermostat</code> as well.</p></div>
<div class="paragraph"><p>Now consider another application (<code>light03</code>) that needs to monitor movement on the same floor and turn on/off the overhead lights depending on whether people are moving around in the rooms. This application needs access to all the <code>motion-senors</code> and <code>light-switches</code> on the third floor.</p></div>
<div class="paragraph"><p>Finally, let&#8217;s assume there is a single building management service interface, one that supports access to all the sensors and all the actuators throughout the building. This is the service that <code>temp03</code> and <code>light03</code> "talk to" to do their work. The ideal situation is to have each client request only the data properties it is interested in monitoring and only returning the action elements (FORMS) that each application wants to access.</p></div>
<div class="paragraph"><p>Client applications need a way to tell the service what information it wants to see for each HTTP request response. This amounts to the client telling the service interface with state values it will "watch." Hence the name of this recipe: <em>state-watch</em>.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_is_this_watchable">7.13.2.2. Is this watchable?</h5>
<div class="paragraph"><p>To make this work, the service interface needs to be able to tell the API consumer just what data properties are "watchable"—which properties can be selected for inclusion in HTTP responses. This is essentially an instance of the list navigation recipe (<a href="#workflow-navigation">[workflow-navigation]</a>). Since that has been covered earlier, I won&#8217;t repeat the details here. For our purposes, let&#8217;s assume the list of available, watchable elements includes all the motion sensors, thermo-sensors, light switches and thermostats for the building. Let&#8217;s make this easier and assume that our application identity only has access to the element on the third floor of the building. That means making a call to the <code>watchList</code> will return available elements.</p></div>
<div class="paragraph"><p>Now we need to be able to tell the service just which elements on that list each client applications wishes to "see."</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_i_8217_ll_take_motion_sensors_for_the_third_floor_please">7.13.2.3. I&#8217;ll take motion sensors for the third floor, please</h5>
<div class="paragraph"><p>There are three ways a client application can signal the desired elements to monitor, each with their own advantages and drawbacks:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Query string
</dt>
<dd>
<p>
The simplest way to pass the list of watched elements is to include them as part of an HTTP query string. The advantage here is that it is a well-known and easily supported solution. The drawback is that the list may get quite long and risks complicating URL parsing for intermediates.
</p>
</dd>
<dt class="hdlist1">
HTTP prefer headers
</dt>
<dd>
<p>
RFC 7240 defines the <a href="https://oreil.ly/Fu5xQ"><code>Prefer</code> header</a>, which allows clients to pass metadata information about how the client prefers the service to modify the HTTP response body. The advantage is that this solution keeps the information out of the URL and has an established standard. The drawback is that there is currently no preference property defined (see <a href="https://oreil.ly/GW99A">HTTP Preferences</a>) for use with state-watch lists. However, you can apply to define one, if you wish, or use this header without registering a preference property.
</p>
</dd>
<dt class="hdlist1">
State-watch resource
</dt>
<dd>
<p>
Another solution is to define a state-watch resource to associate with client requests. In this case, a separate resource can be used to host the list of elements the service should return. A pointer to this resource can be shared via a <code>Link</code> header with the <code>rel="watch"</code> identifier. The advantage is that it is a clear and simple solution. The drawback is that it is a <em>separate</em> resource that both the API consumer and API provider must honor at runtime.
</p>
</dd>
<dt class="hdlist1">
Data query body
</dt>
<dd>
<p>
To prevent problems with long URLs, the state elements to watch can be passed as part of a request body. This is how GraphQL works. The advantage is that there is existing technology for doing this. The drawback is that it requires the use of an unsafe HTTP method (<code>PUT</code> or possibly <code>POST</code>), and this complicates caching, retries, and other issues.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>For various reasons, I recommend the state-watch resource solution. It is the most compatible with proper HTTP protocol usage and avoids the problems related to long lists of data properties. It also allows clients to set their preferences at the start of a workflow session and not have to resend those preferences until it is time to modify the list.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_state_watch_properties_resources_and_actions">7.13.2.4. State-watch properties, resources, and actions</h5>
<div class="paragraph"><p>Supporting the state-watch pattern involves the follow properties: resources and actions. State-watch properties include:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>watchElementID</code>
</dt>
<dd>
<p>
Unique identifier of a watch element
</p>
</dd>
<dt class="hdlist1">
<code>watchElementURL</code>
</dt>
<dd>
<p>
URL of a watch element
</p>
</dd>
<dt class="hdlist1">
<code>watchElementName</code>
</dt>
<dd>
<p>
Text name of a watch element
</p>
</dd>
<dt class="hdlist1">
<code>watchElementValue</code>
</dt>
<dd>
<p>
Current value of a watch element
</p>
</dd>
<dt class="hdlist1">
<code>watchElementTag</code>
</dt>
<dd>
<p>
Filter tag of a watch element
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Here are the state-watch resources:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>watchListResource</code>
</dt>
<dd>
<p>
Contains the list of all available watchable elements
</p>
</dd>
<dt class="hdlist1">
<code>watchResource</code>
</dt>
<dd>
<p>
Represents the list of <em>selected</em> watchable elements
</p>
</dd>
</dl></div>
<div class="paragraph"><p>State-watch actions include:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>doWatchClear</code>
</dt>
<dd>
<p>
Unsafe action to clear any selected watch elements
</p>
</dd>
<dt class="hdlist1">
<code>doWatchCreate</code>
</dt>
<dd>
<p>
Unsafe action to create a new list of selected watch elements
</p>
</dd>
<dt class="hdlist1">
<code>doWatchUpdate</code>
</dt>
<dd>
<p>
Unsafe action to update the current list of selected watch elements
</p>
</dd>
<dt class="hdlist1">
<code>goWatchList</code>
</dt>
<dd>
<p>
Safe action to return the list of available watchable elements
</p>
</dd>
<dt class="hdlist1">
<code>goWatchResource</code>
</dt>
<dd>
<p>
Safe action to return the list of selected watchable elements
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect3">
<h4 id="_typical_state_watch_interaction">7.13.3. Typical State-Watch Interaction</h4>
<div class="paragraph"><p>Using the state-watch resource option as a guide, the process of selecting and reporting to the server state elements the client prefers to watch would look like this:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client locates the <code>rel=watch</code> link for the service (see <a href="#workflow-related">[workflow-related]</a>).
</p>
</li>
<li>
<p>
The client selects the elements it wishes to watch.
</p>
</li>
<li>
<p>
The client uses the <code>updateWatchList</code> form and sends the list of watched elements to the service interface using a unique URL generated <em>by the API client</em>.
</p>
</li>
<li>
<p>
Now, on each request to the service (e.g., <code>listStates</code>), the status of each element is included in the response.
</p>
</li>
<li>
<p>
This continues until the client wishes to update (or clear) the <code>watchList</code>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>See <a href="#fig0710">[fig0710]</a> and the "Example" section for details.</p></div>
<div class="imageblock" id="fig0710">
<div class="content">
<img src="images/rwcb_0710.png" alt="images/rwcb_0710.png" width="80%" />
</div>
<div class="title">Figure 28. State-watch workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_67">7.13.4. Example</h4>
<div class="paragraph"><p>A service interface that supports the state-watch pattern can advertise this using an HTTP link header and/or a link within the body of a response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /building
Host: api.example.org
Accept: application/vnd.siren+json
...

**** RESPONSE ****
200 OK
Content-Type: application/vnd.siren+json
Link: &lt;&lt;http://api.example.org/building/elements/list&gt;&gt;; rel="watchList"
Link: &lt;&lt;http://api.example.org/building/selected;t6r5e4ed&gt;&gt;; rel="watchSelected"

{"class": ["building"],
  "links" : [
   {"rel" : ["self", "home"],
    "href": "/building"},
   {"rel" : ["watchList", "collection"],
    "href": "/building/elements/list"},
   {"rel" : ["watchSelected", "collection"],
    "href": "/building//building/selected;t6r5e4"}
  ],
  "properties": {...},
  "entities": {...}
}</code></pre>
</div></div>
<div class="paragraph"><p>Note that there are two links in the response related to the state-watch pattern. The first (<code>rel="watchList"</code>) is the list of available elements.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>It is important that each API consumer have its own associated <code>rel=watchSelected</code> resource. Generating this URL is mostly the responsibility of the API consumer (remember, the consumer is driving the workflow!). See the "Discussion" section for more on this topic.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Clients can use this to review and select elements to watch. The second link (<code>rel=watchSelected</code>) is the list of currently selected elements that are returned with each response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /building/elements/list
Host: api.example.org
Accept: application/vnd.siren+json

**** RESPONSE ****
200 OK
Content-Type: application/vnd.siren+json
Link: &lt;&lt;http://api.example.org/building/elements/list&gt;&gt;; rel="watchList"
Link: &lt;&lt;http://api.example.org/building/selected;t6r5e4ed&gt;&gt;; rel="watchSelected"

{"class": ["building"],
  "links" : [
   {"rel" : ["home"],
    "href": "/building"},
   {"rel" : ["self", "watchList", "collection"],
    "href": "/building/elements/list"},
   {"rel" : ["watchSelected", "collection"],
    "href": "/building/elements/selected"}
  ],
  "entities" : [
    {"class": ["watch", "element"],
     "properties": {
       "id": "q1w2e3r4",
       "href": "/building/elements/list/q1w2e3r4",
       "type": "thermo-sensor",
       "name": "ts-01",
       "location": "Third floor"
     },
     ...
    {"class": ["watch", "element"],
     "properties": {
       "id": "u8y7t6r5",
       "href": "/building/elements/list/u8y7t6r5",
       "type": "thermostat",
       "name": "stat-0301",
       "location": "Third floor"
     }
  ],
  "actions": [
    {
      "name": "select-elements",
      "title": "Select Elements",
      "method": "PUT",
      "href": "http://api.example.org/building//building/selected;t6r5e4",
      "type": "text/plain",
      "fields": [
        { "name": "elements", "type": "value": "q1w2e3r4,u8y7t6r5" }
      ]
    }
  ]
}</code></pre>
</div></div>
<div class="paragraph"><p>In this example, the client will send two elements to the <code>watchSelected</code> list (<code>q1w2e3r4,u8y7t6r5</code>). Now each response for the related resource (<code>/building/</code>) will include the actual status of these two elements:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /building
Host: api.example.org
Accept: application/vnd.siren+json
...

**** RESPONSE ****
200 OK
Content-Type: application/vnd.siren+json
Link: &lt;&lt;http://api.example.org/building/elements/list&gt;&gt;; rel="watchList"
Link: &lt;&lt;http://api.example.org/building/selected;t6r5e4ed&gt;&gt;; rel="watchSelected"

{"class": ["building"],
  "links" : [
   {"rel" : ["self", "home"],
    "href": "/building"},
   {"rel" : ["watchList", "collection"],
    "href": "/building/elements/list"},
   {"rel" : ["watchSelected", "collection"],
    "href": "/building/elements/selected"}
  ],
  "properties" {...},
  "entities": [
    {"class":["thermo-sensor"],"id":"q1w2e3r4","name":"ts-01","temp": "-3C"},
    {"class":["thermostat"],"id":"u8y7t6r5","name":"stat-0301","state": "off"},
    ...
  ],
  "actions": [...]
}</code></pre>
</div></div>
<div class="paragraph"><p>Note that the two selected elements have been included in the response to the <code>/building</code> resource. It is also possible to get just the list of selected elements:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>GET /building//building/selected;t6r5e4
Host: api.example.org
Accept: application/vnd.siren+json
...

**** RESPONSE ****
200 OK
Content-Type: application/vnd.siren+json
Link: &lt;&lt;http://api.example.org/building/elements/list&gt;&gt;; rel="watchList"
Link: &lt;&lt;http://api.example.org/building/selected;t6r5e4ed&gt;&gt;; rel="watchSelected"

{"class": ["watchSelected"],
  "links" : [
   {"rel" : ["home"],
    "href": "/building"},
   {"rel" : ["watchList", "collection"],
    "href": "/building/elements/list"},
   {"rel" : ["home", "watchSelected", "collection"],
    "href": "/building/selected;t6r5e4"}
  ],
  "properties" {...},
  "entities": [
    {"class":["thermo-sensor"],"id":"q1w2e3r4","name":"ts-01","temp": "-3C"},
    {"class":["thermostat"],"id":"u8y7t6r5","name":"stat-0301","state": "off"},
    ...
  ],
  "actions": [
   {"name": "updateWatchList", "method": "PUT", ...},
   {"name": "clearWatchList", "method": "DELETE", ...}
  ]
}</code></pre>
</div></div>
<div class="paragraph"><p>In this example, not only were the selected elements returned (with their current values), there are also two forms in the response. The <code>updateWatchList</code> action can be used to modify the watch list, and the <code>clearWatchList</code> action can be used to quickly clear all the elements from the watch list.</p></div>
<div class="paragraph"><p>Using our previous example of two API consumers (one watching temperatures and the other watching motion and lighting), we could construct another scenario.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_70">7.13.5. Discussion</h4>
<div class="paragraph"><p>The state-watch pattern works well when the API consumer needs to evaluate a small set of available data to make a decision and/or commit an action. Monitoring sensors of some type (temperatures, motion, liquids, etc.) is a good use case for the state-watch pattern.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is one of the more complicated ones in the collection. It requires both client and server to share a resource that&#8217;s created—at runtime—by the server based on input (unique ID) from the client. Both parties then need to be able to recall that URL when passing HTTP requests and responses.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Because the state-watch pattern relies on two key HTTP resources (the list of available elements to watch and the list of watched elements for each API client), you need to be clear on how to create a unique URL for the client&#8217;s selected elements. The details of the URL are not interesting, but you will need to be sure the client can generate a unique ID for its own <code>watchResource</code> (see <a href="#services-local-identifiers">[services-local-identifiers]</a>), and that the client can <em>remember</em> the URL and pass it to the service when appropriate. This last step usually means the service should return the URL with each response to that client (via HTTP headers and/or the body).</p></div>
<div class="paragraph"><p>In the examples shown here, the <code>updateWatchList</code> form uses a <code>text/plain</code> body to send a comma-delimited list of watched elements. You can use other serializations but will need to work out a way for client applications to know ahead of time how to parse the watch list responses.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_70">7.13.6. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#clients-state">[clients-state]</a>
</p>
</li>
<li>
<p>
<a href="#clients-goals">[clients-goals]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-progress">[workflow-progress]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-accepted">[workflow-accepted]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-replays">7.14. Optimizing Queries with Stored Replays</h3>
<div class="paragraph"><p>For systems that rely heavily on custom queries, this recipe offers a standardized way to create, manage, and execute stored queries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>You might have expected this recipe to appear in <a href="#data">[data]</a>. However, since this recipe involves several resources acting in concert, I decided to place it here in the workflow chapter.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_problem_70">7.14.1. Problem</h4>
<div class="paragraph"><p>Some queries are complex and/or expensive to run. Sometimes HTTP queries require extensive filtering parameters, resulting in a very long query string. Since most HTTP servers have a fixed limit on the length of a URL, complex queries may be misinterpreted as a security attack. What can you do to make storing and <em>replaying</em> those complex queries safe, cheap, and easy? Along the way, how can you better manage the list of collected queries, even implementing a simple sharing support to allow users or machines to author and then "publish" those complex queries for others to use?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_70">7.14.2. Solution</h4>
<div class="paragraph"><p>The first step to making complex queries safe and easy to use is to implement the query itself as a resource.  That means expressing the query details as an HTTP body and then using that message body to create a new <em>query resource</em> that can then be executed directly upon request. That&#8217;s step two, using the query resource URL to execute the query and return results in the response.</p></div>
<div class="sidebarblock less_space">
<div class="content">
<div class="title">Not All URLs Are Equal</div>
<div class="paragraph"><p>There is a slight trick buried in this recipe. API consumers need to know the URL for <em>executing</em> a query and may also need to know the URL for <em>editing</em> the query. See the "Example" section to see how this recipe handles this.</p></div>
</div></div>
<div class="paragraph"><p>Essentially, what you&#8217;re doing is creating a collection of query resources, and that collect needs to be managed, too. This recipe takes advantage of list navigation (<a href="#workflow-navigation">[workflow-navigation]</a>) to support listing, filtering, editing, and removing query resources.</p></div>
<div class="paragraph"><p>Finally, an optional element for this recipe is the <code>shareQuery</code> action. This allows you to support sending the query resource to someone else to use and/or set the "owner" of the query resource for future management.</p></div>
<div class="paragraph"><p>There is a collection of metadata associated with stored queries. You can use these values (and others, if you wish) to manage and track the queries that are created and replayed over time:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>identifier</code>
</dt>
<dd>
<p>
Unique identifier for the stored query.
</p>
</dd>
<dt class="hdlist1">
<code>URL</code>
</dt>
<dd>
<p>
URL of this delayed response document.
</p>
</dd>
<dt class="hdlist1">
<code>resourceQuery</code>
</dt>
<dd>
<p>
Complete (original) HTTP query.
</p>
</dd>
<dt class="hdlist1">
<code>cacheTTL</code>
</dt>
<dd>
<p>
How long (in milliseconds) the response should be cached by the client.
</p>
</dd>
<dt class="hdlist1">
<code>cachingDirectives</code>
</dt>
<dd>
<p>
Additional caching directives for the query.
</p>
</dd>
<dt class="hdlist1">
<code>description</code>
</dt>
<dd>
<p>
Human-readable text that describes this stored query.
</p>
</dd>
<dt class="hdlist1">
<code>owner</code>
</dt>
<dd>
<p>
Identifier (URL or text) of the identity that controls this query resource.
</p>
</dd>
<dt class="hdlist1">
<code>tags</code>
</dt>
<dd>
<p>
Free-form string space-separated values. Use this for filtering or otherwise grouping stored queries.
</p>
</dd>
<dt class="hdlist1">
<code>dateCreated</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) this replay resource was first created.
</p>
</dd>
<dt class="hdlist1">
<code>dateUpdated</code>
</dt>
<dd>
<p>
Indicates the last date/time (UTC) this replay resource was modified.
</p>
</dd>
<dt class="hdlist1">
<code>dateLastRun</code>
</dt>
<dd>
<p>
Indicates the last date/time (UTC) this stored query was executed.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>The <code>resourceQuery</code> property holds the full query string passed to the service when the query was created. This may be updated, too. The <code>cacheTTL</code> and <code>cachingDirectives</code> properties may contain details on the kind of caching metadata that should be returned with the query response. The <code>owner</code> and <code>tags</code> properties are handy for keeping track of management details like who is responsible for the resource and how you can group or filter this resource in the collection.</p></div>
<div class="paragraph"><p><a href="#fig0711">[fig0711]</a> shows the stored query replay workflow.</p></div>
<div class="imageblock" id="fig0711">
<div class="content">
<img src="images/rwcb_0711.png" alt="images/rwcb_0711.png" width="80%" />
</div>
<div class="title">Figure 29. Stored query replay workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_68">7.14.3. Example</h4>
<div class="paragraph"><p>This recipe has two distinct parts. The first part covers creating and replaying query resources. The second part covers managing the list of stored query resources.</p></div>
<div class="sect4 xxx">
<h5 id="_creating_and_replaying_query_resources">7.14.3.1. Creating and replaying query resources</h5>
<div class="paragraph"><p>The first action creates the query resource and stores it on the server. Here&#8217;s how that looks:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /queries/q1w2e3r4
Content-Type: application/x-www-form-urlencoded
Accepted: application/vnd.collection+json
Length: NN
If-Not-Match: "*"

type=customer&amp;region=south&amp;name=Andrews&amp;balance-is-great-then=10000
&amp;past-due-days-is-great-than=90&amp;salesrep=Mork

**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
Length: NN

{"collection" : {
  "title" : "Query Results",
  "metadata" : [
    {"name": "q-sent", "value": "type=customer&amp;region=south&amp;name=Andrews&amp; +
      balance-is-great-then=10000&amp;past-due-days-is-great-than=90&amp;salesrep=Mork"},
    {"name": "q-datetime", "value": "2024-12-12:00:12:0012TZ"},
    {"name": "q-status", "value": "sucess"},
    {"name": "q-seconds", "value": "120"},
    {"name": "q-count", "value": "100"},
  "links" : [...]
  "items" : [...]
}}</code></pre>
</div></div>
<div class="paragraph"><p>As you can see, the API consumer sent the complex query as a <code>PUT</code> to create the new resource (see <a href="#services-idempotent-create">[services-idempotent-create]</a> for details on this recipe). Assuming there are no problems, the service creates the new query resource, executes the query, and returns the results. You&#8217;ll also notice that the server has returned query metadata (see <a href="#data-metadata">[data-metadata]</a>) in the response. This is not a requirement but can be especially handy when relying on this reply recipe to execute queries.</p></div>
<div class="paragraph"><p>Now that the query is stored on the server, API consumers can call the query resource directly to replay the query:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
GET /queries/q1w2e3r4
Accept: application/vnd.collection+json
...

**** RESPONSE ****
200 OK
Cache-Control: public, max-age: 3600
ETag: "w/ki8ju7hy6gt5"
...

{"collection" : {
  "title" : "Query Results",
  "metadata" : [...],
  "links" : [...],
  "items" : [...]
}}</code></pre>
</div></div>
<div class="paragraph"><p>Here, the API consumer just needs to issue an HTTP <code>GET</code> (not <code>PUT</code>) to return the results. In this case, the service has "replayed" the stored query and returned updated results. Note also the use of the <code>Cache-Control</code> header to give the consumer directives on how long to hold the query locally. See <a href="#data-caching">[data-caching]</a> for more on this recipe.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_managing_stored_query_resources">7.14.3.2. Managing stored query resources</h5>
<div class="paragraph"><p>Creating and replaying stored queries is only part of this recipe. The other part involves managing the collection of stored queries. That means offering <code>list</code>, <code>filter</code>, <code>update</code>, and <code>remove</code> actions from <a href="#workflow-navigation">[workflow-navigation]</a>. In this recipe, I also introduce the optional <code>share</code> action.</p></div>
<div class="paragraph"><p>A good way to expose the management elements of the recipe is to include links in the query responses. They can be shipped as part of the media type body:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span><span style="color: #FF0000">"collection"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"Query Results"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"metadata"</span> <span style="color: #990000">:</span> <span style="color: #990000">[...],</span>
  <span style="color: #FF0000">"links"</span> <span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"list"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.company.org/queries/list"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"filter"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.company.org/queries/filter"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"update"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.company.org/queries/q1w2e3r4#update"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span><span style="color: #FF0000">"rel"</span><span style="color: #990000">:</span><span style="color: #FF0000">"share"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"href"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://api.company.org/queries/q1w2e3r4#share}</span>
<span style="color: #FF0000">  ]</span>
<span style="color: #FF0000">  "</span>items<span style="color: #FF0000">" : [...]</span>
<span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>The links can also appear as part of the HTTP headers collection. In the following example, the current user context only has permission to share this query, not edit or remove it or see the complete list:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** RESPONSE ****
200 OK
Content-Type: application/vnd.collection+json
Link: &lt;&lt;https://api.company.org/queries/q1w2e3r4#share&gt;&gt;; rel=share</code></pre>
</div></div>
<div class="paragraph"><p>I won&#8217;t go into the details of the <code>list</code>, <code>filter</code>, <code>update</code>, and <code>remove</code> actions here. Check out <a href="#workflow-navigation">[workflow-navigation]</a> for that. But I will add a comment here about the URLs shown in the preceding example. There&#8217;s a bit of a challenge when creating URLs for this recipe. We need a URL for <em>executing</em> the query, and we need a URL managing the query (e.g., read, edit, delete, and share).</p></div>
<div class="paragraph"><p>There are a few options available. The one I use is to modify the query resource URL to signal to the service which actions I intend. This might annoy some who don&#8217;t like to see verbs in URLs. If you wish, you can use a different URL for managing the query resource (e.g., <em>https://api.company.org/queries/list/q1w2e3r4</em>) than for executing it (<em>https://api.company.org/queries/q1w2e34</em>).</p></div>
<div class="paragraph"><p>The exact URL you use is up to you. Just remember that you&#8217;ll need to keep track of them at runtime and keep the API consumer informed of the differences in order to implement this recipe.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_71">7.14.4. Discussion</h4>
<div class="paragraph"><p>One of the big advantages of implementing the replay recipe is to solve the problem of very long query strings. I see lots of use of HTTP <code>POST</code> to support large query strings; while it works, you don&#8217;t get the advantage of caching on <code>POST</code>. The "create-a-query-resource-then-execute-it" works because you can return the URL of the new resource and do a simple <code>GET</code> on that instead. That way you get all the options of caching in the bargain.</p></div>
<div class="paragraph"><p>This recipe really pays off when you <em>replay</em> the queries later. If you don&#8217;t want to do that, you can skip implementing the resource management part completely and just support the <code>PUT</code>/<code>POST</code> create and execute part. In those cases, you can keep the created resources around for a short time and then just delete them. Later attempts to call those temporary URLs will just return an HTTP 410 error.</p></div>
<div class="paragraph"><p>The <code>owner</code> metadata is listed here but there is nothing to cover, just how to implement that feature. Typically, this gets folded into user or machine identities and related security issues. That is more than I cover in this edition of the book.</p></div>
<div class="paragraph"><p>Sharing queries is a way to make it easy for people to reuse existing resources. I often make all the replay queries "public" and include an interface that allows users or machines to select one or more of them and "claim" them for their own use. If you do this, you&#8217;ll need to deal with who can edit the reusable queries, and you might even need to implement a <code>copy</code> action to allow people to get a copy of their own to edit without changing the source query.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_71">7.14.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#clients-inputs">[clients-inputs]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#data-contains">Recipe 6.4</a>
</p>
</li>
<li>
<p>
<a href="#data-caching">[data-caching]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-accepted">7.15. Synchronous Reply for Incomplete Work <span class=".keep-together">with 202 Accepted</span></h3>
<div class="paragraph"><p>There are times when the work that needs to be completed may take some time. In these cases, HTTP (which relies on a synchronous request/response pattern) supports a <code>202 Accepted</code> response status. You can use this status to create a pattern that allows for delayed responses that may take hours or even days to resolve.</p></div>
<div class="sect3">
<h4 id="_problem_71">7.15.1. Problem</h4>
<div class="paragraph"><p>Sometimes you know ahead of time that a resource request is likely to take a long time to complete—more than a few seconds. In this case, you need to employ a "delayed response" pattern that tells the client, "This will take some time," and supplies enough metadata to allow the client to decide how to handle this delay. So, what does it take to establish and support this pattern? What metadata should be supplied to the client? What possible workflow options should be supported?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_71">7.15.2. Solution</h4>
<div class="paragraph"><p>In cases where the response to an HTTP request is likely to be delayed (take more than a few seconds), you can use a delayed response pattern. This is done by returning a <code>202 Accepted</code> status from the service along with metadata (via body and/or headers) that informs the client application of the status of the request, plus options to take additional action (like <code>refresh</code> or <code>cancel</code>).</p></div>
<div class="paragraph"><p>The initial response can be returned even before the requested work (e.g., save a record, compute a regression, etc.) is started. See the "Example" section for a typical response body and possible headers.</p></div>
<div class="paragraph"><p>Response bodies for the delayed response can include the following metadata:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>identifier</code>
</dt>
<dd>
<p>
Unique identifier for this delayed response
</p>
</dd>
<dt class="hdlist1">
<code>acceptedURL</code>
</dt>
<dd>
<p>
URL of this delayed response document
</p>
</dd>
<dt class="hdlist1">
<code>completedURL</code>
</dt>
<dd>
<p>
URL of the completed status resource
</p>
</dd>
<dt class="hdlist1">
<code>failedURL</code>
</dt>
<dd>
<p>
URL of the failed status resource
</p>
</dd>
<dt class="hdlist1">
<code>description</code>
</dt>
<dd>
<p>
Human-readable text that describes this document
</p>
</dd>
<dt class="hdlist1">
<code>refresh</code>
</dt>
<dd>
<p>
A value (in milliseconds) that represents the refresh interval
</p>
</dd>
<dt class="hdlist1">
<code>percentCompleted</code>
</dt>
<dd>
<p>
A value (0–100) of completion
</p>
</dd>
<dt class="hdlist1">
<code>status</code>
</dt>
<dd>
<p>
Indicates document status (pending, working, completed, or failed)
</p>
</dd>
<dt class="hdlist1">
<code>dateCreated</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) this delayed response was first created
</p>
</dd>
<dt class="hdlist1">
<code>dateUpdated</code>
</dt>
<dd>
<p>
Indicates the last date/time (UTC) this delayed response was modified
</p>
</dd>
<dt class="hdlist1">
<code>dateEstimated</code>
</dt>
<dd>
<p>
Indicates the date/time (UTC) this delayed request is expected to complete
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Common actions that may also appear include:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>goAccepted</code>
</dt>
<dd>
<p>
Navigate to the delayed response resource (safe)
</p>
</dd>
<dt class="hdlist1">
<code>doCancel</code>
</dt>
<dd>
<p>
Request to cancel this outstanding delayed task using <code>DELETE</code> (idempotent)
</p>
</dd>
<dt class="hdlist1">
<code>goCompleted</code>
</dt>
<dd>
<p>
Navigate to the completed resource (safe)
</p>
</dd>
<dt class="hdlist1">
<code>goFailed</code>
</dt>
<dd>
<p>
Navigate to the failed resource (safe)
</p>
</dd>
<dt class="hdlist1">
<code>goHome</code>
</dt>
<dd>
<p>
Navigate to the "Home" resource (safe)
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Some of this metadata can be returned using <code>Link</code> headers, too.</p></div>
<div class="paragraph"><p><a href="#fig0712">[fig0712]</a> shows an HTTP 202 Accepted workflow.</p></div>
<div class="imageblock" id="fig0712">
<div class="content">
<img src="images/rwcb_0712.png" alt="images/rwcb_0712.png" width="80%" />
</div>
<div class="title">Figure 30. 202 Accepted workflow</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_69">7.15.3. Example</h4>
<div class="paragraph"><p>A typical example of the delayed response pattern looks like the following.</p></div>
<div class="paragraph"><p>First, the API consumer sends a request to the service interface, and the service interface starts (or queues up) the work and returns a <code>202 Accepted</code> response:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
PUT /services/compute-results HTTP/1.1
Content-Type: application/vnd.collection+json
...

{"collection": {...}}

**** RESPONSE
202 Accepted HTTP/1.1
Content-Type: application/vnd.collection+json
Link: &lt;http://api.example.org/services/compute-results/q1w2e3&gt;;rel=self;
  refresh=60000
Link: &lt;http://api.example.org/services/cancel-form/q1w2e3&gt;;rel=cancel

{"collection":
  {
    "links": [
      {"rel":"self", "name":"acceptedURL",
      "href":"/services/compute-results/q1w2e3"}
    ],
    "items": [
      {
        "href": "/services/compute-results/q1w2e3",
        "data" : [
          {"name":"identifier", "value":"q1w2e3"},
          {"name":"description",
            "value":"Compute net present value for property"},
          {"name":"refresh", "value":"60000"},
          {"name":"percentCompleted", "value":"10"},
          {"name":"status", "value":"working"},
          {"name":"dateCreated", "value":"2024-02-01:22:11:00"},
          {"name":"dateUpdated", "value":"2024-02-01:22:11:00"},
          {"name":"dateEstimated", "value":"2024-02-01:22:15:00"}
        ]
      }
    ]
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>Next, the API consumer uses metadata in the response to periodically refresh the DR-Doc (delayed response document) to check the status of the work:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
GET /services/compute-results/q1w2e3 HTTP/1.1
Accepted: application/vnd.collection+json
...

**** RESPONSE
200 OK HTTP/1.1
Content-Type: application/vnd.collection+json
Link: &lt;http://api.example.org/services/compute-results/q1w2e3&gt;;rel=self;
  refresh=60000
Link: &lt;http://api.example.org/services/cancel-form/q1w2e3&gt;;rel=cancel

{"collection":
  {
    "links": [
      {"rel":"self", "name":"acceptedURL",
      "href":"/services/compute-results/q1w2e3"}
    ],
    "items": [
      {
        "href": "/services/compute-results/q1w2e3",
        "data" : [
          {"name":"identifier", "value":"q1w2e3"},
          {"name":"description",
            "value":"Compute net present value for property"},
          {"name":"refresh", "value":"60000"},
          {"name":"percentCompleted", "value":"75"},
          {"name":"status", "value":"working"},
          {"name":"dateCreated", "value":"2024-02-01:22:11:00"},
          {"name":"dateUpdated", "value":"2024-02-01:22:14:00"},
          {"name":"dateEstimated", "value":"2024-02-01:22:15:00"}
        ]
      }
    ]
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>Once the DR-Doc has a status of <code>completed</code> or <code>failed</code>, the API consumer follows the appropriate link:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST
GET /services/compute-results/q1w2e3 HTTP/1.1
Accepted: application/vnd.collection+json
...

**** RESPONSE
200 OK HTTP/1.1
Content-Type: application/vnd.collection+json
Link: &lt;http://api.example.org/services/npv/p0o9i8u7y6&gt;;rel=completed
Link: &lt;http://api.example.org/services/compute-results/q1w2e3&gt;;rel=self;
  refresh=60000

{"collection":
  {
    "links": [
      {"rel":"self", "name":"acceptedURL",
      "href":"/services/compute-results/q1w2e3"}
    ],
    "items": [
      {
        "href": "/services/compute-results/q1w2e3",
        "data" : [
          {"name":"identifier", "value":"q1w2e3"},
          {"name":"description",
            "value":"Compute net present value for property"},
          {"name":"percentCompleted", "value":"100"},
          {"name":"status", "value":"completed"},
          {"name":"dateCreated", "value":"2024-02-01:22:11:00"},
          {"name":"dateUpdated", "value":"2024-02-01:22:16:00"},
          {"name":"dateEstimated", "value":"2024-02-01:22:15:00"}
        ],
        "links": [
          {"rel":"completed", "href":"/services/npv/p0o9i8u7y6"}
        ]
      }
    ]
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>Finally, if available in the response, the API consumer may activate the <code>cancel</code> action to abandon the request.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_72">7.15.4. Discussion</h4>
<div class="paragraph"><p>The key to a successful delayed response implementation is to include as much metadata as possible in the interim responses. The most important is the <code>refresh</code> interval and the <code>status</code> value. <code>dateEstimated</code> and <code>percentCompleted</code> are also helpful values.</p></div>
<div class="paragraph"><p>Most API consumers will be unable to do much with an unexpected <code>202 Accepted</code> HTTP response from the service interface. For this reason it is important to tell API consumers ahead of time which actions might return a <code>202</code> status code. This should be done in the documentation of the interface itself.</p></div>
<div class="paragraph"><p>Not all DRs (delayed responses) will support the ability to cancel the request. If the underlying work is limited to handling a long computation (like our net present value example) or generating a long report, then supporting cancel is pretty straightforward. However, if the request involves changing state somewhere (writing a record, deleting or adding data for one or more existing records, etc.), then supporting the cancel option is more involved. See <a href="#workflow-undo">[workflow-undo]</a> for more on supporting the cancel option for RESTful web services.</p></div>
<div class="paragraph"><p>Depending on the representation format used in delayed document responses, the cancel action might be represented as an inline FORM or a link, or a link to a FORM. When implementing responses, be sure to follow the conventions for representing hypermedia actions in the body of the response.</p></div>
<div class="paragraph"><p>It can be tempting to use HTTP headers to contain lots of delayed response metadata, but it is best to keep header use to a minimum. This is especially true in cases where you want to communicate transient information like <code>percentCompleted</code>, <code>dateUpdated</code>, <code>status</code>, etc. Including variable data in headers complicates caching.</p></div>
<div class="paragraph"><p>The actual URL values used throughout the delayed response process (<code>acceptedURL</code>, <code>completedURL</code>, <code>failedURL</code>, or <code>cancelURL</code>) are not important. It is not important, for example, that the <code>acceptedURL</code> is the same as the <code>completedURL</code>.</p></div>
<div class="paragraph"><p>It is a good idea to keep the completed delayed response documentation in storage for at least some set period of time. They might come in handy for reporting, audit purposes, internal debugging, or some other needs.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_72">7.15.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#design-state-transfer">[design-state-transfer]</a>
</p>
</li>
<li>
<p>
<a href="#clients-representors">[clients-representors]</a>
</p>
</li>
<li>
<p>
<a href="#clients-hypermedia">[clients-hypermedia]</a>
</p>
</li>
<li>
<p>
<a href="#services-actions">[services-actions]</a>
</p>
</li>
<li>
<p>
<a href="#services-metadata">[services-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-wip">[workflow-wip]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-retry">7.16. Short-Term Fixes with Automatic Retries</h3>
<div class="paragraph"><p>There will be times when an HTTP request fails due to a network problem. Often, the network problem is temporary and will resolve itself within a matter of seconds. This recipe offers a structured way to build in "automatic retries" to your service interface that allows you to try the unsuccessful network call again before giving up and returning a 5xx HTTP error.</p></div>
<div class="sect3">
<h4 id="_problem_72">7.16.1. Problem</h4>
<div class="paragraph"><p>There are times when transient network errors or temporary outages will impede the completion of an HTTP request. What do you need to do to automatically retry the request in cases where the network problem is intermittent? How do you make sure that problems that persist (nontransient) don&#8217;t end up blocking your service requests entirely?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_72">7.16.2. Solution</h4>
<div class="paragraph"><p>The first thing to keep in mind when arranging to retry requests is that you need to make sure the request itself is <a href="https://oreil.ly/nuhwE">idempotent</a>. In HTTP, <code>GET</code>, <code>PUT</code>, and <code>DELETE</code> are designed as idempotent on the network. This is usually sufficient, but not always. See the "Discussion" section for details.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe, like <a href="#workflow-scaling">[workflow-scaling]</a>, deals with internal server-side programming details; all the elements here should be treated accordingly. This is not information that should be easily reachable on the web.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Second, you need to make sure to inspect the initial response to your request to determine if a retry is warranted. For example, if the response is an HTTP 4xx status (meaning a client-side problem), then retrying that same request without modification will not result in success. If the error condition is an HTTP 5xx status, it may be helpful to retry the same request. Finally, if the error happens at the local connection (e.g., "network connection lost"), then it makes sense to attempt a retry.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If you&#8217;d like to learn more about transient network problems and how to deal with them, check the article <a href="https://oreil.ly/al0cp">"Transient Fault Handling"</a> at Microsoft&#8217;s Azure documentation portal.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>There are a handful of options when it comes to handling transient network problems; some are better than others. The following are the reasonable possibilities, in order of preference, along with some comments:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Exponential backoff (EBO)
</dt>
<dd>
<p>
The best option is to try an exponential backoff or EBO retry. For example, after experiencing a failure, you can wait two seconds and try again. If that fails, wait 4 seconds, then 16. It is not a good idea to retry the same request more than three times (see the "Discusson").
</p>
</dd>
<dt class="hdlist1">
Incremental backoff (IBO)
</dt>
<dd>
<p>
You can also arrange an incremental backoff value (e.g., four seconds) for your repeated attempts. That means you&#8217;d first wait 4 seconds, then 8, then 16 before giving up.
</p>
</dd>
<dt class="hdlist1">
Regular interval retries (RIR)
</dt>
<dd>
<p>
You can get success by trying at the same regular interval (e.g., every three seconds). One of the downsides of this approach is that if there are multiple instances of the same service attempt retries at the same rate, you could be causing more problems than you think.
</p>
</dd>
<dt class="hdlist1">
Immediate retry (IR)
</dt>
<dd>
<p>
If the loss of network is very brief, it could make sense to immediately try again. This can work if the problem is happening at a gateway or some other cluster implementation that is using multiple machines to route the same request. If you use this option, be sure not to try it more than a couple of times since you&#8217;re really not giving much of a chance for network conditions to change.
</p>
</dd>
<dt class="hdlist1">
Randomized retry (RR)
</dt>
<dd>
<p>
Randomized retries can help avoid bottlenecks caused by IR and other options. In this case, you can generate a random wait time (keep it within 15 seconds) and try multiple times. The downside to this technique is that it might randomly generate long wait times (all 3 tries over 10 seconds apart) when all you really needed was to wait a couple of seconds for the network connection to be restored.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Once you settle on an option, you can set up your retry parameters in a configuration resource (see <a href="#services-preferences">[services-preferences]</a>). This resource should established for each service interface (or workflow task—see <a href="#workflow-compliant">[workflow-compliant]</a>). The exact metadata in the configuration depends on which method you choose (see the "Example" section), but here&#8217;s a list of important properties for a complete <code>retry</code> block:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>Method</code>
</dt>
<dd>
<p>
The retry option supported (EBO, IBO, RIR, IR, or RR)
</p>
</dd>
<dt class="hdlist1">
<code>Max-Retries</code>
</dt>
<dd>
<p>
The maximum number of times the request should be retried
</p>
</dd>
<dt class="hdlist1">
<code>Max-Wait-Seconds</code>
</dt>
<dd>
<p>
The maximum number of seconds to wait before a retry attempt
</p>
</dd>
<dt class="hdlist1">
<code>Starting-Value-Seconds</code>
</dt>
<dd>
<p>
The number of seconds to wait before the first retry attempt
</p>
</dd>
<dt class="hdlist1">
<code>Increment-Value-Seconds</code>
</dt>
<dd>
<p>
The number of seconds to wait for each incremental retry
</p>
</dd>
</dl></div>
<div class="paragraph"><p>If the retry attempts fail, the service should report the last HTTP status and request details received.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Keep in mind that the target service <em>might</em> assume your repeated attempts are a denial of service attack (see the "Discussion").</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You also need to make sure to record your attempts in a local log file for later review. You do not need to report this information to the workflow progress record (see <a href="#workflow-progress">[workflow-progress]</a>) since this is an internal detail that only service interface developers should see.</p></div>
</div>
<div class="sect3">
<h4 id="_example_70">7.16.3. Example</h4>
<div class="paragraph"><p>The following are example metadata properties you can use when recording retry options in a configuration file or other resource (see <a href="#services-preferences">[services-preferences]</a>). Here is an example of retry configuration values expressed in XML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- For EBO methods --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>EBO<span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;starting-value-seconds&gt;</span></span>2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/starting-value-seconds&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-retries&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-retries&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/retries&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- for IBO method --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>RIR<span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;increment-value-seconds&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/increment-value-seconds&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-retries&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-retries&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/retries&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- for RIR method --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>RIR<span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;starting-value-seconds&gt;</span></span>2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/starting-value-seconds&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;increment-value-seconds&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/increment-value-seconds&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-retries&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-retries&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/retries&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- for IR method --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>IR<span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-retries&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-retries&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/retries&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- for RR method --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>RR<span style="font-weight: bold"><span style="color: #0000FF">&lt;method&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-retries&gt;</span></span>3<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-retries&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;max-wait-seconds&gt;</span></span>10<span style="font-weight: bold"><span style="color: #0000FF">&lt;/max-wait-seconds&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/retries&gt;</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>The <code>retries</code> block shown here can be added to the existing client preferences document (see <a href="#services-preferences">[services-preferences]</a>) or some other configuration resource that the service uses. Be careful to <em>not</em> expose this internal information to unauthorized parties.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_73">7.16.4. Discussion</h4>
<div class="paragraph"><p>This recipe is designed to <em>hide</em> transient network problems and try to resolve them without disrupting the flow of traffic on the network. This has its downsides. You may be dealing with a regularly problematic connection  and never notice it unless you inspect your local service logs. For this reason, it&#8217;s a good idea to review your local logs often.</p></div>
<div class="paragraph"><p>It is important to remember that repeated attempts to execute the same request multiple times <em>might</em> be flagged as malicious behavior (e.g., a denial of service attack) by the target service. This includes making the exact same request as well as being the "source" for lots of repeated requests for various related URLs. Be conservative in setting up your automatic retries and do everything you can to act as a "good netizen."</p></div>
<div class="paragraph"><p>When logging retries, be sure to log them as warnings and not errors. Once the retries fail, you can report the last attempt as an error. This keeps your logs easier to read and process when you are just looking for retries, for example.</p></div>
<div class="paragraph"><p>If your log review shows the same services repeatedly causing retry attempts, consider fixing that connection (if you can) or replacing the service with something more <span class=".keep-together">reliable</span>.</p></div>
<div class="paragraph pagebreak-before less_space"><p>The EBO approach is handy for M2M interactions. They will not be bothered by the growing lag time between attempts. If you are coding a human-to-machine interface (e.g., a UI instead of an API), the better approach is to implement an IR retry and stop sooner.</p></div>
<div class="paragraph"><p>Keep in mind that any delays in making requests may get compounded by a long set of sequential actions. For example, if you have 3 sequential requests going through the same faulty gateway and your maximum wait time is 10 seconds for 3 attempts, those 3 requests might add up to as much as 90 seconds of delay. The only way to avoid this possibility is to rely on workflow-compliant services (see <a href="#workflow-compliant">[workflow-compliant]</a>) that support <code>jobMaxTTL</code> and <code>taskMaxTTL</code> options.</p></div>
<div class="paragraph"><p>Conversely, when applying retries to a set of parallel actions, the maximum delay in this case might be limited to 30 seconds—still a long time!</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_73">7.16.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
&lt;&lt;design-hypermedia" /&gt;]
</p>
</li>
<li>
<p>
<a href="#design-repeat">[design-repeat]</a>
</p>
</li>
<li>
<p>
<a href="#services-errors">[services-errors]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-progress">[workflow-progress]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-undo">7.17. Supporting Local Undo or Rollback</h3>
<div class="paragraph"><p>Whenever possible, your service interface should offer API consumers an undo option—the ability to reverse the last action. This might be reversing a data update, removing the resource that was just created, or unwinding a process that was executed previously. There are a few challenges to face, including the likelihood that the underlying service does not offer an undo action on its own. However, that doesn&#8217;t mean the API can&#8217;t offer one anyway.</p></div>
<div class="sect3">
<h4 id="_problem_73">7.17.1. Problem</h4>
<div class="paragraph"><p>It is a good practice to support an undo option for the most recent interface action (e.g., add, edit, or delete). However, not all services (the code behind the API) will offer an undo option. What does it take to support undo even for cases where services do not support it? Under what conditions is it recommended versus when is it not recommended to provide an undo option?</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Supporting local undo is a kind of API proxy pattern. Check out <a href="#services-proxy">[services-proxy]</a> for a more general approach to the proxy pattern.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_solution_73">7.17.2. Solution</h4>
<div class="paragraph"><p>As a general practice, all services are better off when they offer some level of undo functionality. The ability to reverse the last action is assumed for most all human-centric interfaces and doing the same for machine-centric interfaces is just as valid.</p></div>
<div class="paragraph"><p>When services provide their own undo option, you should definitely expose that through the external action interface (see <a href="#services-actions">[services-actions]</a>). In these cases, supporting undo is easy; just implement the service option in your API. However, there will be times when an undo action is not available through the underlying service(s). In that case, it is a good idea to implement undo at the API level whenever possible. That means working up a "faux undo" that works with the underlying service (or services).</p></div>
<div class="sect4 xxx">
<h5 id="_direct_undo">7.17.2.1. Direct undo</h5>
<div class="paragraph"><p>For simple CRUD-style services, implementing an undo is pretty straightforward. You need to implement the service action (e.g., <code>updateCustomer</code>), keep a history of undoable actions in a local durable storage index by an identifier (<code>contextId</code>), and expose your own external action (for example, <code>undoUpdateCustomer</code> that takes the <code>contextId</code>).</p></div>
<div class="paragraph"><p>When implementing your local undo functionality, it is wise to establish a time frame for valid rollbacks. For example, you might offer to reverse the action as long as the rollback request comes within five seconds of the original action. This reduces the likelihood that undoing something from last week will have adverse affects in other parts of the system.</p></div>
<div class="paragraph"><p>When you are dealing with simple CRUD-style services, you can consider the "direct undo" approach. When supporting changes to multiple underlying services, or in cases where you are not sure of the implications of implementing a direct reversal of an action, you can try the "undo with delays" approach instead.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_supporting_undo_with_delays">7.17.2.2. Supporting undo with delays</h5>
<div class="paragraph"><p>A less worrisome way to support undo is to simply delay the requested change. For example, you can support the <code>updateCustomer</code> action and, when it is executed, you put the request "on hold" for some set time (e.g., five seconds). If, in that time frame, the API caller discovers its mistake and sends the <code>undoUpdateCustomer</code> message, you can simply ignore the original request. In this case, the underlying service(s) never sees the original <code>updateCustomer</code> action and there is no possibility that undoing a committed transaction will invalidate some other part of the system.</p></div>
<div class="paragraph"><p>The downside of this approach is that you are committing to a built-in delay of some value for all write operations that support undo. For this reason, it is a good idea to only use this delay approach for actions that can support delayed completion without breaking any performance commitments. For example, use cases such as nightly batch updates, patterns that typically work via queues, etc., make good candidates for the delayed undo.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_example_71">7.17.3. Example</h4>
<div class="paragraph"><p>There are two possible implementation patterns for supporting undo for your service interfaces: direct and delayed.</p></div>
<div class="sect4 xxx">
<h5 id="_direct_undo_2">7.17.3.1. Direct undo</h5>
<div class="paragraph"><p>For the direct approach, consider a simple CRUD-style service that has this as its internal function model:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// internal service code</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">internal_actions</span></span><span style="color: #990000">(</span>action<span style="color: #990000">,</span> id<span style="color: #990000">,</span> object<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>action<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span>
      rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> object<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"read"</span><span style="color: #990000">:</span>
      rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"update"</span><span style="color: #990000">:</span>
      rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">update</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> object<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"delete"</span><span style="color: #990000">:</span>
      rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>One way to support undo for your API is to add a new action that looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// external actions in api code</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">createAction</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> object<span style="color: #990000">,</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">writeLogAction</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> object<span style="color: #990000">,</span> context<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
    rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">internal_actions</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"create"</span><span style="color: #990000">,</span> id<span style="color: #990000">,</span> object<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> rt<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">undoCreateAction</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">readLogAction</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> context<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">isUndoable</span></span><span style="color: #990000">(</span>rt<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
    rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">internal_actions</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> id<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">errNotUndoable</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> context<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> rt<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect4 xxx">
<h5 id="_undo_via_delayed_execution">7.17.3.2. Undo via delayed execution</h5>
<div class="paragraph"><p>Implementing rollback via a delayed execution looks slightly different. You can implement this option by queuing up the unsafe operation (create, update, or delete) with a delay. Then if needed, you can cancel the change <em>before</em> it is actually committed to the backend service.</p></div>
<div class="paragraph"><p>In the next example, there is an underlying operation that commits changes to three sources: <code>customers</code>, <code>orders</code>, and <code>products</code>. Here&#8217;s a simplified version of how that might work in code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// external action</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">scheduleUpdate</span></span><span style="color: #990000">(</span>inputProperties<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// sort out properties to three sources:</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customers <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> orders <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> products <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span>
  context <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">setTimeout</span></span><span style="color: #990000">(</span>
    <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">updateSources</span></span><span style="color: #990000">(</span>customers<span style="color: #990000">,</span> orders<span style="color: #990000">,</span> products<span style="color: #990000">);</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #993399">5000</span>
  <span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> context<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// external action</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">cancelUpdate</span></span><span style="color: #990000">(</span>context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">clearTimeout</span></span><span style="color: #990000">(</span>context<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// internal function</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">updateSources</span></span><span style="color: #990000">(</span>customers<span style="color: #990000">,</span> orders<span style="color: #990000">,</span> products<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="font-style: italic"><span style="color: #9A1900">// commit all three sources in parallel</span></span>
  rt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">updateWith</span></span><span style="color: #990000">(</span>customers<span style="color: #990000">,</span> orders<span style="color: #990000">,</span> products<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> rt<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The HTTP exchange to support this use case might look like this (in HTML):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>**** REQUEST ****
PUT /update HTTP/1.1
Host: api.example.org
Content-Type: x-www.form-urlencoded
Accept: text/html
...

customerId=q1w2e3&amp;orderId=p0o9i8&amp;productId=5t6y7u&amp;...

**** RESPONSE ****
HTTP/1.1 202 Accepted
Content-Type text/html
...

&lt;p&gt;Order Updated. You can cancel this order in the next five seconds.&lt;/p&gt;
&lt;form name="rollback" method="put" action="http://api.example.org/update/r4t5"&gt;
  &lt;input type="hidden" name="contextId" value="r4t5" /&gt;
  &lt;input type="submit" value="Undo Order Update" /&gt;
&lt;/form&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Notice that the HTTP exchange uses <code>HTTP 202 Accepted</code> as the response. This is not a requirement for supporting rollbacks via delayed execution but can be helpful for API client applications since it makes the delay explicit in the exchange. You can also just return <code>200 OK</code> or <code>201 Created</code> and still support the undo pattern.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_74">7.17.4. Discussion</h4>
<div class="paragraph"><p>In the case of the direct undo pattern, make sure your current running context (e.g., the logged-in user context) has rights to complete all the underlying actions needed for the undo. For example, if the logged-in user doesn&#8217;t have access rights to HTTP <code>DELETE</code>, that logged-in user should not have access rights to the undo functionality.</p></div>
<div class="paragraph"><p>Even when the underlying service(s) code supports simple CRUD actions, if your API code relies on unsafe actions (add, edit, or delete) against more than one underlying service (e.g., <code>updateCustomer</code> and <code>updateSalesLog</code>), you should consider using the delay method for supporting local undo.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe is designed to support rollback within your own service interface. See <a href="#workflow-undo">[workflow-undo]</a> for details on how to handle rollbacks across multiple services.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>It might seem that implementing your own undo functionality will cause problems for underlying services. This is not true as long as your API code sticks to implementing the exposed functionality of the service. In other words, if the service supports a remove operation, it should not matter if the remove is used on a record three weeks old created by someone else, as opposed to using the remove operation on a record your own API consumer created five seconds ago.</p></div>
<div class="paragraph"><p>One of the downsides of using the delay approach is that you are adding wait states to your service interface. A couple of seconds may not seem like a big deal, but it can add up quickly. Consider the possibility that you add a wait of three seconds to your API, and there are three underlying services called by that API. Now assume that each of those three underlying services has three-second wait states, too. And so forth. Before you know it, we could be looking at 15 to 30 seconds of fixed delays in our workflow! That&#8217;s fine if we&#8217;re looking at overnight batch updates, but it would be a real mess if these APIs are used to provide instant updates to our stock trading <span class=".keep-together">platform</span>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_74">7.17.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-idempotent">[design-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#design-revert">[design-revert]</a>
</p>
</li>
<li>
<p>
<a href="#clients-messages">[clients-messages]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#services-proxy">[services-proxy]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-retry">[workflow-retry]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-help">[workflow-help]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-help">7.18. Calling for Help</h3>
<div class="paragraph"><p>There are times when a workflow problem cannot be easily resolved by a machine at runtime. When that happens, it is a good idea to simply call for help by sending an alert to a person who can sort out the problem and then, if possible, restart the workflow or cancel it completely.</p></div>
<div class="sect3">
<h4 id="_problem_74">7.18.1. Problem</h4>
<div class="paragraph"><p>What do you do when a workflow error has occurred and there is no easy way to resolve it? What is the bare minimum information needed to send a call for help?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_74">7.18.2. Solution</h4>
<div class="paragraph"><p>There will be times when your carefully crafted workflow request will fail badly. Sometimes you can fix the problem using an automatic retry (see <a href="#workflow-retry">[workflow-retry]</a>), but that may not work. When that happens, it is best to simply call for help from a responsible person and let them sort it out.</p></div>
<div class="paragraph pagebreak-before less_space"><p>For example, some network error may be causing requests to fail and there is nothing that can be done to fix that at the moment. When that happens, your workflow processor should send an alert (often an email along with an SMS message) to some predetermined person responsible for handling these kinds of problems.</p></div>
<div class="paragraph"><p>The alert should include (or point to) the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
The workflow description (Recipes <a data-type="xref" href="#workflow-code" data-xrefstyle="select:labelnumber">#workflow-code</a>, <a data-type="xref" href="#workflow-dsl" data-xrefstyle="select:labelnumber">#workflow-dsl</a>, and <a data-type="xref" href="#workflow-document" data-xrefstyle="select:labelnumber">#workflow-document</a>)
</p>
</li>
<li>
<p>
The workflow progress resource (<a href="#workflow-progress">[workflow-progress]</a>)
</p>
</li>
<li>
<p>
The workflow shared state (<a href="#workflow-compliant">[workflow-compliant]</a>)
</p>
</li>
<li>
<p>
Any other pertinent information, such as error reports, traces, etc.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This can be either shipped as a ZIP file collection attached to an email or as pointers (URLs) to the relevant documents (assuming the person has the access rights to all the resources).</p></div>
<div class="paragraph"><p>The person in charge of the incident can then try to sort out the problem and, if it can be fixed, continue or restart the workflow request. If neither of those work, the person can cancel the job completely.</p></div>
<div class="paragraph"><p>This should be written up as an incident and placed in a collection that is reviewed regularly. This incident collection can become the start of a bug fix or redesign to help reduce calls for help in the future.</p></div>
</div>
<div class="sect3">
<h4 id="_example_72">7.18.3. Example</h4>
<div class="paragraph"><p>The first step in supporting this recipe is including a responsible party on the workflow job description.  For document-driven workflow (<a href="#workflow-document">[workflow-document]</a>), that would look like this (see the <code>contact</code> section of the HTML version of the workflow document):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Shopping Checkout Workflow<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Shopping Checkout Workflow<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"job"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobID"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>q1w2e3r4t5<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"jobStatus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>working<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      ...
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"contact"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"person"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Mook Maundy<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>mook@example.org<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"sms"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>1234567890<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"voice"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>9086574321<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"tasks"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskID"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>p0o9i8u7y6<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"taskStatus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
          ...
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        ...
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that the <code>contact</code> block contains <code>name</code>, <code>email</code>, <code>voice</code>, and <code>sms</code> properties. These values might not all be supplied, but at least <code>email</code>, <code>voice</code>, or <code>sms</code> should appear as part of the <code>contact</code> block. These values may also be group values (e.g., <code>support@example.org</code>) or a general help line (e.g., <code>1-800-PLS-HELP</code>).</p></div>
<div class="paragraph"><p>If a halting error occurs (one that cannot be automatically resolved), an alert should be automatically sent using <code>email</code> and/or <code>sms</code> with the related data or a URL pointing to that data. For example, this error might automatically generate the following incident message sent as an attachment to the <code>email</code> address:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">{</span>"collection": <span style="color: #990000">{</span>
  "title": "<span style="color: #FF0000">CFH Incident Report q1w2e3r4</span>"<span style="color: #990000">,</span>
  "links": <span style="color: #990000">[</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">job</span>"<span style="color: #990000">,</span> "href":"<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">progress</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">sharedState</span>"<span style="color: #990000">,</span> "href": "<span style="color: #FF0000">...</span>"<span style="color: #990000">},</span>
    <span style="color: #990000">{</span>"rel": "<span style="color: #FF0000">errorReport</span>"<span style="color: #990000">,</span> "href": "...<span style="color: #990000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #990000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>This example is a machine-readable version. The same data can be sent in a human-friendly format, as well.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_75">7.18.4. Discussion</h4>
<div class="paragraph"><p>Implementing this recipe is an important part of a healthy workflow design. You can never be sure what might happen at runtime, and the ability to simply alert a human to sort out the problem is essential.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>While not mentioned here, it may also help to set some type of priority codes for your workflow alerts. This goes beyond simple workflow design and is best handled by an existing incident management platform.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Generating a call for help incident is rather simple when you are using workflow documents (<a href="#workflow-document">[workflow-document]</a>), but it is a bit more involved if you are using DSL or code to describe workflow. In the case of DSL workflow (<a href="#workflow-dsl">[workflow-dsl]</a>), you probably need to generate a resource that holds a nonexecutable version of the workflow script. For cases where the workflow is expressed as source code (<a href="#workflow-code">[workflow-code]</a>), you will likely be unable to share that code and may need to generate some tracing or other internal information to share in the report.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Be sure that your call for help records <em>do not</em> publicly share any private data, proprietary information, or other security-related data that could be exploited.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You can use the output from the call for help system to publish on a dashboard to indicate the general health of your overall system. This can help you track the most common call for help incidents and target them for bug fixes or updates. It can also give you a sense of the ebb and flow of incidents (do they happen at common times of the workday? etc.). Finally, you can track the time it takes to resolve incidents as a measure of your response quality and adjust your teams, if needed.</p></div>
<div class="paragraph"><p>Depending on your current environment, you may be able to use your existing bug or incident reporting system to automatically generate a high-priority ticket that kicks off its own alerting and routing workflow. This is not required but would likely be easier to support than setting your own internal email/sms/voice alerting process for alerts.</p></div>
<div class="paragraph"><p>If you are generating your own alerts, you probably need to set up a <code>list</code> resource (<a href="#workflow-navigation">[workflow-navigation]</a>) and maybe even a work-in-progress (<a href="#workflow-wip">[workflow-wip]</a>) interface to track and manage your incidents. At this point, you are dangerously close to implementing your own workflow support platform and probably need to check into some off-the-shelf solutions for your call for help program.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_75">7.18.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-vocabularies">[design-vocabularies]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#services-fallback">[services-fallback]</a>
</p>
</li>
<li>
<p>
<a href="#data-metadata">[data-metadata]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-progress">[workflow-progress]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="workflow-scaling">7.19. Scaling Workflow with Queues and Clusters</h3>
<div class="paragraph"><p>One of the challenges of supporting workflow on the web is the possibility of high-traffic loads (either sporadic or constant). This recipe covers some internal programming you can do to help better handle times when request volume might cause a backup in processing.</p></div>
<div class="sect3">
<h4 id="_problem_75">7.19.1. Problem</h4>
<div class="paragraph"><p>How can you make sure that heavy traffic doesn&#8217;t cause workflow services to crash or operate unreliably? What can be done behind the scenes to make it easier to handle large traffic volumes and/or flaky workflow processing without causing the service interface consumers to change their own behaviors?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_75">7.19.2. Solution</h4>
<div class="paragraph"><p>If you are concerned that your workflow services might get overrun with high-volume traffic or jobs that run too long, you can use two programming or architecture techniques behind the interface to improve reliability and scalability: queues and clusters.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This recipe, like <a href="#workflow-retry">[workflow-retry]</a>, deals with internal server-side programming details; all the elements here should be treated accordingly. This is not information that should be easily reachable on the web.</p></div>
</td>
</tr></table>
</div>
<div class="sect4 xxx">
<h5 id="_use_queues_to_scale_request_traffic">7.19.2.1. Use queues to scale request traffic</h5>
<div class="paragraph"><p>By adding a message queue between the service interface and the service itself, you can reduce the time it takes for a request to get <em>acknowledged</em> even if it will take some time before the request is <em>processed</em> (<a href="#fig0713">[fig0713]</a>).</p></div>
<div class="paragraph"><p>This technique is especially easy if you are expressing workflow requests as documents (<a href="#workflow-document">[workflow-document]</a>). By adding a queue between the interface and the service, you can quickly return an HTTP <code>202 Accepted</code> when the request arrives and then log the request into a persistent queue. The service can then read messages off the queue and process them as they are available.</p></div>
<div class="imageblock" id="fig0713">
<div class="content">
<img src="images/rwcb_0713.png" alt="images/rwcb_0713.png" width="80%" />
</div>
<div class="title">Figure 31. Message queues help you scale up request volume</div>
</div>
<div class="paragraph"><p>If your messages are timing out in the queue (reaching <code>jobMaxTTL</code> or <code>taskMaxTTL</code>) before they are successfully processed, you may need to add more workflow processors to read the queues.</p></div>
</div>
<div class="sect4 xxx">
<h5 id="_use_clusters_to_handle_request_processing">7.19.2.2. Use clusters to handle request processing</h5>
<div class="paragraph"><p>If your workflow processing is timing out, you likely need to add more processors—more workflow engines—to handle the added work. The easiest way to do this is to create a machine cluster (see <a href="#fig0714">[fig0714]</a>). Most platforms (including all the cloud platforms) have a feature that allows you to declare a single IP address as the destination for a service interface and then place several machines behind that destination. Any machine running in the cluster can accept workflow requests. That includes reading off the backlog queue.</p></div>
<div class="imageblock" id="fig0714">
<div class="content">
<img src="images/rwcb_0714.png" alt="images/rwcb_0714.png" width="80%" />
</div>
<div class="title">Figure 32. Clusters help you scale up processing volume</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>The details of setting up and managing machine clusters is beyond the scope of this book. Kubernetes is a great example of a product that handles cluster management. All the major cloud platforms (AWS, Google, Heroku, Microsoft, etc.) offer support for clustering, too.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Using machine clusters can also protect you against intermittent machine failures. If one machine in the cluster goes down, you may still have one or more machines up and running that can take the request load while the problem machine gets rebooted or replaced.</p></div>
<div class="paragraph"><p>The good news is that both queues and clusters can be introduced without disrupting the public service interface.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_76">7.19.3. Discussion</h4>
<div class="paragraph"><p>There are lots of solutions for implementing queues behind your interface. The simplest one is to create a disk folder somewhere (e.g., /requests/) and write all requests as a file in that folder. Then write code that monitors the folder and reads any files that appear there. The drawback of this option is that the folder is often tied to a specific machine, making it harder to implement shared queues for machine clusters.</p></div>
<div class="paragraph pagebreak-before less_space"><p>All the major cloud vendors offer an auto-scaling feature. You can set parameters that control how large the traffic volume grows, automatically spin up new machines to handle the added requests, and then close out machines as the volume decreases. This can sometimes be fiddly to set up and possibly costly to operate, but it can get you through a short-term jam.</p></div>
<div class="paragraph"><p>In both cases (queues and clusters), it is important that the messages are fully self-describing, the share states exist as independent resources, and the services can operate in parallel. These are all features of workflow-compliant services covered in <a href="#workflow-compliant">[workflow-compliant]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_76">7.19.4. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-state-transfer">[design-state-transfer]</a>
</p>
</li>
<li>
<p>
<a href="#clients-qualities">[clients-qualities]</a>
</p>
</li>
<li>
<p>
<a href="#data-hiding">[data-hiding]</a>
</p>
</li>
<li>
<p>
<a href="#data-caching">[data-caching]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-progress">[workflow-progress]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-accepted">[workflow-accepted]</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="workflow-proxy">7.20. Using Workflow Proxies to Enlist <span class=".keep-together">Noncompliant Services</span></h3>
<div class="paragraph"><p>There are times when you want to use an existing noncompliant service interface as part of your workflow process. This recipe shows you how to do that safely and when to <em>not</em> do it at all.</p></div>
<div class="sect3">
<h4 id="_problem_76">7.20.1. Problem</h4>
<div class="paragraph"><p>What do you do when you have an existing service interface that is not a workflow-compliant implementation and you want to include that as a task in a workflow job? Under what cases can this be done safely, and when it is not advisable to try at all?</p></div>
</div>
<div class="sect3">
<h4 id="_solution_76">7.20.2. Solution</h4>
<div class="paragraph"><p>The simplest way to enlist a service interface that is not workflow-compliant into your workflow stream is to wrap it in a workflow-compliant <em>proxy</em>. This proxy can supply all the aspects of a workflow-compliant service (see <a href="#workflow-compliant">[workflow-compliant]</a>), including all the actions, support for shared state, and passing correlation and request identifiers.</p></div>
<div class="paragraph pagebreak-before less_space"><p>Your workflow proxy needs to support all the important actions listed in <a href="#workflow-compliant">[workflow-compliant]</a>, including:</p></div>
<div class="ulist"><ul>
<li>
<p>
Execute
</p>
</li>
<li>
<p>
Repeat
</p>
</li>
<li>
<p>
Revert
</p>
</li>
</ul></div>
<div class="paragraph"><p>Typically, you can use the Execute  action to point to the target service and perform the desired work. You will likely need to code routines that read and write content in the associated shared state resource, too.</p></div>
<div class="paragraph"><p>However, support for the Repeat  idempotent action and the Revert  undo action can be more difficult. For read-only services like validating a postal code against a list, or compute-only services like calculating sales tax, there is no meaningful Revert to support and you can easily Repeat  the actions as many times as you wish.</p></div>
<div class="paragraph"><p>Note that if the target service changes state on the server side (e.g., modifies stored data, modifies a resource, etc.), you&#8217;ll need to make sure to support both Repeat  and Revert. If the existing service interface does this already, you can just wire up the proxy actions to the target service. If not, you&#8217;ll need to see if you can code the proxy in a way that gives you the support you need.</p></div>
<div class="paragraph"><p>For example, you might be able to support the Revert action for creating a resource by coding into the proxy the local knowledge of the resources the proxy has created, and upon request, executing the Revert action to delete that resource. However, you need to ensure that the resource you are attempting to delete has not created some other dependent state change (modified existing resources like a work ticket, log entry, etc.). This can be close to impossible if you or your team do not "own" the target service interface.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Here Be Dragons!</div>
<div class="paragraph"><p>For reasons stated here, you should only proxy services that are read-only. The exception to this rule would be cases where you are in control of the noncompliant service and are confident you can safely support Revert and Repeat actions on that service.</p></div>
</div></div>
<div class="paragraph"><p>In general, you should steer clear of relying on workflow proxies if at all possible. When you can&#8217;t avoid it, try to stick to proxying read-only services unless you are absolutely sure the unsafe actions can be properly repeated and reverted.</p></div>
</div>
<div class="sect3">
<h4 id="_example_73">7.20.3. Example</h4>
<div class="paragraph"><p>Assume you have a noncompliant service called <code>computeVAT</code> that you want to enlist in your shopping workflow. To do this, you need to create a new workflow-compliant proxy interface (let&#8217;s call it <code>workflowVAT</code>) that supports following:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>readSharedState</code>
</dt>
<dd>
<p>
This loads shared state into local memory, ready to use to supply any required data for execution service actions.
</p>
</dd>
<dt class="hdlist1">
<code>inputVATData</code>
</dt>
<dd>
<p>
This exposes a form for calling the execution operation and, if possible, is filled in by properties in the <code>sharedState</code> collection.
</p>
</dd>
<dt class="hdlist1">
<code>executeVATComputation</code>
</dt>
<dd>
<p>
This calls the target service&#8217;s key functionality (e.g., <code>computeVAT</code>) using the previous form, filled in with data from the <code>sharedState</code> collection.
</p>
</dd>
<dt class="hdlist1">
<code>writeSharedState</code>
</dt>
<dd>
<p>
This writes the results of the execution to the <code>sharedState</code> collection.
</p>
</dd>
<dt class="hdlist1">
<code>repeatVATComputation</code>
</dt>
<dd>
<p>
This repeats the process of taking data from the <code>sharedState</code> collection, filling in the <code>inputVATData</code> form, and running the <code>executeVATComputation</code> action. This also results in a call to the <code>writeSharedState</code> action to update the <code>sharedState</code> collection.
</p>
</dd>
<dt class="hdlist1">
<code>RevertVATComputation</code>
</dt>
<dd>
<p>
This action removes any results (from the <code>executeVATComputation</code> action) from the <code>sharedState</code> collection (essentially reverting it back to its state <em>before</em> any execution took place) and performs a <code>writeSharedState</code> to commit the Revert action to the collection.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>All through this process, the HTTP interface for the proxy actions supports both the <code>correlation-id</code> (job identifier) and <code>request-id</code> (task identifier) properties that are passed back and forth for any of the HTTP request or response messages.</p></div>
<div class="paragraph"><p>You may notice that the proxy is doing quite a bit of heavy lifting to make it possible to use the <code>computeVAT</code> service. So much heavy lifting, that it might make sense to simply replace the <code>computeVAT</code> service with one that <em>is</em> workflow compliant. And you would be correct.</p></div>
<div class="paragraph"><p>In other words, only use the workflow proxy recipe when you are unable to replace the noncompliant service with one that is workflow compliant.</p></div>
</div>
<div class="sect3">
<h4 id="_discussion_77">7.20.4. Discussion</h4>
<div class="paragraph"><p>Introducing workflow proxies can reduce the reliability of your system. You are adding another service in the chain, and that exposes the possibility of network disconnects as well as service failures at either the proxy or target location. Be sure to include fixes for these things in your implementation (see <a href="#services-fallback">[services-fallback]</a>).</p></div>
<div class="paragraph"><p>It can be especially dangerous to attempt to proxy an unsafe noncompliant service (one that writes data) if you do not control the target service. For example, you don&#8217;t know just what is happening behind the interface you are shown. Are there other services running? Is there a chain of dependent writes going on that you do not see?  Even if you are confident of the current actions of the target service, what happens when that target is updated or replaced by its owner?</p></div>
<div class="paragraph"><p>If you own the noncompliant service, you might need to use the workflow proxy pattern as an interim solution, one that will help you build up your workflow service practice while you spend time replacing noncompliant services with ones that meet all the requirements laid out in <a href="#workflow-compliant">[workflow-compliant]</a>. This is a common digital transformation pattern that I see many organizations go through. A kind of "fake it until you make it" approach. See <a href="#closing-transform">[closing-transform]</a> for more on this point.</p></div>
</div>
<div class="sect3">
<h4 id="_see_also_77">7.20.5. See Also</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="#design-profiles">[design-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#design-idempotent">[design-idempotent]</a>
</p>
</li>
<li>
<p>
<a href="#clients-profiles">[clients-profiles]</a>
</p>
</li>
<li>
<p>
<a href="#services-registry">[services-registry]</a>
</p>
</li>
<li>
<p>
<a href="#services-proxy">[services-proxy]</a>
</p>
</li>
<li>
<p>
<a href="#data-proxy">[data-proxy]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-compliant">[workflow-compliant]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-accepted">[workflow-accepted]</a>
</p>
</li>
<li>
<p>
<a href="#workflow-undo">[workflow-undo]</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="principles">8. Appendix A: Guiding Principles of RESTful Web APIs</h2>
<div class="sectionbody">
<div class="paragraph"><p>The guiding principle driving this recipe collection is:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Leverage global reach to solve problems you haven&#8217;t thought of for people you have never met.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>The supporting principles are illustrated in <a href="#figaa01">[figaa01]</a> and described further in the following list.</p></div>
<div class="imageblock" id="figaa01">
<div class="content">
<img src="images/rwcb_aa01.png" alt="images/rwcb_aa01.png" width="80%" />
</div>
<div class="title">Figure 33. RESTful web API principles</div>
</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Discovery
</dt>
<dd>
<p>
Good recipes increase our global reach—the ability to share our solutions and to find and use the solutions of others.
</p>
</dd>
<dt class="hdlist1">
Extension
</dt>
<dd>
<p>
Good recipes make well-designed services available for others to use in ways we haven&#8217;t thought of yet.
</p>
</dd>
<dt class="hdlist1">
Composition
</dt>
<dd>
<p>
Good recipes make it possible for "strangers" (services and/or people) to safely and successfully interact with each other to solve a problem.
</p>
</dd>
<dt class="hdlist1">
Evolution
</dt>
<dd>
<p>
Good recipes promote longevity and independent evolution on a scale of <span class=".keep-together">decades</span>.
</p>
</dd>
<dt class="hdlist1">
Longevity
</dt>
<dd>
<p>
Good recipes recognize that nothing is permanent and things will always change over time.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_applying_restful_patterns">9. Applying RESTful Patterns</h2>
<div class="sectionbody">
<blockquote data-type="epigraph" style="text-align:right; font-style:italic;">
<p><q>The best designers will use many design patterns that dovetail and intertwine to produce a greater whole.</q></p>
<p data-type="attribution">Erich Gamma</p>
</blockquote>
<div class="paragraph"><p>You&#8217;ve been assigned the work of designing, building, and maintaining a basic <em>User Account API</em> for an existing set of <em>User Account Services</em>. You have complete control over the design and implementation of the API. However, you have no control over the underlying <em>services</em> that provide the functionality for that API.</p></div>
<div class="paragraph"><p>Below are are a series of API architecture challenges. Read through each challenge scenario. Think about what is needed, what is possible, and how you might apply one or more RESTful patterns to the use case.  As a result, list out one or more of the API patterns that you think could be applied. Keep in mind that your list might cover more than just the stated challenge. for Example,to solve a design challenge you may need to include one or more client or service patterns, too.</p></div>
<div class="paragraph"><p>Keep in mind there is no <em>single</em> correct answer.</p></div>
<div class="sect2">
<h3 id="_restful_design">9.1. RESTful Design</h3>
<div class="ulist"><ul>
<li>
<p>
You are told that the API <strong>MUST</strong> support simple HTML responses, <strong>SHOULD</strong> support at least one set JSON-based responses. It is also likely that other formats <strong>MAY</strong> be needed in the future
</p>
</li>
<li>
<p>
This API will need to support multiple security roles&#8201;&#8212;&#8201;some roles may have limited access to API actions (e.g. visitors cannot DELETE records, etc.)
</p>
</li>
<li>
<p>
It should be possible to reverse an update (e.g. undo a DELETE action, reset and UPDATE, etc.)
</p>
</li>
<li>
<p>
You <strong>MUST</strong> design the API in a way that allows for changes in the services to <em>not</em> break the shared interface (API).
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_restful_clients">9.2. RESTful Clients</h3>
<div class="ulist"><ul>
<li>
<p>
After a merger with a rival company the URL of the existing <em>User Account API</em> <strong>MUST</strong> be changed soon. You will need to update the client application to handle this seamlessly. You are also told that the URL <strong>MAY</strong> change in the future.
</p>
</li>
<li>
<p>
You are told to create Single Page Application (SPA) client application for the <em>User Account API</em>. I <strong>MUST</strong> support a plain JSON-based version and a SIREN-JSON version. This client application <strong>MAY</strong> need to support other JSON-based formats in the future.
</p>
</li>
<li>
<p>
You are asked to write a small command-line interface (CLI) application that that produces simple CSV report files for uploading into spreadsheets. You only need three of the fields in a typical response (<code>id</code>, <code>fullName</code>, and <code>dateLastModified</code>).
</p>
</li>
<li>
<p>
You&#8217;ve been asked to improve the validation of incoming responses from the <em>User Account API</em>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_restful_services">9.3. RESTful Services</h3>
<div class="ulist"><ul>
<li>
<p>
You are told that your <em>User Account API</em> needs to support multiple response formats (HTML and plain JSON to start, others in the future).
</p>
</li>
<li>
<p>
You&#8217;ve been asked to produce a definite vocabulary document for your <em>User Account API</em> and share that with all client applications using the API.
</p>
</li>
<li>
<p>
You have been <strong>REQUIRED</strong> to support both run-time and design-time discover-ability for the _User Account API.
</p>
</li>
<li>
<p>
To improve reliability, you&#8217;ve been asked to make sure the <em>User Account API</em> doesn&#8217;t fail (e.g. <code>HTTP 5xx</code>) even when that service&#8217;s other dependencies (e.g. data service) fails or is not available at run-time.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_distributed_data">9.4. Distributed Data</h3>
<div class="ulist"><ul>
<li>
<p>
You have been told that the existing data model for the <em>User Account</em> product will be changing. Some tables will add/remove fields. some existing fields will change names, and there will be one or more new tables in the data model. How can you modify the underlying
</p>
</li>
<li>
<p>
The current data technology for the <em>User Account</em> systems is <code>MySQL</code>. You are told that it will soon be replaced with a new "NoSQL" <code>MongoDB</code> system. What changes do you make to the existing system? How can you be sure to support similar changes in the years to come?
</p>
</li>
<li>
<p>
What HTTP Response code and body should be returned in cases where a valid filter request (<code>dateLastModified=2024-12-01</code>) returns no records?
</p>
</li>
<li>
<p>
You&#8217;ve been asked to support multiple information retrieval query languages (IRQL)l for the <em>User Account API</em>. To start, you
<strong>MUST</strong> support <code>SOLR</code> and <code>SQL</code> and <strong>MAY</strong> need to support other possible IRQLs in the future.\
</p>
</li>
<li>
<p>
You are using an existing third-party data service API (e.g. <code>RemoteWorkData</code>) for your client application and need to add three new fields for each data record (<code>hatSize</code>, <code>shoeSize</code>, and <code>neckSize</code>). How do you support the new fields even though the third-party service does not allow customization at the field level?
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_restful_workflow">9.5. RESTful Workflow</h3>
<div class="ulist"><ul>
<li>
<p>
The <em>User Account API</em> has added several reporting API calls. A commonly-used one (<code>ChangeHistoryLastMonth</code>) is expected to take several minutes (up to <code>15 minutes</code>) to complete. How can you implement support for this report call without adding needless latency to the API?
</p>
</li>
<li>
<p>
You are <strong>REQUIRED</strong> to support a limited set of workflows for the <em>User Account API</em> (less than ten). These workflows are only meant to be used within the office network and are next expected to be exposed as public APIs for customers. The workflows are each well-defined and have a limited amounts of "tasks" within a single "job." What patterns can you use to implement this level of service workflow?
</p>
</li>
<li>
<p>
How will you support paging for any lists returned by the <em>User Account API</em>?
</p>
</li>
<li>
<p>
The <em>User Account API</em> has introduced a series of multi-step input processes (tabbed UI in HTML). Sometime this multi-step process involves two screens, sometimes as many as five. It depends on the process and the client application&#8217;s needs. What pattern(s) can you use to support this varying set of input steps?
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2024-06-07 12:35:24 EDT
</div>
</div>
</body>
</html>
